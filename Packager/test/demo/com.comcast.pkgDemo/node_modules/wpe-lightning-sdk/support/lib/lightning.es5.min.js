/**
 * Lightning v1.10.0
 *
 * https://github.com/rdkcentral/Lightning
 */

!function(e,t){"object"==typeof exports&&"undefined"!=typeof module?module.exports=t():"function"==typeof define&&define.amd?define(t):(e=e||self).lng=t()}(this,(function(){"use strict";function _classCallCheck(e,t){if(!(e instanceof t))throw new TypeError("Cannot call a class as a function")}function _defineProperties(e,t){for(var i=0;i<t.length;i++){var r=t[i];r.enumerable=r.enumerable||!1,r.configurable=!0,"value"in r&&(r.writable=!0),Object.defineProperty(e,r.key,r)}}function _createClass(e,t,i){return t&&_defineProperties(e.prototype,t),i&&_defineProperties(e,i),e}function _defineProperty(e,t,i){return t in e?Object.defineProperty(e,t,{value:i,enumerable:!0,configurable:!0,writable:!0}):e[t]=i,e}function ownKeys(e,t){var i=Object.keys(e);if(Object.getOwnPropertySymbols){var r=Object.getOwnPropertySymbols(e);t&&(r=r.filter((function(t){return Object.getOwnPropertyDescriptor(e,t).enumerable}))),i.push.apply(i,r)}return i}function _objectSpread2(e){for(var t=1;t<arguments.length;t++){var i=null!=arguments[t]?arguments[t]:{};t%2?ownKeys(Object(i),!0).forEach((function(t){_defineProperty(e,t,i[t])})):Object.getOwnPropertyDescriptors?Object.defineProperties(e,Object.getOwnPropertyDescriptors(i)):ownKeys(Object(i)).forEach((function(t){Object.defineProperty(e,t,Object.getOwnPropertyDescriptor(i,t))}))}return e}function _inherits(e,t){if("function"!=typeof t&&null!==t)throw new TypeError("Super expression must either be null or a function");e.prototype=Object.create(t&&t.prototype,{constructor:{value:e,writable:!0,configurable:!0}}),t&&_setPrototypeOf(e,t)}function _getPrototypeOf(e){return(_getPrototypeOf=Object.setPrototypeOf?Object.getPrototypeOf:function _getPrototypeOf(e){return e.__proto__||Object.getPrototypeOf(e)})(e)}function _setPrototypeOf(e,t){return(_setPrototypeOf=Object.setPrototypeOf||function _setPrototypeOf(e,t){return e.__proto__=t,e})(e,t)}function _newArrowCheck(e,t){if(e!==t)throw new TypeError("Cannot instantiate an arrow function")}function _assertThisInitialized(e){if(void 0===e)throw new ReferenceError("this hasn't been initialised - super() hasn't been called");return e}function _possibleConstructorReturn(e,t){return!t||"object"!=typeof t&&"function"!=typeof t?_assertThisInitialized(e):t}function _superPropBase(e,t){for(;!Object.prototype.hasOwnProperty.call(e,t)&&null!==(e=_getPrototypeOf(e)););return e}function _get(e,t,i){return(_get="undefined"!=typeof Reflect&&Reflect.get?Reflect.get:function _get(e,t,i){var r=_superPropBase(e,t);if(r){var n=Object.getOwnPropertyDescriptor(r,t);return n.get?n.get.call(i):n.value}})(e,t,i||e)}function set(e,t,i,r){return(set="undefined"!=typeof Reflect&&Reflect.set?Reflect.set:function set(e,t,i,r){var n,s=_superPropBase(e,t);if(s){if((n=Object.getOwnPropertyDescriptor(s,t)).set)return n.set.call(r,i),!0;if(!n.writable)return!1}if(n=Object.getOwnPropertyDescriptor(r,t)){if(!n.writable)return!1;n.value=i,Object.defineProperty(r,t,n)}else _defineProperty(r,t,i);return!0})(e,t,i,r)}function _set(e,t,i,r,n){if(!set(e,t,i,r||e)&&n)throw new Error("failed to set property");return i}function _toConsumableArray(e){return function _arrayWithoutHoles(e){if(Array.isArray(e)){for(var t=0,i=new Array(e.length);t<e.length;t++)i[t]=e[t];return i}}(e)||function _iterableToArray(e){if(Symbol.iterator in Object(e)||"[object Arguments]"===Object.prototype.toString.call(e))return Array.from(e)}(e)||function _nonIterableSpread(){throw new TypeError("Invalid attempt to spread non-iterable instance")}()}var e=function(){function StageUtils(){_classCallCheck(this,StageUtils)}return _createClass(StageUtils,null,[{key:"mergeNumbers",value:function mergeNumbers(e,t,i){return e*i+t*(1-i)}},{key:"rgb",value:function rgb(e,t,i){return(e<<16)+(t<<8)+i+4278190080}},{key:"rgba",value:function rgba(e,t,i,r){return(e<<16)+(t<<8)+i+16777216*(255*r|0)}},{key:"getRgbString",value:function getRgbString(e){return"rgb("+(e/65536|0)%256+","+(e/256|0)%256+","+e%256+")"}},{key:"getRgbaString",value:function getRgbaString(e){return"rgba("+(e/65536|0)%256+","+(e/256|0)%256+","+e%256+","+((e/16777216|0)/255).toFixed(4)+")"}},{key:"getRgbaStringFromArray",value:function getRgbaStringFromArray(e){return"rgba("+Math.floor(255*e[0])+","+Math.floor(255*e[1])+","+Math.floor(255*e[2])+","+(Math.floor(255*e[3])/255).toFixed(4)+")"}},{key:"getRgbaComponentsNormalized",value:function getRgbaComponentsNormalized(e){return[(e/65536|0)%256/255,(e/256|0)%256/255,e%256/255,(e/16777216|0)/255]}},{key:"getRgbComponentsNormalized",value:function getRgbComponentsNormalized(e){return[(e/65536|0)%256/255,(e/256|0)%256/255,e%256/255]}},{key:"getRgbaComponents",value:function getRgbaComponents(e){return[(e/65536|0)%256,(e/256|0)%256,e%256,e/16777216|0]}},{key:"getArgbNumber",value:function getArgbNumber(e){e[0]=Math.max(0,Math.min(255,e[0])),e[1]=Math.max(0,Math.min(255,e[1])),e[2]=Math.max(0,Math.min(255,e[2])),e[3]=Math.max(0,Math.min(255,e[3]));var t=((0|e[3])<<24)+((0|e[0])<<16)+((0|e[1])<<8)+(0|e[2]);return t<0&&(t=4294967295+t+1),t}},{key:"mergeColors",value:function mergeColors(e,t,i){var r=(e/65536|0)%256*i+(t/65536|0)%256*(1-i),n=(e/256|0)%256*i+(t/256|0)%256*(1-i),s=e%256*i+t%256*(1-i),o=(e/16777216|0)*i+(t/16777216|0)*(1-i);return 16777216*Math.round(o)+65536*Math.round(r)+256*Math.round(n)+Math.round(s)}},{key:"mergeMultiColors",value:function mergeMultiColors(e,t){for(var i=0,r=0,n=0,s=0,o=0,h=e.length,u=0;u<h;u++){var l=(e[u]/65536|0)%256,_=(e[u]/256|0)%256,d=e[u]%256,f=e[u]/16777216|0;i+=l*t[u],r+=_*t[u],n+=d*t[u],s+=f*t[u],o+=t[u]}return o=1/o,16777216*Math.round(s*o)+65536*Math.round(i*o)+256*Math.round(r*o)+Math.round(n*o)}},{key:"mergeMultiColorsEqual",value:function mergeMultiColorsEqual(e){for(var t=0,i=0,r=0,n=0,s=0,o=e.length,h=0;h<o;h++){t+=(e[h]/65536|0)%256,i+=(e[h]/256|0)%256,r+=e[h]%256,n+=e[h]/16777216|0,s+=1}return s=1/s,16777216*Math.round(n*s)+65536*Math.round(t*s)+256*Math.round(i*s)+Math.round(r*s)}},{key:"mergeColorAlpha",value:function mergeColorAlpha(e,t){var i=(e/16777216|0)*t|0;return((e>>16&255)*i/255&255)+((65280&e)*i/255&65280)+(((255&e)<<16)*i/255&16711680)+(i<<24)}},{key:"rad",value:function rad(e){return e*(Math.PI/180)}},{key:"getTimingBezier",value:function getTimingBezier(e,t,i,r){var n=3*e,s=3*(i-e)-n,o=1-n-s,h=3*t,u=3*(r-t)-h,l=1-h-u;return function(e){if(e>=1)return 1;if(e<=0)return 0;for(var t,i,r=.5,_=0;_<20;_++){if((i=e-r*(r*(r*o+s)+n))>-1e-8&&i<1e-8)return r*(r*(r*l+u)+h);if((t=r*(r*(3*o)+2*s)+n)>1e-10&&t<1e-10)break;r+=i/t}for(var d=0,f=1,g=0;g<20;g++){if((i=e-(r=.5*(d+f))*(r*(r*o+s)+n))>-1e-8&&i<1e-8)return r*(r*(r*l+u)+h);i<0?f=r:d=r}}}},{key:"getTimingFunction",value:function getTimingFunction(e){switch(e){case"linear":return function(e){return e};case"ease":return StageUtils.getTimingBezier(.25,.1,.25,1);case"ease-in":return StageUtils.getTimingBezier(.42,0,1,1);case"ease-out":return StageUtils.getTimingBezier(0,0,.58,1);case"ease-in-out":return StageUtils.getTimingBezier(.42,0,.58,1);case"step-start":return function(){return 1};case"step-end":return function(e){return 1===e?1:0};default:var t="cubic-bezier(";if(e&&0===e.indexOf(t)){var i=e.substr(t.length,e.length-t.length-1).split(",");if(4!==i.length)return console.warn("Unknown timing function: "+e),function(e){return e};var r=parseFloat(i[0]),n=parseFloat(i[1]),s=parseFloat(i[2]),o=parseFloat(i[3]);return isNaN(r)||isNaN(n)||isNaN(s)||isNaN(o)?(console.warn("Unknown timing function: "+e),function(e){return e}):StageUtils.getTimingBezier(r,n,s,o)}return console.warn("Unknown timing function: "+e),function(e){return e}}}}]),StageUtils}(),t=function(){function Utils(){_classCallCheck(this,Utils)}return _createClass(Utils,null,[{key:"isFunction",value:function isFunction(e){return"function"==typeof e}},{key:"isNumber",value:function isNumber(e){return"number"==typeof e}},{key:"isInteger",value:function isInteger(e){return"number"==typeof e&&e%1==0}},{key:"isBoolean",value:function isBoolean(e){return!0===e||!1===e}},{key:"isString",value:function isString(e){return"string"==typeof e}},{key:"clone",value:function clone(e){return Utils.isObjectLiteral(e)||Array.isArray(e)?Utils.getDeepClone(e):e}},{key:"cloneObjShallow",value:function cloneObjShallow(e){for(var t=Object.keys(e),i={},r=0;r<t.length;r++)i[t[r]]=e[t[r]];return i}},{key:"merge",value:function merge(e,t){for(var i=Object.keys(t),r=0;r<i.length;r++)e[i[r]]=t[i[r]];return e}},{key:"isObject",value:function isObject(e){var t=typeof e;return!!e&&("object"===t||"function"===t)}},{key:"isPlainObject",value:function isPlainObject(e){return!!e&&"object"===typeof e}},{key:"isObjectLiteral",value:function isObjectLiteral(e){return"object"==typeof e&&e&&e.constructor===Object}},{key:"getArrayIndex",value:function getArrayIndex(e,t){return Utils.getModuloIndex(e,t.length)}},{key:"getModuloIndex",value:function getModuloIndex(e,t){if(0===t)return e;for(;e<0;)e+=Math.ceil(-e/t)*t;return e%=t}},{key:"getDeepClone",value:function getDeepClone(e){var t,i;if(Utils.isFunction(e))return e;if(Array.isArray(e)){i=[];var r=Object.keys(e);for(t=0;t<r.length;t++)i[r[t]]=Utils.getDeepClone(e[r[t]]);return i}if(Utils.isObject(e)){i={};var n=Object.keys(e);for(t=0;t<n.length;t++)i[n[t]]=Utils.getDeepClone(e[n[t]]);return i}return e}},{key:"equalValues",value:function equalValues(e,t){return typeof e==typeof t&&(Utils.isObjectLiteral(e)?Utils.isObjectLiteral(t)&&Utils.equalObjectLiterals(e,t):Array.isArray(e)?Array.isArray(t)&&Utils.equalArrays(e,t):e===t)}},{key:"equalObjectLiterals",value:function equalObjectLiterals(e,t){var i=Object.keys(e),r=Object.keys(t);if(i.length!==r.length)return!1;for(var n=0,s=i.length;n<s;n++){var o=i[n],h=r[n];if(o!==h)return!1;var u=e[o],l=t[h];if(!Utils.equalValues(u,l))return!1}return!0}},{key:"equalArrays",value:function equalArrays(e,t){if(e.length!==t.length)return!1;for(var i=0,r=e.length;i<r;i++)if(!this.equalValues(e[i],t[i]))return!1;return!0}},{key:"setToArray",value:function setToArray(e){var t=[];return e.forEach((function(e){t.push(e)})),t}},{key:"iteratorToArray",value:function iteratorToArray(e){for(var t=[],i=e.next();!i.done;)t.push(i.value),i=e.next();return t}},{key:"isUcChar",value:function isUcChar(e){return e>=65&&e<=90}}]),Utils}();t.isWeb="undefined"!=typeof window&&"undefined"==typeof sparkscene,t.isWPE=t.isWeb&&-1!==navigator.userAgent.indexOf("WPE"),t.isSpark="undefined"!=typeof sparkscene,t.isNode="undefined"==typeof window||t.isSpark;var i=function(){function Base(){_classCallCheck(this,Base)}return _createClass(Base,null,[{key:"defaultSetter",value:function defaultSetter(e,t,i){e[t]=i}},{key:"patchObject",value:function patchObject(e,i){if(t.isObjectLiteral(i))for(var r=Object.keys(i),n=0,s=r.length;n<s;n++){var o=r[n];this.patchObjectProperty(e,o,i[o])}else console.error("Settings must be object literal")}},{key:"patchObjectProperty",value:function patchObjectProperty(e,i,r){var n=e.setSetting||Base.defaultSetter;"_"===i.charAt(0)?"__create"!==i&&console.error("Patch of private property '"+i+"' is not allowed"):"type"!==i&&(t.isFunction(r)&&r.__local&&(r=r.__local(e)),n(e,i,r))}},{key:"local",value:function local(e){e.__local=!0}}]),Base}(),r=function(){function SpacingCalculator(){_classCallCheck(this,SpacingCalculator)}return _createClass(SpacingCalculator,null,[{key:"getSpacing",value:function getSpacing(e,t,i){var r,n,s,o=t-1;switch(e){case"flex-start":n=0,s=0;break;case"flex-end":n=i,s=0;break;case"center":n=i/2,s=0;break;case"space-between":n=0,s=Math.max(0,i)/o;break;case"space-around":if(i<0)return this.getSpacing("center",t,i);n=.5*(r=i/(o+1)),s=r;break;case"space-evenly":if(i<0)return this.getSpacing("center",t,i);n=r=i/(o+2),s=r;break;case"stretch":n=0,s=0;break;default:throw new Error("Unknown mode: "+e)}return{spacingBefore:n,spacingBetween:s}}}]),SpacingCalculator}(),n=function(){function ContentAligner(e){_classCallCheck(this,ContentAligner),this._layout=e,this._totalCrossAxisSize=0}return _createClass(ContentAligner,[{key:"init",value:function init(){this._totalCrossAxisSize=this._getTotalCrossAxisSize()}},{key:"align",value:function align(){var e=this._layout.crossAxisSize-this._totalCrossAxisSize,t=this._getSpacing(e),i=t.spacingBefore,r=t.spacingBetween,n=this._lines,s=0;"stretch"===this._layout._flexContainer.alignContent&&n.length&&e>0&&(s=e/n.length);for(var o=i,h=0,u=n.length;h<u;h++){var l=o,_=n[h].createItemAligner(),d=n[h].crossAxisLayoutSize+s;_.setCrossAxisLayoutSize(d),_.setCrossAxisLayoutOffset(l),_.align(),_.recursiveResizeOccured&&n[h].setItemPositions(),o+=d,o+=r}}},{key:"_getTotalCrossAxisSize",value:function _getTotalCrossAxisSize(){for(var e=this._lines,t=0,i=0,r=e.length;i<r;i++){t+=e[i].crossAxisLayoutSize}return t}},{key:"_getSpacing",value:function _getSpacing(e){var t=this._layout._flexContainer.alignContent,i=this._lines.length;return r.getSpacing(t,i,e)}},{key:"_lines",get:function get(){return this._layout._lines}},{key:"totalCrossAxisSize",get:function get(){return this._totalCrossAxisSize}}]),ContentAligner}(),s=function(){function FlexUtils(){_classCallCheck(this,FlexUtils)}return _createClass(FlexUtils,null,[{key:"getParentAxisSizeWithPadding",value:function getParentAxisSizeWithPadding(e,t){var i=e.target.getParent();if(i){var r=e.flexParent;return r?this.getAxisLayoutSize(r,t)+this.getTotalPadding(r,t):t?i.w:i.h}return 0}},{key:"getRelAxisSize",value:function getRelAxisSize(e,t){return t?e.funcW?this._allowRelAxisSizeFunction(e,!0)?e.funcW(this.getParentAxisSizeWithPadding(e,!0)):0:e.originalWidth:e.funcH?this._allowRelAxisSizeFunction(e,!1)?e.funcH(this.getParentAxisSizeWithPadding(e,!1)):0:e.originalHeight}},{key:"_allowRelAxisSizeFunction",value:function _allowRelAxisSizeFunction(e,t){var i=e.flexParent;return!i||!i._flex._layout.isAxisFitToContents(t)}},{key:"isZeroAxisSize",value:function isZeroAxisSize(e,t){return t?!e.originalWidth&&!e.funcW:!e.originalHeight&&!e.funcH}},{key:"getAxisLayoutPos",value:function getAxisLayoutPos(e,t){return t?e.x:e.y}},{key:"getAxisLayoutSize",value:function getAxisLayoutSize(e,t){return t?e.w:e.h}},{key:"setAxisLayoutPos",value:function setAxisLayoutPos(e,t,i){t?e.x=i:e.y=i}},{key:"setAxisLayoutSize",value:function setAxisLayoutSize(e,t,i){t?e.w=i:e.h=i}},{key:"getAxisMinSize",value:function getAxisMinSize(e,t){var i=this.getPlainAxisMinSize(e,t),r=0;return e.isFlexItemEnabled()&&(r=e._flexItem._getMinSizeSetting(t)),r>0&&(i=Math.max(i,r)),i}},{key:"getPlainAxisMinSize",value:function getPlainAxisMinSize(e,t){return e.isFlexEnabled()?e._flex._layout.getAxisMinSize(t):0!==e.flexItem.shrink?0:this.getRelAxisSize(e,t)}},{key:"resizeAxis",value:function resizeAxis(e,t,i){e.isFlexEnabled()?e._flex._horizontal===t?e._flex._layout.resizeMainAxis(i):e._flex._layout.resizeCrossAxis(i):this.setAxisLayoutSize(e,t,i)}},{key:"getPaddingOffset",value:function getPaddingOffset(e,t){if(e.isFlexEnabled()){var i=e._flex;return t?i.paddingLeft:i.paddingTop}return 0}},{key:"getTotalPadding",value:function getTotalPadding(e,t){if(e.isFlexEnabled()){var i=e._flex;return t?i.paddingRight+i.paddingLeft:i.paddingTop+i.paddingBottom}return 0}},{key:"getMarginOffset",value:function getMarginOffset(e,t){var i=e.flexItem;return i?t?i.marginLeft:i.marginTop:0}},{key:"getTotalMargin",value:function getTotalMargin(e,t){var i=e.flexItem;return i?t?i.marginRight+i.marginLeft:i.marginTop+i.marginBottom:0}}]),FlexUtils}(),o=function(){function SizeShrinker(e){_classCallCheck(this,SizeShrinker),this._line=e,this._amountRemaining=0,this._shrunkSize=0}return _createClass(SizeShrinker,[{key:"shrink",value:function shrink(e){this._shrunkSize=0,this._amountRemaining=e;var t=this._getTotalShrinkAmount();if(t){var i=this._line.items;do{for(var r=this._amountRemaining/t,n=this._line.startIndex;n<=this._line.endIndex;n++){var s=i[n].flexItem,o=s.shrink;if(o>0){var shrink=o*r,h=s._getMainAxisMinSize(),u=s._getMainAxisLayoutSize();if(u>h){var l=u-h;shrink>=l&&(shrink=l,t-=o);var _=u-shrink;if(s._resizeMainAxis(_),this._shrunkSize+=shrink,this._amountRemaining-=shrink,Math.abs(this._amountRemaining)<1e-5)return}}}}while(t&&Math.abs(this._amountRemaining)>1e-5)}}},{key:"_getTotalShrinkAmount",value:function _getTotalShrinkAmount(){for(var e=0,t=this._line.items,i=this._line.startIndex;i<=this._line.endIndex;i++){var r=t[i].flexItem;if(r.shrink){var n=r._getMainAxisMinSize();r._getMainAxisLayoutSize()>n&&(e+=r.shrink)}}return e}},{key:"getShrunkSize",value:function getShrunkSize(){return this._shrunkSize}}]),SizeShrinker}(),h=function(){function SizeGrower(e){_classCallCheck(this,SizeGrower),this._line=e,this._amountRemaining=0,this._grownSize=0}return _createClass(SizeGrower,[{key:"grow",value:function grow(e){this._grownSize=0,this._amountRemaining=e;var t=this._getTotalGrowAmount();if(t){var i=this._line.items;do{for(var r=this._amountRemaining/t,n=this._line.startIndex;n<=this._line.endIndex;n++){var s=i[n].flexItem,o=s.grow;if(o>0){var grow=o*r,h=s._getMainAxisMaxSizeSetting(),u=s._getMainAxisLayoutSize();if(h>0)if(u>=h)grow=0;else{var l=h-u;grow>=l&&(grow=l,t-=o)}if(grow>0){var _=u+grow;if(s._resizeMainAxis(_),this._grownSize+=grow,this._amountRemaining-=grow,Math.abs(this._amountRemaining)<1e-5)return}}}}while(t&&Math.abs(this._amountRemaining)>1e-5)}}},{key:"_getTotalGrowAmount",value:function _getTotalGrowAmount(){for(var e=0,t=this._line.items,i=this._line.startIndex;i<=this._line.endIndex;i++){var r=t[i].flexItem;if(r.grow){var n=r._getMainAxisMaxSizeSetting(),s=r._getMainAxisLayoutSize();(0===n||s<n)&&(e+=r.grow)}}return e}},{key:"getGrownSize",value:function getGrownSize(){return this._grownSize}}]),SizeGrower}(),u=function(){function ItemPositioner(e){_classCallCheck(this,ItemPositioner),this._line=e}return _createClass(ItemPositioner,[{key:"position",value:function position(){for(var e=this._getSpacing(),t=e.spacingBefore,i=e.spacingBetween,r=t,n=this._line.items,s=this._line.startIndex;s<=this._line.endIndex;s++){var o=n[s];o.flexItem._setMainAxisLayoutPos(r),r+=o.flexItem._getMainAxisLayoutSizeWithPaddingAndMargin(),r+=i}}},{key:"_getSpacing",value:function _getSpacing(){var e=this._line._availableSpace,t=this._layout._flexContainer.justifyContent,i=this._line.numberOfItems;return r.getSpacing(t,i,e)}},{key:"_layout",get:function get(){return this._line._layout}}]),ItemPositioner}(),l=function(){function ItemAligner(e){_classCallCheck(this,ItemAligner),this._line=e,this._crossAxisLayoutSize=0,this._crossAxisLayoutOffset=0,this._alignItemsSetting=null,this._recursiveResizeOccured=!1,this._isCrossAxisFitToContents=!1}return _createClass(ItemAligner,[{key:"setCrossAxisLayoutSize",value:function setCrossAxisLayoutSize(e){this._crossAxisLayoutSize=e}},{key:"setCrossAxisLayoutOffset",value:function setCrossAxisLayoutOffset(e){this._crossAxisLayoutOffset=e}},{key:"align",value:function align(){this._alignItemsSetting=this._flexContainer.alignItems,this._isCrossAxisFitToContents=this._layout.isAxisFitToContents(!this._flexContainer._horizontal),this._recursiveResizeOccured=!1;for(var e=this._line.items,t=this._line.startIndex;t<=this._line.endIndex;t++){var i=e[t];this._alignItem(i)}}},{key:"_alignItem",value:function _alignItem(e){var t=e.flexItem,i=t.alignSelf||this._alignItemsSetting;switch("stretch"===i&&this._preventStretch(t)&&(i="flex-start"),"stretch"===i||this._isCrossAxisFitToContents||t._hasRelCrossAxisSize()&&t._resetCrossAxisLayoutSize(),i){case"flex-start":this._alignItemFlexStart(t);break;case"flex-end":this._alignItemFlexEnd(t);break;case"center":this._alignItemFlexCenter(t);break;case"stretch":this._alignItemStretch(t)}}},{key:"_alignItemFlexStart",value:function _alignItemFlexStart(e){e._setCrossAxisLayoutPos(this._crossAxisLayoutOffset)}},{key:"_alignItemFlexEnd",value:function _alignItemFlexEnd(e){var t=e._getCrossAxisLayoutSizeWithPaddingAndMargin();e._setCrossAxisLayoutPos(this._crossAxisLayoutOffset+(this._crossAxisLayoutSize-t))}},{key:"_alignItemFlexCenter",value:function _alignItemFlexCenter(e){var t=e._getCrossAxisLayoutSizeWithPaddingAndMargin(),i=(this._crossAxisLayoutSize-t)/2;e._setCrossAxisLayoutPos(this._crossAxisLayoutOffset+i)}},{key:"_alignItemStretch",value:function _alignItemStretch(e){e._setCrossAxisLayoutPos(this._crossAxisLayoutOffset);var t=e._getMainAxisLayoutSize(),i=this._crossAxisLayoutSize-e._getCrossAxisMargin()-e._getCrossAxisPadding(),r=e._getCrossAxisMinSizeSetting();r>0&&(i=Math.max(i,r));var n=e._getCrossAxisMaxSizeSetting();n>0&&(i=Math.min(i,n)),e._resizeCrossAxis(i),e._getMainAxisLayoutSize()!==t&&(this._recursiveResizeOccured=!0)}},{key:"_preventStretch",value:function _preventStretch(e){var t=e._hasFixedCrossAxisSize(),i="stretch"===e.alignSelf;return t&&!i}},{key:"_layout",get:function get(){return this._line._layout}},{key:"_flexContainer",get:function get(){return this._layout._flexContainer}},{key:"recursiveResizeOccured",get:function get(){return this._recursiveResizeOccured}}]),ItemAligner}(),_=function(){function LineLayout(e,t,i,r){_classCallCheck(this,LineLayout),this._layout=e,this.items=e.items,this.startIndex=t,this.endIndex=i,this._availableSpace=r}return _createClass(LineLayout,[{key:"performLayout",value:function performLayout(){this._setItemSizes(),this.setItemPositions(),this._calcLayoutInfo()}},{key:"_setItemSizes",value:function _setItemSizes(){this._availableSpace>0?this._growItemSizes(this._availableSpace):this._availableSpace<0&&this._shrinkItemSizes(-this._availableSpace)}},{key:"_growItemSizes",value:function _growItemSizes(e){var t=new h(this);t.grow(e),this._availableSpace-=t.getGrownSize()}},{key:"_shrinkItemSizes",value:function _shrinkItemSizes(e){var t=new o(this);t.shrink(e),this._availableSpace+=t.getShrunkSize()}},{key:"setItemPositions",value:function setItemPositions(){new u(this).position()}},{key:"createItemAligner",value:function createItemAligner(){return new l(this)}},{key:"_calcLayoutInfo",value:function _calcLayoutInfo(){this._calcCrossAxisMaxLayoutSize()}},{key:"getMainAxisMinSize",value:function getMainAxisMinSize(){for(var e=0,t=this.startIndex;t<=this.endIndex;t++){e+=this.items[t].flexItem._getMainAxisMinSizeWithPaddingAndMargin()}return e}},{key:"_calcCrossAxisMaxLayoutSize",value:function _calcCrossAxisMaxLayoutSize(){this._crossAxisMaxLayoutSize=this._getCrossAxisMaxLayoutSize()}},{key:"_getCrossAxisMaxLayoutSize",value:function _getCrossAxisMaxLayoutSize(){for(var e=0,t=this.startIndex;t<=this.endIndex;t++){var i=this.items[t];e=Math.max(e,i.flexItem._getCrossAxisLayoutSizeWithPaddingAndMargin())}return e}},{key:"numberOfItems",get:function get(){return this.endIndex-this.startIndex+1}},{key:"crossAxisLayoutSize",get:function get(){var e=this._layout.isCrossAxisFitToContents()&&!this._layout.resizingCrossAxis;return this._layout.isWrapping()||e?this._crossAxisMaxLayoutSize:this._layout.crossAxisSize}}]),LineLayout}(),d=function(){function LineLayouter(e){_classCallCheck(this,LineLayouter),this._layout=e,this._mainAxisMinSize=-1,this._crossAxisMinSize=-1,this._mainAxisContentSize=0}return _createClass(LineLayouter,[{key:"layoutLines",value:function layoutLines(){this._setup();var e,t=this._layout.items,i=this._layout.isWrapping(),r=0,n=t.length;for(e=0;e<n;e++){var s=t[e];this._layoutFlexItem(s);var o=s.flexItem._getMainAxisLayoutSizeWithPaddingAndMargin();if(i&&e>r)this._curMainAxisPos+o>this._mainAxisSize&&(this._layoutLine(r,e-1),this._curMainAxisPos=0,r=e);this._addToMainAxisPos(o)}r<e&&this._layoutLine(r,e-1)}},{key:"_layoutFlexItem",value:function _layoutFlexItem(e){e.isFlexEnabled()?e.flexLayout.updateTreeLayout():e.flexItem._resetLayoutSize()}},{key:"_setup",value:function _setup(){this._mainAxisSize=this._layout.mainAxisSize,this._curMainAxisPos=0,this._maxMainAxisPos=0,this._lines=[],this._mainAxisMinSize=-1,this._crossAxisMinSize=-1,this._mainAxisContentSize=0}},{key:"_addToMainAxisPos",value:function _addToMainAxisPos(e){this._curMainAxisPos+=e,this._curMainAxisPos>this._maxMainAxisPos&&(this._maxMainAxisPos=this._curMainAxisPos)}},{key:"_layoutLine",value:function _layoutLine(e,t){var i=this._getAvailableMainAxisLayoutSpace(),r=new _(this._layout,e,t,i);r.performLayout(),this._lines.push(r),(0===this._mainAxisContentSize||this._curMainAxisPos>this._mainAxisContentSize)&&(this._mainAxisContentSize=this._curMainAxisPos)}},{key:"_getAvailableMainAxisLayoutSpace",value:function _getAvailableMainAxisLayoutSpace(){return!this._layout.resizingMainAxis&&this._layout.isMainAxisFitToContents()?0:this._mainAxisSize-this._curMainAxisPos}},{key:"_getCrossAxisMinSize",value:function _getCrossAxisMinSize(){for(var e=0,t=this._layout.items,i=0,r=t.length;i<r;i++){var n=t[i].flexItem._getCrossAxisMinSizeWithPaddingAndMargin();e=Math.max(e,n)}return e}},{key:"_getMainAxisMinSize",value:function _getMainAxisMinSize(){return 1===this._lines.length?this._lines[0].getMainAxisMinSize():this._layout.mainAxisSize}},{key:"lines",get:function get(){return this._lines}},{key:"mainAxisMinSize",get:function get(){return-1===this._mainAxisMinSize&&(this._mainAxisMinSize=this._getMainAxisMinSize()),this._mainAxisMinSize}},{key:"crossAxisMinSize",get:function get(){return-1===this._crossAxisMinSize&&(this._crossAxisMinSize=this._getCrossAxisMinSize()),this._crossAxisMinSize}},{key:"mainAxisContentSize",get:function get(){return this._mainAxisContentSize}}]),LineLayouter}(),f=function(){function ItemCoordinatesUpdater(e){_classCallCheck(this,ItemCoordinatesUpdater),this._layout=e,this._isReverse=this._flexContainer._reverse,this._horizontalPaddingOffset=this._layout._getHorizontalPaddingOffset(),this._verticalPaddingOffset=this._layout._getVerticalPaddingOffset()}return _createClass(ItemCoordinatesUpdater,[{key:"finalize",value:function finalize(){var e=this._layout.getParentFlexContainer();e?new ItemCoordinatesUpdater(e._layout)._finalizeItemAndChildren(this._flexContainer.item):(this._finalizeRoot(),this._finalizeItems())}},{key:"_finalizeRoot",value:function _finalizeRoot(){var e=this._flexContainer.item,t=s.getAxisLayoutPos(e,!0),i=s.getAxisLayoutPos(e,!1),r=s.getAxisLayoutSize(e,!0),n=s.getAxisLayoutSize(e,!1);r+=this._layout._getHorizontalPadding(),n+=this._layout._getVerticalPadding(),e.clearRecalcFlag(),e.setLayout(t,i,r,n)}},{key:"_finalizeItems",value:function _finalizeItems(){for(var e=this._layout.items,t=0,i=e.length;t<i;t++){var r=e[t],n=this._validateItemCache(r);this._finalizeItem(r),n||this._finalizeItemChildren(r)}}},{key:"_validateItemCache",value:function _validateItemCache(e){if(0===e.recalc&&e.isFlexEnabled()){var t=e._flex._layout;if(e.w===e.target.w&&e.h===e.target.h)return!0;var i=t.crossAxisSize;t.performResizeMainAxis(t.mainAxisSize),t.performResizeCrossAxis(i)}return!1}},{key:"_finalizeItemAndChildren",value:function _finalizeItemAndChildren(e){this._finalizeItem(e),this._finalizeItemChildren(e)}},{key:"_finalizeItem",value:function _finalizeItem(e){this._isReverse&&this._reverseMainAxisLayoutPos(e);var t=s.getAxisLayoutPos(e,!0),i=s.getAxisLayoutPos(e,!1),r=s.getAxisLayoutSize(e,!0),n=s.getAxisLayoutSize(e,!1);t+=this._horizontalPaddingOffset,i+=this._verticalPaddingOffset,e.flex&&(r+=e._flex._layout._getHorizontalPadding(),n+=e._flex._layout._getVerticalPadding());var o=e.flexItem;o&&(t+=o._getHorizontalMarginOffset(),i+=o._getVerticalMarginOffset()),e.clearRecalcFlag(),e.setLayout(t,i,r,n)}},{key:"_finalizeItemChildren",value:function _finalizeItemChildren(e){var t=e._flex;t&&new ItemCoordinatesUpdater(t._layout)._finalizeItems()}},{key:"_reverseMainAxisLayoutPos",value:function _reverseMainAxisLayoutPos(e){var t=e.flexItem._getMainAxisLayoutPos()+e.flexItem._getMainAxisLayoutSizeWithPaddingAndMargin(),i=this._layout.mainAxisSize-t;e.flexItem._setMainAxisLayoutPos(i)}},{key:"_flexContainer",get:function get(){return this._layout._flexContainer}}]),ItemCoordinatesUpdater}(),g=function(){function FlexLayout(e){_classCallCheck(this,FlexLayout),this._flexContainer=e,this._lineLayouter=new d(this),this._resizingMainAxis=!1,this._resizingCrossAxis=!1,this._cachedMainAxisSizeAfterLayout=0,this._cachedCrossAxisSizeAfterLayout=0,this._shrunk=!1}return _createClass(FlexLayout,[{key:"layoutTree",value:function layoutTree(){null!==this.item.flexParent?this._updateSubTreeLayout():this.updateTreeLayout(),this.updateItemCoords()}},{key:"updateTreeLayout",value:function updateTreeLayout(){this.recalc?this._performUpdateLayoutTree():this._performUpdateLayoutTreeFromCache()}},{key:"_performUpdateLayoutTree",value:function _performUpdateLayoutTree(){this._setInitialAxisSizes(),this._layoutAxes(),this._refreshLayoutCache()}},{key:"_refreshLayoutCache",value:function _refreshLayoutCache(){this._cachedMainAxisSizeAfterLayout=this.mainAxisSize,this._cachedCrossAxisSizeAfterLayout=this.crossAxisSize}},{key:"_performUpdateLayoutTreeFromCache",value:function _performUpdateLayoutTreeFromCache(){this.item.funcW||this.item.funcH?(this.item.enableLocalRecalcFlag(),this._performUpdateLayoutTree()):(this.mainAxisSize=this._cachedMainAxisSizeAfterLayout,this.crossAxisSize=this._cachedCrossAxisSizeAfterLayout)}},{key:"updateItemCoords",value:function updateItemCoords(){new f(this).finalize()}},{key:"_updateSubTreeLayout",value:function _updateSubTreeLayout(){var e=this.crossAxisSize;this._layoutMainAxis(),this.performResizeCrossAxis(e)}},{key:"_setInitialAxisSizes",value:function _setInitialAxisSizes(){this.item.isFlexItemEnabled()?this.item.flexItem._resetLayoutSize():(this.mainAxisSize=this._getMainAxisBasis(),this.crossAxisSize=this._getCrossAxisBasis()),this._resizingMainAxis=!1,this._resizingCrossAxis=!1,this._shrunk=!1}},{key:"_layoutAxes",value:function _layoutAxes(){this._layoutMainAxis(),this._layoutCrossAxis()}},{key:"_layoutMainAxis",value:function _layoutMainAxis(){this._layoutLines(),this._fitMainAxisSizeToContents()}},{key:"_layoutLines",value:function _layoutLines(){this._lineLayouter.layoutLines()}},{key:"_fitMainAxisSizeToContents",value:function _fitMainAxisSizeToContents(){this._resizingMainAxis||this.isMainAxisFitToContents()&&(this.mainAxisSize=this._lineLayouter.mainAxisContentSize)}},{key:"_layoutCrossAxis",value:function _layoutCrossAxis(){var e=new n(this);e.init(),this._totalCrossAxisSize=e.totalCrossAxisSize,this._fitCrossAxisSizeToContents(),e.align()}},{key:"_fitCrossAxisSizeToContents",value:function _fitCrossAxisSizeToContents(){this._resizingCrossAxis||this.isCrossAxisFitToContents()&&(this.crossAxisSize=this._totalCrossAxisSize)}},{key:"isWrapping",value:function isWrapping(){return this._flexContainer.wrap}},{key:"isAxisFitToContents",value:function isAxisFitToContents(e){return this._horizontal===e?this.isMainAxisFitToContents():this.isCrossAxisFitToContents()}},{key:"isMainAxisFitToContents",value:function isMainAxisFitToContents(){return!this.isWrapping()&&!this._hasFixedMainAxisBasis()}},{key:"isCrossAxisFitToContents",value:function isCrossAxisFitToContents(){return!this._hasFixedCrossAxisBasis()}},{key:"_hasFixedMainAxisBasis",value:function _hasFixedMainAxisBasis(){return!s.isZeroAxisSize(this.item,this._horizontal)}},{key:"_hasFixedCrossAxisBasis",value:function _hasFixedCrossAxisBasis(){return!s.isZeroAxisSize(this.item,!this._horizontal)}},{key:"getAxisMinSize",value:function getAxisMinSize(e){return this._horizontal===e?this._getMainAxisMinSize():this._getCrossAxisMinSize()}},{key:"_getMainAxisMinSize",value:function _getMainAxisMinSize(){return this._lineLayouter.mainAxisMinSize}},{key:"_getCrossAxisMinSize",value:function _getCrossAxisMinSize(){return this._lineLayouter.crossAxisMinSize}},{key:"resizeMainAxis",value:function resizeMainAxis(e){this.mainAxisSize!==e&&(this.recalc>0?this.performResizeMainAxis(e):this._checkValidCacheMainAxisResize()?(this.mainAxisSize=e,this._fitCrossAxisSizeToContents()):(this.item.enableLocalRecalcFlag(),this.performResizeMainAxis(e)))}},{key:"_checkValidCacheMainAxisResize",value:function _checkValidCacheMainAxisResize(e){return e===this.targetMainAxisSize||!this.isCrossAxisFitToContents()}},{key:"performResizeMainAxis",value:function performResizeMainAxis(e){var t=e<this.mainAxisSize;this._shrunk=t,this.mainAxisSize=e,this._resizingMainAxis=!0,this._layoutAxes(),this._resizingMainAxis=!1}},{key:"resizeCrossAxis",value:function resizeCrossAxis(e){this.crossAxisSize!==e&&(this.recalc>0?this.performResizeCrossAxis(e):this.crossAxisSize=e)}},{key:"performResizeCrossAxis",value:function performResizeCrossAxis(e){this.crossAxisSize=e,this._resizingCrossAxis=!0,this._layoutCrossAxis(),this._resizingCrossAxis=!1}},{key:"getParentFlexContainer",value:function getParentFlexContainer(){return this.item.isFlexItemEnabled()?this.item.flexItem.ctr:null}},{key:"_getHorizontalPadding",value:function _getHorizontalPadding(){return s.getTotalPadding(this.item,!0)}},{key:"_getVerticalPadding",value:function _getVerticalPadding(){return s.getTotalPadding(this.item,!1)}},{key:"_getHorizontalPaddingOffset",value:function _getHorizontalPaddingOffset(){return s.getPaddingOffset(this.item,!0)}},{key:"_getVerticalPaddingOffset",value:function _getVerticalPaddingOffset(){return s.getPaddingOffset(this.item,!1)}},{key:"_getMainAxisBasis",value:function _getMainAxisBasis(){return s.getRelAxisSize(this.item,this._horizontal)}},{key:"_getCrossAxisBasis",value:function _getCrossAxisBasis(){return s.getRelAxisSize(this.item,!this._horizontal)}},{key:"shrunk",get:function get(){return this._shrunk}},{key:"recalc",get:function get(){return this.item.recalc}},{key:"_lines",get:function get(){return this._lineLayouter.lines}},{key:"targetMainAxisSize",get:function get(){return this._horizontal?this.item.target.w:this.item.target.h}},{key:"targetCrossAxisSize",get:function get(){return this._horizontal?this.item.target.h:this.item.target.w}},{key:"_horizontal",get:function get(){return this._flexContainer._horizontal}},{key:"_reverse",get:function get(){return this._flexContainer._reverse}},{key:"item",get:function get(){return this._flexContainer.item}},{key:"items",get:function get(){return this.item.items}},{key:"resizingMainAxis",get:function get(){return this._resizingMainAxis}},{key:"resizingCrossAxis",get:function get(){return this._resizingCrossAxis}},{key:"numberOfItems",get:function get(){return this.items.length}},{key:"mainAxisSize",get:function get(){return s.getAxisLayoutSize(this.item,this._horizontal)},set:function set(e){s.setAxisLayoutSize(this.item,this._horizontal,e)}},{key:"crossAxisSize",get:function get(){return s.getAxisLayoutSize(this.item,!this._horizontal)},set:function set(e){s.setAxisLayoutSize(this.item,!this._horizontal,e)}}]),FlexLayout}(),p=function(){function FlexContainer(e){_classCallCheck(this,FlexContainer),this._item=e,this._layout=new g(this),this._horizontal=!0,this._reverse=!1,this._wrap=!1,this._alignItems="stretch",this._justifyContent="flex-start",this._alignContent="flex-start",this._paddingLeft=0,this._paddingTop=0,this._paddingRight=0,this._paddingBottom=0}return _createClass(FlexContainer,[{key:"_changedDimensions",value:function _changedDimensions(){this._item.changedDimensions()}},{key:"_changedContents",value:function _changedContents(){this._item.changedContents()}},{key:"patch",value:function patch(e){i.patchObject(this,e)}},{key:"item",get:function get(){return this._item}},{key:"direction",get:function get(){return(this._horizontal?"row":"column")+(this._reverse?"-reverse":"")},set:function set(e){this.direction!==e&&(this._horizontal="row"===e||"row-reverse"===e,this._reverse="row-reverse"===e||"column-reverse"===e,this._changedContents())}},{key:"wrap",set:function set(e){this._wrap=e,this._changedContents()},get:function get(){return this._wrap}},{key:"alignItems",get:function get(){return this._alignItems},set:function set(e){if(this._alignItems!==e){if(-1===FlexContainer.ALIGN_ITEMS.indexOf(e))throw new Error("Unknown alignItems, options: "+FlexContainer.ALIGN_ITEMS.join(","));this._alignItems=e,this._changedContents()}}},{key:"alignContent",get:function get(){return this._alignContent},set:function set(e){if(this._alignContent!==e){if(-1===FlexContainer.ALIGN_CONTENT.indexOf(e))throw new Error("Unknown alignContent, options: "+FlexContainer.ALIGN_CONTENT.join(","));this._alignContent=e,this._changedContents()}}},{key:"justifyContent",get:function get(){return this._justifyContent},set:function set(e){if(this._justifyContent!==e){if(-1===FlexContainer.JUSTIFY_CONTENT.indexOf(e))throw new Error("Unknown justifyContent, options: "+FlexContainer.JUSTIFY_CONTENT.join(","));this._justifyContent=e,this._changedContents()}}},{key:"padding",set:function set(e){this.paddingLeft=e,this.paddingTop=e,this.paddingRight=e,this.paddingBottom=e},get:function get(){return this.paddingLeft}},{key:"paddingLeft",set:function set(e){this._paddingLeft=e,this._changedDimensions()},get:function get(){return this._paddingLeft}},{key:"paddingTop",set:function set(e){this._paddingTop=e,this._changedDimensions()},get:function get(){return this._paddingTop}},{key:"paddingRight",set:function set(e){this._paddingRight=e,this._changedDimensions()},get:function get(){return this._paddingRight}},{key:"paddingBottom",set:function set(e){this._paddingBottom=e,this._changedDimensions()},get:function get(){return this._paddingBottom}}]),FlexContainer}();p.ALIGN_ITEMS=["flex-start","flex-end","center","stretch"],p.ALIGN_CONTENT=["flex-start","flex-end","center","space-between","space-around","space-evenly","stretch"],p.JUSTIFY_CONTENT=["flex-start","flex-end","center","space-between","space-around","space-evenly"];var v=function(){function FlexItem(e){_classCallCheck(this,FlexItem),this._ctr=null,this._item=e,this._grow=0,this._shrink=FlexItem.SHRINK_AUTO,this._alignSelf=void 0,this._minWidth=0,this._minHeight=0,this._maxWidth=0,this._maxHeight=0,this._marginLeft=0,this._marginTop=0,this._marginRight=0,this._marginBottom=0}return _createClass(FlexItem,[{key:"_getDefaultShrink",value:function _getDefaultShrink(){return this.item.isFlexEnabled()?1:0}},{key:"_changed",value:function _changed(){this.ctr&&this.ctr._changedContents()}},{key:"patch",value:function patch(e){i.patchObject(this,e)}},{key:"_resetLayoutSize",value:function _resetLayoutSize(){this._resetHorizontalAxisLayoutSize(),this._resetVerticalAxisLayoutSize()}},{key:"_resetCrossAxisLayoutSize",value:function _resetCrossAxisLayoutSize(){this.ctr._horizontal?this._resetVerticalAxisLayoutSize():this._resetHorizontalAxisLayoutSize()}},{key:"_resetHorizontalAxisLayoutSize",value:function _resetHorizontalAxisLayoutSize(){var e=s.getRelAxisSize(this.item,!0);this._minWidth&&(e=Math.max(this._minWidth,e)),this._maxWidth&&(e=Math.min(this._maxWidth,e)),s.setAxisLayoutSize(this.item,!0,e)}},{key:"_resetVerticalAxisLayoutSize",value:function _resetVerticalAxisLayoutSize(){var e=s.getRelAxisSize(this.item,!1);this._minHeight&&(e=Math.max(this._minHeight,e)),this._maxHeight&&(e=Math.min(this._maxHeight,e)),s.setAxisLayoutSize(this.item,!1,e)}},{key:"_getCrossAxisMinSizeSetting",value:function _getCrossAxisMinSizeSetting(){return this._getMinSizeSetting(!this.ctr._horizontal)}},{key:"_getCrossAxisMaxSizeSetting",value:function _getCrossAxisMaxSizeSetting(){return this._getMaxSizeSetting(!this.ctr._horizontal)}},{key:"_getMainAxisMaxSizeSetting",value:function _getMainAxisMaxSizeSetting(){return this._getMaxSizeSetting(this.ctr._horizontal)}},{key:"_getMinSizeSetting",value:function _getMinSizeSetting(e){return e?this._minWidth:this._minHeight}},{key:"_getMaxSizeSetting",value:function _getMaxSizeSetting(e){return e?this._maxWidth:this._maxHeight}},{key:"_getMainAxisMinSize",value:function _getMainAxisMinSize(){return s.getAxisMinSize(this.item,this.ctr._horizontal)}},{key:"_getCrossAxisMinSize",value:function _getCrossAxisMinSize(){return s.getAxisMinSize(this.item,!this.ctr._horizontal)}},{key:"_getMainAxisLayoutSize",value:function _getMainAxisLayoutSize(){return s.getAxisLayoutSize(this.item,this.ctr._horizontal)}},{key:"_getMainAxisLayoutPos",value:function _getMainAxisLayoutPos(){return s.getAxisLayoutPos(this.item,this.ctr._horizontal)}},{key:"_setMainAxisLayoutPos",value:function _setMainAxisLayoutPos(e){return s.setAxisLayoutPos(this.item,this.ctr._horizontal,e)}},{key:"_setCrossAxisLayoutPos",value:function _setCrossAxisLayoutPos(e){return s.setAxisLayoutPos(this.item,!this.ctr._horizontal,e)}},{key:"_getCrossAxisLayoutSize",value:function _getCrossAxisLayoutSize(){return s.getAxisLayoutSize(this.item,!this.ctr._horizontal)}},{key:"_resizeCrossAxis",value:function _resizeCrossAxis(e){return s.resizeAxis(this.item,!this.ctr._horizontal,e)}},{key:"_resizeMainAxis",value:function _resizeMainAxis(e){return s.resizeAxis(this.item,this.ctr._horizontal,e)}},{key:"_getMainAxisPadding",value:function _getMainAxisPadding(){return s.getTotalPadding(this.item,this.ctr._horizontal)}},{key:"_getCrossAxisPadding",value:function _getCrossAxisPadding(){return s.getTotalPadding(this.item,!this.ctr._horizontal)}},{key:"_getMainAxisMargin",value:function _getMainAxisMargin(){return s.getTotalMargin(this.item,this.ctr._horizontal)}},{key:"_getCrossAxisMargin",value:function _getCrossAxisMargin(){return s.getTotalMargin(this.item,!this.ctr._horizontal)}},{key:"_getHorizontalMarginOffset",value:function _getHorizontalMarginOffset(){return s.getMarginOffset(this.item,!0)}},{key:"_getVerticalMarginOffset",value:function _getVerticalMarginOffset(){return s.getMarginOffset(this.item,!1)}},{key:"_getMainAxisMinSizeWithPaddingAndMargin",value:function _getMainAxisMinSizeWithPaddingAndMargin(){return this._getMainAxisMinSize()+this._getMainAxisPadding()+this._getMainAxisMargin()}},{key:"_getCrossAxisMinSizeWithPaddingAndMargin",value:function _getCrossAxisMinSizeWithPaddingAndMargin(){return this._getCrossAxisMinSize()+this._getCrossAxisPadding()+this._getCrossAxisMargin()}},{key:"_getMainAxisLayoutSizeWithPaddingAndMargin",value:function _getMainAxisLayoutSizeWithPaddingAndMargin(){return this._getMainAxisLayoutSize()+this._getMainAxisPadding()+this._getMainAxisMargin()}},{key:"_getCrossAxisLayoutSizeWithPaddingAndMargin",value:function _getCrossAxisLayoutSizeWithPaddingAndMargin(){return this._getCrossAxisLayoutSize()+this._getCrossAxisPadding()+this._getCrossAxisMargin()}},{key:"_hasFixedCrossAxisSize",value:function _hasFixedCrossAxisSize(){return!s.isZeroAxisSize(this.item,!this.ctr._horizontal)}},{key:"_hasRelCrossAxisSize",value:function _hasRelCrossAxisSize(){return!!(this.ctr._horizontal?this.item.funcH:this.item.funcW)}},{key:"item",get:function get(){return this._item}},{key:"grow",get:function get(){return this._grow},set:function set(e){this._grow!==e&&(this._grow=parseInt(e)||0,this._changed())}},{key:"shrink",get:function get(){return this._shrink===FlexItem.SHRINK_AUTO?this._getDefaultShrink():this._shrink},set:function set(e){this._shrink!==e&&(this._shrink=parseInt(e)||0,this._changed())}},{key:"alignSelf",get:function get(){return this._alignSelf},set:function set(e){if(this._alignSelf!==e){if(void 0===e)this._alignSelf=void 0;else{if(-1===p.ALIGN_ITEMS.indexOf(e))throw new Error("Unknown alignSelf, options: "+p.ALIGN_ITEMS.join(","));this._alignSelf=e}this._changed()}}},{key:"minWidth",get:function get(){return this._minWidth},set:function set(e){this._minWidth=Math.max(0,e),this._item.changedDimensions(!0,!1)}},{key:"minHeight",get:function get(){return this._minHeight},set:function set(e){this._minHeight=Math.max(0,e),this._item.changedDimensions(!1,!0)}},{key:"maxWidth",get:function get(){return this._maxWidth},set:function set(e){this._maxWidth=Math.max(0,e),this._item.changedDimensions(!0,!1)}},{key:"maxHeight",get:function get(){return this._maxHeight},set:function set(e){this._maxHeight=Math.max(0,e),this._item.changedDimensions(!1,!0)}},{key:"margin",set:function set(e){this.marginLeft=e,this.marginTop=e,this.marginRight=e,this.marginBottom=e},get:function get(){return this.marginLeft}},{key:"marginLeft",set:function set(e){this._marginLeft=e,this._changed()},get:function get(){return this._marginLeft}},{key:"marginTop",set:function set(e){this._marginTop=e,this._changed()},get:function get(){return this._marginTop}},{key:"marginRight",set:function set(e){this._marginRight=e,this._changed()},get:function get(){return this._marginRight}},{key:"marginBottom",set:function set(e){this._marginBottom=e,this._changed()},get:function get(){return this._marginBottom}},{key:"ctr",set:function set(e){this._ctr=e},get:function get(){return this._ctr}}]),FlexItem}();v.SHRINK_AUTO=-1;var y=function(){function FlexTarget(e){_classCallCheck(this,FlexTarget),this._target=e,this._recalc=0,this._enabled=!1,this.x=0,this.y=0,this.w=0,this.h=0,this._originalX=0,this._originalY=0,this._originalWidth=0,this._originalHeight=0,this._flex=null,this._flexItem=null,this._flexItemDisabled=!1,this._items=null}return _createClass(FlexTarget,[{key:"layoutFlexTree",value:function layoutFlexTree(){this.isFlexEnabled()&&this.isChanged()&&this.flexLayout.layoutTree()}},{key:"_enableFlex",value:function _enableFlex(){this._flex=new p(this),this._checkEnabled(),this.changedDimensions(),this._enableChildrenAsFlexItems()}},{key:"_disableFlex",value:function _disableFlex(){this.changedDimensions(),this._flex=null,this._checkEnabled(),this._disableChildrenAsFlexItems()}},{key:"_enableChildrenAsFlexItems",value:function _enableChildrenAsFlexItems(){var e=this._target._children;if(e)for(var t=0,i=e.length;t<i;t++){e[t].layout._enableFlexItem()}}},{key:"_disableChildrenAsFlexItems",value:function _disableChildrenAsFlexItems(){var e=this._target._children;if(e)for(var t=0,i=e.length;t<i;t++){e[t].layout._disableFlexItem()}}},{key:"_enableFlexItem",value:function _enableFlexItem(){this._ensureFlexItem();var e=this._target._parent._layout;this._flexItem.ctr=e._flex,e.changedContents(),this._checkEnabled()}},{key:"_disableFlexItem",value:function _disableFlexItem(){this._flexItem&&(this._flexItem.ctr=null),this._checkEnabled(),this._resetOffsets()}},{key:"_resetOffsets",value:function _resetOffsets(){this.x=0,this.y=0}},{key:"_ensureFlexItem",value:function _ensureFlexItem(){this._flexItem||(this._flexItem=new v(this))}},{key:"_checkEnabled",value:function _checkEnabled(){var e=this.isEnabled();this._enabled!==e&&(e?this._enable():this._disable(),this._enabled=e)}},{key:"_enable",value:function _enable(){this._setupTargetForFlex(),this._target.enableFlexLayout()}},{key:"_disable",value:function _disable(){this._restoreTargetToNonFlex(),this._target.disableFlexLayout()}},{key:"isEnabled",value:function isEnabled(){return this.isFlexEnabled()||this.isFlexItemEnabled()}},{key:"isFlexEnabled",value:function isFlexEnabled(){return null!==this._flex}},{key:"isFlexItemEnabled",value:function isFlexItemEnabled(){return null!==this.flexParent}},{key:"_restoreTargetToNonFlex",value:function _restoreTargetToNonFlex(){var e=this._target;e.x=this._originalX,e.y=this._originalY,e.setDimensions(this._originalWidth,this._originalHeight)}},{key:"_setupTargetForFlex",value:function _setupTargetForFlex(){var e=this._target;this._originalX=e._x,this._originalY=e._y,this._originalWidth=e._w,this._originalHeight=e._h}},{key:"setParent",value:function setParent(e,t){e&&e.isFlexContainer()&&e._layout._changedChildren(),t&&t.isFlexContainer()&&(this._enableFlexItem(),t._layout._changedChildren()),this._checkEnabled()}},{key:"setVisible",value:function setVisible(e){var t=this.flexParent;t&&t._changedChildren()}},{key:"_getFlexItems",value:function _getFlexItems(){var e=[],t=this._target._children;if(t)for(var i=0,r=t.length;i<r;i++){var n=t[i];n.visible&&n.isFlexItem()&&e.push(n.layout)}return e}},{key:"_changedChildren",value:function _changedChildren(){this._clearFlexItemsCache(),this.changedContents()}},{key:"_clearFlexItemsCache",value:function _clearFlexItemsCache(){this._items=null}},{key:"setLayout",value:function setLayout(e,t,i,r){var n=this._originalX,o=this._originalY;this.funcX&&(n=this.funcX(s.getParentAxisSizeWithPadding(this,!0))),this.funcY&&(o=this.funcY(s.getParentAxisSizeWithPadding(this,!1))),this.isFlexItemEnabled()?this.target.setLayout(e+n,t+o,i,r):this.target.setLayout(n,o,i,r)}},{key:"changedDimensions",value:function changedDimensions(){var e=!(arguments.length>0&&void 0!==arguments[0])||arguments[0],t=!(arguments.length>1&&void 0!==arguments[1])||arguments[1];this._updateRecalc(e,t)}},{key:"changedContents",value:function changedContents(){this._updateRecalc()}},{key:"forceLayout",value:function forceLayout(){this._updateRecalc()}},{key:"isChanged",value:function isChanged(){return this._recalc>0}},{key:"_updateRecalc",value:function _updateRecalc(){var e=arguments.length>0&&void 0!==arguments[0]&&arguments[0],t=arguments.length>1&&void 0!==arguments[1]&&arguments[1];if(this.isFlexEnabled()){var i=this._flex._layout;e=e||i.isAxisFitToContents(!0),t=t||i.isAxisFitToContents(!1)}var r=1+(e?2:0)+(t?4:0),n=this.getNewRecalcFlags(r);this._recalc|=r,n>1&&this.flexParent?this.flexParent._updateRecalcBottomUp(r):this._target.triggerLayout()}},{key:"getNewRecalcFlags",value:function getNewRecalcFlags(e){return 7-this._recalc&e}},{key:"_updateRecalcBottomUp",value:function _updateRecalcBottomUp(e){var t=this._getRecalcFromChangedChildRecalc(e),i=this.getNewRecalcFlags(t);if(this._recalc|=t,i>1){var r=this.flexParent;r?r._updateRecalcBottomUp(t):this._target.triggerLayout()}else this._target.triggerLayout()}},{key:"_getRecalcFromChangedChildRecalc",value:function _getRecalcFromChangedChildRecalc(e){var t=this._flex._layout,i=t._horizontal?1:2,r=t._horizontal?2:1;e&r||e&i&&t.isWrapping()&&t.isCrossAxisFitToContents()&&(e+=r);var n=t.isAxisFitToContents(!0),s=t.isAxisFitToContents(!1);return t.shrunk&&(t._horizontal?n=!0:s=!0),e&1+(n?2:0)+(s?4:0)}},{key:"clearRecalcFlag",value:function clearRecalcFlag(){this._recalc=0}},{key:"enableLocalRecalcFlag",value:function enableLocalRecalcFlag(){this._recalc=1}},{key:"setOriginalXWithoutUpdatingLayout",value:function setOriginalXWithoutUpdatingLayout(e){this._originalX=e}},{key:"setOriginalYWithoutUpdatingLayout",value:function setOriginalYWithoutUpdatingLayout(e){this._originalY=e}},{key:"flexLayout",get:function get(){return this.flex?this.flex._layout:null}},{key:"target",get:function get(){return this._target}},{key:"flex",get:function get(){return this._flex},set:function set(e){e?(this.isFlexEnabled()||this._enableFlex(),this._flex.patch(e)):this.isFlexEnabled()&&this._disableFlex()}},{key:"flexItem",get:function get(){return!this._flexItemDisabled&&(this._ensureFlexItem(),this._flexItem)},set:function set(e){if(!1===e){if(!this._flexItemDisabled){var t=this.flexParent;this._flexItemDisabled=!0,this._checkEnabled(),t&&(t._clearFlexItemsCache(),t.changedContents())}}else if(this._ensureFlexItem(),this._flexItem.patch(e),this._flexItemDisabled){this._flexItemDisabled=!1,this._checkEnabled();var i=this.flexParent;i&&(i._clearFlexItemsCache(),i.changedContents())}}},{key:"flexParent",get:function get(){if(this._flexItemDisabled)return null;var e=this._target._parent;return e&&e.isFlexContainer()?e._layout:null}},{key:"items",get:function get(){return this._items||(this._items=this._getFlexItems()),this._items}},{key:"recalc",get:function get(){return this._recalc}},{key:"originalX",get:function get(){return this._originalX}},{key:"originalY",get:function get(){return this._originalY}},{key:"originalWidth",get:function get(){return this._originalWidth},set:function set(e){this._originalWidth!==e&&(this._originalWidth=e,this.changedDimensions(!0,!1))}},{key:"originalHeight",get:function get(){return this._originalHeight},set:function set(e){this._originalHeight!==e&&(this._originalHeight=e,this.changedDimensions(!1,!0))}},{key:"funcX",get:function get(){return this._target.funcX}},{key:"funcY",get:function get(){return this._target.funcY}},{key:"funcW",get:function get(){return this._target.funcW}},{key:"funcH",get:function get(){return this._target.funcH}}]),FlexTarget}(),x=function(){function TextureSource(e){var t=arguments.length>1&&void 0!==arguments[1]?arguments[1]:null;_classCallCheck(this,TextureSource),this.id=TextureSource.id++,this.manager=e,this.stage=e.stage,this.textures=new Set,this._activeTextureCount=0,this.loader=t,this.lookupId=null,this._cancelCb=null,this.loadingSince=0,this.w=0,this.h=0,this._nativeTexture=null,this.permanent=!1,this.renderInfo=null,this._isResultTexture=!this.loader,this._loadError=null,this._imageRef=null}return _createClass(TextureSource,[{key:"addTexture",value:function addTexture(e){this.textures.has(e)||this.textures.add(e)}},{key:"removeTexture",value:function removeTexture(e){this.textures.delete(e)}},{key:"incActiveTextureCount",value:function incActiveTextureCount(){this._activeTextureCount++,1===this._activeTextureCount&&this.becomesUsed()}},{key:"decActiveTextureCount",value:function decActiveTextureCount(){this._activeTextureCount--,0===this._activeTextureCount&&this.becomesUnused()}},{key:"forEachEnabledElement",value:function forEachEnabledElement(e){var t=this;this.textures.forEach(function(i){_newArrowCheck(this,t),i.elements.forEach(e)}.bind(this))}},{key:"hasEnabledElements",value:function hasEnabledElements(){return this.textures.size>0}},{key:"forEachActiveElement",value:function forEachActiveElement(e){var t=this;this.textures.forEach(function(i){var r=this;_newArrowCheck(this,t),i.elements.forEach(function(t){_newArrowCheck(this,r),t.active&&e(t)}.bind(this))}.bind(this))}},{key:"getRenderWidth",value:function getRenderWidth(){return this.w}},{key:"getRenderHeight",value:function getRenderHeight(){return this.h}},{key:"allowCleanup",value:function allowCleanup(){return!this.permanent&&!this.isUsed()}},{key:"becomesUsed",value:function becomesUsed(){this.load()}},{key:"becomesUnused",value:function becomesUnused(){this.cancel()}},{key:"cancel",value:function cancel(){this.isLoading()&&(this._cancelCb&&(this._cancelCb(this),this._cancelCb=null),this.loadingSince=0)}},{key:"isLoaded",value:function isLoaded(){return!!this._nativeTexture}},{key:"isLoading",value:function isLoading(){return this.loadingSince>0}},{key:"isError",value:function isError(){return!!this._loadError}},{key:"reload",value:function reload(){this.free(),this.isUsed()&&this.load()}},{key:"load",value:function load(){var e=this,t=arguments.length>0&&void 0!==arguments[0]&&arguments[0];this.isResultTexture||this._nativeTexture||this.isLoading()||(this.loadingSince=(new Date).getTime(),this._cancelCb=this.loader(function(i,r){if(_newArrowCheck(this,e),this.isLoading()){if(this._cancelCb=null,this.manager.stage.destroyed)return;if(i)this.onError(i);else if(r&&r.source)if(this.stage.isUpdatingFrame()||t||!1===r.throttle)this.processLoadedSource(r);else{var n=this.stage.textureThrottler;this._cancelCb=n.genericCancelCb,n.add(this,r)}}}.bind(this),this))}},{key:"processLoadedSource",value:function processLoadedSource(e){this.loadingSince=0,this.setSource(e)}},{key:"setSource",value:function setSource(e){var t=e.source;this.w=t.width||e&&e.w||0,this.h=t.height||e&&e.h||0,e&&e.renderInfo&&(this.renderInfo=e.renderInfo),this.permanent=!!e.permanent,e&&e.imageRef&&(this._imageRef=e.imageRef),e&&e.flipTextureY?this._flipTextureY=e.flipTextureY:this._flipTextureY=!1,this._isNativeTexture(t)?(this._nativeTexture=t,this.w=this.w||t.w,this.h=this.h||t.h,this.permanent=!e.hasOwnProperty("permanent")||e.permanent):this.manager.uploadTextureSource(this,e),this._loadError=null,this.onLoad()}},{key:"isUsed",value:function isUsed(){return this._activeTextureCount>0}},{key:"onLoad",value:function onLoad(){var e=this;this.isUsed()&&this.textures.forEach(function(t){_newArrowCheck(this,e),t.onLoad()}.bind(this))}},{key:"forceRenderUpdate",value:function forceRenderUpdate(){this._nativeTexture&&(this._nativeTexture.update=this.stage.frameCounter),this.forEachActiveElement((function(e){e.forceRenderUpdate()}))}},{key:"forceUpdateRenderCoords",value:function forceUpdateRenderCoords(){this.forEachActiveElement((function(e){e._updateTextureCoords()}))}},{key:"clearNativeTexture",value:function clearNativeTexture(){this._nativeTexture=null,this._imageRef=null}},{key:"replaceNativeTexture",value:function replaceNativeTexture(e,t,i){var r=this,n=this._nativeTexture;this._nativeTexture=e,this.w=t,this.h=i,!n&&this._nativeTexture&&this.forEachActiveElement(function(e){return _newArrowCheck(this,r),e.onTextureSourceLoaded()}.bind(this)),this._nativeTexture||this.forEachActiveElement(function(e){return _newArrowCheck(this,r),e._setDisplayedTexture(null)}.bind(this)),this.forEachEnabledElement(function(e){return _newArrowCheck(this,r),e._updateDimensions()}.bind(this))}},{key:"onError",value:function onError(e){var t=this;this._loadError=e,this.loadingSince=0,console.error("texture load error",e,this.lookupId),this.forEachActiveElement(function(i){return _newArrowCheck(this,t),i.onTextureSourceLoadError(e)}.bind(this))}},{key:"free",value:function free(){this.isLoaded()&&this.manager.freeTextureSource(this)}},{key:"_isNativeTexture",value:function _isNativeTexture(e){return t.isNode?"WebGLTexture"===e.constructor.name:"WebGLTexture"in window&&e instanceof WebGLTexture}},{key:"loadError",get:function get(){return this._loadError}},{key:"isResultTexture",get:function get(){return this._isResultTexture},set:function set(e){this._isResultTexture=e}},{key:"nativeTexture",get:function get(){return this._nativeTexture}}]),TextureSource}();x.prototype.isTextureSource=!0,x.id=1;var m=function(){function ElementTexturizer(e){_classCallCheck(this,ElementTexturizer),this._element=e.element,this._core=e,this.ctx=this._core.ctx,this._enabled=!1,this.lazy=!1,this._colorize=!1,this._renderTexture=null,this._renderTextureReused=!1,this._resultTextureSource=null,this._renderOffscreen=!1,this.empty=!1}return _createClass(ElementTexturizer,[{key:"_getTextureSource",value:function _getTextureSource(){return this._resultTextureSource||(this._resultTextureSource=new x(this._element.stage.textureManager),this.updateResultTexture()),this._resultTextureSource}},{key:"hasResultTexture",value:function hasResultTexture(){return!!this._resultTextureSource}},{key:"resultTextureInUse",value:function resultTextureInUse(){return this._resultTextureSource&&this._resultTextureSource.hasEnabledElements()}},{key:"updateResultTexture",value:function updateResultTexture(){var e=this,t=this.getResultTexture();if(this._resultTextureSource){if(this._resultTextureSource.nativeTexture!==t){var i=t?t.w:0,r=t?t.h:0;this._resultTextureSource.replaceNativeTexture(t,i,r)}this._resultTextureSource.forEachEnabledElement(function(t){_newArrowCheck(this,e),t._updateDimensions(),t.core.setHasRenderUpdates(3)}.bind(this))}}},{key:"mustRenderToTexture",value:function mustRenderToTexture(){return!(!this._enabled||this.lazy)||!!(this._enabled&&this.lazy&&this._core._hasRenderUpdates<3)}},{key:"deactivate",value:function deactivate(){this.release()}},{key:"release",value:function release(){this.releaseRenderTexture()}},{key:"releaseRenderTexture",value:function releaseRenderTexture(){this._renderTexture&&(this._renderTextureReused||this.ctx.releaseRenderTexture(this._renderTexture),this._renderTexture=null,this._renderTextureReused=!1,this.updateResultTexture())}},{key:"reuseTextureAsRenderTexture",value:function reuseTextureAsRenderTexture(e){this._renderTexture!==e&&(this.releaseRenderTexture(),this._renderTexture=e,this._renderTextureReused=!0)}},{key:"hasRenderTexture",value:function hasRenderTexture(){return!!this._renderTexture}},{key:"getRenderTexture",value:function getRenderTexture(){return this._renderTexture||(this._renderTexture=this.ctx.allocateRenderTexture(this._core._w,this._core._h),this._renderTextureReused=!1),this._renderTexture}},{key:"getResultTexture",value:function getResultTexture(){return this._renderTexture}},{key:"enabled",get:function get(){return this._enabled},set:function set(e){this._enabled=e,this._core.updateRenderToTextureEnabled()}},{key:"renderOffscreen",get:function get(){return this._renderOffscreen},set:function set(e){this._renderOffscreen=e,this._core.setHasRenderUpdates(1),this._core._setRecalc(6)}},{key:"colorize",get:function get(){return this._colorize},set:function set(e){this._colorize!==e&&(this._colorize=e,this._core.setHasRenderUpdates(1))}},{key:"renderTextureReused",get:function get(){return this._renderTextureReused}}]),ElementTexturizer}(),k=function(){function ElementCore(e){_classCallCheck(this,ElementCore),this._element=e,this.ctx=e.stage.ctx,this._recalc=0,this._parent=null,this._onUpdate=null,this._pRecalc=0,this._worldContext=new S,this._hasUpdates=!1,this._localAlpha=1,this._onAfterCalcs=null,this._onAfterUpdate=null,this._localPx=0,this._localPy=0,this._localTa=1,this._localTb=0,this._localTc=0,this._localTd=1,this._isComplex=!1,this._dimsUnknown=!1,this._clipping=!1,this._zSort=!1,this._outOfBounds=0,this._displayedTextureSource=null,this._zContextUsage=0,this._children=null,this._hasRenderUpdates=0,this._zIndexedChildren=null,this._renderContext=this._worldContext,this.renderState=this.ctx.renderState,this._scissor=null,this._shaderOwner=null,this._updateTreeOrder=0,this._colorUl=this._colorUr=this._colorBl=this._colorBr=4294967295,this._x=0,this._y=0,this._w=0,this._h=0,this._optFlags=0,this._funcX=null,this._funcY=null,this._funcW=null,this._funcH=null,this._scaleX=1,this._scaleY=1,this._pivotX=.5,this._pivotY=.5,this._mountX=0,this._mountY=0,this._rotation=0,this._alpha=1,this._visible=!0,this._ulx=0,this._uly=0,this._brx=1,this._bry=1,this._zIndex=0,this._forceZIndexContext=!1,this._zParent=null,this._isRoot=!1,this._zIndexResort=!1,this._shader=null,this._renderToTextureEnabled=!1,this._texturizer=null,this._useRenderToTexture=!1,this._boundsMargin=null,this._recBoundsMargin=null,this._withinBoundsMargin=!1,this._viewport=null,this._clipbox=!0,this.render=this._renderSimple,this._layout=null}return _createClass(ElementCore,[{key:"_disableFuncX",value:function _disableFuncX(){this._optFlags=65534&this._optFlags,this._funcX=null}},{key:"_disableFuncY",value:function _disableFuncY(){this._optFlags=65533&this._optFlags,this._funcY=null}},{key:"disableFuncW",value:function disableFuncW(){this._optFlags=65531&this._optFlags,this._funcW=null}},{key:"disableFuncH",value:function disableFuncH(){this._optFlags=65527&this._optFlags,this._funcH=null}},{key:"getRenderWidth",value:function getRenderWidth(){return this.hasFlexLayout()?this._layout.originalWidth:this._w}},{key:"getRenderHeight",value:function getRenderHeight(){return this.hasFlexLayout()?this._layout.originalHeight:this._h}},{key:"_updateLocalTransform",value:function _updateLocalTransform(){if(0!==this._rotation&&this._rotation%(2*Math.PI)){var e=Math.sin(this._rotation),t=Math.cos(this._rotation);this._setLocalTransform(t*this._scaleX,-e*this._scaleY,e*this._scaleX,t*this._scaleY)}else this._setLocalTransform(this._scaleX,0,0,this._scaleY);this._updateLocalTranslate()}},{key:"_updateLocalTranslate",value:function _updateLocalTranslate(){this._recalcLocalTranslate(),this._triggerRecalcTranslate()}},{key:"_recalcLocalTranslate",value:function _recalcLocalTranslate(){var e=this._pivotX*this._w,t=this._pivotY*this._h,i=this._x-(e*this._localTa+t*this._localTb)+e,r=this._y-(e*this._localTc+t*this._localTd)+t;i-=this._mountX*this._w,r-=this._mountY*this._h,this._localPx=i,this._localPy=r}},{key:"_updateLocalTranslateDelta",value:function _updateLocalTranslateDelta(e,t){this._addLocalTranslate(e,t)}},{key:"_updateLocalAlpha",value:function _updateLocalAlpha(){this._setLocalAlpha(this._visible?this._alpha:0)}},{key:"setHasRenderUpdates",value:function setHasRenderUpdates(e){if(this._worldContext.alpha){var t=this;for(t._hasRenderUpdates=Math.max(e,t._hasRenderUpdates);(t=t._parent)&&3!==t._hasRenderUpdates;)t._hasRenderUpdates=3}}},{key:"_setRecalc",value:function _setRecalc(e){this._recalc|=e,this._setHasUpdates(),this._parent&&this._parent.setHasRenderUpdates(3)}},{key:"_setHasUpdates",value:function _setHasUpdates(){for(var e=this;e&&!e._hasUpdates;)e._hasUpdates=!0,e=e._parent}},{key:"getParent",value:function getParent(){return this._parent}},{key:"setParent",value:function setParent(e){if(e!==this._parent){var t=this.isZContext(),i=this._parent;if(this._parent=e,(this._layout||e&&e.isFlexContainer())&&this.layout.setParent(i,e),i&&i.setHasRenderUpdates(3),this._setRecalc(7),this._parent&&this._parent._setHasUpdates(),0===this._zIndex?this.setZParent(e):this.setZParent(e?e.findZContext():null),t!==this.isZContext()&&(this.isZContext()?this.enableZContext(i.findZContext()):this.disableZContext()),this._zIndexResort=!0,this._zParent&&this._zParent.enableZSort(),!this._shader){var r=e&&!e._renderToTextureEnabled?e._shaderOwner:null;r!==this._shaderOwner&&(this.setHasRenderUpdates(1),this._setShaderOwnerRecursive(r))}}}},{key:"enableZSort",value:function enableZSort(){var e=arguments.length>0&&void 0!==arguments[0]&&arguments[0];!this._zSort&&this._zContextUsage>0&&(this._zSort=!0,e&&this.ctx.forceZSort(this))}},{key:"addChildAt",value:function addChildAt(e,t){this._children||(this._children=[]),this._children.splice(e,0,t),t.setParent(this)}},{key:"setChildAt",value:function setChildAt(e,t){this._children||(this._children=[]),this._children[e].setParent(null),this._children[e]=t,t.setParent(this)}},{key:"removeChildAt",value:function removeChildAt(e){var t=this._children[e];this._children.splice(e,1),t.setParent(null)}},{key:"removeChildren",value:function removeChildren(){if(this._children){for(var e=0,t=this._children.length;e<t;e++)this._children[e].setParent(null);this._children.splice(0),this._zIndexedChildren&&this._zIndexedChildren.splice(0)}}},{key:"syncChildren",value:function syncChildren(e,t,i){this._children=i;for(var r=0,n=e.length;r<n;r++)e[r].setParent(null);for(var s=0,o=t.length;s<o;s++)t[s].setParent(this)}},{key:"moveChild",value:function moveChild(e,t){var i=this._children[e];this._children.splice(e,1),this._children.splice(t,0,i),this._zIndexResort=!0,this._zParent&&this._zParent.enableZSort()}},{key:"_setLocalTransform",value:function _setLocalTransform(e,t,i,r){this._setRecalc(4),this._localTa=e,this._localTb=t,this._localTc=i,this._localTd=r,this._isComplex=0!==t||0!==i||e<0||r<0}},{key:"_addLocalTranslate",value:function _addLocalTranslate(e,t){this._localPx+=e,this._localPy+=t,this._triggerRecalcTranslate()}},{key:"_setLocalAlpha",value:function _setLocalAlpha(e){!this._worldContext.alpha&&this._parent&&this._parent._worldContext.alpha&&e?this._setRecalc(129):this._setRecalc(1),e<1e-14&&(e=0),this._localAlpha=e}},{key:"setDimensions",value:function setDimensions(e,t){var i=arguments.length>2&&void 0!==arguments[2]?arguments[2]:this._dimsUnknown;if(this._dimsUnknown=i,this.hasFlexLayout())this._layout.originalWidth=e,this._layout.originalHeight=t;else if(this._w!==e||this._h!==t)return this._updateDimensions(e,t),!0;return!1}},{key:"_updateDimensions",value:function _updateDimensions(e,t){this._w===e&&this._h===t||(this._w=e,this._h=t,this._triggerRecalcTranslate(),this._texturizer&&(this._texturizer.releaseRenderTexture(),this._texturizer.updateResultTexture()),this._updateLocalTranslate())}},{key:"setTextureCoords",value:function setTextureCoords(e,t,i,r){this.setHasRenderUpdates(3),this._ulx=e,this._uly=t,this._brx=i,this._bry=r}},{key:"setDisplayedTextureSource",value:function setDisplayedTextureSource(e){this.setHasRenderUpdates(3),this._displayedTextureSource=e}},{key:"setAsRoot",value:function setAsRoot(){this._parent=new ElementCore(this._element),this._parent._hasRenderUpdates=3,this._parent._hasUpdates=!0,this._isRoot=!0,this.ctx.root=this,this._parent._viewport=[0,0,this.ctx.stage.coordsWidth,this.ctx.stage.coordsHeight],this._parent._scissor=this._parent._viewport,this._parent._recBoundsMargin=null,this._setRecalc(7)}},{key:"isAncestorOf",value:function isAncestorOf(e){for(var t=e;t=t._parent;)if(this===t)return!0;return!1}},{key:"isZContext",value:function isZContext(){return this._forceZIndexContext||this._renderToTextureEnabled||0!==this._zIndex||this._isRoot||!this._parent}},{key:"findZContext",value:function findZContext(){return this.isZContext()?this:this._parent.findZContext()}},{key:"setZParent",value:function setZParent(e){if(this._zParent!==e){if(null!==this._zParent&&(0!==this._zIndex&&this._zParent.decZContextUsage(),this._zParent.enableZSort()),null!==e){var t=e._zContextUsage>0;0!==this._zIndex&&e.incZContextUsage(),e._zContextUsage>0&&((t||this._parent!==e)&&e._zIndexedChildren.push(this),e.enableZSort())}this._zParent=e,this._zIndexResort=!0}}},{key:"incZContextUsage",value:function incZContextUsage(){if(this._zContextUsage++,1===this._zContextUsage&&(this._zIndexedChildren||(this._zIndexedChildren=[]),this._children)){for(var e=0,t=this._children.length;e<t;e++)this._zIndexedChildren.push(this._children[e]);this._zSort=!1}}},{key:"decZContextUsage",value:function decZContextUsage(){this._zContextUsage--,0===this._zContextUsage&&(this._zSort=!1,this._zIndexedChildren.splice(0))}},{key:"enableZContext",value:function enableZContext(e){var t=this;e&&e._zContextUsage>0&&this._getZIndexedDescs().forEach(function(e){_newArrowCheck(this,t),this.isAncestorOf(e)&&0!==e._zIndex&&e.setZParent(this)}.bind(this))}},{key:"_getZIndexedDescs",value:function _getZIndexedDescs(){var e=[];if(this._children)for(var t=0,i=this._children.length;t<i;t++)this._children[t]._getZIndexedDescsRec(e);return e}},{key:"_getZIndexedDescsRec",value:function _getZIndexedDescsRec(e){if(this._zIndex)e.push(this);else if(this._children&&!this.isZContext())for(var t=0,i=this._children.length;t<i;t++)this._children[t]._getZIndexedDescsRec(e)}},{key:"disableZContext",value:function disableZContext(){if(this._zContextUsage>0){var e=this._parent.findZContext();this._zSort&&this.sortZIndexedChildren(),this._zIndexedChildren.slice().forEach((function(t){0!==t._zIndex&&t.setZParent(e)}))}}},{key:"_setShaderOwnerRecursive",value:function _setShaderOwnerRecursive(e){if(this._shaderOwner=e,this._children&&!this._renderToTextureEnabled)for(var t=0,i=this._children.length;t<i;t++){var r=this._children[t];r._shader||(r._setShaderOwnerRecursive(e),r._hasRenderUpdates=3)}}},{key:"_setShaderOwnerChildrenRecursive",value:function _setShaderOwnerChildrenRecursive(e){if(this._children)for(var t=0,i=this._children.length;t<i;t++){var r=this._children[t];r._shader||(r._setShaderOwnerRecursive(e),r._hasRenderUpdates=3)}}},{key:"_hasRenderContext",value:function _hasRenderContext(){return this._renderContext!==this._worldContext}},{key:"updateRenderToTextureEnabled",value:function updateRenderToTextureEnabled(){this.texturizer._enabled?this._enableRenderToTexture():(this._disableRenderToTexture(),this._texturizer.releaseRenderTexture())}},{key:"_enableRenderToTexture",value:function _enableRenderToTexture(){if(!this._renderToTextureEnabled){var e=this.isZContext();this._renderToTextureEnabled=!0,this._renderContext=new S,this._setShaderOwnerChildrenRecursive(null),e||this.enableZContext(this._parent?this._parent.findZContext():null),this.setHasRenderUpdates(3),this._setRecalc(7),this.render=this._renderAdvanced}}},{key:"_disableRenderToTexture",value:function _disableRenderToTexture(){this._renderToTextureEnabled&&(this._renderToTextureEnabled=!1,this._setShaderOwnerChildrenRecursive(this._shaderOwner),this._renderContext=this._worldContext,this.isZContext()||this.disableZContext(),this._setRecalc(7),this.setHasRenderUpdates(3),this.render=this._renderSimple)}},{key:"isWhite",value:function isWhite(){return 4294967295===this._colorUl&&4294967295===this._colorUr&&4294967295===this._colorBl&&4294967295===this._colorBr}},{key:"hasSimpleTexCoords",value:function hasSimpleTexCoords(){return 0===this._ulx&&0===this._uly&&1===this._brx&&1===this._bry}},{key:"_stashTexCoords",value:function _stashTexCoords(){this._stashedTexCoords=[this._ulx,this._uly,this._brx,this._bry],this._ulx=0,this._uly=0,this._brx=1,this._bry=1}},{key:"_unstashTexCoords",value:function _unstashTexCoords(){this._ulx=this._stashedTexCoords[0],this._uly=this._stashedTexCoords[1],this._brx=this._stashedTexCoords[2],this._bry=this._stashedTexCoords[3],this._stashedTexCoords=null}},{key:"_stashColors",value:function _stashColors(){this._stashedColors=[this._colorUl,this._colorUr,this._colorBr,this._colorBl],this._colorUl=4294967295,this._colorUr=4294967295,this._colorBr=4294967295,this._colorBl=4294967295}},{key:"_unstashColors",value:function _unstashColors(){this._colorUl=this._stashedColors[0],this._colorUr=this._stashedColors[1],this._colorBr=this._stashedColors[2],this._colorBl=this._stashedColors[3],this._stashedColors=null}},{key:"isVisible",value:function isVisible(){return this._localAlpha>1e-14}},{key:"update",value:function update(){this._recalc|=this._parent._pRecalc,this._layout&&this._layout.isEnabled()?256&this._recalc&&this._layout.layoutFlexTree():2&this._recalc&&this._optFlags&&this._applyRelativeDimFuncs(),this._onUpdate&&(this._hasUpdates=!0,this._onUpdate(this.element,this));var e=this._parent._worldContext,t=this._worldContext,i=e.alpha&&this._localAlpha;if(this._hasUpdates||this._recalc&&i||t.alpha&&!i){var r=this._recalc;1&r&&(!t.alpha&&i&&(this._hasRenderUpdates=3),t.alpha=e.alpha*this._localAlpha,t.alpha<1e-14&&(t.alpha=0)),6&r&&(t.px=e.px+this._localPx*e.ta,t.py=e.py+this._localPy*e.td,0!==e.tb&&(t.px+=this._localPy*e.tb),0!==e.tc&&(t.py+=this._localPx*e.tc)),4&r&&(t.ta=this._localTa*e.ta,t.tb=this._localTd*e.tb,t.tc=this._localTa*e.tc,t.td=this._localTd*e.td,this._isComplex&&(t.ta+=this._localTc*e.tb,t.tb+=this._localTb*e.ta,t.tc+=this._localTc*e.td,t.td+=this._localTb*e.tc));var n=this._parent._renderContext;if(this._parent._hasRenderContext()){var s=this._renderContext===this._worldContext;s&&(this._renderContext=new S);var o=this._renderContext;(s||1&r)&&(o.alpha=n.alpha*this._localAlpha,o.alpha<1e-14&&(o.alpha=0)),(s||6&r)&&(o.px=n.px+this._localPx*n.ta,o.py=n.py+this._localPy*n.td,0!==n.tb&&(o.px+=this._localPy*n.tb),0!==n.tc&&(o.py+=this._localPx*n.tc)),s&&(r|=2),(s||4&r)&&(o.ta=this._localTa*n.ta,o.tb=this._localTd*n.tb,o.tc=this._localTa*n.tc,o.td=this._localTd*n.td,this._isComplex&&(o.ta+=this._localTc*n.tb,o.tb+=this._localTb*n.ta,o.tc+=this._localTc*n.td,o.td+=this._localTb*n.tc))}else this._renderContext=this._worldContext;-1===this.ctx.updateTreeOrder?this.ctx.updateTreeOrder=this._updateTreeOrder+1:this._updateTreeOrder=this.ctx.updateTreeOrder++;var h=this._renderToTextureEnabled&&this._texturizer.mustRenderToTexture();this._useRenderToTexture!==h&&(this._recalc|=6,r|=2,this._useRenderToTexture||this._texturizer.release()),this._useRenderToTexture=h;var u,l,_,d,f=this._renderContext,g=this._dimsUnknown?2048:this._w,p=this._dimsUnknown?2048:this._h,v=0!==f.tb||0!==f.tc||f.ta<0||f.td<0;if(v?(u=Math.min(0,g*f.ta,g*f.ta+p*f.tb,p*f.tb)+f.px,_=Math.max(0,g*f.ta,g*f.ta+p*f.tb,p*f.tb)+f.px,l=Math.min(0,g*f.tc,g*f.tc+p*f.td,p*f.td)+f.py,d=Math.max(0,g*f.tc,g*f.tc+p*f.td,p*f.td)+f.py):(u=f.px,_=f.px+f.ta*g,l=f.py,d=f.py+f.td*p),this._dimsUnknown&&(v||this._localTa<1||this._localTb<1)){var y=this._x*n.ta+this._y*n.tb+n.px,x=this._x*n.tc+this._y*n.td+n.py;y<u&&(u=y),x<l&&(l=x),y>_&&(_=y),x>d&&(d=x)}if(6&r||!this._scissor)if(this._clipping&&f.isSquare()){var m=this._parent._useRenderToTexture?this._parent._viewport:this._parent._scissor;if(m){var k=Math.max(m[0],u),C=Math.max(m[1],l);this._scissor=[k,C,Math.min(m[2]+m[0],_)-k,Math.min(m[3]+m[1],d)-C]}else this._scissor=[u,l,_-u,d-l]}else this._scissor=this._parent._useRenderToTexture?this._parent._viewport:this._parent._scissor;if(this._boundsMargin?this._recBoundsMargin=this._boundsMargin:this._recBoundsMargin=this._parent._recBoundsMargin,this._onAfterCalcs&&this._onAfterCalcs(this.element)&&(v?(u=Math.min(0,g*f.ta,g*f.ta+p*f.tb,p*f.tb)+f.px,_=Math.max(0,g*f.ta,g*f.ta+p*f.tb,p*f.tb)+f.px,l=Math.min(0,g*f.tc,g*f.tc+p*f.td,p*f.td)+f.py,d=Math.max(0,g*f.tc,g*f.tc+p*f.td,p*f.td)+f.py):(u=f.px,_=f.px+f.ta*g,l=f.py,d=f.py+f.td*p),this._dimsUnknown&&(v||this._localTa<1||this._localTb<1))){var T=this._x*n.ta+this._y*n.tb+n.px,b=this._x*n.tc+this._y*n.td+n.py;T<u&&(u=T),b<l&&(l=b),T>_&&(_=T),b>d&&(d=b)}if(2===this._parent._outOfBounds)this._outOfBounds=2,this._withinBoundsMargin&&(this._withinBoundsMargin=!1,this.element._disableWithinBoundsMargin());else if(6&r){this._outOfBounds=0;var A=!0;if(this._renderToTextureEnabled&&this._texturizer&&this._texturizer.renderOffscreen||(this._scissor&&(this._scissor[2]<=0||this._scissor[3]<=0)?this._outOfBounds=2:((this._scissor[0]>_||this._scissor[1]>d||u>this._scissor[0]+this._scissor[2]||l>this._scissor[1]+this._scissor[3])&&(this._outOfBounds=1),this._outOfBounds&&(this._clipping||this._useRenderToTexture||this._clipbox&&g&&p)&&(this._outOfBounds=2)),(A=0===this._outOfBounds)||(A=this._recBoundsMargin?!(_<this._scissor[0]-this._recBoundsMargin[2]||d<this._scissor[1]-this._recBoundsMargin[3]||u>this._scissor[0]+this._scissor[2]+this._recBoundsMargin[0]||l>this._scissor[1]+this._scissor[3]+this._recBoundsMargin[1]):!(_<this._scissor[0]-100||d<this._scissor[1]-100||u>this._scissor[0]+this._scissor[2]+100||l>this._scissor[1]+this._scissor[3]+100))&&2===this._outOfBounds&&(this._outOfBounds=1)),this._withinBoundsMargin!==A)if(this._withinBoundsMargin=A,this._withinBoundsMargin){this._hasUpdates=!0;var w=this._recalc;if(this._recalc=0,this.element._enableWithinBoundsMargin(),this._recalc)return this.update();this._recalc=w}else this.element._disableWithinBoundsMargin()}if(this._useRenderToTexture&&(this._viewport?(this._viewport[2]=g,this._viewport[3]=p):this._viewport=[0,0,g,p]),this._pRecalc=135&this._recalc,this._recalc=0,this._hasUpdates=!1,this._outOfBounds<2){if(this._useRenderToTexture&&(this._worldContext.isIdentity()?this._renderContext=this._worldContext:this._renderContext=S.IDENTITY),this._children)for(var R=0,L=this._children.length;R<L;R++)this._children[R].update();this._useRenderToTexture&&(this._renderContext=f)}else if(this._children)for(var P=0,E=this._children.length;P<E;P++)this._children[P]._hasUpdates?this._children[P].update():(this._children[P]._recalc|=this._pRecalc,this._children[P].updateOutOfBounds());this._onAfterUpdate&&this._onAfterUpdate(this.element)}else-1===this.ctx.updateTreeOrder||this._updateTreeOrder>=this.ctx.updateTreeOrder?this.ctx.updateTreeOrder=-1:this.updateTreeOrder()}},{key:"_applyRelativeDimFuncs",value:function _applyRelativeDimFuncs(){if(1&this._optFlags){var e=this._funcX(this._parent.w);e!==this._x&&(this._localPx+=e-this._x,this._x=e)}if(2&this._optFlags){var t=this._funcY(this._parent.h);t!==this._y&&(this._localPy+=t-this._y,this._y=t)}var i=!1;if(4&this._optFlags){var r=this._funcW(this._parent.w);r!==this._w&&(this._w=r,i=!0)}if(8&this._optFlags){var n=this._funcH(this._parent.h);n!==this._h&&(this._h=n,i=!0)}i&&(this._recalcLocalTranslate(),this.element.onDimensionsChanged(this._w,this._h))}},{key:"updateOutOfBounds",value:function updateOutOfBounds(){if(2!==this._outOfBounds&&this._renderContext.alpha>0&&(this._outOfBounds=2,this._withinBoundsMargin&&(this._withinBoundsMargin=!1,this.element._disableWithinBoundsMargin()),this._children))for(var e=0,t=this._children.length;e<t;e++)this._children[e].updateOutOfBounds()}},{key:"updateTreeOrder",value:function updateTreeOrder(){if(this._localAlpha&&2!==this._outOfBounds&&(this._updateTreeOrder=this.ctx.updateTreeOrder++,this._children))for(var e=0,t=this._children.length;e<t;e++)this._children[e].updateTreeOrder()}},{key:"_renderSimple",value:function _renderSimple(){if(this._hasRenderUpdates=0,this._zSort&&this.sortZIndexedChildren(),this._outOfBounds<2&&this._renderContext.alpha){var e=this.renderState;if(0===this._outOfBounds&&this._displayedTextureSource&&(e.setShader(this.activeShader,this._shaderOwner),e.setScissor(this._scissor),this.renderState.addQuad(this)),this._children)if(this._zContextUsage)for(var t=0,i=this._zIndexedChildren.length;t<i;t++)this._zIndexedChildren[t].render();else for(var r=0,n=this._children.length;r<n;r++)0===this._children[r]._zIndex&&this._children[r].render()}}},{key:"_renderAdvanced",value:function _renderAdvanced(){var e=this._hasRenderUpdates;if(this._hasRenderUpdates=0,this._zSort&&this.sortZIndexedChildren(),this._outOfBounds<2&&this._renderContext.alpha){var t,i,r=this.renderState,n=!0;if(this._useRenderToTexture){if(0===this._w||0===this._h)return;if(!this._texturizer.hasRenderTexture()||e>=3){if(r.setShader(r.defaultShader,this),i=r.renderTextureInfo,t={nativeTexture:null,offset:0,w:this._w,h:this._h,empty:!0,cleared:!1,ignore:!1,cache:!1},(this._texturizer.hasResultTexture()||!r.isCachingTexturizer&&e<3)&&(t.cache=!0,r.isCachingTexturizer=!0),this._texturizer.hasResultTexture()||this._texturizer.releaseRenderTexture(),r.setRenderTextureInfo(t),r.setScissor(null),this._displayedTextureSource){var s=this._renderContext;this._renderContext=S.IDENTITY,this.renderState.addQuad(this),this._renderContext=s}}else n=!1}else 0===this._outOfBounds&&this._displayedTextureSource&&(r.setShader(this.activeShader,this._shaderOwner),r.setScissor(this._scissor),this.renderState.addQuad(this));if(n&&this._children)if(this._zContextUsage)for(var o=0,h=this._zIndexedChildren.length;o<h;o++)this._zIndexedChildren[o].render();else for(var u=0,l=this._children.length;u<l;u++)0===this._children[u]._zIndex&&this._children[u].render();if(this._useRenderToTexture){var _=!1;if(n&&(r.finishedRenderTexture(),this._texturizer.empty=t.empty,t.empty?this._texturizer.releaseRenderTexture():t.nativeTexture?(this._texturizer.reuseTextureAsRenderTexture(t.nativeTexture),t.ignore=!0):(this._texturizer.renderTextureReused&&this._texturizer.releaseRenderTexture(),t.nativeTexture=this._texturizer.getRenderTexture()),r.setRenderTextureInfo(i),_=!0),!this._texturizer.empty){var d=this._texturizer.getResultTexture();if(_&&(d&&(d.update=r.stage.frameCounter),this._texturizer.updateResultTexture()),!this._texturizer.renderOffscreen){r.setShader(this.activeShader,this._shaderOwner),r.setScissor(this._scissor);var f=!t||t.cache;r.setTexturizer(this._texturizer,f),this._stashTexCoords(),this._texturizer.colorize||this._stashColors(),this.renderState.addQuad(this,!0),this._texturizer.colorize||this._unstashColors(),this._unstashTexCoords(),r.setTexturizer(null)}}}t&&t.cache&&(r.isCachingTexturizer=!1)}}},{key:"sortZIndexedChildren",value:function sortZIndexedChildren(){for(var e=this._zIndexedChildren.length,t=0,i=this._zIndexedChildren,r=[],n=0;n<e;n++)i[n]._zParent===this&&(i[n]._zIndexResort?r.push(i[n]):(t!==n&&(i[t]=i[n]),t++));var s=r.length;if(s){for(var o=0;o<s;o++)r[o]._zIndexResort=!1;r.sort(ElementCore.sortZIndexedChildren);var h=t;if(h){t=0;for(var u=0,l=0,_=[];;){var d=(i[u]._zIndex===r[l]._zIndex?i[u]._updateTreeOrder-r[l]._updateTreeOrder:i[u]._zIndex-r[l]._zIndex)>0?r[l++]:i[u++];if(0!==t&&_[t-1]===d||(_[t++]=d),u>=h){do{var f=r[l++];0!==t&&_[t-1]===f||(_[t++]=f)}while(l<s);break}if(l>=s){do{var g=i[u++];0!==t&&_[t-1]===g||(_[t++]=g)}while(u<h);break}}this._zIndexedChildren=_}else{t=0;var p=0;do{i[t++]=r[p++]}while(p<s);i.length>t&&i.splice(t)}}else i.length>t&&i.splice(t);this._zSort=!1}},{key:"getCornerPoints",value:function getCornerPoints(){var e=this._worldContext;return[e.px,e.py,e.px+this._w*e.ta,e.py+this._w*e.tc,e.px+this._w*e.ta+this._h*e.tb,e.py+this._w*e.tc+this._h*e.td,e.px+this._h*e.tb,e.py+this._h*e.td]}},{key:"getRenderTextureCoords",value:function getRenderTextureCoords(e,t){var i=this._renderContext;return[i.px+i.ta*e+i.tb*t,i.py+i.tc*e+i.td*t]}},{key:"getAbsoluteCoords",value:function getAbsoluteCoords(e,t){var i=this._renderContext;return[i.px+i.ta*e+i.tb*t,i.py+i.tc*e+i.td*t]}},{key:"isFlexItem",value:function isFlexItem(){return!!this._layout&&this._layout.isFlexItemEnabled()}},{key:"isFlexContainer",value:function isFlexContainer(){return!!this._layout&&this._layout.isFlexEnabled()}},{key:"enableFlexLayout",value:function enableFlexLayout(){this._ensureLayout()}},{key:"_ensureLayout",value:function _ensureLayout(){this._layout||(this._layout=new y(this))}},{key:"disableFlexLayout",value:function disableFlexLayout(){this._triggerRecalcTranslate()}},{key:"hasFlexLayout",value:function hasFlexLayout(){return this._layout&&this._layout.isEnabled()}},{key:"setLayout",value:function setLayout(e,t,i,r){this.x=e,this.y=t,this._updateDimensions(i,r)}},{key:"triggerLayout",value:function triggerLayout(){this._setRecalc(256)}},{key:"_triggerRecalcTranslate",value:function _triggerRecalcTranslate(){this._setRecalc(2)}},{key:"offsetX",get:function get(){return this._funcX?this._funcX:this.hasFlexLayout()?this._layout.originalX:this._x},set:function set(e){t.isFunction(e)?this.funcX=e:(this._disableFuncX(),this.hasFlexLayout()?(this.x+=e-this._layout.originalX,this._layout.setOriginalXWithoutUpdatingLayout(e)):this.x=e)}},{key:"x",get:function get(){return this._x},set:function set(e){e!==this._x&&(this._updateLocalTranslateDelta(e-this._x,0),this._x=e)}},{key:"funcX",get:function get(){return 1&this._optFlags?this._funcX:null},set:function set(e){this._funcX!==e&&(this._optFlags|=1,this._funcX=e,this.hasFlexLayout()?(this._layout.setOriginalXWithoutUpdatingLayout(0),this.layout.forceLayout()):(this._x=0,this._triggerRecalcTranslate()))}},{key:"offsetY",get:function get(){return this._funcY?this._funcY:this.hasFlexLayout()?this._layout.originalY:this._y},set:function set(e){t.isFunction(e)?this.funcY=e:(this._disableFuncY(),this.hasFlexLayout()?(this.y+=e-this._layout.originalY,this._layout.setOriginalYWithoutUpdatingLayout(e)):this.y=e)}},{key:"y",get:function get(){return this._y},set:function set(e){e!==this._y&&(this._updateLocalTranslateDelta(0,e-this._y),this._y=e)}},{key:"funcY",get:function get(){return 2&this._optFlags?this._funcY:null},set:function set(e){this._funcY!==e&&(this._optFlags|=2,this._funcY=e,this.hasFlexLayout()?(this._layout.setOriginalYWithoutUpdatingLayout(0),this.layout.forceLayout()):(this._y=0,this._triggerRecalcTranslate()))}},{key:"funcW",get:function get(){return 4&this._optFlags?this._funcW:null},set:function set(e){this._funcW!==e&&(this._optFlags|=4,this._funcW=e,this.hasFlexLayout()?(this._layout._originalWidth=0,this.layout.changedDimensions(!0,!1)):(this._w=0,this._triggerRecalcTranslate()))}},{key:"funcH",get:function get(){return 8&this._optFlags?this._funcH:null},set:function set(e){this._funcH!==e&&(this._optFlags|=8,this._funcH=e,this.hasFlexLayout()?(this._layout._originalHeight=0,this.layout.changedDimensions(!1,!0)):(this._h=0,this._triggerRecalcTranslate()))}},{key:"w",get:function get(){return this._w}},{key:"h",get:function get(){return this._h}},{key:"scaleX",get:function get(){return this._scaleX},set:function set(e){this._scaleX!==e&&(this._scaleX=e,this._updateLocalTransform())}},{key:"scaleY",get:function get(){return this._scaleY},set:function set(e){this._scaleY!==e&&(this._scaleY=e,this._updateLocalTransform())}},{key:"scale",get:function get(){return this.scaleX},set:function set(e){this._scaleX===e&&this._scaleY===e||(this._scaleX=e,this._scaleY=e,this._updateLocalTransform())}},{key:"pivotX",get:function get(){return this._pivotX},set:function set(e){this._pivotX!==e&&(this._pivotX=e,this._updateLocalTranslate())}},{key:"pivotY",get:function get(){return this._pivotY},set:function set(e){this._pivotY!==e&&(this._pivotY=e,this._updateLocalTranslate())}},{key:"pivot",get:function get(){return this._pivotX},set:function set(e){this._pivotX===e&&this._pivotY===e||(this._pivotX=e,this._pivotY=e,this._updateLocalTranslate())}},{key:"mountX",get:function get(){return this._mountX},set:function set(e){this._mountX!==e&&(this._mountX=e,this._updateLocalTranslate())}},{key:"mountY",get:function get(){return this._mountY},set:function set(e){this._mountY!==e&&(this._mountY=e,this._updateLocalTranslate())}},{key:"mount",get:function get(){return this._mountX},set:function set(e){this._mountX===e&&this._mountY===e||(this._mountX=e,this._mountY=e,this._updateLocalTranslate())}},{key:"rotation",get:function get(){return this._rotation},set:function set(e){this._rotation!==e&&(this._rotation=e,this._updateLocalTransform())}},{key:"alpha",get:function get(){return this._alpha},set:function set(e){if(e=e>1?1:e<1e-14?0:e,this._alpha!==e){var t=this._alpha;this._alpha=e,this._updateLocalAlpha(),0===t!=(0===e)&&this._element._updateEnabledFlag()}}},{key:"visible",get:function get(){return this._visible},set:function set(e){this._visible!==e&&(this._visible=e,this._updateLocalAlpha(),this._element._updateEnabledFlag(),this.hasFlexLayout()&&this.layout.setVisible(e))}},{key:"displayedTextureSource",get:function get(){return this._displayedTextureSource}},{key:"isRoot",get:function get(){return this._isRoot}},{key:"zIndex",get:function get(){return this._zIndex},set:function set(e){if(this._zIndex!==e){this.setHasRenderUpdates(1);var t=this._zParent,i=this.isZContext();0===e&&0!==this._zIndex?this._parent===this._zParent?this._zParent&&this._zParent.decZContextUsage():t=this._parent:0!==e&&0===this._zIndex?(t=this._parent?this._parent.findZContext():null)===this._zParent&&this._zParent&&(this._zParent.incZContextUsage(),this._zParent.enableZSort()):e!==this._zIndex&&this._zParent&&this._zParent._zContextUsage&&this._zParent.enableZSort(),t!==this._zParent&&this.setZParent(null),this._zIndex=e,t!==this._zParent&&this.setZParent(t),i!==this.isZContext()&&(this.isZContext()?this.enableZContext(this._parent.findZContext()):this.disableZContext()),this._zIndexResort=!0,this._zParent&&this._zParent.enableZSort()}}},{key:"forceZIndexContext",get:function get(){return this._forceZIndexContext},set:function set(e){this.setHasRenderUpdates(1);var t=this.isZContext();this._forceZIndexContext=e,t!==this.isZContext()&&(this.isZContext()?this.enableZContext(this._parent.findZContext()):this.disableZContext())}},{key:"colorUl",get:function get(){return this._colorUl},set:function set(e){this._colorUl!==e&&(this.setHasRenderUpdates(this._displayedTextureSource?3:1),this._colorUl=e)}},{key:"colorUr",get:function get(){return this._colorUr},set:function set(e){this._colorUr!==e&&(this.setHasRenderUpdates(this._displayedTextureSource?3:1),this._colorUr=e)}},{key:"colorBl",get:function get(){return this._colorBl},set:function set(e){this._colorBl!==e&&(this.setHasRenderUpdates(this._displayedTextureSource?3:1),this._colorBl=e)}},{key:"colorBr",get:function get(){return this._colorBr},set:function set(e){this._colorBr!==e&&(this.setHasRenderUpdates(this._displayedTextureSource?3:1),this._colorBr=e)}},{key:"onUpdate",set:function set(e){this._onUpdate=e,this._setRecalc(7)}},{key:"onAfterUpdate",set:function set(e){this._onAfterUpdate=e,this._setRecalc(7)}},{key:"onAfterCalcs",set:function set(e){this._onAfterCalcs=e,this._setRecalc(7)}},{key:"shader",get:function get(){return this._shader},set:function set(e){this.setHasRenderUpdates(1);var t=this._shader;if(this._shader=e,!e&&t){var i=this._parent&&!this._parent._renderToTextureEnabled?this._parent._shaderOwner:null;this._setShaderOwnerRecursive(i)}else e&&this._setShaderOwnerRecursive(this)}},{key:"activeShader",get:function get(){return this._shaderOwner?this._shaderOwner.shader:this.renderState.defaultShader}},{key:"activeShaderOwner",get:function get(){return this._shaderOwner}},{key:"clipping",get:function get(){return this._clipping},set:function set(e){this._clipping!==e&&(this._clipping=e,this._setRecalc(3))}},{key:"clipbox",get:function get(){return this._clipbox},set:function set(e){this._clipbox=e}},{key:"renderContext",get:function get(){return this._renderContext}},{key:"outOfBounds",get:function get(){return this._outOfBounds}},{key:"boundsMargin",set:function set(e){this._boundsMargin=e?e.slice():null,this._triggerRecalcTranslate()},get:function get(){return this._boundsMargin}},{key:"zSort",get:function get(){return this._zSort}},{key:"localTa",get:function get(){return this._localTa}},{key:"localTb",get:function get(){return this._localTb}},{key:"localTc",get:function get(){return this._localTc}},{key:"localTd",get:function get(){return this._localTd}},{key:"element",get:function get(){return this._element}},{key:"renderUpdates",get:function get(){return this._hasRenderUpdates}},{key:"texturizer",get:function get(){return this._texturizer||(this._texturizer=new m(this)),this._texturizer}},{key:"layout",get:function get(){return this._ensureLayout(),this._layout}},{key:"flex",get:function get(){return this._layout?this._layout.flex:null},set:function set(e){this.layout.flex=e}},{key:"flexItem",get:function get(){return this._layout?this._layout.flexItem:null},set:function set(e){this.layout.flexItem=e}}]),ElementCore}(),S=function(){function ElementCoreContext(){_classCallCheck(this,ElementCoreContext),this.alpha=1,this.px=0,this.py=0,this.ta=1,this.tb=0,this.tc=0,this.td=1}return _createClass(ElementCoreContext,[{key:"isIdentity",value:function isIdentity(){return 1===this.alpha&&0===this.px&&0===this.py&&1===this.ta&&0===this.tb&&0===this.tc&&1===this.td}},{key:"isSquare",value:function isSquare(){return 0===this.tb&&0===this.tc}}]),ElementCoreContext}();S.IDENTITY=new S,k.sortZIndexedChildren=function(e,t){return e._zIndex===t._zIndex?e._updateTreeOrder-t._updateTreeOrder:e._zIndex-t._zIndex};var C=function(){function EventEmitter(){_classCallCheck(this,EventEmitter),this._hasEventListeners=!1}return _createClass(EventEmitter,[{key:"on",value:function on(e,t){this._hasEventListeners||(this._eventFunction={},this._eventListeners={},this._hasEventListeners=!0),this._eventFunction[e]?this._eventFunction[e]!==EventEmitter.combiner?(this._eventListeners[e]=[this._eventFunction[e],t],this._eventFunction[e]=EventEmitter.combiner):this._eventListeners[e].push(t):this._eventFunction[e]=t}},{key:"has",value:function has(e,t){if(this._hasEventListeners){var i=this._eventFunction[e];if(i){if(i===EventEmitter.combiner)return this._eventListeners[e].indexOf(t)>=0;if(this._eventFunction[e]===t)return!0}}return!1}},{key:"off",value:function off(e,t){if(this._hasEventListeners){var i=this._eventFunction[e];if(i)if(i===EventEmitter.combiner){var r=this._eventListeners[e],n=r.indexOf(t);n>=0&&r.splice(n,1),1===r.length&&(this._eventFunction[e]=r[0],this._eventListeners[e]=void 0)}else this._eventFunction[e]===t&&(this._eventFunction[e]=void 0)}}},{key:"removeListener",value:function removeListener(e,t){this.off(e,t)}},{key:"emit",value:function emit(e,t,i,r){if(this._hasEventListeners){var n=this._eventFunction[e];n&&(n===EventEmitter.combiner?n(this,e,t,i,r):n(t,i,r))}}},{key:"listenerCount",value:function listenerCount(e){if(!this._hasEventListeners)return 0;var t=this._eventFunction[e];return t?t===EventEmitter.combiner?this._eventListeners[e].length:1:void 0}},{key:"removeAllListeners",value:function removeAllListeners(e){this._hasEventListeners&&(delete this._eventFunction[e],delete this._eventListeners[e])}}]),EventEmitter}();C.combiner=function(e,t,i,r,n){var s=this,o=e._eventListeners[t];o&&o.forEach(function(e){_newArrowCheck(this,s),e(i,r,n)}.bind(this))},C.addAsMixin=function(e){e.prototype.on=C.prototype.on,e.prototype.has=C.prototype.has,e.prototype.off=C.prototype.off,e.prototype.removeListener=C.prototype.removeListener,e.prototype.emit=C.prototype.emit,e.prototype.listenerCount=C.prototype.listenerCount,e.prototype.removeAllListeners=C.prototype.removeAllListeners};var T=function(){function Shader(e){_classCallCheck(this,Shader),this._initialized=!1,this.ctx=e,this._elements=new Set}return _createClass(Shader,[{key:"addElement",value:function addElement(e){this._elements.add(e)}},{key:"removeElement",value:function removeElement(e){this._elements.delete(e),this._elements||this.cleanup()}},{key:"redraw",value:function redraw(){var e=this;this._elements.forEach(function(t){_newArrowCheck(this,e),t.setHasRenderUpdates(2)}.bind(this))}},{key:"patch",value:function patch(e){i.patchObject(this,e)}},{key:"useDefault",value:function useDefault(){return!1}},{key:"addEmpty",value:function addEmpty(){return!1}},{key:"cleanup",value:function cleanup(){}},{key:"isShader",get:function get(){return!0}}],[{key:"create",value:function create(e,r){var n;if(t.isObjectLiteral(r))(n=r.type?e.renderer.createShader(e.ctx,r):this.shader)&&i.patchObject(n,r);else if(null===r)n=e.ctx.renderState.defaultShader;else if(void 0===r)n=null;else{if(!r.isShader)return void console.error("Please specify a shader type.");e.renderer.isValidShaderType(r.constructor)||(console.error("Invalid shader type"),r=null),n=r}return n}},{key:"getWebGL",value:function getWebGL(){}},{key:"getC2d",value:function getC2d(){}}]),Shader}(),b=function(){function Texture(e){_classCallCheck(this,Texture),this.stage=e,this.manager=this.stage.textureManager,this.id=Texture.id++,this.elements=new Set,this._activeCount=0,this._source=null,this._resizeMode=null,this._x=0,this._y=0,this._w=0,this._h=0,this._precision=1,this.mw=0,this.mh=0,this.clipping=!1,this._mustUpdate=!0}return _createClass(Texture,[{key:"addElement",value:function addElement(e){this.elements.has(e)||(this.elements.add(e),1===this.elements.size&&this._source&&this._source.addTexture(this),e.active&&this.incActiveCount())}},{key:"removeElement",value:function removeElement(e){this.elements.delete(e)&&(0===this.elements.size&&this._source&&this._source.removeTexture(this),e.active&&this.decActiveCount())}},{key:"incActiveCount",value:function incActiveCount(){this.source&&this._checkForNewerReusableTextureSource(),this._activeCount++,1===this._activeCount&&this.becomesUsed()}},{key:"decActiveCount",value:function decActiveCount(){this.source;this._activeCount--,this._activeCount||this.becomesUnused()}},{key:"becomesUsed",value:function becomesUsed(){this.source&&this.source.incActiveTextureCount()}},{key:"onLoad",value:function onLoad(){var e=this;this._resizeMode&&this._applyResizeMode(),this.elements.forEach(function(t){_newArrowCheck(this,e),t.active&&t.onTextureSourceLoaded()}.bind(this))}},{key:"_checkForNewerReusableTextureSource",value:function _checkForNewerReusableTextureSource(){var e=this.source;if(e.isLoaded())this._resizeMode&&this._applyResizeMode();else{var t=this._getReusableTextureSource();t&&t.isLoaded()&&t!==e&&this._replaceTextureSource(t)}}},{key:"becomesUnused",value:function becomesUnused(){this.source&&this.source.decActiveTextureCount()}},{key:"isUsed",value:function isUsed(){return this._activeCount>0}},{key:"_getLookupId",value:function _getLookupId(){return null}},{key:"_getSourceLoader",value:function _getSourceLoader(){throw new Error("Texture.generate must be implemented.")}},{key:"_getIsValid",value:function _getIsValid(){return!0}},{key:"_changed",value:function _changed(){this.isUsed()?this._updateSource():this._mustUpdate=!0}},{key:"_updateSource",value:function _updateSource(){this.stage.addUpdateSourceTexture(this)}},{key:"_performUpdateSource",value:function _performUpdateSource(){var e=arguments.length>0&&void 0!==arguments[0]&&arguments[0];if(e||this.isUsed()){this._mustUpdate=!1;var t=this._getTextureSource();this._replaceTextureSource(t)}}},{key:"_getTextureSource",value:function _getTextureSource(){var e=null;if(this._getIsValid()){var t=this._getLookupId();(e=this._getReusableTextureSource(t))||(e=this.manager.getTextureSource(this._getSourceLoader(),t))}return e}},{key:"_getReusableTextureSource",value:function _getReusableTextureSource(){var e=arguments.length>0&&void 0!==arguments[0]?arguments[0]:this._getLookupId();return this._getIsValid()&&e?this.manager.getReusableTextureSource(e):null}},{key:"_replaceTextureSource",value:function _replaceTextureSource(){var e=this,t=arguments.length>0&&void 0!==arguments[0]?arguments[0]:null,i=this._source;if(this._source=t,this.elements.size&&(i&&(this._activeCount&&i.decActiveTextureCount(),i.removeTexture(this)),t&&(t.addTexture(this),this._activeCount&&t.incActiveTextureCount())),this.isUsed())if(t)if(t.isLoaded())this._resizeMode&&this._applyResizeMode(),this.elements.forEach(function(t){_newArrowCheck(this,e),t.active&&t._setDisplayedTexture(this)}.bind(this));else{var r=t.loadError;r&&this.elements.forEach(function(t){_newArrowCheck(this,e),t.active&&t.onTextureSourceLoadError(r)}.bind(this))}else this.elements.forEach(function(t){_newArrowCheck(this,e),t.active&&t._setDisplayedTexture(null)}.bind(this))}},{key:"load",value:function load(){this.source&&(this.isLoaded()||this.source.load(!0))}},{key:"isLoaded",value:function isLoaded(){return this._source&&this._source.isLoaded()}},{key:"free",value:function free(){this._source&&this._source.free()}},{key:"_clearResizeMode",value:function _clearResizeMode(){this._resizeMode=null}},{key:"_applyResizeMode",value:function _applyResizeMode(){"cover"===this._resizeMode.type?this._applyResizeCover():"contain"===this._resizeMode.type&&this._applyResizeContain(),this._updatePrecision(),this._updateClipping()}},{key:"_applyResizeCover",value:function _applyResizeCover(){var e=this._resizeMode.w/this._source.w,t=this._resizeMode.h/this._source.h,i=Math.max(e,t);if(i){if(this._precision=1/i,e&&e<i){var r=this._precision*this._resizeMode.w,n=this._source.w-r;this._x=n*this._resizeMode.clipX,this._w=this._source.w-n}if(t&&t<i){var s=this._precision*this._resizeMode.h,o=this._source.h-s;this._y=o*this._resizeMode.clipY,this._h=this._source.h-o}}}},{key:"_applyResizeContain",value:function _applyResizeContain(){var e=this._resizeMode.w/this._source.w,t=this._resizeMode.h/this._source.h,i=e;(!i||t<i)&&(i=t),i&&(this._precision=1/i)}},{key:"enableClipping",value:function enableClipping(e,t,i,r){this._clearResizeMode(),e*=this._precision,t*=this._precision,i*=this._precision,r*=this._precision,this._x===e&&this._y===t&&this._w===i&&this._h===r||(this._x=e,this._y=t,this._w=i,this._h=r,this._updateClipping(!0))}},{key:"disableClipping",value:function disableClipping(){this._clearResizeMode(),(this._x||this._y||this._w||this._h)&&(this._x=0,this._y=0,this._w=0,this._h=0,this._updateClipping())}},{key:"_updateClipping",value:function _updateClipping(){this.clipping=!!(this._x||this._y||this._w||this._h);var e=this;this.elements.forEach((function(t){t.displayedTexture===e&&t.onDisplayedTextureClippingChanged()}))}},{key:"_updatePrecision",value:function _updatePrecision(){var e=this;this.elements.forEach((function(t){t.displayedTexture===e&&t.onPrecisionChanged()}))}},{key:"getNonDefaults",value:function getNonDefaults(){var e={};return e.type=this.constructor.name,0!==this.x&&(e.x=this.x),0!==this.y&&(e.y=this.y),0!==this.w&&(e.w=this.w),0!==this.h&&(e.h=this.h),1!==this.precision&&(e.precision=this.precision),e}},{key:"isAutosizeTexture",value:function isAutosizeTexture(){return!0}},{key:"getRenderWidth",value:function getRenderWidth(){return this.isAutosizeTexture()?(this._w||(this._source?this._source.getRenderWidth()-this._x:0))/this._precision:0}},{key:"getRenderHeight",value:function getRenderHeight(){return this.isAutosizeTexture()?(this._h||(this._source?this._source.getRenderHeight()-this._y:0))/this._precision:0}},{key:"patch",value:function patch(e){i.patchObject(this,e)}},{key:"source",get:function get(){return(this._mustUpdate||this.stage.hasUpdateSourceTexture(this))&&(this._performUpdateSource(!0),this.stage.removeUpdateSourceTexture(this)),this._source}},{key:"isValid",get:function get(){return this._getIsValid()}},{key:"loadError",get:function get(){return this._source&&this._source.loadError}},{key:"resizeMode",set:function set(e){var t=e.type,i=void 0===t?"cover":t,r=e.w,n=void 0===r?0:r,s=e.h,o=void 0===s?0:s,h=e.clipX,u=void 0===h?.5:h,l=e.clipY,_=void 0===l?.5:l;this._resizeMode={type:i,w:n,h:o,clipX:u,clipY:_},this.isLoaded()&&this._applyResizeMode()},get:function get(){return this._resizeMode}},{key:"px",get:function get(){return this._x}},{key:"py",get:function get(){return this._y}},{key:"pw",get:function get(){return this._w}},{key:"ph",get:function get(){return this._h}},{key:"x",get:function get(){return this._x/this._precision},set:function set(e){this._clearResizeMode(),e*=this._precision,this._x!==e&&(this._x=e,this._updateClipping())}},{key:"y",get:function get(){return this._y/this._precision},set:function set(e){this._clearResizeMode(),e*=this._precision,this._y!==e&&(this._y=e,this._updateClipping())}},{key:"w",get:function get(){return this._w/this._precision},set:function set(e){this._clearResizeMode(),e*=this._precision,this._w!==e&&(this._w=e,this._updateClipping())}},{key:"h",get:function get(){return this._h/this._precision},set:function set(e){this._clearResizeMode(),e*=this._precision,this._h!==e&&(this._h=e,this._updateClipping())}},{key:"precision",get:function get(){return this._precision},set:function set(e){this._clearResizeMode(),this._precision!==e&&(this._precision=e,this._updatePrecision())}}]),Texture}();b.prototype.isTexture=!0,b.id=0;var A=function(e){function ImageTexture(e){var t;return _classCallCheck(this,ImageTexture),(t=_possibleConstructorReturn(this,_getPrototypeOf(ImageTexture).call(this,e)))._src=void 0,t._hasAlpha=!1,t}return _inherits(ImageTexture,e),_createClass(ImageTexture,[{key:"_getIsValid",value:function _getIsValid(){return!!this._src}},{key:"_getLookupId",value:function _getLookupId(){return this._src}},{key:"_getSourceLoader",value:function _getSourceLoader(){var e=this,t=this._src,i=this._hasAlpha;if(this.stage.getOption("srcBasePath")){var r=t.charCodeAt(0);-1===t.indexOf("//")&&(r>=65&&r<=90||r>=97&&r<=122||46==r)&&(t=this.stage.getOption("srcBasePath")+t)}return function(r){return _newArrowCheck(this,e),this.stage.platform.loadSrcTexture({src:t,hasAlpha:i},r)}.bind(this)}},{key:"getNonDefaults",value:function getNonDefaults(){var e=_get(_getPrototypeOf(ImageTexture.prototype),"getNonDefaults",this).call(this);return this._src&&(e.src=this._src),e}},{key:"src",get:function get(){return this._src},set:function set(e){this._src!==e&&(this._src=e,this._changed())}},{key:"hasAlpha",get:function get(){return this._hasAlpha},set:function set(e){this._hasAlpha!==e&&(this._hasAlpha=e,this._changed())}}]),ImageTexture}(b),w=function(){function TextTextureRenderer(e,t,i){_classCallCheck(this,TextTextureRenderer),this._stage=e,this._canvas=t,this._context=this._canvas.getContext("2d"),this._settings=i}return _createClass(TextTextureRenderer,[{key:"getPrecision",value:function getPrecision(){return this._settings.precision}},{key:"setFontProperties",value:function setFontProperties(){this._context.font=t.isSpark?this._stage.platform.getFontSetting(this):this._getFontSetting(),this._context.textBaseline=this._settings.textBaseline}},{key:"_getFontSetting",value:function _getFontSetting(){var e=this._settings.fontFace;Array.isArray(e)||(e=[e]);for(var t=[],i=0,r=e.length;i<r;i++)"serif"===e[i]||"sans-serif"===e[i]?t.push(e[i]):t.push('"'.concat(e[i],'"'));return"".concat(this._settings.fontStyle," ").concat(this._settings.fontSize*this.getPrecision(),"px ").concat(t.join(","))}},{key:"_load",value:function _load(){var e=this;if(t.isWeb&&document.fonts){var i=this._getFontSetting();try{if(!document.fonts.check(i,this._settings.text))return document.fonts.load(i,this._settings.text).catch(function(t){_newArrowCheck(this,e),console.warn("Font load error",t,i)}.bind(this)).then(function(){_newArrowCheck(this,e),document.fonts.check(i,this._settings.text)||console.warn("Font not found",i)}.bind(this))}catch(e){console.warn("Can't check font loading for "+i)}}}},{key:"draw",value:function draw(){var e=this,i=this._load();return i?i.then(function(){return _newArrowCheck(this,e),t.isSpark?this._stage.platform.drawText(this):this._draw()}.bind(this)):t.isSpark?this._stage.platform.drawText(this):this._draw()}},{key:"_calculateRenderInfo",value:function _calculateRenderInfo(){var e={},t=this.getPrecision(),i=this._settings.paddingLeft*t,r=this._settings.paddingRight*t,n=this._settings.fontSize*t,s=null===this._settings.offsetY?null:this._settings.offsetY*t,o=this._settings.lineHeight*t,h=this._settings.w*t,u=this._settings.h*t,l=this._settings.wordWrapWidth*t,_=this._settings.cutSx*t,d=this._settings.cutEx*t,f=this._settings.cutSy*t,g=this._settings.cutEy*t,p=this._settings.letterSpacing||0;this.setFontProperties();var v,y=h||2048/this.getPrecision(),x=y-i;if(x<10&&(y+=10-x,x+=10-x),l||(l=x),this._settings.textOverflow&&!this._settings.wordWrap){var m;switch(this._settings.textOverflow){case"clip":m="";break;case"ellipsis":m=this._settings.maxLinesSuffix;break;default:m=this._settings.textOverflow}this._settings.text=this.wrapWord(this._settings.text,l,m)}if(this._settings.wordWrap)v=this.wrapText(this._settings.text,l,p);else for(var k=(v={l:this._settings.text.split(/(?:\r\n|\r|\n)/),n:[]}).l.length,S=0;S<k-1;S++)v.n.push(S);var C=v.l;if(this._settings.maxLines&&C.length>this._settings.maxLines){var T=C.slice(0,this._settings.maxLines),b=null;if(this._settings.maxLinesSuffix){var A=this._settings.maxLinesSuffix?this.measureText(this._settings.maxLinesSuffix):0,w=this.wrapText(T[T.length-1],l-A,p);T[T.length-1]=w.l[0]+this._settings.maxLinesSuffix,b=[w.l.length>1?w.l[1]:""]}else b=[""];var R,L=C.length,P=0,E=v.n.length;for(R=this._settings.maxLines;R<L;R++)b[P]+=(b[P]?" ":"")+C[R],R+1<E&&v.n[R+1]&&P++;e.remainingText=b.join("\n"),e.moreTextLines=!0,C=T}else e.moreTextLines=!1,e.remainingText="";for(var O,z=0,M=[],F=0;F<C.length;F++){var I=this.measureText(C[F],p);M.push(I),z=Math.max(z,I)}return e.lineWidths=M,h||(y=z+i+r,x=z),o=o||n,O=u||o*(C.length-1)+.5*n+Math.max(o,n)+s,null===s&&(s=n),e.w=y,e.h=O,e.lines=C,e.precision=t,y||(y=1),O||(O=1),(_||d)&&(y=Math.min(y,d-_)),(f||g)&&(O=Math.min(O,g-f)),e.width=y,e.innerWidth=x,e.height=O,e.fontSize=n,e.cutSx=_,e.cutSy=f,e.cutEx=d,e.cutEy=g,e.lineHeight=o,e.lineWidths=M,e.offsetY=s,e.paddingLeft=i,e.paddingRight=r,e.letterSpacing=p,e}},{key:"_draw",value:function _draw(){var t,i,r=this._calculateRenderInfo(),n=this.getPrecision();this._canvas.width=Math.ceil(r.width+this._stage.getOption("textRenderIssueMargin")),this._canvas.height=Math.ceil(r.height),this.setFontProperties(),r.fontSize>=128&&(this._context.globalAlpha=.01,this._context.fillRect(0,0,.01,.01),this._context.globalAlpha=1),(r.cutSx||r.cutSy)&&this._context.translate(-r.cutSx,-r.cutSy);for(var s=[],o=0,h=r.lines.length;o<h;o++)t=0,i=o*r.lineHeight+r.offsetY,"middle"==this._settings.verticalAlign?i+=(r.lineHeight-r.fontSize)/2:"bottom"==this._settings.verticalAlign&&(i+=r.lineHeight-r.fontSize),"right"===this._settings.textAlign?t+=r.innerWidth-r.lineWidths[o]:"center"===this._settings.textAlign&&(t+=(r.innerWidth-r.lineWidths[o])/2),t+=r.paddingLeft,s.push({text:r.lines[o],x:t,y:i,w:r.lineWidths[o]});if(this._settings.highlight){var u=this._settings.highlightColor||0,l=this._settings.highlightHeight*n||1.5*r.fontSize,_=this._settings.highlightOffset*n,d=null!==this._settings.highlightPaddingLeft?this._settings.highlightPaddingLeft*n:r.paddingLeft,f=null!==this._settings.highlightPaddingRight?this._settings.highlightPaddingRight*n:r.paddingRight;this._context.fillStyle=e.getRgbaString(u);for(var g=0;g<s.length;g++){var p=s[g];this._context.fillRect(p.x-d,p.y-r.offsetY+_,p.w+f+d,l)}}var v=null;this._settings.shadow&&(v=[this._context.shadowColor,this._context.shadowOffsetX,this._context.shadowOffsetY,this._context.shadowBlur],this._context.shadowColor=e.getRgbaString(this._settings.shadowColor),this._context.shadowOffsetX=this._settings.shadowOffsetX*n,this._context.shadowOffsetY=this._settings.shadowOffsetY*n,this._context.shadowBlur=this._settings.shadowBlur*n),this._context.fillStyle=e.getRgbaString(this._settings.textColor);for(var y=0,x=s.length;y<x;y++){var m=s[y];if(0===r.letterSpacing)this._context.fillText(m.text,m.x,m.y);else for(var k=m.text.split(""),S=m.x,C=0,T=k.length;C<T;C++)this._context.fillText(k[C],S,m.y),S+=this.measureText(k[C],r.letterSpacing)}v&&(this._context.shadowColor=v[0],this._context.shadowOffsetX=v[1],this._context.shadowOffsetY=v[2],this._context.shadowBlur=v[3]),(r.cutSx||r.cutSy)&&this._context.translate(r.cutSx,r.cutSy),this.renderInfo=r}},{key:"wrapWord",value:function wrapWord(e,t,i){var r=this._context.measureText(i).width,n=e.length,s=this._context.measureText(e).width;if(s<=t)return e;var o=Math.floor(t*n/s),h=this._context.measureText(e.substring(0,o)).width+r;if(h>t)for(;o>0&&(h=this._context.measureText(e.substring(0,o)).width+r)>t;)o-=1;else for(;o<n;){if(!((h=this._context.measureText(e.substring(0,o)).width+r)<t)){o-=1;break}o+=1}return e.substring(0,o)+(t>=r?i:"")}},{key:"wrapText",value:function wrapText(e,t,i){for(var r=e.split(/\r?\n/g),n=[],s=[],o=0;o<r.length;o++){for(var h=[],u="",l=t,_=r[o].split(" "),d=0;d<_.length;d++){var f=this.measureText(_[d],i),g=f+this.measureText(" ",i);0===d||g>l?(d>0&&(h.push(u),u=""),u+=_[d],l=t-f):(l-=g,u+=" "+_[d])}u&&(h.push(u),u=""),n=n.concat(h),o<r.length-1&&s.push(n.length)}return{l:n,n:s}}},{key:"measureText",value:function measureText(e){var t=this,i=arguments.length>1&&void 0!==arguments[1]?arguments[1]:0;return i?e.split("").reduce(function(e,r){return _newArrowCheck(this,t),e+this._context.measureText(r).width+i}.bind(this),0):this._context.measureText(e).width}}]),TextTextureRenderer}(),R=function(e){function TextTexture(e){var t;return _classCallCheck(this,TextTexture),(t=_possibleConstructorReturn(this,_getPrototypeOf(TextTexture).call(this,e)))._precision=t.stage.getOption("precision"),t}return _inherits(TextTexture,e),_createClass(TextTexture,[{key:"_getIsValid",value:function _getIsValid(){return!!this.text}},{key:"_getLookupId",value:function _getLookupId(){var e=[];return 0!==this.w&&e.push("w "+this.w),0!==this.h&&e.push("h "+this.h),"normal"!==this.fontStyle&&e.push("fS"+this.fontStyle),40!==this.fontSize&&e.push("fs"+this.fontSize),null!==this.fontFace&&e.push("ff"+(Array.isArray(this.fontFace)?this.fontFace.join(","):this.fontFace)),!0!==this.wordWrap&&e.push("wr"+(this.wordWrap?1:0)),0!==this.wordWrapWidth&&e.push("ww"+this.wordWrapWidth),""!=this.textOverflow&&e.push("to"+this.textOverflow),null!==this.lineHeight&&e.push("lh"+this.lineHeight),"alphabetic"!==this.textBaseline&&e.push("tb"+this.textBaseline),"left"!==this.textAlign&&e.push("ta"+this.textAlign),"top"!==this.verticalAlign&&e.push("va"+this.verticalAlign),null!==this.offsetY&&e.push("oy"+this.offsetY),0!==this.maxLines&&e.push("ml"+this.maxLines),".."!==this.maxLinesSuffix&&e.push("ms"+this.maxLinesSuffix),e.push("pc"+this.precision),4294967295!==this.textColor&&e.push("co"+this.textColor.toString(16)),0!==this.paddingLeft&&e.push("pl"+this.paddingLeft),0!==this.paddingRight&&e.push("pr"+this.paddingRight),!1!==this.shadow&&e.push("sh"+(this.shadow?1:0)),4278190080!==this.shadowColor&&e.push("sc"+this.shadowColor.toString(16)),0!==this.shadowOffsetX&&e.push("sx"+this.shadowOffsetX),0!==this.shadowOffsetY&&e.push("sy"+this.shadowOffsetY),5!==this.shadowBlur&&e.push("sb"+this.shadowBlur),!1!==this.highlight&&e.push("hL"+(this.highlight?1:0)),0!==this.highlightHeight&&e.push("hh"+this.highlightHeight),4278190080!==this.highlightColor&&e.push("hc"+this.highlightColor.toString(16)),null!==this.highlightOffset&&e.push("ho"+this.highlightOffset),null!==this.highlightPaddingLeft&&e.push("hl"+this.highlightPaddingLeft),null!==this.highlightPaddingRight&&e.push("hr"+this.highlightPaddingRight),null!==this.letterSpacing&&e.push("ls"+this.letterSpacing),this.cutSx&&e.push("csx"+this.cutSx),this.cutEx&&e.push("cex"+this.cutEx),this.cutSy&&e.push("csy"+this.cutSy),this.cutEy&&e.push("cey"+this.cutEy),"TX$"+e.join("|")+":"+this.text}},{key:"_getSourceLoader",value:function _getSourceLoader(){var e=this.cloneArgs();return null===e.fontFace&&(e.fontFace=this.stage.getOption("defaultFontFace")),function(t){var i=this,r=this.stage.platform.getDrawingCanvas(),n=new w(this.stage,r,e),s=n.draw();s?s.then(function(){_newArrowCheck(this,i),t(null,Object.assign({renderInfo:n.renderInfo,throttle:!1},this.stage.platform.getTextureOptionsForDrawingCanvas(r)))}.bind(this)).catch(function(e){_newArrowCheck(this,i),t(e)}.bind(this)):t(null,Object.assign({renderInfo:n.renderInfo,throttle:!1},this.stage.platform.getTextureOptionsForDrawingCanvas(r)))}}},{key:"getNonDefaults",value:function getNonDefaults(){var e=_get(_getPrototypeOf(TextTexture.prototype),"getNonDefaults",this).call(this);return""!==this.text&&(e.text=this.text),0!==this.w&&(e.w=this.w),0!==this.h&&(e.h=this.h),"normal"!==this.fontStyle&&(e.fontStyle=this.fontStyle),40!==this.fontSize&&(e.fontSize=this.fontSize),null!==this.fontFace&&(e.fontFace=this.fontFace),!0!==this.wordWrap&&(e.wordWrap=this.wordWrap),0!==this.wordWrapWidth&&(e.wordWrapWidth=this.wordWrapWidth),""!=this.textOverflow&&(e.textOverflow=this.textOverflow),null!==this.lineHeight&&(e.lineHeight=this.lineHeight),"alphabetic"!==this.textBaseline&&(e.textBaseline=this.textBaseline),"left"!==this.textAlign&&(e.textAlign=this.textAlign),"top"!==this.verticalAlign&&(e.verticalAlign=this.verticalAlign),null!==this.offsetY&&(e.offsetY=this.offsetY),0!==this.maxLines&&(e.maxLines=this.maxLines),".."!==this.maxLinesSuffix&&(e.maxLinesSuffix=this.maxLinesSuffix),this.precision!==this.stage.getOption("precision")&&(e.precision=this.precision),4294967295!==this.textColor&&(e.textColor=this.textColor),0!==this.paddingLeft&&(e.paddingLeft=this.paddingLeft),0!==this.paddingRight&&(e.paddingRight=this.paddingRight),!1!==this.shadow&&(e.shadow=this.shadow),4278190080!==this.shadowColor&&(e.shadowColor=this.shadowColor),0!==this.shadowOffsetX&&(e.shadowOffsetX=this.shadowOffsetX),0!==this.shadowOffsetY&&(e.shadowOffsetY=this.shadowOffsetY),5!==this.shadowBlur&&(e.shadowBlur=this.shadowBlur),!1!==this.highlight&&(e.highlight=this.highlight),0!==this.highlightHeight&&(e.highlightHeight=this.highlightHeight),4278190080!==this.highlightColor&&(e.highlightColor=this.highlightColor),0!==this.highlightOffset&&(e.highlightOffset=this.highlightOffset),0!==this.highlightPaddingLeft&&(e.highlightPaddingLeft=this.highlightPaddingLeft),0!==this.highlightPaddingRight&&(e.highlightPaddingRight=this.highlightPaddingRight),0!==this.letterSpacing&&(e.letterSpacing=this.letterSpacing),this.cutSx&&(e.cutSx=this.cutSx),this.cutEx&&(e.cutEx=this.cutEx),this.cutSy&&(e.cutSy=this.cutSy),this.cutEy&&(e.cutEy=this.cutEy),e}},{key:"cloneArgs",value:function cloneArgs(){var e={};return e.text=this._text,e.w=this._w,e.h=this._h,e.fontStyle=this._fontStyle,e.fontSize=this._fontSize,e.fontFace=this._fontFace,e.wordWrap=this._wordWrap,e.wordWrapWidth=this._wordWrapWidth,e.textOverflow=this._textOverflow,e.lineHeight=this._lineHeight,e.textBaseline=this._textBaseline,e.textAlign=this._textAlign,e.verticalAlign=this._verticalAlign,e.offsetY=this._offsetY,e.maxLines=this._maxLines,e.maxLinesSuffix=this._maxLinesSuffix,e.precision=this._precision,e.textColor=this._textColor,e.paddingLeft=this._paddingLeft,e.paddingRight=this._paddingRight,e.shadow=this._shadow,e.shadowColor=this._shadowColor,e.shadowOffsetX=this._shadowOffsetX,e.shadowOffsetY=this._shadowOffsetY,e.shadowBlur=this._shadowBlur,e.highlight=this._highlight,e.highlightHeight=this._highlightHeight,e.highlightColor=this._highlightColor,e.highlightOffset=this._highlightOffset,e.highlightPaddingLeft=this._highlightPaddingLeft,e.highlightPaddingRight=this._highlightPaddingRight,e.letterSpacing=this._letterSpacing,e.cutSx=this._cutSx,e.cutEx=this._cutEx,e.cutSy=this._cutSy,e.cutEy=this._cutEy,e}},{key:"text",get:function get(){return this._text},set:function set(e){this._text!==e&&(this._text=""+e,this._changed())}},{key:"w",get:function get(){return this._w},set:function set(e){this._w!==e&&(this._w=e,this._changed())}},{key:"h",get:function get(){return this._h},set:function set(e){this._h!==e&&(this._h=e,this._changed())}},{key:"fontStyle",get:function get(){return this._fontStyle},set:function set(e){this._fontStyle!==e&&(this._fontStyle=e,this._changed())}},{key:"fontSize",get:function get(){return this._fontSize},set:function set(e){this._fontSize!==e&&(this._fontSize=e,this._changed())}},{key:"fontFace",get:function get(){return this._fontFace},set:function set(e){this._fontFace!==e&&(this._fontFace=e,this._changed())}},{key:"wordWrap",get:function get(){return this._wordWrap},set:function set(e){this._wordWrap!==e&&(this._wordWrap=e,this._changed())}},{key:"wordWrapWidth",get:function get(){return this._wordWrapWidth},set:function set(e){this._wordWrapWidth!==e&&(this._wordWrapWidth=e,this._changed())}},{key:"textOverflow",get:function get(){return this._textOverflow},set:function set(e){e!=this._textOverflow&&(this._textOverflow=e,this._changed())}},{key:"lineHeight",get:function get(){return this._lineHeight},set:function set(e){this._lineHeight!==e&&(this._lineHeight=e,this._changed())}},{key:"textBaseline",get:function get(){return this._textBaseline},set:function set(e){this._textBaseline!==e&&(this._textBaseline=e,this._changed())}},{key:"textAlign",get:function get(){return this._textAlign},set:function set(e){this._textAlign!==e&&(this._textAlign=e,this._changed())}},{key:"verticalAlign",get:function get(){return this._verticalAlign},set:function set(e){this._verticalAlign!==e&&(this._verticalAlign=e,this._changed())}},{key:"offsetY",get:function get(){return this._offsetY},set:function set(e){this._offsetY!==e&&(this._offsetY=e,this._changed())}},{key:"maxLines",get:function get(){return this._maxLines},set:function set(e){this._maxLines!==e&&(this._maxLines=e,this._changed())}},{key:"maxLinesSuffix",get:function get(){return this._maxLinesSuffix},set:function set(e){this._maxLinesSuffix!==e&&(this._maxLinesSuffix=e,this._changed())}},{key:"textColor",get:function get(){return this._textColor},set:function set(e){this._textColor!==e&&(this._textColor=e,this._changed())}},{key:"paddingLeft",get:function get(){return this._paddingLeft},set:function set(e){this._paddingLeft!==e&&(this._paddingLeft=e,this._changed())}},{key:"paddingRight",get:function get(){return this._paddingRight},set:function set(e){this._paddingRight!==e&&(this._paddingRight=e,this._changed())}},{key:"shadow",get:function get(){return this._shadow},set:function set(e){this._shadow!==e&&(this._shadow=e,this._changed())}},{key:"shadowColor",get:function get(){return this._shadowColor},set:function set(e){this._shadowColor!==e&&(this._shadowColor=e,this._changed())}},{key:"shadowOffsetX",get:function get(){return this._shadowOffsetX},set:function set(e){this._shadowOffsetX!==e&&(this._shadowOffsetX=e,this._changed())}},{key:"shadowOffsetY",get:function get(){return this._shadowOffsetY},set:function set(e){this._shadowOffsetY!==e&&(this._shadowOffsetY=e,this._changed())}},{key:"shadowBlur",get:function get(){return this._shadowBlur},set:function set(e){this._shadowBlur!==e&&(this._shadowBlur=e,this._changed())}},{key:"highlight",get:function get(){return this._highlight},set:function set(e){this._highlight!==e&&(this._highlight=e,this._changed())}},{key:"highlightHeight",get:function get(){return this._highlightHeight},set:function set(e){this._highlightHeight!==e&&(this._highlightHeight=e,this._changed())}},{key:"highlightColor",get:function get(){return this._highlightColor},set:function set(e){this._highlightColor!==e&&(this._highlightColor=e,this._changed())}},{key:"highlightOffset",get:function get(){return this._highlightOffset},set:function set(e){this._highlightOffset!==e&&(this._highlightOffset=e,this._changed())}},{key:"highlightPaddingLeft",get:function get(){return this._highlightPaddingLeft},set:function set(e){this._highlightPaddingLeft!==e&&(this._highlightPaddingLeft=e,this._changed())}},{key:"highlightPaddingRight",get:function get(){return this._highlightPaddingRight},set:function set(e){this._highlightPaddingRight!==e&&(this._highlightPaddingRight=e,this._changed())}},{key:"cutSx",get:function get(){return this._cutSx},set:function set(e){this._cutSx!==e&&(this._cutSx=e,this._changed())}},{key:"cutEx",get:function get(){return this._cutEx},set:function set(e){this._cutEx!==e&&(this._cutEx=e,this._changed())}},{key:"cutSy",get:function get(){return this._cutSy},set:function set(e){this._cutSy!==e&&(this._cutSy=e,this._changed())}},{key:"cutEy",get:function get(){return this._cutEy},set:function set(e){this._cutEy!==e&&(this._cutEy=e,this._changed())}},{key:"letterSpacing",set:function set(e){this._letterSpacing!==e&&(this._letterSpacing=e,this._changed())},get:function get(){return this._letterSpacing}},{key:"precision",get:function get(){return _get(_getPrototypeOf(TextTexture.prototype),"precision",this)},set:function set(e){this.precision!==e&&(_set(_getPrototypeOf(TextTexture.prototype),"precision",e,this,!0),this._changed())}}],[{key:"renderer",value:function renderer(e,t,i){return new w(e,t,i)}}]),TextTexture}(b),L=R.prototype;L._text="",L._w=0,L._h=0,L._fontStyle="normal",L._fontSize=40,L._fontFace=null,L._wordWrap=!0,L._wordWrapWidth=0,L._textOverflow="",L._lineHeight=null,L._textBaseline="alphabetic",L._textAlign="left",L._verticalAlign="top",L._offsetY=null,L._maxLines=0,L._maxLinesSuffix="..",L._textColor=4294967295,L._paddingLeft=0,L._paddingRight=0,L._shadow=!1,L._shadowColor=4278190080,L._shadowOffsetX=0,L._shadowOffsetY=0,L._shadowBlur=5,L._highlight=!1,L._highlightHeight=0,L._highlightColor=4278190080,L._highlightOffset=0,L._highlightPaddingLeft=0,L._highlightPaddingRight=0,L._letterSpacing=0,L._cutSx=0,L._cutEx=0,L._cutSy=0,L._cutEy=0;var P=function(e){function SourceTexture(e){var t;return _classCallCheck(this,SourceTexture),(t=_possibleConstructorReturn(this,_getPrototypeOf(SourceTexture).call(this,e)))._textureSource=void 0,t}return _inherits(SourceTexture,e),_createClass(SourceTexture,[{key:"_getTextureSource",value:function _getTextureSource(){return this._textureSource}},{key:"textureSource",get:function get(){return this._textureSource},set:function set(e){e!==this._textureSource&&(e.isResultTexture&&(this._precision=this.stage.getRenderPrecision()),this._textureSource=e,this._changed())}}]),SourceTexture}(b),E=function(e){function Transition(e,t,i,r){var n;return _classCallCheck(this,Transition),(n=_possibleConstructorReturn(this,_getPrototypeOf(Transition).call(this))).manager=e,n._settings=t,n._element=i,n._getter=i.constructor.getGetter(r),n._setter=i.constructor.getSetter(r),n._merger=t.merger,n._merger||(n._merger=i.constructor.getMerger(r)),n._startValue=n._getter(n._element),n._targetValue=n._startValue,n._p=1,n._delayLeft=0,n}return _inherits(Transition,e),_createClass(Transition,[{key:"start",value:function start(e){this._startValue=this._getter(this._element),this.isAttached()?e===this._startValue?this.reset(e,1):(this._targetValue=e,this._p=0,this._delayLeft=this._settings.delay,this.emit("start"),this.add()):(this._targetValue=e,this._p=1,this._updateDrawValue())}},{key:"finish",value:function finish(){this._p<1&&(this._p=1)}},{key:"stop",value:function stop(){this.emit("stop"),this.manager.removeActive(this)}},{key:"pause",value:function pause(){this.stop()}},{key:"play",value:function play(){this.manager.addActive(this)}},{key:"reset",value:function reset(e,t){this.isAttached()?(this._startValue=this._getter(this._element),this._targetValue=e,this._p=t,this.add()):(this._startValue=this._getter(this._element),this._targetValue=e,this._p=1,this._updateDrawValue())}},{key:"_updateDrawValue",value:function _updateDrawValue(){this._setter(this._element,this.getDrawValue())}},{key:"add",value:function add(){this.manager.addActive(this)}},{key:"isAttached",value:function isAttached(){return this._element.attached}},{key:"isRunning",value:function isRunning(){return this._p<1}},{key:"progress",value:function progress(e){if(this.isAttached()||(this._p=1),this.p<1){if(this.delayLeft>0){if(this._delayLeft-=e,!(this.delayLeft<0))return;e=-this.delayLeft,this._delayLeft=0,this.emit("delayEnd")}0==this._settings.duration?this._p=1:this._p+=e/this._settings.duration,this._p>=1&&(this._p=1)}this._updateDrawValue(),this.invokeListeners()}},{key:"invokeListeners",value:function invokeListeners(){this.emit("progress",this.p),1===this.p&&this.emit("finish")}},{key:"updateTargetValue",value:function updateTargetValue(e){var t=this._settings.timingFunctionImpl(this.p);1===t?this._targetValue=e:0===t?(this._startValue=this._targetValue,this._targetValue=e):(this._startValue=e-(e-this._targetValue)/(1-t),this._targetValue=e)}},{key:"getDrawValue",value:function getDrawValue(){if(this.p>=1)return this.targetValue;var e=this._settings._timingFunctionImpl(this.p);return this._merger(this.targetValue,this.startValue,e)}},{key:"skipDelay",value:function skipDelay(){this._delayLeft=0}},{key:"startValue",get:function get(){return this._startValue}},{key:"targetValue",get:function get(){return this._targetValue}},{key:"p",get:function get(){return this._p}},{key:"delayLeft",get:function get(){return this._delayLeft}},{key:"element",get:function get(){return this._element}},{key:"settings",get:function get(){return this._settings},set:function set(e){this._settings=e}}]),Transition}(C);E.prototype.isTransition=!0;var O=function(){function ObjectList(){_classCallCheck(this,ObjectList),this._items=[],this._refs={}}return _createClass(ObjectList,[{key:"get",value:function get(){return this._items}},{key:"add",value:function add(e){this.addAt(e,this._items.length)}},{key:"addAt",value:function addAt(e,t){if(!(t>=0&&t<=this._items.length))throw new Error("addAt: The index "+t+" is out of bounds "+this._items.length);var i=this._items.indexOf(e);if(i===t)return e;-1!=i?this.setAt(e,t):(e.ref&&(this._refs[e.ref]=e),this._items.splice(t,0,e),this.onAdd(e,t))}},{key:"replaceByRef",value:function replaceByRef(e){if(!e.ref)throw new Error("replaceByRef: no ref specified in item");var t=this.getByRef(e.ref);if(!t)throw new Error("replaceByRef: no item found with reference: "+e.ref);this.replace(e,t),this.addAt(e,this._items.length)}},{key:"replace",value:function replace(e,t){var i=this.getIndex(t);if(-1===i)throw new Error("replace: The previous item does not exist");this.setAt(e,i)}},{key:"setAt",value:function setAt(e,t){if(!(t>=0&&t<=this._items.length))throw new Error("setAt: The index "+t+" is out of bounds "+this._items.length);var i=this._items.indexOf(e);if(-1!=i){if(i!==t){var r=i;r!==t&&(this._items.splice(r,1),this._items.splice(t,0,e),this.onMove(e,r,t))}}else{t<this._items.length&&this._items[t].ref&&(this._refs[this._items[t].ref]=void 0);var n=this._items[t];this._items[t]=e,e.ref&&(this._refs[e.ref]=e),this.onSet(e,t,n)}}},{key:"getAt",value:function getAt(e){return this._items[e]}},{key:"getIndex",value:function getIndex(e){return this._items.indexOf(e)}},{key:"remove",value:function remove(e){var t=this._items.indexOf(e);-1!==t&&this.removeAt(t)}},{key:"removeAt",value:function removeAt(e){var t=this._items[e];return t.ref&&(this._refs[t.ref]=void 0),this._items.splice(e,1),this.onRemove(t,e),t}},{key:"clear",value:function clear(){if(this._items.length){var e=this._items;this._items=[],this._refs={},this.onSync(e,[],[])}}},{key:"a",value:function a(e){if(t.isObjectLiteral(e)){var i=this.createItem(e);return i.patch(e),this.add(i),i}if(Array.isArray(e)){for(var r=0,n=e.length;r<n;r++)this.a(e[r]);return null}if(this.isItem(e))return this.add(e),e}},{key:"_getRefs",value:function _getRefs(){return this._refs}},{key:"getByRef",value:function getByRef(e){return this._refs[e]}},{key:"clearRef",value:function clearRef(e){delete this._refs[e]}},{key:"setRef",value:function setRef(e,t){this._refs[e]=t}},{key:"patch",value:function patch(e){t.isObjectLiteral(e)?this._setByObject(e):Array.isArray(e)&&this._setByArray(e)}},{key:"_setByObject",value:function _setByObject(e){for(var t=this._getRefs(),i=Object.keys(e),r=0,n=i.length;r<n;r++){var s=i[r],o=e[s],h=t[s];if(h)if(this.isItem(o)){if(h!==o){var u=this.getIndex(h);o.ref=s,this.setAt(o,u)}}else h.patch(o);else this.isItem(o)?(o.ref=s,this.add(o)):((h=this.createItem(o)).ref=s,h.patch(o),this.add(h))}}},{key:"_equalsArray",value:function _equalsArray(e){var t=!0;if(e.length===this._items.length)for(var i=0,r=this._items.length;i<r&&t;i++)t=t&&this._items[i]===e[i];else t=!1;return t}},{key:"_setByArray",value:function _setByArray(e){if(!this._equalsArray(e)){for(var i=0,r=this._items.length;i<r;i++)this._items[i].marker=!0;for(var n,s=[],o=0,h=e.length;o<h;o++){var u=e[o];if(this.isItem(u))u.marker=!1,s.push(u);else{var l=u.ref,_=void 0;l&&(n||(n=this._getRefs()),_=n[l]),_?_.marker=!1:_=this.createItem(u),t.isObjectLiteral(u)&&_.patch(u),s.push(_)}}this._setItems(s)}}},{key:"_setItems",value:function _setItems(e){var t=this,i=this._items;this._items=e;var r=i.filter(function(e){_newArrowCheck(this,t);var i=e.marker;return delete e.marker,i}.bind(this)),n=e.filter(function(e){return _newArrowCheck(this,t),-1===i.indexOf(e)}.bind(this));if(r.length||n.length){this._refs={};for(var s=0,o=this._items.length;s<o;s++){var h=this._items[s].ref;h&&(this._refs[h]=this._items[s])}}this.onSync(r,n,e)}},{key:"sort",value:function sort(e){var t=this._items.slice();t.sort(e),this._setByArray(t)}},{key:"onAdd",value:function onAdd(e,t){}},{key:"onRemove",value:function onRemove(e,t){}},{key:"onSync",value:function onSync(e,t,i){}},{key:"onSet",value:function onSet(e,t,i){}},{key:"onMove",value:function onMove(e,t,i){}},{key:"createItem",value:function createItem(e){throw new Error("ObjectList.createItem must create and return a new object")}},{key:"isItem",value:function isItem(e){return!1}},{key:"forEach",value:function forEach(e){this.get().forEach(e)}},{key:"first",get:function get(){return this._items[0]}},{key:"last",get:function get(){return this._items.length?this._items[this._items.length-1]:void 0}},{key:"length",get:function get(){return this._items.length}}]),ObjectList}(),z=function(e){function ElementChildList(e){var t;return _classCallCheck(this,ElementChildList),(t=_possibleConstructorReturn(this,_getPrototypeOf(ElementChildList).call(this)))._element=e,t}return _inherits(ElementChildList,e),_createClass(ElementChildList,[{key:"_connectParent",value:function _connectParent(e){var t=e.parent;if(t&&t!==this._element){var i=e.parent.childList,r=i.getIndex(e);e.ref&&(i._refs[e.ref]=void 0),i._items.splice(r,1),t.core.removeChildAt(r)}e._setParent(this._element)}},{key:"onAdd",value:function onAdd(e,t){this._connectParent(e),this._element.core.addChildAt(t,e.core)}},{key:"onRemove",value:function onRemove(e,t){e._setParent(null),this._element.core.removeChildAt(t)}},{key:"onSync",value:function onSync(e,t,i){for(var r=this,n=0,s=e.length;n<s;n++)e[n]._setParent(null);for(var o=0,h=t.length;o<h;o++)this._connectParent(t[o]);var u=function gc(e){return _newArrowCheck(this,r),e.core}.bind(this);this._element.core.syncChildren(e.map(u),t.map(u),i.map(u))}},{key:"onSet",value:function onSet(e,t,i){i._setParent(null),this._connectParent(e),this._element.core.setChildAt(t,e.core)}},{key:"onMove",value:function onMove(e,t,i){this._element.core.moveChild(t,i)}},{key:"createItem",value:function createItem(e){return e.type?new e.type(this._element.stage):this._element.stage.createElement()}},{key:"isItem",value:function isItem(e){return e.isElement}}]),ElementChildList}(O),M=function(){function Element(e){_classCallCheck(this,Element),this.stage=e,this.__id=Element.id++,this.__start(),this._hasEventListeners=!1,this.__core=new k(this),this.__ref=null,this.__attached=!1,this.__enabled=!1,this.__active=!1,this.__parent=null,this.__texture=null,this.__displayedTexture=null,this.__tags=null,this.__treeTags=null,this.__tagRoot=!1,this.__childList=null,this._w=0,this._h=0}return _createClass(Element,[{key:"__start",value:function __start(){}},{key:"setAsRoot",value:function setAsRoot(){this.__core.setAsRoot(),this._updateAttachedFlag(),this._updateEnabledFlag()}},{key:"_setParent",value:function _setParent(e){this.__parent!==e&&(this.__parent&&this._unsetTagsParent(),this.__parent=e,e&&this._setTagsParent(),this._updateAttachedFlag(),this._updateEnabledFlag(),this.isRoot&&e&&this._throwError("Root should not be added as a child! Results are unspecified!"))}},{key:"getDepth",value:function getDepth(){for(var e=0,t=this.__parent;t;)e++,t=t.__parent;return e}},{key:"getAncestor",value:function getAncestor(e){for(var t=this;e>0&&t.__parent;)t=t.__parent,e--;return t}},{key:"getAncestorAtDepth",value:function getAncestorAtDepth(e){var t=this.getDepth()-e;return t<0?null:this.getAncestor(t)}},{key:"isAncestorOf",value:function isAncestorOf(e){for(var t=e;t=t.parent;)if(this===t)return!0;return!1}},{key:"getSharedAncestor",value:function getSharedAncestor(e){var t=this,i=e,r=t.getDepth(),n=i.getDepth();r>n?t=t.getAncestor(r-n):n>r&&(i=i.getAncestor(n-r));do{if(t===i)return t;t=t.__parent,i=i.__parent}while(t&&i);return null}},{key:"_isAttached",value:function _isAttached(){return this.__parent?this.__parent.__attached:this.stage.root===this}},{key:"_isEnabled",value:function _isEnabled(){return this.__core.visible&&this.__core.alpha>0&&(this.__parent?this.__parent.__enabled:this.stage.root===this)}},{key:"_isActive",value:function _isActive(){return this._isEnabled()&&this.withinBoundsMargin}},{key:"_updateAttachedFlag",value:function _updateAttachedFlag(){var e=this._isAttached();if(this.__attached!==e){this.__attached=e,e&&this._onSetup();var t=this._children.get();if(t){var i=t.length;if(i>0)for(var r=0;r<i;r++)t[r]._updateAttachedFlag()}e?this._onAttach():this._onDetach()}}},{key:"_updateEnabledFlag",value:function _updateEnabledFlag(){var e=this._isEnabled();if(this.__enabled!==e){e?(this._onEnabled(),this._setEnabledFlag()):(this._onDisabled(),this._unsetEnabledFlag());var t=this._children.get();if(t){var i=t.length;if(i>0)for(var r=0;r<i;r++)t[r]._updateEnabledFlag()}}}},{key:"_setEnabledFlag",value:function _setEnabledFlag(){this.__enabled=!0,this._updateDimensions(),this._updateTextureCoords(),this.__texture&&this.__texture.addElement(this),this.withinBoundsMargin&&this._setActiveFlag(),this.__core.shader&&this.__core.shader.addElement(this.__core)}},{key:"_unsetEnabledFlag",value:function _unsetEnabledFlag(){var e=this;this.__active&&this._unsetActiveFlag(),this.__texture&&this.__texture.removeElement(this),this.__core.shader&&this.__core.shader.removeElement(this.__core),this._texturizer&&this.texturizer.filters.forEach(function(t){return _newArrowCheck(this,e),t.removeElement(this.__core)}.bind(this)),this.__enabled=!1}},{key:"_setActiveFlag",value:function _setActiveFlag(){this.__active=!0,this.__texture&&this.__texture.incActiveCount(),this.__texture&&this._enableTexture(),this._onActive()}},{key:"_unsetActiveFlag",value:function _unsetActiveFlag(){this.__texture&&this.__texture.decActiveCount(),this.__active=!1,this.__texture&&this._disableTexture(),this._hasTexturizer()&&this.texturizer.deactivate(),this._onInactive()}},{key:"_onSetup",value:function _onSetup(){}},{key:"_onAttach",value:function _onAttach(){}},{key:"_onDetach",value:function _onDetach(){}},{key:"_onEnabled",value:function _onEnabled(){}},{key:"_onDisabled",value:function _onDisabled(){}},{key:"_onActive",value:function _onActive(){}},{key:"_onInactive",value:function _onInactive(){}},{key:"_onResize",value:function _onResize(){}},{key:"_getRenderWidth",value:function _getRenderWidth(){return this._w?this._w:this.__displayedTexture?this.__displayedTexture.getRenderWidth():this.__texture?this.__texture.getRenderWidth():0}},{key:"_getRenderHeight",value:function _getRenderHeight(){return this._h?this._h:this.__displayedTexture?this.__displayedTexture.getRenderHeight():this.__texture?this.__texture.getRenderHeight():0}},{key:"textureIsLoaded",value:function textureIsLoaded(){return this.__texture&&this.__texture.isLoaded()}},{key:"loadTexture",value:function loadTexture(){this.__texture&&(this.__texture.load(),this.__texture.isUsed()&&this._isEnabled()||this._updateDimensions())}},{key:"_enableTextureError",value:function _enableTextureError(){var e=this.__texture.loadError;e&&this.emit("txError",e,this.__texture._source)}},{key:"_enableTexture",value:function _enableTexture(){this.__texture.isLoaded()?this._setDisplayedTexture(this.__texture):(this._setDisplayedTexture(null),this._enableTextureError())}},{key:"_disableTexture",value:function _disableTexture(){this._setDisplayedTexture(null)}},{key:"_setDisplayedTexture",value:function _setDisplayedTexture(e){var t=this.__displayedTexture;t&&e!==t&&this.__texture!==t&&t.removeElement(this);var i=this.__core.displayedTextureSource?this.__core.displayedTextureSource._source:null,r=(e?e._source:null)!==i;this.__displayedTexture=e,this._updateDimensions(),this.__displayedTexture?r&&(this._updateTextureCoords(),this.__core.setDisplayedTextureSource(this.__displayedTexture._source)):this.__core.setDisplayedTextureSource(null),r&&(this.__displayedTexture?this.emit("txLoaded",this.__displayedTexture):this.emit("txUnloaded",this.__displayedTexture))}},{key:"onTextureSourceLoaded",value:function onTextureSourceLoaded(){this.active&&this._setDisplayedTexture(this.__texture)}},{key:"onTextureSourceLoadError",value:function onTextureSourceLoadError(e){this.emit("txError",e,this.__texture._source)}},{key:"forceRenderUpdate",value:function forceRenderUpdate(){this.__core.setHasRenderUpdates(3)}},{key:"onDisplayedTextureClippingChanged",value:function onDisplayedTextureClippingChanged(){this._updateDimensions(),this._updateTextureCoords()}},{key:"onPrecisionChanged",value:function onPrecisionChanged(){this._updateDimensions()}},{key:"onDimensionsChanged",value:function onDimensionsChanged(e,t){this.texture instanceof R&&(this.texture.w=e,this.texture.h=t,this.w=e,this.h=t)}},{key:"_updateDimensions",value:function _updateDimensions(){var e=this._getRenderWidth(),t=this._getRenderHeight(),i=!1;e&&t||!this.__displayedTexture&&this.__texture&&(e=e||this.__texture.mw,t=t||this.__texture.mh,e&&t||!this.__texture.isAutosizeTexture()||(i=!0)),this.__core.setDimensions(e,t,i)&&this._onResize()}},{key:"_updateTextureCoords",value:function _updateTextureCoords(){if(this.displayedTexture&&this.displayedTexture._source){var e=this.displayedTexture,t=this.displayedTexture._source,i=0,r=0,n=1,s=1;if(e.clipping){var o,h,u,l,_=t.getRenderWidth(),d=t.getRenderHeight();o=1/_,h=1/d,u=e.pw?e.pw*o:(_-e.px)*o,l=e.ph?e.ph*h:(d-e.py)*h,i=o*=e.px,r=h*=e.py,n=n*u+o,s=s*l+h,i=Math.max(0,i),r=Math.max(0,r),n=Math.min(1,n),s=Math.min(1,s)}if(t._flipTextureY){var f=s;s=r,r=f}this.__core.setTextureCoords(i,r,n,s)}}},{key:"getCornerPoints",value:function getCornerPoints(){return this.__core.getCornerPoints()}},{key:"_unsetTagsParent",value:function _unsetTagsParent(){var e=this;this.__tags&&this.__tags.forEach(function(t){_newArrowCheck(this,e);for(var i=this;i=i.__parent;){if(i.__treeTags.get(t).delete(this),i.__tagRoot)break}}.bind(this));var i=null,r=0;if(this.__treeTags&&!this.__tagRoot&&(r=(i=t.iteratorToArray(this.__treeTags.keys())).length)>0)for(var n=0;n<r;n++)for(var s=this.__treeTags.get(i[n]),o=this,h=function _loop(){var e=o.__treeTags.get(i[n]);if(s.forEach((function(t){e.delete(t)})),o.__tagRoot)return"break"};o=o.__parent;){if("break"===h())break}}},{key:"_setTagsParent",value:function _setTagsParent(){var e=this;this.__tags&&this.__tags.forEach(function(t){_newArrowCheck(this,e);for(var i=this;i=i.__parent;){i.__treeTags||(i.__treeTags=new Map);var r=i.__treeTags.get(t);if(r||(r=new Set,i.__treeTags.set(t,r)),r.add(this),i.__tagRoot)break}}.bind(this)),this.__treeTags&&this.__treeTags.size&&(this.__tagRoot||this.__treeTags.forEach(function(t,i){_newArrowCheck(this,e);for(var r=this,n=function _loop2(){r.__tagRoot,r.__treeTags||(r.__treeTags=new Map);var e=r.__treeTags.get(i);e||(e=new Set,r.__treeTags.set(i,e)),t.forEach((function(t){e.add(t)}))};!r.__tagRoot&&(r=r.__parent);)n()}.bind(this)))}},{key:"_getByTag",value:function _getByTag(e){if(!this.__treeTags)return[];var i=this.__treeTags.get(e);return i?t.setToArray(i):[]}},{key:"getTags",value:function getTags(){return this.__tags?this.__tags:[]}},{key:"setTags",value:function setTags(e){var t=this;e=e.reduce(function(e,i){return _newArrowCheck(this,t),e.concat(i.split(" "))}.bind(this),[]),this.__ref&&e.push(this.__ref);var i,r=e.length,n=[],s=[];for(i=0;i<r;i++)this.hasTag(e[i])||s.push(e[i]);var o=this.tags||[];for(r=o.length,i=0;i<r;i++)-1==e.indexOf(o[i])&&n.push(o[i]);for(i=0;i<n.length;i++)this.removeTag(n[i]);for(i=0;i<s.length;i++)this.addTag(s[i])}},{key:"addTag",value:function addTag(e){if(-1===e.indexOf(" "))t.isUcChar(e.charCodeAt(0))&&this._throwError("Tag may not start with an upper case character."),this._addTag(e);else for(var i=e.split(" "),r=0,n=i.length;r<n;r++){var s=i[r];t.isUcChar(s.charCodeAt(0))&&this._throwError("Tag may not start with an upper case character."),this._addTag(s)}}},{key:"_addTag",value:function _addTag(e){if(this.__tags||(this.__tags=[]),-1===this.__tags.indexOf(e)){this.__tags.push(e);var t=this.__parent;if(t)do{t.__treeTags||(t.__treeTags=new Map);var i=t.__treeTags.get(e);i||(i=new Set,t.__treeTags.set(e,i)),i.add(this)}while(!t.__tagRoot&&(t=t.__parent))}}},{key:"removeTag",value:function removeTag(e){var t=this.__tags.indexOf(e);if(-1!==t){this.__tags.splice(t,1);var i=this.__parent;if(i)do{var r=i.__treeTags.get(e);r&&r.delete(this)}while(!i.__tagRoot&&(i=i.__parent))}}},{key:"hasTag",value:function hasTag(e){return this.__tags&&-1!==this.__tags.indexOf(e)}},{key:"_tag",value:function _tag(e){if(-1!==e.indexOf("."))return this.mtag(e)[0];if(this.__treeTags){var t=this.__treeTags.get(e);if(t){var i=t.values().next();return i?i.value:void 0}}}},{key:"mtag",value:function mtag(e){if(e.indexOf(".")>=0){for(var t=e.split("."),i=this._getByTag(t[0]),r=1,n=t.length;i.length&&r<n;){for(var s=[],o=0,h=i.length;o<h;o++)s=s.concat(i[o]._getByTag(t[r]));i=s,r++}return i}return this._getByTag(e)}},{key:"stag",value:function stag(e,t){for(var r=this.mtag(e),n=r.length,s=0;s<n;s++)i.patchObject(r[s],t)}},{key:"sel",value:function sel(e){var t=this.select(e);return t.length?t[0]:void 0}},{key:"select",value:function select(e){if(-1!==e.indexOf(",")){for(var t=e.split(","),i=[],r=0;r<t.length;r++)i=i.concat(this._select(t[r]));return i}return this._select(e)}},{key:"_select",value:function _select(e){if(""===e)return[this];var t,i=e.indexOf("."),r=e.indexOf(">");return-1===i&&-1===r?this.mtag(e):(0===r?(t=!0,e=e.substr(1)):0===i?(t=!1,e=e.substr(1)):t=!1,this._selectChilds(e,t))}},{key:"_selectChilds",value:function _selectChilds(e,t){var i=e.indexOf("."),r=e.indexOf(">");if(-1===i&&-1===r){if(t){var n=this.getByRef(e);return n?[n]:[]}return this.mtag(e)}if(-1===r||-1!==i&&i<r){var s,o=e.substr(0,i);if(t){var h=this.getByRef(o);s=h?[h]:[]}else s=this.mtag(o);for(var u=[],l=e.substr(i+1),_=0,d=s.length;_<d;_++)u=u.concat(s[_]._selectChilds(l,!1));return u}var f,g=e.substr(0,r);if(t){var p=this.getByRef(g);f=p?[p]:[]}else f=this.mtag(g);for(var v=[],y=e.substr(r+1),x=0,m=f.length;x<m;x++)v=v.concat(f[x]._selectChilds(y,!0));return v}},{key:"getByRef",value:function getByRef(e){return this.childList.getByRef(e)}},{key:"getLocationString",value:function getLocationString(){var e;e=this.__parent?this.__parent._children.getIndex(this):"R";var t=this.getTags(),i=this.__parent?this.__parent.getLocationString():"";return this.ref?i+=":["+e+"]"+this.ref:t.length?i+=":["+e+"]"+t.join(","):i+=":["+e+"]#"+this.id,i}},{key:"toString",value:function toString(){var e=this.getSettings();return Element.getPrettyString(e,"")}},{key:"getSettings",value:function getSettings(){var e=this,t=this.getNonDefaults(),i=this._children.get();if(i){var r=i.length;if(r){for(var n=[],s=!1,o=0;o<r;o++)n.push(i[o].getSettings()),s=s||!i[o].ref;s?t.children=n:(t.children={},n.forEach(function(i){_newArrowCheck(this,e),t.children[i.ref]=i}.bind(this)))}}return t.id=this.id,t}},{key:"getNonDefaults",value:function getNonDefaults(){var e={};if(this.constructor!==Element&&(e.type=this.constructor.name),this.__ref&&(e.ref=this.__ref),this.__tags&&this.__tags.length&&(e.tags=this.__tags),0!==this.x&&(e.x=this.x),0!==this.y&&(e.y=this.y),0!==this.w&&(e.w=this.w),0!==this.h&&(e.h=this.h),this.scaleX===this.scaleY?1!==this.scaleX&&(e.scale=this.scaleX):(1!==this.scaleX&&(e.scaleX=this.scaleX),1!==this.scaleY&&(e.scaleY=this.scaleY)),this.pivotX===this.pivotY?.5!==this.pivotX&&(e.pivot=this.pivotX):(.5!==this.pivotX&&(e.pivotX=this.pivotX),.5!==this.pivotY&&(e.pivotY=this.pivotY)),this.mountX===this.mountY?0!==this.mountX&&(e.mount=this.mountX):(0!==this.mountX&&(e.mountX=this.mountX),0!==this.mountY&&(e.mountY=this.mountY)),1!==this.alpha&&(e.alpha=this.alpha),this.visible||(e.visible=!1),0!==this.rotation&&(e.rotation=this.rotation),this.colorUl===this.colorUr&&this.colorBl===this.colorBr&&this.colorUl===this.colorBl?4294967295!==this.colorUl&&(e.color=this.colorUl.toString(16)):(4294967295!==this.colorUl&&(e.colorUl=this.colorUl.toString(16)),4294967295!==this.colorUr&&(e.colorUr=this.colorUr.toString(16)),4294967295!==this.colorBl&&(e.colorBl=this.colorBl.toString(16)),4294967295!==this.colorBr&&(e.colorBr=this.colorBr.toString(16))),this.zIndex&&(e.zIndex=this.zIndex),this.forceZIndexContext&&(e.forceZIndexContext=!0),this.clipping&&(e.clipping=this.clipping),this.clipbox||(e.clipbox=this.clipbox),this.__texture){var i=this.__texture.getNonDefaults();Object.keys(i).length&&(e.texture=i)}if(this.shader&&t.isFunction(this.shader.getNonDefaults)){var r=this.shader.getNonDefaults();Object.keys(r).length&&(e.shader=r)}return this._hasTexturizer()&&(this.texturizer.enabled&&(e.renderToTexture=this.texturizer.enabled),this.texturizer.lazy&&(e.renderToTextureLazy=this.texturizer.lazy),this.texturizer.colorize&&(e.colorizeResultTexture=this.texturizer.colorize),this.texturizer.renderOffscreen&&(e.renderOffscreen=this.texturizer.renderOffscreen)),e}},{key:"_enableWithinBoundsMargin",value:function _enableWithinBoundsMargin(){this.__enabled&&this._setActiveFlag()}},{key:"_disableWithinBoundsMargin",value:function _disableWithinBoundsMargin(){this.__active&&this._unsetActiveFlag()}},{key:"hasChildren",value:function hasChildren(){return this._allowChildrenAccess()&&this.__childList&&this.__childList.length>0}},{key:"_allowChildrenAccess",value:function _allowChildrenAccess(){return!0}},{key:"add",value:function add(e){return this.childList.a(e)}},{key:"enableTextTexture",value:function enableTextTexture(){return this.texture&&this.texture instanceof R||(this.texture=new R(this.stage),this.texture.w||this.texture.h||(this.texture.w=this.w,this.texture.h=this.h)),this.texture}},{key:"forceUpdate",value:function forceUpdate(){this.__core._setHasUpdates()}},{key:"_hasTexturizer",value:function _hasTexturizer(){return!!this.__core._texturizer}},{key:"getTexture",value:function getTexture(){return this.texturizer._getTextureSource()}},{key:"patch",value:function patch(e){for(var r=Object.keys(e),n=0,s=r.length;n<s;n++){var o=r[n],h=e[o],u=o.charCodeAt(0);if(t.isUcChar(u)){var l=this.getByRef(o);if(l)void 0===h?l.parent&&l.parent.childList.remove(l):t.isObjectLiteral(h)?l.patch(h):h.isElement?(h.ref=o,this.childList.replace(h,l)):this._throwError("Unexpected value for path: "+o);else if(void 0!==h){var _=void 0;t.isObjectLiteral(h)?(_=this.childList.createItem(h)).patch(h):t.isObject(h)&&(_=h),_.isElement&&(_.ref=o),this.childList.a(_)}}else i.patchObjectProperty(this,o,h)}}},{key:"_throwError",value:function _throwError(e){throw new Error(this.constructor.name+" ("+this.getLocationString()+"): "+e)}},{key:"animation",value:function animation(e){return this.stage.animations.createAnimation(this,e)}},{key:"transition",value:function transition(e){var t=arguments.length>1&&void 0!==arguments[1]?arguments[1]:null;return null===t?this._getTransition(e):(this._setTransition(e,t),null)}},{key:"fastForward",value:function fastForward(e){if(this._transitions){var t=this._transitions[e];t&&t.isTransition&&t.finish()}}},{key:"_getTransition",value:function _getTransition(e){this._transitions||(this._transitions={});var t=this._transitions[e];return t?t.isTransitionSettings&&(t=new E(this.stage.transitions,t,this,e)):t=new E(this.stage.transitions,this.stage.transitions.defaultTransitionSettings,this,e),this._transitions[e]=t,t}},{key:"_setTransition",value:function _setTransition(e,i){if(i){t.isObjectLiteral(i)&&(i=this.stage.transitions.createSettings(i)),this._transitions||(this._transitions={});var r=this._transitions[e];if(r&&r.isTransition)return r.settings=i,r;this._transitions[e]=i}else this._removeTransition(e)}},{key:"_removeTransition",value:function _removeTransition(e){this._transitions&&delete this._transitions[e]}},{key:"getSmooth",value:function getSmooth(e,t){var i=this._getTransition(e);return i&&i.isAttached()?i.targetValue:t}},{key:"setSmooth",value:function setSmooth(e,t,i){i&&this._setTransition(e,i);var r=this._getTransition(e);return r.start(t),r}},{key:"toJSON",value:function toJSON(){var e=["".concat(this.constructor.name)],t=_defineProperty({},e,{});return this.hasChildren()?Element.collectChildren(t[e],this.__childList):t[e]=_objectSpread2({},Element.getProperties(this)),t}},{key:"id",get:function get(){return this.__id}},{key:"ref",set:function set(e){if(this.__ref!==e){var i=e.charCodeAt(0);t.isUcChar(i)||this._throwError("Ref must start with an upper case character: "+e),null!==this.__ref&&(this.removeTag(this.__ref),this.__parent&&this.__parent.__childList.clearRef(this.__ref)),this.__ref=e,this.__ref&&(this._addTag(this.__ref),this.__parent&&this.__parent.__childList.setRef(this.__ref,this))}},get:function get(){return this.__ref}},{key:"core",get:function get(){return this.__core}},{key:"isRoot",get:function get(){return this.__core.isRoot}},{key:"attached",get:function get(){return this.__attached}},{key:"enabled",get:function get(){return this.__enabled}},{key:"active",get:function get(){return this.__active}},{key:"renderWidth",get:function get(){return this.__enabled?this.__core.getRenderWidth():this._getRenderWidth()}},{key:"renderHeight",get:function get(){return this.__enabled?this.__core.getRenderHeight():this._getRenderHeight()}},{key:"finalX",get:function get(){return this.__core.x}},{key:"finalY",get:function get(){return this.__core.y}},{key:"finalW",get:function get(){return this.__core.w}},{key:"finalH",get:function get(){return this.__core.h}},{key:"texture",get:function get(){return this.__texture},set:function set(e){var r;if(t.isObjectLiteral(e))(r=e.type?new e.type(this.stage):this.texture)&&i.patchObject(r,e);else if(e)if(e.isTexture)r=e;else{if(!e.isTextureSource)return void console.error("Please specify a texture type.");(r=new P(this.stage)).textureSource=e}else r=null;var n=this.__texture;r!==n&&(this.__texture=r,this.__texture?this.__enabled&&(this.__texture.addElement(this),this.withinBoundsMargin&&(this.__texture.isLoaded()?this._setDisplayedTexture(this.__texture):this._enableTextureError())):this._setDisplayedTexture(null),n&&n!==this.__displayedTexture&&n.removeElement(this),this._updateDimensions())}},{key:"displayedTexture",get:function get(){return this.__displayedTexture}},{key:"tag",get:function get(){return this._tag},set:function set(e){this.tags=e}},{key:"tagRoot",get:function get(){return this.__tagRoot},set:function set(e){this.__tagRoot!==e&&(e?this._unsetTagsParent():this._setTagsParent(),this.__tagRoot=e)}},{key:"withinBoundsMargin",get:function get(){return this.__core._withinBoundsMargin}},{key:"boundsMargin",set:function set(e){if(!Array.isArray(e)&&null!==e)throw new Error("boundsMargin should be an array of left-top-right-bottom values or null (inherit margin)");this.__core.boundsMargin=e},get:function get(){return this.__core.boundsMargin}},{key:"x",get:function get(){return this.__core.offsetX},set:function set(e){this.__core.offsetX=e}},{key:"y",get:function get(){return this.__core.offsetY},set:function set(e){this.__core.offsetY=e}},{key:"w",get:function get(){return this._w},set:function set(e){t.isFunction(e)?(this._w=0,this.__core.funcW=e):(e=Math.max(e,0),this._w!==e&&(this.__core.disableFuncW(),this._w=e,this._updateDimensions()))}},{key:"h",get:function get(){return this._h},set:function set(e){t.isFunction(e)?(this._h=0,this.__core.funcH=e):(e=Math.max(e,0),this._h!==e&&(this.__core.disableFuncH(),this._h=e,this._updateDimensions()))}},{key:"scaleX",get:function get(){return this.__core.scaleX},set:function set(e){this.__core.scaleX=e}},{key:"scaleY",get:function get(){return this.__core.scaleY},set:function set(e){this.__core.scaleY=e}},{key:"scale",get:function get(){return this.__core.scale},set:function set(e){this.__core.scale=e}},{key:"pivotX",get:function get(){return this.__core.pivotX},set:function set(e){this.__core.pivotX=e}},{key:"pivotY",get:function get(){return this.__core.pivotY},set:function set(e){this.__core.pivotY=e}},{key:"pivot",get:function get(){return this.__core.pivot},set:function set(e){this.__core.pivot=e}},{key:"mountX",get:function get(){return this.__core.mountX},set:function set(e){this.__core.mountX=e}},{key:"mountY",get:function get(){return this.__core.mountY},set:function set(e){this.__core.mountY=e}},{key:"mount",get:function get(){return this.__core.mount},set:function set(e){this.__core.mount=e}},{key:"rotation",get:function get(){return this.__core.rotation},set:function set(e){this.__core.rotation=e}},{key:"alpha",get:function get(){return this.__core.alpha},set:function set(e){this.__core.alpha=e}},{key:"visible",get:function get(){return this.__core.visible},set:function set(e){this.__core.visible=e}},{key:"colorUl",get:function get(){return this.__core.colorUl},set:function set(e){this.__core.colorUl=e}},{key:"colorUr",get:function get(){return this.__core.colorUr},set:function set(e){this.__core.colorUr=e}},{key:"colorBl",get:function get(){return this.__core.colorBl},set:function set(e){this.__core.colorBl=e}},{key:"colorBr",get:function get(){return this.__core.colorBr},set:function set(e){this.__core.colorBr=e}},{key:"color",get:function get(){return this.__core.colorUl},set:function set(e){this.colorUl===e&&this.colorUr===e&&this.colorBl===e&&this.colorBr===e||(this.colorUl=e,this.colorUr=e,this.colorBl=e,this.colorBr=e)}},{key:"colorTop",get:function get(){return this.colorUl},set:function set(e){this.colorUl===e&&this.colorUr===e||(this.colorUl=e,this.colorUr=e)}},{key:"colorBottom",get:function get(){return this.colorBl},set:function set(e){this.colorBl===e&&this.colorBr===e||(this.colorBl=e,this.colorBr=e)}},{key:"colorLeft",get:function get(){return this.colorUl},set:function set(e){this.colorUl===e&&this.colorBl===e||(this.colorUl=e,this.colorBl=e)}},{key:"colorRight",get:function get(){return this.colorUr},set:function set(e){this.colorUr===e&&this.colorBr===e||(this.colorUr=e,this.colorBr=e)}},{key:"zIndex",get:function get(){return this.__core.zIndex},set:function set(e){this.__core.zIndex=e}},{key:"forceZIndexContext",get:function get(){return this.__core.forceZIndexContext},set:function set(e){this.__core.forceZIndexContext=e}},{key:"clipping",get:function get(){return this.__core.clipping},set:function set(e){this.__core.clipping=e}},{key:"clipbox",get:function get(){return this.__core.clipbox},set:function set(e){this.__core.clipbox=e}},{key:"tags",get:function get(){return this.getTags()},set:function set(e){Array.isArray(e)||(e=[e]),this.setTags(e)}},{key:"t",set:function set(e){this.tags=e}},{key:"_children",get:function get(){return this.__childList||(this.__childList=new z(this,!1)),this.__childList}},{key:"childList",get:function get(){return this._allowChildrenAccess()||this._throwError("Direct access to children is not allowed in "+this.getLocationString()),this._children}},{key:"children",get:function get(){return this.childList.get()},set:function set(e){this.childList.patch(e)}},{key:"p",get:function get(){return this.__parent}},{key:"parent",get:function get(){return this.__parent}},{key:"src",get:function get(){return this.texture&&this.texture instanceof A?this.texture._src:void 0},set:function set(e){var t=new A(this.stage);t.src=e,this.texture=t}},{key:"mw",set:function set(e){this.texture?(this.texture.mw=e,this._updateDimensions()):this._throwError("Please set mw after setting a texture.")}},{key:"mh",set:function set(e){this.texture?(this.texture.mh=e,this._updateDimensions()):this._throwError("Please set mh after setting a texture.")}},{key:"rect",get:function get(){return this.texture===this.stage.rectangleTexture},set:function set(e){this.texture=e?this.stage.rectangleTexture:null}},{key:"text",get:function get(){return this.texture&&this.texture instanceof R?this.texture:null},set:function set(e){this.texture&&this.texture instanceof R||this.enableTextTexture(),t.isString(e)?this.texture.text=e:this.texture.patch(e)}},{key:"onUpdate",set:function set(e){this.__core.onUpdate=e}},{key:"onAfterCalcs",set:function set(e){this.__core.onAfterCalcs=e}},{key:"onAfterUpdate",set:function set(e){this.__core.onAfterUpdate=e}},{key:"shader",get:function get(){return this.__core.shader},set:function set(e){if(t.isObjectLiteral(e)&&!e.type)this.shader&&this.shader.patch(e);else{var i=T.create(this.stage,e);this.__enabled&&this.__core.shader&&this.__core.shader.removeElement(this.__core),this.__core.shader=i,this.__enabled&&this.__core.shader&&this.__core.shader.addElement(this.__core)}}},{key:"renderToTexture",get:function get(){return this.rtt},set:function set(e){this.rtt=e}},{key:"rtt",get:function get(){return this._hasTexturizer()&&this.texturizer.enabled},set:function set(e){this.texturizer.enabled=e}},{key:"rttLazy",get:function get(){return this._hasTexturizer()&&this.texturizer.lazy},set:function set(e){this.texturizer.lazy=e}},{key:"renderOffscreen",get:function get(){return this._hasTexturizer()&&this.texturizer.renderOffscreen},set:function set(e){this.texturizer.renderOffscreen=e}},{key:"colorizeResultTexture",get:function get(){return this._hasTexturizer()&&this.texturizer.colorize},set:function set(e){this.texturizer.colorize=e}},{key:"texturizer",get:function get(){return this.__core.texturizer}},{key:"transitions",set:function set(e){var t=this;Object.keys(e).forEach(function(i){_newArrowCheck(this,t),this.transition(i,e[i])}.bind(this))}},{key:"smooth",set:function set(e){var t=this;Object.keys(e).forEach(function(i){_newArrowCheck(this,t);var r=e[i];Array.isArray(r)?this.setSmooth(i,r[0],r[1]):this.setSmooth(i,r)}.bind(this))}},{key:"flex",get:function get(){return this.__core.flex},set:function set(e){this.__core.flex=e}},{key:"flexItem",get:function get(){return this.__core.flexItem},set:function set(e){this.__core.flexItem=e}}],[{key:"getPrettyString",value:function getPrettyString(e,i){var r=e.children;delete e.children;var n=["color","colorUl","colorUr","colorBl","colorBr"],s=JSON.stringify(e,(function(e,t){return-1!==n.indexOf(e)?"COLOR["+t.toString(16)+"]":t}));if(s=s.replace(/"COLOR\[([a-f0-9]{1,8})\]"/g,"0x$1"),r){var o="";if(t.isObjectLiteral(r)){var h=Object.keys(r);o="";for(var u=0,l=h.length;u<l;u++)o+="\n".concat(i,'  "').concat(h[u],'":'),delete r[h[u]].ref,o+=Element.getPrettyString(r[h[u]],i+"  ")+(u<l-1?",":"");var _="{}"===s;s=s.substr(0,s.length-1)+(_?"":",")+o+"\n"+i+"}"}else{var d=r.length;o="[";for(var f=0;f<d;f++)o+=Element.getPrettyString(r[f],i+"  ")+(f<d-1?",":"")+"\n";o+=i+"]}";var g="{}"===s;s=s.substr(0,s.length-1)+(g?"":",")+'"children":\n'+i+o+"}"}}return s}},{key:"getGetter",value:function getGetter(e){var t=Element.PROP_GETTERS.get(e);return t||(t=new Function("obj","return obj."+e),Element.PROP_GETTERS.set(e,t)),t}},{key:"getSetter",value:function getSetter(e){var t=Element.PROP_SETTERS.get(e);return t||(t=new Function("obj","v","obj."+e+" = v"),Element.PROP_SETTERS.set(e,t)),t}},{key:"isColorProperty",value:function isColorProperty(e){return e.toLowerCase().indexOf("color")>=0}},{key:"getMerger",value:function getMerger(t){return Element.isColorProperty(t)?e.mergeColors:e.mergeNumbers}},{key:"collectChildren",value:function collectChildren(e,t){for(var i=t,r=0,n=i.length;r<n;r++){var s=i.getAt(r),o="".concat(s.__ref||"Element-".concat(s.id)),h=this.getProperties(s);e[o]=_objectSpread2({},h),s.hasChildren()&&(e[o].children={},this.collectChildren(e[o].children,s.__childList))}}},{key:"getProperties",value:function getProperties(e){for(var t={},i=["alpha","active","attached","boundsMargin","color","clipping","enabled","h","id","isComponent","mount","mountY","mountX","pivot","pivotX","pivotY","ref","renderOfScreen","renderToTexture","scale","scaleX","scaleY","state","tag","visible","w","x","y","zIndex","!!flex","!!flexItem","hasFocus()","hasFinalFocus()"],r=i.length;r--;){var n=i[r];/^!{2}/.test(n)?t[n=n.substring(2,n.length)]=!!e[n]:/\(\)$/.test(n)?"function"==typeof e[n=n.substring(0,n.length-2)]&&(t[n]=e[n]()):t[n]=e[n]}return _objectSpread2({},t,{},e.getNonDefaults())}}]),Element}();C.addAsMixin(M),M.prototype.isElement=1,M.id=1,M.PROP_GETTERS=new Map,M.PROP_SETTERS=new Map;var F=function(){function StateMachine(){_classCallCheck(this,StateMachine),StateMachine.setupStateMachine(this)}return _createClass(StateMachine,[{key:"fire",value:function fire(e){if(this._hasMethod(e)){for(var t=arguments.length,i=new Array(t>1?t-1:0),r=1;r<t;r++)i[r-1]=arguments[r];return this[e].apply(this,i)}}},{key:"_getState",value:function _getState(){return this._state.__path}},{key:"_inState",value:function _inState(e){var t=arguments.length>1&&void 0!==arguments[1]?arguments[1]:this._state.__path,i=this._sm.getStateByPath(e),r=this._sm.getStateByPath(t),n=i.__level,s=StateMachine._getStateAtLevel(r,n);return s===i}},{key:"_hasMember",value:function _hasMember(e){return!!this.constructor.prototype[e]}},{key:"_hasMethod",value:function _hasMethod(e){var t=this.constructor.prototype[e];return!!t&&"function"==typeof t}},{key:"_setState",value:function _setState(e,t){var i=++this._setStateCounter;if(this._setStateId=i,this._state.__path!==e){var r=this._sm._stateMap[e];r||(r=this._sm.getStateByPath(e));var n=this._state,s=r.prototype.$enter!==this._state.prototype.$enter,o=r.prototype.$exit!==this._state.prototype.$exit;if(s||o){var h=StateMachine._getSharedState(this._state,r),u={newState:r.__path,prevState:n.__path,sharedState:h.__path},l=h.__level;if(o)for(var _=StateMachine._getStatesUntilLevel(this._state,l),d=0,f=_.length;d<f;d++){if(this.__setState(_[d]),this._callExit(this._state,t,u),this._setStateId!==i)return}if(s)for(var g=StateMachine._getStatesUntilLevel(r,l).reverse(),p=0,v=g.length;p<v;p++){if(this.__setState(g[p]),this._callEnter(this._state,t,u),this._setStateId!==i)return}}if(this.__setState(r),this._changedState){var y={newState:r.__path,prevState:n.__path};t?this._changedState.apply(this,[y].concat(_toConsumableArray(t))):this._changedState(y)}if(this._onStateChange){var x={newState:r.__path,prevState:n.__path};this._onStateChange(x)}}}},{key:"_callEnter",value:function _callEnter(e){var t=arguments.length>1&&void 0!==arguments[1]?arguments[1]:[],i=arguments.length>2?arguments[2]:void 0,r=!!e.__parent;e.prototype.$enter&&(r&&e.__parent.prototype.$enter===e.prototype.$enter||e.prototype.$enter.apply(this,[i].concat(_toConsumableArray(t))))}},{key:"_callExit",value:function _callExit(e){var t=arguments.length>1&&void 0!==arguments[1]?arguments[1]:[],i=arguments.length>2?arguments[2]:void 0,r=!!e.__parent;e.prototype.$exit&&(r&&e.__parent.prototype.$exit===e.prototype.$exit||e.prototype.$exit.apply(this,[i].concat(_toConsumableArray(t))))}},{key:"__setState",value:function __setState(e){this._state=e,this._stateIndex=e.__index,this.constructor=e}},{key:"_initStateMachine",value:function _initStateMachine(){this._state=null,this._stateIndex=0,this._setStateCounter=0,this._sm=this._routedType._sm,this.__setState(this._sm.getStateByPath(""));var e={newState:"",prevState:void 0,sharedState:void 0};this._callEnter(this._state,[],e),this._onStateChange=void 0}},{key:"_getMostSpecificHandledMember",value:function _getMostSpecificHandledMember(e){var t=this._state;do{for(var i=0,r=e.length;i<r;i++){var n=e[i];if(t.__parent){if(this[I.getStateMemberAlias(t.__path,n)])return n}else if(t.prototype[n])return n}t=t.__parent}while(t)}}],[{key:"setupStateMachine",value:function setupStateMachine(e){var t=e.constructor,i=StateMachine.create(t);Object.setPrototypeOf(e,i.prototype),e.constructor=t,e._initStateMachine()}},{key:"create",value:function create(e){if(!e.hasOwnProperty("_sm")){var t=new I(e);e._sm=t}return e._sm.router}},{key:"_getStatesUntilLevel",value:function _getStatesUntilLevel(e,t){for(var i=[];e.__level>t;)i.push(e),e=e.__parent;return i}},{key:"_getSharedState",value:function _getSharedState(e,t){for(var i=StateMachine._getAncestorStates(e),r=StateMachine._getAncestorStates(t),n=Math.min(i.length,r.length),s=0;s<n;s++)if(i[s]!==r[s])return i[s-1];return i[n-1]}},{key:"_getAncestorStates",value:function _getAncestorStates(e){var t=[];do{t.push(e)}while(e=e.__parent);return t.reverse()}},{key:"_getStateAtLevel",value:function _getStateAtLevel(e,t){if(!(t>e.__level)){for(;t<e.__level;)e=e.__parent;return e}}}]),StateMachine}(),I=function(){function StateMachineType(e){_classCallCheck(this,StateMachineType),this._type=e,this._router=null,this.init()}return _createClass(StateMachineType,[{key:"init",value:function init(){this._router=this._createRouter(),this._stateMap=this._getStateMap(),this._addStateMemberDelegatorsToRouter()}},{key:"_createRouter",value:function _createRouter(){var e=this._type,t=function(t){function StateMachineRouter(){var t;if(_classCallCheck(this,StateMachineRouter),!(t=_possibleConstructorReturn(this,_getPrototypeOf(StateMachineRouter).apply(this,arguments))).constructor.hasOwnProperty("_isRouter"))throw new Error("You need to extend ".concat(e.name,".original instead of ").concat(e.name,"."));return t}return _inherits(StateMachineRouter,t),StateMachineRouter}(e);return t._isRouter=!0,t.prototype._routedType=e,t.original=e,this._mixinStateMachineMethods(t),t}},{key:"_mixinStateMachineMethods",value:function _mixinStateMachineMethods(e){for(var t=Object.getOwnPropertyNames(F.prototype),i=0,r=t.length;i<r;i++){var n=t[i];if("constructor"!==n){var s=Object.getOwnPropertyDescriptor(F.prototype,n);Object.defineProperty(e.prototype,n,s)}}}},{key:"_addStateMemberDelegatorsToRouter",value:function _addStateMemberDelegatorsToRouter(){var e=this;this._getAllMemberNames().forEach(function(t){_newArrowCheck(this,e),this._addMemberRouter(t)}.bind(this))}},{key:"_addMemberRouter",value:function _addMemberRouter(e){var t=this,i=Object.keys(this._stateMap),r=[],n=[];i.forEach(function(i,s){_newArrowCheck(this,t);var o=this._stateMap[i],h=this._getDescriptor(o,e);if(h){r[s]=h;var u=StateMachineType.getStateMemberAlias(h._source.__path,e);n[s]=u,this._router.prototype.hasOwnProperty(u)||Object.defineProperty(this._router.prototype,u,h)}else r[s]=null,n[s]=null}.bind(this));var s=void 0;switch(r.forEach(function(i){if(_newArrowCheck(this,t),i){var r=this._getDescriptorType(i);if(s&&s!==r)return void console.warn("Member ".concat(e," in ").concat(this._type.name," has inconsistent types."));s=r}}.bind(this)),s){case"method":this._addMethodRouter(e,r,n);break;case"getter":this._addGetterSetterRouters(e);break;case"property":console.warn("Fixed properties are not supported; please use a getter instead!")}}},{key:"_getDescriptor",value:function _getDescriptor(e,t){var i=this,r=arguments.length>2&&void 0!==arguments[2]?arguments[2]:function(){return _newArrowCheck(this,i),!0}.bind(this),n=e,s=e;do{var o=Object.getOwnPropertyDescriptor(n.prototype,t);if(o&&r(o))return o._source=s,o;(n=Object.getPrototypeOf(n))&&n.hasOwnProperty("__state")&&(s=n)}while(n&&n.prototype)}},{key:"_getDescriptorType",value:function _getDescriptorType(e){return e.get||e.set?"getter":"function"==typeof e.value?"method":"property"}},{key:"_addMethodRouter",value:function _addMethodRouter(e,t,i){for(var r=["//@ sourceURL=StateMachineRouter.js","const i = this._stateIndex;"],n=i[0],s=StateMachineType._supportsSpread(),o=1,h=i.length;o<h;o++){var u=i[o];u!==n&&(n?s?r.push("if (i < ".concat(o,') return this["').concat(n,'"](...arguments); else')):r.push("if (i < ".concat(o,') return this["').concat(n,'"].apply(this, arguments); else')):r.push("if (i < ".concat(o,") return ; else"))),n=u}n?s?r.push('return this["'.concat(n,'"](...arguments);')):r.push('return this["'.concat(n,'"].apply(this, arguments);')):r.push(";");var l=r.join("\n"),_={value:new Function([],l)};Object.defineProperty(this._router.prototype,e,_)}},{key:"_addGetterSetterRouters",value:function _addGetterSetterRouters(e){var t={get:this._getGetterRouter(e),set:this._getSetterRouter(e)};Object.defineProperty(this._router.prototype,e,t)}},{key:"_getGetterRouter",value:function _getGetterRouter(e){var t=this,i=Object.keys(this._stateMap),r=[],n=[];i.forEach(function(i,s){var o=this;_newArrowCheck(this,t);var h=this._stateMap[i],u=this._getDescriptor(h,e,function(e){return _newArrowCheck(this,o),e.get}.bind(this));if(u){r[s]=u;var l=StateMachineType.getStateMemberAlias(u._source.__path,e);n[s]=l,this._router.prototype.hasOwnProperty(l)||Object.defineProperty(this._router.prototype,l,u)}else r[s]=null,n[s]=null}.bind(this));for(var s=["//@ sourceURL=StateMachineRouter.js","const i = this._stateIndex;"],o=n[0],h=1,u=n.length;h<u;h++){var l=n[h];l!==o&&(o?s.push("if (i < ".concat(h,') return this["').concat(o,'"]; else')):s.push("if (i < ".concat(h,") return ; else"))),o=l}o?s.push('return this["'.concat(o,'"];')):s.push(";");var _=s.join("\n");return new Function([],_)}},{key:"_getSetterRouter",value:function _getSetterRouter(e){var t=this,i=Object.keys(this._stateMap),r=[],n=[];i.forEach(function(i,s){var o=this;_newArrowCheck(this,t);var h=this._stateMap[i],u=this._getDescriptor(h,e,function(e){return _newArrowCheck(this,o),e.set}.bind(this));if(u){r[s]=u;var l=StateMachineType.getStateMemberAlias(u._source.__path,e);n[s]=l,this._router.prototype.hasOwnProperty(l)||Object.defineProperty(this._router.prototype,l,u)}else r[s]=null,n[s]=null}.bind(this));for(var s=["//@ sourceURL=StateMachineRouter.js","const i = this._stateIndex;"],o=n[0],h=1,u=n.length;h<u;h++){var l=n[h];l!==o&&(o?s.push("if (i < ".concat(h,') this["').concat(o,'"] = arg; else')):s.push("if (i < ".concat(h,") ; else"))),o=l}o?s.push('this["'.concat(o,'"] = arg;')):s.push(";");var _=s.join("\n");return new Function(["arg"],_)}},{key:"_getAllMemberNames",value:function _getAllMemberNames(){var e=this,t=this._stateMap,i=Object.keys(t),r=new Set;return i.forEach(function(i){var n=this;if(_newArrowCheck(this,e),""!==i){var s=t[i];this._getStateMemberNames(s).forEach(function(e){_newArrowCheck(this,n),r.add(e)}.bind(this))}}.bind(this)),_toConsumableArray(r)}},{key:"_getStateMemberNames",value:function _getStateMemberNames(e){var t=this,i=e,r=new Set,n=this._type===e;do{this._getStateMemberNamesForType(i).forEach(function(e){_newArrowCheck(this,t),r.add(e)}.bind(this)),i=Object.getPrototypeOf(i)}while(i&&i.prototype&&(!i.hasOwnProperty("__state")||n));return r}},{key:"_getStateMemberNamesForType",value:function _getStateMemberNamesForType(e){var t=this;return Object.getOwnPropertyNames(e.prototype).filter(function(e){return _newArrowCheck(this,t),"constructor"!==e&&!StateMachineType._isStateLocalMember(e)}.bind(this))}},{key:"getStateByPath",value:function getStateByPath(e){if(this._stateMap[e])return this._stateMap[e];for(var t=e.split(".");t.pop();){var i=t.join(".");if(this._stateMap[i])return this._stateMap[i]}}},{key:"_getStateMap",value:function _getStateMap(){return this._stateMap||(this._stateMap=this._createStateMap()),this._stateMap}},{key:"_createStateMap",value:function _createStateMap(){var e={};return this._addState(this._type,null,"",e),e}},{key:"_addState",value:function _addState(e,t,i,r){var n=this;e.__state=!0,e.__name=i,this._addStaticStateProperty(e,t);var s=t?t.__path:"",o=(s?s+".":"")+i;e.__path=o,e.__level=t?t.__level+1:0,e.__parent=t,e.__index=Object.keys(r).length,r[o]=e;var h=e._states;h&&(t&&t._states===h||e._states().forEach(function(t){_newArrowCheck(this,n);var i=StateMachineType._getStateName(t);this._addState(t,e,i,r)}.bind(this)))}},{key:"_addStaticStateProperty",value:function _addStaticStateProperty(e,t){t&&(t&&!t.__parent?this._router[e.__name]=e:t[e.__name]=e)}},{key:"router",get:function get(){return this._router}}],[{key:"_supportsSpread",value:function _supportsSpread(){if(void 0===this.__supportsSpread){this.__supportsSpread=!1;try{new Function("return [].concat(...arguments);")(),this.__supportsSpread=!0}catch(e){}}return this.__supportsSpread}},{key:"getStateMemberAlias",value:function getStateMemberAlias(e,t){return"$"+(e?e+".":"")+t}},{key:"_isStateLocalMember",value:function _isStateLocalMember(e){return"$enter"===e||"$exit"===e}},{key:"_getStateName",value:function _getStateName(e){var t=e.name,i=t.indexOf("$");return i>0?t.substr(0,i):t}}]),StateMachineType}(),U=function(e){function Component(e,i){var r;_classCallCheck(this,Component),(r=_possibleConstructorReturn(this,_getPrototypeOf(Component).call(this,e))).tagRoot=!0,t.isObjectLiteral(i)&&Object.assign(_assertThisInitialized(r),i),r.__initialized=!1,r.__firstActive=!1,r.__firstEnable=!1,r.__signals=void 0,r.__passSignals=void 0,r.__construct();var n=r.constructor.getTemplateFunc();return n.f(_assertThisInitialized(r),n.a),r._build(),r}return _inherits(Component,e),_createClass(Component,[{key:"__start",value:function __start(){F.setupStateMachine(this),this._onStateChange=Component.prototype.__onStateChange}},{key:"__onStateChange",value:function __onStateChange(){this.application&&this.application.updateFocusPath()}},{key:"_refocus",value:function _refocus(){this.application&&this.application.updateFocusPath()}},{key:"_onSetup",value:function _onSetup(){this.__initialized||this._setup()}},{key:"_setup",value:function _setup(){}},{key:"_onAttach",value:function _onAttach(){this.__initialized||(this.__init(),this.__initialized=!0),this._attach()}},{key:"_attach",value:function _attach(){}},{key:"_onDetach",value:function _onDetach(){this._detach()}},{key:"_detach",value:function _detach(){}},{key:"_onEnabled",value:function _onEnabled(){this.__firstEnable||(this._firstEnable(),this.__firstEnable=!0),this._enable()}},{key:"_firstEnable",value:function _firstEnable(){}},{key:"_enable",value:function _enable(){}},{key:"_onDisabled",value:function _onDisabled(){this._disable()}},{key:"_disable",value:function _disable(){}},{key:"_onActive",value:function _onActive(){this.__firstActive||(this._firstActive(),this.__firstActive=!0),this._active()}},{key:"_firstActive",value:function _firstActive(){}},{key:"_active",value:function _active(){}},{key:"_onInactive",value:function _onInactive(){this._inactive()}},{key:"_inactive",value:function _inactive(){}},{key:"__construct",value:function __construct(){this._construct()}},{key:"_construct",value:function _construct(){}},{key:"_build",value:function _build(){}},{key:"__init",value:function __init(){this._init()}},{key:"_init",value:function _init(){}},{key:"_focus",value:function _focus(e,t){}},{key:"_unfocus",value:function _unfocus(e){}},{key:"_focusChange",value:function _focusChange(e,t){}},{key:"_getFocused",value:function _getFocused(){return this}},{key:"_setFocusSettings",value:function _setFocusSettings(e){}},{key:"_handleFocusSettings",value:function _handleFocusSettings(e){}},{key:"hasFinalFocus",value:function hasFinalFocus(){var e=this.application._focusPath;return e&&e.length&&e[e.length-1]===this}},{key:"hasFocus",value:function hasFocus(){var e=this.application._focusPath;return e&&e.indexOf(this)>=0}},{key:"seekAncestorByType",value:function seekAncestorByType(e){for(var t=this.cparent;t;){if(t.constructor===e)return t;t=t.cparent}}},{key:"getSharedAncestorComponent",value:function getSharedAncestorComponent(e){for(var t=this.getSharedAncestor(e);t&&!t.isComponent;)t=t.parent;return t}},{key:"signal",value:function signal(e){for(var t=arguments.length,i=new Array(t>1?t-1:0),r=1;r<t;r++)i[r-1]=arguments[r];return this._signal(e,i)}},{key:"_signal",value:function _signal(e,t){var i=this._getParentSignalHandler();if(i){if(this.__signals){var r=this.__signals[e];if(!1===r)return;if(r&&(!0===r&&(r=e),i._hasMethod(r)))return i[r].apply(i,_toConsumableArray(t))}var n=this.__passSignals&&this.__passSignals[e];if(n)return n&&!0!==n&&(e=n),i._signal(e,t)}}},{key:"_getParentSignalHandler",value:function _getParentSignalHandler(){return this.cparent?this.cparent._getSignalHandler():null}},{key:"_getSignalHandler",value:function _getSignalHandler(){return this._signalProxy?this.cparent?this.cparent._getSignalHandler():null:this}},{key:"fireAncestors",value:function fireAncestors(e){if(!e.startsWith("$"))throw new Error("Ancestor event name must be prefixed by dollar sign.");var t=this._getParentSignalHandler();if(t){for(var i=arguments.length,r=new Array(i>1?i-1:0),n=1;n<i;n++)r[n-1]=arguments[n];return t._doFireAncestors(e,r)}}},{key:"_doFireAncestors",value:function _doFireAncestors(e,t){if(this._hasMethod(e))return this.fire.apply(this,[e].concat(_toConsumableArray(t)));var i=this._getParentSignalHandler();return i?i._doFireAncestors(e,t):void 0}},{key:"state",get:function get(){return this._getState()}},{key:"application",get:function get(){return this.stage.application}},{key:"cparent",get:function get(){return Component.getParent(this)}},{key:"signals",get:function get(){return this.__signals},set:function set(e){t.isObjectLiteral(e)||this._throwError("Signals: specify an object with signal-to-fire mappings"),this.__signals=e}},{key:"alterSignals",set:function set(e){for(var i in t.isObjectLiteral(e)||this._throwError("Signals: specify an object with signal-to-fire mappings"),this.__signals||(this.__signals={}),e){void 0===e[i]?delete this.__signals[i]:this.__signals[i]=e}}},{key:"passSignals",get:function get(){return this.__passSignals||{}},set:function set(e){this.__passSignals=Object.assign(this.__passSignals||{},e)}},{key:"alterPassSignals",set:function set(e){for(var i in t.isObjectLiteral(e)||this._throwError("Signals: specify an object with signal-to-fire mappings"),this.__passSignals||(this.__passSignals={}),e){void 0===e[i]?delete this.__passSignals[i]:this.__passSignals[i]=e}}},{key:"_signalProxy",get:function get(){return!1}}],[{key:"getTemplateFunc",value:function getTemplateFunc(){var e="_templateFunc";return this.__has_templateFunc!==this&&(this.__has_templateFunc=this,this[e]=this.parseTemplate(this._template())),this[e]}},{key:"parseTemplate",value:function parseTemplate(e){var t={loc:[],store:[],rid:0};this.parseTemplateRec(e,t,"element");var i=t.loc.join(";\n");return{f:new Function("element","store",i),a:t.store}}},{key:"parseTemplateRec",value:function parseTemplateRec(e,i,r){var n=this,s=i.store,o=i.loc;Object.keys(e).forEach(function(h){_newArrowCheck(this,n);var u=e[h];if(t.isUcChar(h.charCodeAt(0)))if(t.isObjectLiteral(u)){var l="r".concat(h.replace(/[^a-z0-9]/gi,"")+i.rid),_=u.type?u.type:M;_===M?o.push("const ".concat(l," = element.stage.createElement()")):(s.push(_),o.push("const ".concat(l," = new store[").concat(s.length-1,"](").concat(r,".stage)"))),o.push("".concat(l,'.ref = "').concat(h,'"')),i.rid++,this.parseTemplateRec(u,i,l),o.push("".concat(r,".childList.add(").concat(l,")"))}else t.isObject(u)&&(s.push(u),o.push("".concat(r,".childList.add(store[").concat(s.length-1,"])")));else if("text"===h){var d=r+"__text";o.push("const ".concat(d," = ").concat(r,".enableTextTexture()")),this.parseTemplatePropRec(u,i,d)}else if("texture"===h&&t.isObjectLiteral(u)){var f=r+"__texture",g=u.type;g?(s.push(g),o.push("const ".concat(f," = new store[").concat(s.length-1,"](").concat(r,".stage)")),this.parseTemplatePropRec(u,i,f),o.push("".concat(r,'["').concat(h,'"] = ').concat(f))):(o.push("".concat(f," = ").concat(r,".texture")),this.parseTemplatePropRec(u,i,f))}else t.isNumber(u)?o.push("".concat(r,'["').concat(h,'"] = ').concat(u)):t.isBoolean(u)?o.push("".concat(r,'["').concat(h,'"] = ').concat(u?"true":"false")):t.isObject(u)||Array.isArray(u)?(s.push(u),o.push("".concat(r,'["').concat(h,'"] = store[').concat(s.length-1,"]"))):o.push("".concat(r,'["').concat(h,'"] = ').concat(JSON.stringify(u)))}.bind(this))}},{key:"parseTemplatePropRec",value:function parseTemplatePropRec(e,i,r){var n=this,s=i.store,o=i.loc;Object.keys(e).forEach(function(i){if(_newArrowCheck(this,n),"type"!==i){var h=e[i];t.isNumber(h)?o.push("".concat(r,'["').concat(i,'"] = ').concat(h)):t.isBoolean(h)?o.push("".concat(r,'["').concat(i,'"] = ').concat(h?"true":"false")):t.isObject(h)||Array.isArray(h)?(s.push(h),o.push("".concat(r,'["').concat(i,'"] = store[').concat(s.length-1,"]"))):o.push("".concat(r,'["').concat(i,'"] = ').concat(JSON.stringify(h)))}}.bind(this))}},{key:"_template",value:function _template(){return{}}},{key:"collectSubComponents",value:function collectSubComponents(e,t){if(t.hasChildren())for(var i=t.__childList,r=0,n=i.length;r<n;r++){var s=i.getAt(r);s.isComponent?e.push(s):Component.collectSubComponents(e,s)}}},{key:"getComponent",value:function getComponent(e){for(var t=e;t&&!t.isComponent;)t=t.parent;return t}},{key:"getParent",value:function getParent(e){return Component.getComponent(e.parent)}}]),Component}(M);U.prototype.isComponent=!0;var B=function(){function CoreQuadList(e){_classCallCheck(this,CoreQuadList),this.ctx=e,this.quadTextures=[],this.quadElements=[]}return _createClass(CoreQuadList,[{key:"reset",value:function reset(){this.quadTextures=[],this.quadElements=[],this.dataLength=0}},{key:"getElement",value:function getElement(e){return this.quadElements[e]._element}},{key:"getElementCore",value:function getElementCore(e){return this.quadElements[e]}},{key:"getTexture",value:function getTexture(e){return this.quadTextures[e]}},{key:"getTextureWidth",value:function getTextureWidth(e){var t=this.quadTextures[e];return t.w?t.w:this.quadElements[e]._displayedTextureSource.w}},{key:"getTextureHeight",value:function getTextureHeight(e){var t=this.quadTextures[e];return t.h?t.h:this.quadElements[e]._displayedTextureSource.h}},{key:"length",get:function get(){return this.quadTextures.length}}]),CoreQuadList}(),D=function(e){function WebGLCoreQuadList(e){var t;_classCallCheck(this,WebGLCoreQuadList),t=_possibleConstructorReturn(this,_getPrototypeOf(WebGLCoreQuadList).call(this,e));var i=e.stage.getOption("bufferMemory");return t.dataLength=0,t.data=new ArrayBuffer(i),t.floats=new Float32Array(t.data),t.uints=new Uint32Array(t.data),t}return _inherits(WebGLCoreQuadList,e),_createClass(WebGLCoreQuadList,[{key:"getAttribsDataByteOffset",value:function getAttribsDataByteOffset(e){return 80*e}},{key:"getQuadContents",value:function getQuadContents(){for(var e=this.floats,t=this.uints,i=[],r=1;r<=this.length;r++){for(var n="entry "+r+": ",s=0;s<4;s++){var o=20*r+4*s;n+=e[o]+","+e[o+1]+":"+e[o+2]+","+e[o+3]+"["+t[o+4].toString(16)+"] "}i.push(n)}return i}}]),WebGLCoreQuadList}(B),W=function(){function CoreQuadOperation(e,t,i,r,n,s){_classCallCheck(this,CoreQuadOperation),this.ctx=e,this.shader=t,this.shaderOwner=i,this.renderTextureInfo=r,this.scissor=n,this.index=s,this.length=0}return _createClass(CoreQuadOperation,[{key:"getTexture",value:function getTexture(e){return this.quads.getTexture(this.index+e)}},{key:"getElementCore",value:function getElementCore(e){return this.quads.getElementCore(this.index+e)}},{key:"getElement",value:function getElement(e){return this.quads.getElement(this.index+e)}},{key:"getElementWidth",value:function getElementWidth(e){return this.getElement(e).renderWidth}},{key:"getElementHeight",value:function getElementHeight(e){return this.getElement(e).renderHeight}},{key:"getTextureWidth",value:function getTextureWidth(e){return this.quads.getTextureWidth(this.index+e)}},{key:"getTextureHeight",value:function getTextureHeight(e){return this.quads.getTextureHeight(this.index+e)}},{key:"getRenderWidth",value:function getRenderWidth(){return this.renderTextureInfo?this.renderTextureInfo.w:this.ctx.stage.w}},{key:"getRenderHeight",value:function getRenderHeight(){return this.renderTextureInfo?this.renderTextureInfo.h:this.ctx.stage.h}},{key:"quads",get:function get(){return this.ctx.renderState.quads}}]),CoreQuadOperation}(),j=function(e){function WebGLCoreQuadOperation(e,t,i,r,n,s){var o;return _classCallCheck(this,WebGLCoreQuadOperation),(o=_possibleConstructorReturn(this,_getPrototypeOf(WebGLCoreQuadOperation).call(this,e,t,i,r,n,s))).extraAttribsDataByteOffset=0,o}return _inherits(WebGLCoreQuadOperation,e),_createClass(WebGLCoreQuadOperation,[{key:"getAttribsDataByteOffset",value:function getAttribsDataByteOffset(e){return this.quads.getAttribsDataByteOffset(this.index+e)}},{key:"getNormalRenderTextureCoords",value:function getNormalRenderTextureCoords(e,t){var i=this.shaderOwner.getRenderTextureCoords(e,t);return i[0]/=this.getRenderWidth(),i[1]/=this.getRenderHeight(),i[0]=2*i[0]-1,i[1]=1-2*i[1],i}},{key:"getProjection",value:function getProjection(){return null===this.renderTextureInfo?this.ctx.renderExec._projection:this.renderTextureInfo.nativeTexture.projection}}]),WebGLCoreQuadOperation}(W),N=function(){function CoreRenderExecutor(e){_classCallCheck(this,CoreRenderExecutor),this.ctx=e,this.renderState=e.renderState,this.gl=this.ctx.stage.gl}return _createClass(CoreRenderExecutor,[{key:"destroy",value:function destroy(){}},{key:"_reset",value:function _reset(){this._bindRenderTexture(null),this._setScissor(null),this._clearRenderTexture()}},{key:"execute",value:function execute(){this._reset();for(var e=this.renderState.quadOperations,t=0,i=e.length;t<i;)this._processQuadOperation(e[t]),t++}},{key:"_processQuadOperation",value:function _processQuadOperation(e){e.renderTextureInfo&&e.renderTextureInfo.ignore||(this._setupQuadOperation(e),this._execQuadOperation(e))}},{key:"_setupQuadOperation",value:function _setupQuadOperation(e){}},{key:"_execQuadOperation",value:function _execQuadOperation(e){var t=e.renderTextureInfo?e.renderTextureInfo.nativeTexture:null;this._renderTexture!==t&&this._bindRenderTexture(t),e.renderTextureInfo&&!e.renderTextureInfo.cleared?(this._setScissor(null),this._clearRenderTexture(),e.renderTextureInfo.cleared=!0,this._setScissor(e.scissor)):this._setScissor(e.scissor),this._renderQuadOperation(e)}},{key:"_renderQuadOperation",value:function _renderQuadOperation(e){}},{key:"_bindRenderTexture",value:function _bindRenderTexture(e){this._renderTexture=e}},{key:"_clearRenderTexture",value:function _clearRenderTexture(e){}},{key:"_setScissor",value:function _setScissor(e){}}]),CoreRenderExecutor}(),H=function(e){function WebGLCoreRenderExecutor(e){var t;return _classCallCheck(this,WebGLCoreRenderExecutor),(t=_possibleConstructorReturn(this,_getPrototypeOf(WebGLCoreRenderExecutor).call(this,e))).gl=t.ctx.stage.gl,t.init(),t}return _inherits(WebGLCoreRenderExecutor,e),_createClass(WebGLCoreRenderExecutor,[{key:"init",value:function init(){var e=this.gl;this._attribsBuffer=e.createBuffer();for(var t=Math.floor(this.renderState.quads.data.byteLength/80),i=new Uint16Array(6*t),r=0,n=0;r<t;r+=6,n+=4)i[r]=n,i[r+1]=n+1,i[r+2]=n+2,i[r+3]=n,i[r+4]=n+2,i[r+5]=n+3;this._quadsBuffer=e.createBuffer(),e.bindBuffer(e.ELEMENT_ARRAY_BUFFER,this._quadsBuffer),e.bufferData(e.ELEMENT_ARRAY_BUFFER,i,e.STATIC_DRAW),this._projection=new Float32Array([2/this.ctx.stage.coordsWidth,-2/this.ctx.stage.coordsHeight])}},{key:"destroy",value:function destroy(){_get(_getPrototypeOf(WebGLCoreRenderExecutor.prototype),"destroy",this).call(this),this.gl.deleteBuffer(this._attribsBuffer),this.gl.deleteBuffer(this._quadsBuffer)}},{key:"_reset",value:function _reset(){_get(_getPrototypeOf(WebGLCoreRenderExecutor.prototype),"_reset",this).call(this);var e=this.gl;e.blendFunc(e.ONE,e.ONE_MINUS_SRC_ALPHA),e.enable(e.BLEND),e.disable(e.DEPTH_TEST),this._stopShaderProgram(),this._setupBuffers()}},{key:"_setupBuffers",value:function _setupBuffers(){var e=this.gl;e.bindBuffer(e.ELEMENT_ARRAY_BUFFER,this._quadsBuffer);var t=new Float32Array(this.renderState.quads.data,0,this.renderState.quads.dataLength);e.bindBuffer(e.ARRAY_BUFFER,this._attribsBuffer),e.bufferData(e.ARRAY_BUFFER,t,e.DYNAMIC_DRAW)}},{key:"_setupQuadOperation",value:function _setupQuadOperation(e){_get(_getPrototypeOf(WebGLCoreRenderExecutor.prototype),"_setupQuadOperation",this).call(this,e),this._useShaderProgram(e.shader,e)}},{key:"_renderQuadOperation",value:function _renderQuadOperation(e){var t=e.shader;(e.length||e.shader.addEmpty())&&(t.beforeDraw(e),t.draw(e),t.afterDraw(e))}},{key:"_useShaderProgram",value:function _useShaderProgram(e,t){e.hasSameProgram(this._currentShaderProgram)||(this._currentShaderProgram&&this._currentShaderProgram.stopProgram(),e.useProgram(),this._currentShaderProgram=e),e.setupUniforms(t)}},{key:"_stopShaderProgram",value:function _stopShaderProgram(){this._currentShaderProgram&&(this._currentShaderProgram.stopProgram(),this._currentShaderProgram=null)}},{key:"_bindRenderTexture",value:function _bindRenderTexture(e){_get(_getPrototypeOf(WebGLCoreRenderExecutor.prototype),"_bindRenderTexture",this).call(this,e);var t=this.gl;this._renderTexture?(t.bindFramebuffer(t.FRAMEBUFFER,this._renderTexture.framebuffer),t.viewport(0,0,this._renderTexture.w,this._renderTexture.h)):(t.bindFramebuffer(t.FRAMEBUFFER,null),t.viewport(0,0,this.ctx.stage.w,this.ctx.stage.h))}},{key:"_clearRenderTexture",value:function _clearRenderTexture(){_get(_getPrototypeOf(WebGLCoreRenderExecutor.prototype),"_clearRenderTexture",this).call(this);var e=this.gl;if(this._renderTexture)e.clearColor(0,0,0,0),e.clear(e.COLOR_BUFFER_BIT);else{var t=this.ctx.stage.getClearColor();t&&(e.clearColor(t[0]*t[3],t[1]*t[3],t[2]*t[3],t[3]),e.clear(e.COLOR_BUFFER_BIT))}}},{key:"_setScissor",value:function _setScissor(e){if(_get(_getPrototypeOf(WebGLCoreRenderExecutor.prototype),"_setScissor",this).call(this,e),this._scissor!==e){this._scissor=e;var t=this.gl;if(e){t.enable(t.SCISSOR_TEST);var i=this.ctx.stage.getRenderPrecision(),r=e[1];null===this._renderTexture&&(r=this.ctx.stage.h/i-(e[1]+e[3])),t.scissor(Math.round(e[0]*i),Math.round(r*i),Math.round(e[2]*i),Math.round(e[3]*i))}else t.disable(t.SCISSOR_TEST)}}}]),WebGLCoreRenderExecutor}(N),G=function(){function CoreRenderState(e){_classCallCheck(this,CoreRenderState),this.ctx=e,this.stage=e.stage,this.defaultShader=this.stage.renderer.getDefaultShader(e),this.renderer=e.stage.renderer,this.quads=this.renderer.createCoreQuadList(e)}return _createClass(CoreRenderState,[{key:"reset",value:function reset(){this._renderTextureInfo=null,this._scissor=null,this._shader=null,this._shaderOwner=null,this._realShader=null,this._check=!1,this.quadOperations=[],this._texturizer=null,this._texturizerTemporary=!1,this._quadOperation=null,this.quads.reset(),this._temporaryTexturizers=[],this._isCachingTexturizer=!1}},{key:"setShader",value:function setShader(e,t){this._shaderOwner===t&&this._realShader===e||(this._realShader=e,e.useDefault()&&(e=this.defaultShader),this._shader===e&&this._shaderOwner===t||(this._shader=e,this._shaderOwner=t,this._check=!0))}},{key:"setScissor",value:function setScissor(e){this._scissor!==e&&(this._scissor=e||null,this._check=!0)}},{key:"getScissor",value:function getScissor(){return this._scissor}},{key:"setRenderTextureInfo",value:function setRenderTextureInfo(e){this._renderTextureInfo!==e&&(this._renderTextureInfo=e,this._scissor=null,this._check=!0)}},{key:"setTexturizer",value:function setTexturizer(e){var t=arguments.length>1&&void 0!==arguments[1]&&arguments[1];this._texturizer=e,this._cacheTexturizer=t}},{key:"addQuad",value:function addQuad(e){this._quadOperation?this._check&&this._hasChanges()&&(this._finishQuadOperation(),this._check=!1):this._createQuadOperation();var t=null;this._texturizer&&(t=this._texturizer.getResultTexture(),this._cacheTexturizer||this._temporaryTexturizers.push(this._texturizer)),t||(t=e._displayedTextureSource.nativeTexture),this._renderTextureInfo&&(this._shader===this.defaultShader&&this._renderTextureInfo.empty?(this._renderTextureInfo.nativeTexture=t,this._renderTextureInfo.offset=this.length):this._renderTextureInfo.nativeTexture=null,this._renderTextureInfo.empty=!1),this.quads.quadTextures.push(t),this.quads.quadElements.push(e),this._quadOperation.length++,this.renderer.addQuad(this,this.quads,this.length-1)}},{key:"finishedRenderTexture",value:function finishedRenderTexture(){this._renderTextureInfo.nativeTexture&&(this._isRenderTextureReusable()||(this._renderTextureInfo.nativeTexture=null))}},{key:"_isRenderTextureReusable",value:function _isRenderTextureReusable(){var e=this._renderTextureInfo.offset;return this.quads.quadTextures[e].w===this._renderTextureInfo.w&&this.quads.quadTextures[e].h===this._renderTextureInfo.h&&this.renderer.isRenderTextureReusable(this,this._renderTextureInfo)}},{key:"_hasChanges",value:function _hasChanges(){var e=this._quadOperation;return this._shader!==e.shader||(this._shaderOwner!==e.shaderOwner||(this._renderTextureInfo!==e.renderTextureInfo||this._scissor!==e.scissor&&(this._scissor[0]!==e.scissor[0]||this._scissor[1]!==e.scissor[1]||this._scissor[2]!==e.scissor[2]||this._scissor[3]!==e.scissor[3])))}},{key:"_finishQuadOperation",value:function _finishQuadOperation(){var e=!(arguments.length>0&&void 0!==arguments[0])||arguments[0];if(this._quadOperation){if((this._quadOperation.length||this._shader.addEmpty())&&(!this._quadOperation.scissor||this._quadOperation.scissor[2]>0&&this._quadOperation.scissor[3]>0)&&this.quadOperations.push(this._quadOperation),this._temporaryTexturizers.length){for(var t=0,i=this._temporaryTexturizers.length;t<i;t++)this._temporaryTexturizers[t].releaseRenderTexture();this._temporaryTexturizers=[]}this._quadOperation=null}e&&this._createQuadOperation()}},{key:"_createQuadOperation",value:function _createQuadOperation(){this._quadOperation=this.renderer.createCoreQuadOperation(this.ctx,this._shader,this._shaderOwner,this._renderTextureInfo,this._scissor,this.length),this._check=!1}},{key:"finish",value:function finish(){this._quadOperation&&this._finishQuadOperation(!1),this.renderer.finishRenderState(this)}},{key:"length",get:function get(){return this.quads.quadTextures.length}},{key:"renderTextureInfo",get:function get(){return this._renderTextureInfo}},{key:"isCachingTexturizer",set:function set(e){this._isCachingTexturizer=e},get:function get(){return this._isCachingTexturizer}}]),CoreRenderState}(),V=function(){function WebGLShaderProgram(e,t){_classCallCheck(this,WebGLShaderProgram),this.vertexShaderSource=e,this.fragmentShaderSource=t,this._program=null,this._uniformLocations=new Map,this._attributeLocations=new Map,this._currentUniformValues={}}return _createClass(WebGLShaderProgram,[{key:"compile",value:function compile(e){if(!this._program){this.gl=e,this._program=e.createProgram();var t=this._glCompile(e.VERTEX_SHADER,this.vertexShaderSource),i=this._glCompile(e.FRAGMENT_SHADER,this.fragmentShaderSource);e.attachShader(this._program,t),e.attachShader(this._program,i),e.linkProgram(this._program),e.getProgramParameter(this._program,e.LINK_STATUS)||(console.error("Error: Could not initialize shader."),console.error("gl.VALIDATE_STATUS",e.getProgramParameter(this._program,e.VALIDATE_STATUS)),console.error("gl.getError()",e.getError()),""!==e.getProgramInfoLog(this._program)&&console.warn("Warning: gl.getProgramInfoLog()",e.getProgramInfoLog(this._program)),e.deleteProgram(this._program),this._program=null),e.deleteShader(t),e.deleteShader(i)}}},{key:"_glCompile",value:function _glCompile(e,t){var i=this,r=this.gl.createShader(e);if(this.gl.shaderSource(r,t),this.gl.compileShader(r),!this.gl.getShaderParameter(r,this.gl.COMPILE_STATUS)){console.log(this.constructor.name,"Type: "+(e===this.gl.VERTEX_SHADER?"vertex shader":"fragment shader")),console.log(this.gl.getShaderInfoLog(r));var n=0;return console.log("========== source ==========\n"+t.split("\n").map(function(e){return _newArrowCheck(this,i),++n+": "+e}.bind(this)).join("\n")),null}return r}},{key:"getUniformLocation",value:function getUniformLocation(e){var t=this._uniformLocations.get(e);return void 0===t&&(t=this.gl.getUniformLocation(this._program,e),this._uniformLocations.set(e,t)),t}},{key:"getAttribLocation",value:function getAttribLocation(e){var t=this._attributeLocations.get(e);return void 0===t&&(t=this.gl.getAttribLocation(this._program,e),this._attributeLocations.set(e,t)),t}},{key:"destroy",value:function destroy(){this._program&&(this.gl.deleteProgram(this._program),this._program=null)}},{key:"_valueEquals",value:function _valueEquals(e,t){if(e.length&&t.length){for(var i=0,r=e.length;i<r;i++)if(e[i]!==t[i])return!1;return!0}return e===t}},{key:"_valueClone",value:function _valueClone(e){return e.length?e.slice(0):e}},{key:"setUniformValue",value:function setUniformValue(e,t,i){var r=this._currentUniformValues[e];if(void 0===r||!this._valueEquals(r,t)){var n=this._valueClone(t);this._currentUniformValues[e]=n;var s=this.getUniformLocation(e);if(s)i===this.gl.uniformMatrix2fv||i===this.gl.uniformMatrix3fv||i===this.gl.uniformMatrix4fv?i.call(this.gl,s,!1,n):i.call(this.gl,s,n)}}},{key:"glProgram",get:function get(){return this._program}},{key:"compiled",get:function get(){return!!this._program}}]),WebGLShaderProgram}(),X=function(e){function WebGLShader(e){var t;_classCallCheck(this,WebGLShader),t=_possibleConstructorReturn(this,_getPrototypeOf(WebGLShader).call(this,e));var i=e.stage;return t._program=i.renderer.shaderPrograms.get(t.constructor),t._program||(t._program=new V(t.constructor.vertexShaderSource,t.constructor.fragmentShaderSource),i.renderer.shaderPrograms.set(t.constructor,t._program)),t.gl=i.gl,t}return _inherits(WebGLShader,e),_createClass(WebGLShader,[{key:"_init",value:function _init(){this._initialized||(this.initialize(),this._initialized=!0)}},{key:"initialize",value:function initialize(){this._program.compile(this.gl)}},{key:"_uniform",value:function _uniform(e){return this._program.getUniformLocation(e)}},{key:"_attrib",value:function _attrib(e){return this._program.getAttribLocation(e)}},{key:"_setUniform",value:function _setUniform(e,t,i){this._program.setUniformValue(e,t,i)}},{key:"useProgram",value:function useProgram(){this._init(),this.gl.useProgram(this.glProgram),this.beforeUsage(),this.enableAttribs()}},{key:"stopProgram",value:function stopProgram(){this.afterUsage(),this.disableAttribs()}},{key:"hasSameProgram",value:function hasSameProgram(e){return e&&(e===this||e._program===this._program)}},{key:"beforeUsage",value:function beforeUsage(){}},{key:"afterUsage",value:function afterUsage(){}},{key:"enableAttribs",value:function enableAttribs(){}},{key:"disableAttribs",value:function disableAttribs(){}},{key:"getExtraAttribBytesPerVertex",value:function getExtraAttribBytesPerVertex(){return 0}},{key:"getVertexAttribPointerOffset",value:function getVertexAttribPointerOffset(e){return e.extraAttribsDataByteOffset-4*e.index*this.getExtraAttribBytesPerVertex()}},{key:"setExtraAttribsInBuffer",value:function setExtraAttribsInBuffer(e){}},{key:"setupUniforms",value:function setupUniforms(e){}},{key:"_getProjection",value:function _getProjection(e){return e.getProjection()}},{key:"getFlipY",value:function getFlipY(e){return this._getProjection(e)[1]<0}},{key:"beforeDraw",value:function beforeDraw(e){}},{key:"draw",value:function draw(e){}},{key:"afterDraw",value:function afterDraw(e){}},{key:"cleanup",value:function cleanup(){this._initialized=!1}},{key:"glProgram",get:function get(){return this._program.glProgram}},{key:"initialized",get:function get(){return this._initialized}}]),WebGLShader}(T),Y=function(e){function DefaultShader(){return _classCallCheck(this,DefaultShader),_possibleConstructorReturn(this,_getPrototypeOf(DefaultShader).apply(this,arguments))}return _inherits(DefaultShader,e),_createClass(DefaultShader,[{key:"enableAttribs",value:function enableAttribs(){var e=this.gl;e.vertexAttribPointer(this._attrib("aVertexPosition"),2,e.FLOAT,!1,20,0),e.enableVertexAttribArray(this._attrib("aVertexPosition")),-1!==this._attrib("aTextureCoord")&&(e.vertexAttribPointer(this._attrib("aTextureCoord"),2,e.FLOAT,!1,20,8),e.enableVertexAttribArray(this._attrib("aTextureCoord"))),-1!==this._attrib("aColor")&&(e.vertexAttribPointer(this._attrib("aColor"),4,e.UNSIGNED_BYTE,!0,20,16),e.enableVertexAttribArray(this._attrib("aColor")))}},{key:"disableAttribs",value:function disableAttribs(){var e=this.gl;e.disableVertexAttribArray(this._attrib("aVertexPosition")),-1!==this._attrib("aTextureCoord")&&e.disableVertexAttribArray(this._attrib("aTextureCoord")),-1!==this._attrib("aColor")&&e.disableVertexAttribArray(this._attrib("aColor"))}},{key:"setupUniforms",value:function setupUniforms(e){this._setUniform("projection",this._getProjection(e),this.gl.uniform2fv,!1)}},{key:"draw",value:function draw(e){var t=this.gl,i=e.length;if(i){for(var r=e.getTexture(0),n=0,s=0;s<i;s++){var o=e.getTexture(s);r!==o&&(t.bindTexture(t.TEXTURE_2D,r),t.drawElements(t.TRIANGLES,6*(s-n),t.UNSIGNED_SHORT,6*(n+e.index)*2),r=o,n=s)}n<i&&(t.bindTexture(t.TEXTURE_2D,r),t.drawElements(t.TRIANGLES,6*(i-n),t.UNSIGNED_SHORT,6*(n+e.index)*2))}}}]),DefaultShader}(X);Y.vertexShaderSource="\n    #ifdef GL_ES\n    precision lowp float;\n    #endif\n    attribute vec2 aVertexPosition;\n    attribute vec2 aTextureCoord;\n    attribute vec4 aColor;\n    uniform vec2 projection;\n    varying vec2 vTextureCoord;\n    varying vec4 vColor;\n    void main(void){\n        gl_Position = vec4(aVertexPosition.x * projection.x - 1.0, aVertexPosition.y * -abs(projection.y) + 1.0, 0.0, 1.0);\n        vTextureCoord = aTextureCoord;\n        vColor = aColor;\n        gl_Position.y = -sign(projection.y) * gl_Position.y;\n    }\n",Y.fragmentShaderSource="\n    #ifdef GL_ES\n    precision lowp float;\n    #endif\n    varying vec2 vTextureCoord;\n    varying vec4 vColor;\n    uniform sampler2D uSampler;\n    void main(void){\n        gl_FragColor = texture2D(uSampler, vTextureCoord) * vColor;\n    }\n";var q=function(){function Renderer(e){_classCallCheck(this,Renderer),this.stage=e,this._defaultShader=void 0}return _createClass(Renderer,[{key:"gc",value:function gc(e){}},{key:"destroy",value:function destroy(){}},{key:"getDefaultShader",value:function getDefaultShader(){var e=arguments.length>0&&void 0!==arguments[0]?arguments[0]:this.stage.ctx;return this._defaultShader||(this._defaultShader=this._createDefaultShader(e)),this._defaultShader}},{key:"_createDefaultShader",value:function _createDefaultShader(e){}},{key:"isValidShaderType",value:function isValidShaderType(e){return e.prototype instanceof this._getShaderBaseType()}},{key:"createShader",value:function createShader(e,t){var r=t.type;if(this.isValidShaderType(r)){var n=new r(e);return i.patchObject(this,t),n}var s=this._getShaderAlternative(r);return s?new s(e):(console.warn("Shader has no implementation for render target: "+r.name),this._createDefaultShader(e))}},{key:"_getShaderBaseType",value:function _getShaderBaseType(){}},{key:"_getShaderAlternative",value:function _getShaderAlternative(e){return this.getDefaultShader()}},{key:"copyRenderTexture",value:function copyRenderTexture(e,t,i){console.warn("copyRenderTexture not supported by renderer")}}]),Renderer}(),Z=function(i){function WebGLRenderer(e){var t;return _classCallCheck(this,WebGLRenderer),(t=_possibleConstructorReturn(this,_getPrototypeOf(WebGLRenderer).call(this,e))).shaderPrograms=new Map,t}return _inherits(WebGLRenderer,i),_createClass(WebGLRenderer,[{key:"destroy",value:function destroy(){var e=this;this.shaderPrograms.forEach(function(t){return _newArrowCheck(this,e),t.destroy()}.bind(this))}},{key:"_createDefaultShader",value:function _createDefaultShader(e){return new Y(e)}},{key:"_getShaderBaseType",value:function _getShaderBaseType(){return X}},{key:"_getShaderAlternative",value:function _getShaderAlternative(e){return e.getWebGL&&e.getWebGL()}},{key:"createCoreQuadList",value:function createCoreQuadList(e){return new D(e)}},{key:"createCoreQuadOperation",value:function createCoreQuadOperation(e,t,i,r,n,s){return new j(e,t,i,r,n,s)}},{key:"createCoreRenderExecutor",value:function createCoreRenderExecutor(e){return new H(e)}},{key:"createCoreRenderState",value:function createCoreRenderState(e){return new G(e)}},{key:"createRenderTexture",value:function createRenderTexture(e,t,i,r){var n=this.stage.gl,s=n.createTexture();return n.bindTexture(n.TEXTURE_2D,s),n.texImage2D(n.TEXTURE_2D,0,n.RGBA,i,r,0,n.RGBA,n.UNSIGNED_BYTE,null),n.texParameteri(n.TEXTURE_2D,n.TEXTURE_MAG_FILTER,n.LINEAR),n.texParameteri(n.TEXTURE_2D,n.TEXTURE_MIN_FILTER,n.LINEAR),n.texParameteri(n.TEXTURE_2D,n.TEXTURE_WRAP_S,n.CLAMP_TO_EDGE),n.texParameteri(n.TEXTURE_2D,n.TEXTURE_WRAP_T,n.CLAMP_TO_EDGE),s.params={},s.params[n.TEXTURE_MAG_FILTER]=n.LINEAR,s.params[n.TEXTURE_MIN_FILTER]=n.LINEAR,s.params[n.TEXTURE_WRAP_S]=n.CLAMP_TO_EDGE,s.params[n.TEXTURE_WRAP_T]=n.CLAMP_TO_EDGE,s.options={format:n.RGBA,internalFormat:n.RGBA,type:n.UNSIGNED_BYTE},s.framebuffer=n.createFramebuffer(),s.projection=new Float32Array([2/e,2/t]),n.bindFramebuffer(n.FRAMEBUFFER,s.framebuffer),n.framebufferTexture2D(n.FRAMEBUFFER,n.COLOR_ATTACHMENT0,n.TEXTURE_2D,s,0),s}},{key:"freeRenderTexture",value:function freeRenderTexture(e){var t=this.stage.gl;t.deleteFramebuffer(e.framebuffer),t.deleteTexture(e)}},{key:"uploadTextureSource",value:function uploadTextureSource(e,i){var r=this,n=this.stage.gl,s=i.source,o={premultiplyAlpha:!0,hasAlpha:!0};i&&i.hasOwnProperty("premultiplyAlpha")&&(o.premultiplyAlpha=i.premultiplyAlpha),i&&i.hasOwnProperty("flipBlueRed")&&(o.flipBlueRed=i.flipBlueRed),i&&i.hasOwnProperty("hasAlpha")&&(o.hasAlpha=i.hasAlpha),o.hasAlpha||(o.premultiplyAlpha=!1),o.texParams=i.texParams||{},o.texOptions=i.texOptions||{};var h=n.createTexture();n.bindTexture(n.TEXTURE_2D,h),n.pixelStorei(n.UNPACK_PREMULTIPLY_ALPHA_WEBGL,o.premultiplyAlpha),t.isNode&&n.pixelStorei(n.UNPACK_FLIP_BLUE_RED,!!o.flipBlueRed);var u=o.texParams;u[n.TEXTURE_MAG_FILTER]||(u[n.TEXTURE_MAG_FILTER]=n.LINEAR),u[n.TEXTURE_MIN_FILTER]||(u[n.TEXTURE_MIN_FILTER]=n.LINEAR),u[n.TEXTURE_WRAP_S]||(u[n.TEXTURE_WRAP_S]=n.CLAMP_TO_EDGE),u[n.TEXTURE_WRAP_T]||(u[n.TEXTURE_WRAP_T]=n.CLAMP_TO_EDGE),Object.keys(u).forEach(function(e){_newArrowCheck(this,r);var t=u[e];n.texParameteri(n.TEXTURE_2D,parseInt(e),t)}.bind(this));var l=o.texOptions;return l.format=l.format||(o.hasAlpha?n.RGBA:n.RGB),l.type=l.type||n.UNSIGNED_BYTE,l.internalFormat=l.internalFormat||l.format,i&&i.imageRef&&(l.imageRef=i.imageRef),this.stage.platform.uploadGlTexture(n,e,s,l),h.params=t.cloneObjShallow(u),h.options=t.cloneObjShallow(l),h}},{key:"freeTextureSource",value:function freeTextureSource(e){this.stage.gl.deleteTexture(e.nativeTexture)}},{key:"addQuad",value:function addQuad(t,i,r){var n=20*r,s=i.quadElements[r],o=s._renderContext,h=t.quads.floats,u=t.quads.uints,l=e.mergeColorAlpha;if(0!==o.tb||0!==o.tc)h[n++]=o.px,h[n++]=o.py,h[n++]=s._ulx,h[n++]=s._uly,u[n++]=l(s._colorUl,o.alpha),h[n++]=o.px+s._w*o.ta,h[n++]=o.py+s._w*o.tc,h[n++]=s._brx,h[n++]=s._uly,u[n++]=l(s._colorUr,o.alpha),h[n++]=o.px+s._w*o.ta+s._h*o.tb,h[n++]=o.py+s._w*o.tc+s._h*o.td,h[n++]=s._brx,h[n++]=s._bry,u[n++]=l(s._colorBr,o.alpha),h[n++]=o.px+s._h*o.tb,h[n++]=o.py+s._h*o.td,h[n++]=s._ulx,h[n++]=s._bry,u[n]=l(s._colorBl,o.alpha);else{var _=o.px+s._w*o.ta,d=o.py+s._h*o.td;h[n++]=o.px,h[n++]=o.py,h[n++]=s._ulx,h[n++]=s._uly,u[n++]=l(s._colorUl,o.alpha),h[n++]=_,h[n++]=o.py,h[n++]=s._brx,h[n++]=s._uly,u[n++]=l(s._colorUr,o.alpha),h[n++]=_,h[n++]=d,h[n++]=s._brx,h[n++]=s._bry,u[n++]=l(s._colorBr,o.alpha),h[n++]=o.px,h[n++]=d,h[n++]=s._ulx,h[n++]=s._bry,u[n]=l(s._colorBl,o.alpha)}}},{key:"isRenderTextureReusable",value:function isRenderTextureReusable(e,t){var i=80*e._renderTextureInfo.offset/4,r=e.quads.floats,n=e.quads.uints;return 0===r[i]&&0===r[i+1]&&0===r[i+2]&&0===r[i+3]&&4294967295===n[i+4]&&r[i+5]===t.w&&0===r[i+6]&&1===r[i+7]&&0===r[i+8]&&4294967295===n[i+9]&&r[i+10]===t.w&&r[i+11]===t.h&&1===r[i+12]&&1===r[i+13]&&4294967295===n[i+14]&&0===r[i+15]&&r[i+16]===t.h&&0===r[i+17]&&1===r[i+18]&&4294967295===n[i+19]}},{key:"finishRenderState",value:function finishRenderState(e){for(var t=80*e.length,i=0,r=e.quadOperations.length;i<r;i++){e.quadOperations[i].extraAttribsDataByteOffset=t;var n=4*e.quadOperations[i].shader.getExtraAttribBytesPerVertex()*e.quadOperations[i].length;t+=n,n&&e.quadOperations[i].shader.setExtraAttribsInBuffer(e.quadOperations[i],e.quads)}e.quads.dataLength=t}},{key:"copyRenderTexture",value:function copyRenderTexture(e,t,i){var r=this.stage.gl;r.bindTexture(r.TEXTURE_2D,t),r.bindFramebuffer(r.FRAMEBUFFER,e.framebuffer);var n=e.precision;r.copyTexSubImage2D(r.TEXTURE_2D,0,n*(i.sx||0),n*(i.sy||0),n*(i.x||0),n*(i.y||0),n*(i.w||e.ow),n*(i.h||e.oh))}}]),WebGLRenderer}(q),$=function(e){function C2dCoreQuadList(e){var t;return _classCallCheck(this,C2dCoreQuadList),(t=_possibleConstructorReturn(this,_getPrototypeOf(C2dCoreQuadList).call(this,e))).renderContexts=[],t.modes=[],t}return _inherits(C2dCoreQuadList,e),_createClass(C2dCoreQuadList,[{key:"setRenderContext",value:function setRenderContext(e,t){this.renderContexts[e]=t}},{key:"setSimpleTc",value:function setSimpleTc(e,t){t?this.modes[e]|=1:this.modes[e]-=1&this.modes[e]}},{key:"setWhite",value:function setWhite(e,t){t?this.modes[e]|=2:this.modes[e]-=2&this.modes[e]}},{key:"getRenderContext",value:function getRenderContext(e){return this.renderContexts[e]}},{key:"getSimpleTc",value:function getSimpleTc(e){return 1&this.modes[e]}},{key:"getWhite",value:function getWhite(e){return 2&this.modes[e]}}]),C2dCoreQuadList}(B),Q=function(e){function C2dCoreQuadOperation(){return _classCallCheck(this,C2dCoreQuadOperation),_possibleConstructorReturn(this,_getPrototypeOf(C2dCoreQuadOperation).apply(this,arguments))}return _inherits(C2dCoreQuadOperation,e),_createClass(C2dCoreQuadOperation,[{key:"getRenderContext",value:function getRenderContext(e){return this.quads.getRenderContext(this.index+e)}},{key:"getSimpleTc",value:function getSimpleTc(e){return this.quads.getSimpleTc(this.index+e)}},{key:"getWhite",value:function getWhite(e){return this.quads.getWhite(this.index+e)}}]),C2dCoreQuadOperation}(W),K=function(i){function C2dCoreRenderExecutor(){return _classCallCheck(this,C2dCoreRenderExecutor),_possibleConstructorReturn(this,_getPrototypeOf(C2dCoreRenderExecutor).apply(this,arguments))}return _inherits(C2dCoreRenderExecutor,i),_createClass(C2dCoreRenderExecutor,[{key:"init",value:function init(){this._mainRenderTexture=this.ctx.stage.getCanvas()}},{key:"_renderQuadOperation",value:function _renderQuadOperation(e){var t=e.shader;if(e.length||e.shader.addEmpty()){var i=this._renderTexture||this._mainRenderTexture;t.beforeDraw(e,i),t.draw(e,i),t.afterDraw(e,i)}}},{key:"_clearRenderTexture",value:function _clearRenderTexture(){var t=this._getContext(),i=[0,0,0,0];this._mainRenderTexture.ctx===t&&(i=this.ctx.stage.getClearColor());var r=t.canvas;t.setTransform(1,0,0,1,0,0),i[0]||i[1]||i[2]||i[3]?(t.fillStyle=e.getRgbaStringFromArray(i),t.globalCompositeOperation="copy",t.beginPath(),t.rect(0,0,r.width,r.height),t.closePath(),t.fill(),t.globalCompositeOperation="source-over"):t.clearRect(0,0,r.width,r.height)}},{key:"_getContext",value:function _getContext(){return this._renderTexture?this._renderTexture.ctx:this._mainRenderTexture.ctx}},{key:"_restoreContext",value:function _restoreContext(){var e=this._getContext();e.restore(),e.save(),e._scissor=null}},{key:"_setScissor",value:function _setScissor(e){var t=this._getContext();if(!C2dCoreRenderExecutor._equalScissorAreas(t.canvas,t._scissor,e)){this._restoreContext();var i=this.ctx.stage.getRenderPrecision();e&&(t.beginPath(),t.rect(Math.round(e[0]*i),Math.round(e[1]*i),Math.round(e[2]*i),Math.round(e[3]*i)),t.closePath(),t.clip()),t._scissor=e}}}],[{key:"_equalScissorAreas",value:function _equalScissorAreas(e,i,r){return i||(i=[0,0,e.width,e.height]),r||(r=[0,0,e.width,e.height]),t.equalValues(i,r)}}]),C2dCoreRenderExecutor}(N),J=function(e){function C2dShader(){return _classCallCheck(this,C2dShader),_possibleConstructorReturn(this,_getPrototypeOf(C2dShader).apply(this,arguments))}return _inherits(C2dShader,e),_createClass(C2dShader,[{key:"beforeDraw",value:function beforeDraw(e){}},{key:"draw",value:function draw(e){}},{key:"afterDraw",value:function afterDraw(e){}}]),C2dShader}(T),ee=function(t){function DefaultShader(e){var t;return _classCallCheck(this,DefaultShader),(t=_possibleConstructorReturn(this,_getPrototypeOf(DefaultShader).call(this,e)))._rectangleTexture=e.stage.rectangleTexture.source.nativeTexture,t._tintManager=t.ctx.stage.renderer.tintManager,t}return _inherits(DefaultShader,t),_createClass(DefaultShader,[{key:"draw",value:function draw(t,i){for(var r=i.ctx,n=t.length,s=0;s<n;s++){var o=t.getTexture(s),h=t.getElementCore(s),u=t.getRenderContext(s),l=t.getWhite(s),_=t.getSimpleTc(s),d=this.ctx.stage.getRenderPrecision();r.setTransform(u.ta*d,u.tc*d,u.tb*d,u.td*d,u.px*d,u.py*d);var f=o===this._rectangleTexture,g={operation:t,target:i,index:s,rect:f};if(f)l?r.fillStyle="white":this._setColorGradient(r,h),r.globalAlpha=u.alpha,this._beforeDrawEl(g),r.fillRect(0,0,h.w,h.h),this._afterDrawEl(g),r.globalAlpha=1;else{r.globalAlpha=u.alpha,this._beforeDrawEl(g);var p=_?0:h._ulx*o.w,v=_?0:h._uly*o.h,y=(_?1:h._brx-h._ulx)*o.w,x=(_?1:h._bry-h._uly)*o.h;if(!l){var m=h._colorUl;h._colorUl===h._colorUr&&h._colorUr===h._colorBl&&h._colorBr===h._colorBl||(m=e.mergeMultiColorsEqual([h._colorUl,h._colorUr,h._colorBl,h._colorBr]));var k=(m/16777216|0)/255;r.globalAlpha*=k;var S=16777215&m,C=this._tintManager.getTintTexture(o,S);r.fillStyle="white",r.drawImage(C,p,v,y,x,0,0,h.w,h.h)}else r.fillStyle="white",r.drawImage(o,p,v,y,x,0,0,h.w,h.h);this._afterDrawEl(g),r.globalAlpha=1}}}},{key:"_setColorGradient",value:function _setColorGradient(t,i){var r,n=arguments.length>2&&void 0!==arguments[2]?arguments[2]:i.w,s=arguments.length>3&&void 0!==arguments[3]?arguments[3]:i.h,o=!(arguments.length>4&&void 0!==arguments[4])||arguments[4],h=i._colorUl;i._colorUl===i._colorUr?i._colorBl===i._colorBr&&(i._colorUl===i.colorBl||(r=t.createLinearGradient(0,0,0,s),o?(r.addColorStop(0,e.getRgbaString(i._colorUl)),r.addColorStop(1,e.getRgbaString(i._colorBl))):(r.addColorStop(0,e.getRgbString(i._colorUl)),r.addColorStop(1,e.getRgbString(i._colorBl))))):i._colorUl===i._colorBl&&i._colorUr===i._colorBr&&(r=t.createLinearGradient(0,0,n,0),o?(r.addColorStop(0,e.getRgbaString(i._colorUl)),r.addColorStop(1,e.getRgbaString(i._colorBr))):(r.addColorStop(0,e.getRgbString(i._colorUl)),r.addColorStop(1,e.getRgbString(i._colorBr)))),t.fillStyle=r||(o?e.getRgbaString(h):e.getRgbString(h))}},{key:"_beforeDrawEl",value:function _beforeDrawEl(e){}},{key:"_afterDrawEl",value:function _afterDrawEl(e){}}]),DefaultShader}(J),te=function(){function C2dTextureTintManager(e){_classCallCheck(this,C2dTextureTintManager),this.stage=e,this._usedMemory=0,this._cachedNativeTextures=new Set}return _createClass(C2dTextureTintManager,[{key:"destroy",value:function destroy(){this.gc(!0)}},{key:"_addMemoryUsage",value:function _addMemoryUsage(e){this._usedMemory+=e,this.stage.addMemoryUsage(e)}},{key:"delete",value:function _delete(e){if(this._hasCache(e)){var t=this._getCache(e),i=t.memoryUsage;t.clear(),this._cachedNativeTextures.delete(e),this._addMemoryUsage(t.memoryUsage-i)}}},{key:"getTintTexture",value:function getTintTexture(e,t){var i=this.stage.frameCounter;this._cachedNativeTextures.add(e);var r=this._getCache(e),n=r.get(t);if(n.lf=i,n.tx)return e.update>n.u&&this._tintTexture(n.tx,e,t),n.tx;var s=r.memoryUsage,o=r.reuseTexture(i);o?o.ctx.clearRect(0,0,o.width,o.height):((o=document.createElement("canvas")).width=e.w,o.height=e.h,o.ctx=o.getContext("2d")),this._tintTexture(o,e,t),r.set(t,o,i);var h=r.memoryUsage;return h!==s&&this._addMemoryUsage(h-s),o}},{key:"_tintTexture",value:function _tintTexture(e,t,i){for(var r=i.toString(16);r.length<6;)r="0"+r;e.ctx.fillStyle="#"+r,e.ctx.globalCompositeOperation="copy",e.ctx.fillRect(0,0,t.w,t.h),e.ctx.globalCompositeOperation="multiply",e.ctx.drawImage(t,0,0,t.w,t.h,0,0,e.width,e.height),e.ctx.globalCompositeOperation="destination-in",e.ctx.drawImage(t,0,0,t.w,t.h,0,0,e.width,e.height)}},{key:"_hasCache",value:function _hasCache(e){return!!e._tintCache}},{key:"_getCache",value:function _getCache(e){return e._tintCache||(e._tintCache=new ie(e)),e._tintCache}},{key:"gc",value:function gc(){var e=this,t=arguments.length>0&&void 0!==arguments[0]&&arguments[0],i=this.stage.frameCounter,r=0;this._cachedNativeTextures.forEach(function(n){_newArrowCheck(this,e);var s=this._getCache(n);if(t)r+=s.memoryUsage,n.clear();else{var o=s.memoryUsage;s.cleanup(i),s.releaseBlancoTextures(),r+=s.memoryUsage-o}}.bind(this)),t&&this._cachedNativeTextures.clear(),r&&this._addMemoryUsage(r)}}]),C2dTextureTintManager}(),ie=function(){function C2dTintCache(e){_classCallCheck(this,C2dTintCache),this._tx=e,this._colors=new Map,this._blancoTextures=null,this._lastCleanupFrame=0,this._memTextures=0}return _createClass(C2dTintCache,[{key:"releaseBlancoTextures",value:function releaseBlancoTextures(){this._memTextures-=this._blancoTextures.length,this._blancoTextures=[]}},{key:"clear",value:function clear(){this._blancoTextures=null,this._colors.clear(),this._memTextures=0}},{key:"get",value:function get(e){var t=this._colors.get(e);return t||(t={lf:-1,tx:void 0,u:-1},this._colors.set(e,t)),t}},{key:"set",value:function set(e,t,i){var r=this.get(e);r.lf=i,r.tx=t,r.u=i,this._memTextures++}},{key:"cleanup",value:function cleanup(e){var t=this;this._lastCleanupFrame!==e&&(this._blancoTextures=[],this._colors.forEach(function(i,r){_newArrowCheck(this,t),i.lf<e-1&&(i.tx&&this._blancoTextures.push(i.tx),this._colors.delete(r))}.bind(this)),this._lastCleanupFrame=e)}},{key:"reuseTexture",value:function reuseTexture(e){if(this.cleanup(e),this._blancoTextures&&this._blancoTextures.length)return this._memTextures--,this._blancoTextures.pop()}},{key:"memoryUsage",get:function get(){return this._memTextures*this._tx.w*this._tx.h}}]),C2dTintCache}(),re=function(e){function C2dRenderer(e){var t;return _classCallCheck(this,C2dRenderer),(t=_possibleConstructorReturn(this,_getPrototypeOf(C2dRenderer).call(this,e))).tintManager=new te(e),t.setupC2d(t.stage.c2d.canvas),t}return _inherits(C2dRenderer,e),_createClass(C2dRenderer,[{key:"destroy",value:function destroy(){this.tintManager.destroy()}},{key:"_createDefaultShader",value:function _createDefaultShader(e){return new ee(e)}},{key:"_getShaderBaseType",value:function _getShaderBaseType(){return J}},{key:"_getShaderAlternative",value:function _getShaderAlternative(e){return e.getC2d&&e.getC2d()}},{key:"createCoreQuadList",value:function createCoreQuadList(e){return new $(e)}},{key:"createCoreQuadOperation",value:function createCoreQuadOperation(e,t,i,r,n,s){return new Q(e,t,i,r,n,s)}},{key:"createCoreRenderExecutor",value:function createCoreRenderExecutor(e){return new K(e)}},{key:"createCoreRenderState",value:function createCoreRenderState(e){return new G(e)}},{key:"createRenderTexture",value:function createRenderTexture(e,t,i,r){var n=document.createElement("canvas");return n.width=i,n.height=r,this.setupC2d(n),n}},{key:"freeRenderTexture",value:function freeRenderTexture(e){this.tintManager.delete(e)}},{key:"gc",value:function gc(e){this.tintManager.gc(e)}},{key:"uploadTextureSource",value:function uploadTextureSource(e,t){if(t.source.buffer){var i=document.createElement("canvas");i.width=t.w,i.height=t.h;var r=new ImageData(new Uint8ClampedArray(t.source.buffer),t.w,t.h);return i.getContext("2d").putImageData(r,0,0),i}return t.source}},{key:"freeTextureSource",value:function freeTextureSource(e){this.tintManager.delete(e.nativeTexture)}},{key:"addQuad",value:function addQuad(e,t,i){var r=t.quadElements[i];t.setRenderContext(i,r._renderContext),t.setWhite(i,r.isWhite()),t.setSimpleTc(i,r.hasSimpleTexCoords())}},{key:"isRenderTextureReusable",value:function isRenderTextureReusable(e,t){return!1}},{key:"finishRenderState",value:function finishRenderState(e){}},{key:"setupC2d",value:function setupC2d(e){var t=e.getContext("2d");e.ctx=t,t._scissor=null,e.ctx.save()}}]),C2dRenderer}(q),ne=function(e){function SparkShader(){return _classCallCheck(this,SparkShader),_possibleConstructorReturn(this,_getPrototypeOf(SparkShader).apply(this,arguments))}return _inherits(SparkShader,e),_createClass(SparkShader,[{key:"enableAttribs",value:function enableAttribs(){var e=this.gl;e.vertexAttribPointer(this._attrib("aVertexPosition"),2,e.FLOAT,!1,20,0),e.enableVertexAttribArray(this._attrib("aVertexPosition")),-1!==this._attrib("aTextureCoord")&&(e.vertexAttribPointer(this._attrib("aTextureCoord"),2,e.FLOAT,!1,20,8),e.enableVertexAttribArray(this._attrib("aTextureCoord"))),-1!==this._attrib("aColor")&&(e.vertexAttribPointer(this._attrib("aColor"),4,e.UNSIGNED_BYTE,!0,20,16),e.enableVertexAttribArray(this._attrib("aColor")))}},{key:"disableAttribs",value:function disableAttribs(){var e=this.gl;e.disableVertexAttribArray(this._attrib("aVertexPosition")),-1!==this._attrib("aTextureCoord")&&e.disableVertexAttribArray(this._attrib("aTextureCoord")),-1!==this._attrib("aColor")&&e.disableVertexAttribArray(this._attrib("aColor"))}},{key:"setupUniforms",value:function setupUniforms(e){this._setUniform("projection",this._getProjection(e),this.gl.uniform2fv,!1)}},{key:"draw",value:function draw(e){var t=this.gl,i=e.length;if(i){for(var r=e.getTexture(0),n=0,s=0;s<i;s++){var o=e.getTexture(s);if(r!==o){if(r.options&&r.options.imageRef){var h=s>0?s-1:s,u=this.ctx.stage.getOption("precision"),l=e.getElementCore(h);this.ctx.stage.platform.paint(t,r.options.imageRef,l._worldContext.px*u,l._worldContext.py*u,l._colorUl,l)}else t.bindTexture(t.TEXTURE_2D,r),t.drawElements(t.TRIANGLES,6*(s-n),t.UNSIGNED_SHORT,6*(n+e.index)*2);r=o,n=s}}if(n<i)if(r.options&&r.options.imageRef){var _=this.ctx.stage.getOption("precision"),d=e.getElementCore(n);this.ctx.stage.platform.paint(t,r.options.imageRef,d._worldContext.px*_,d._worldContext.py*_,d._colorUl,d)}else t.bindTexture(t.TEXTURE_2D,r),t.drawElements(t.TRIANGLES,6*(i-n),t.UNSIGNED_SHORT,6*(n+e.index)*2)}}}]),SparkShader}(X);ne.vertexShaderSource="\n    #ifdef GL_ES\n    precision lowp float;\n    #endif\n    attribute vec2 aVertexPosition;\n    attribute vec2 aTextureCoord;\n    attribute vec4 aColor;\n    uniform vec2 projection;\n    varying vec2 vTextureCoord;\n    varying vec4 vColor;\n    void main(void){\n        gl_Position = vec4(aVertexPosition.x * projection.x - 1.0, aVertexPosition.y * -abs(projection.y) + 1.0, 0.0, 1.0);\n        vTextureCoord = aTextureCoord;\n        vColor = aColor;\n        gl_Position.y = -sign(projection.y) * gl_Position.y;\n    }\n",ne.fragmentShaderSource="\n    #ifdef GL_ES\n    precision lowp float;\n    #endif\n    varying vec2 vTextureCoord;\n    varying vec4 vColor;\n    uniform sampler2D uSampler;\n    void main(void){\n        gl_FragColor = texture2D(uSampler, vTextureCoord) * vColor;\n    }\n";var se=function(e){function SparkRenderer(e){return _classCallCheck(this,SparkRenderer),_possibleConstructorReturn(this,_getPrototypeOf(SparkRenderer).call(this,e))}return _inherits(SparkRenderer,e),_createClass(SparkRenderer,[{key:"_createDefaultShader",value:function _createDefaultShader(e){return new ne(e)}},{key:"createCoreRenderExecutor",value:function createCoreRenderExecutor(e){global.beginDrawing();var t=_get(_getPrototypeOf(SparkRenderer.prototype),"createCoreRenderExecutor",this).call(this,e);return global.endDrawing(),t}}]),SparkRenderer}(Z),ae=function(){function ImageWorker(){_classCallCheck(this,ImageWorker),this._items=new Map,this._id=0,this._initWorker()}return _createClass(ImageWorker,[{key:"destroy",value:function destroy(){this._worker&&this._worker.terminate()}},{key:"_initWorker",value:function _initWorker(){var e=this,t="(".concat(he.toString(),")()"),i=new Blob([t.replace('"use strict";',"")]),r=(window.URL?URL:webkitURL).createObjectURL(i,{type:"application/javascript; charset=utf-8"});this._worker=new Worker(r),this._worker.postMessage({type:"config",config:{path:window.location.href,protocol:window.location.protocol}}),this._worker.onmessage=function(t){if(_newArrowCheck(this,e),t.data&&t.data.id){var i=t.data.id,r=this._items.get(i);r&&("data"==t.data.type?this.finish(r,t.data.info):this.error(r,t.data.info))}}.bind(this)}},{key:"create",value:function create(e){var t=++this._id,i=new oe(this,t,e);return this._items.set(t,i),this._worker.postMessage({type:"add",id:t,src:e}),i}},{key:"cancel",value:function cancel(e){this._worker.postMessage({type:"cancel",id:e.id}),this._items.delete(e.id)}},{key:"error",value:function error(e,t){e.error(t),this._items.delete(e.id)}},{key:"finish",value:function finish(e,t){e.load(t),this._items.delete(e.id)}}]),ImageWorker}(),oe=function(){function ImageWorkerImage(e,t,i){_classCallCheck(this,ImageWorkerImage),this._manager=e,this._id=t,this._src=i,this._onError=null,this._onLoad=null}return _createClass(ImageWorkerImage,[{key:"cancel",value:function cancel(){this._manager.cancel(this)}},{key:"load",value:function load(e){this._onLoad&&this._onLoad(e)}},{key:"error",value:function error(e){this._onError&&this._onError(e)}},{key:"id",get:function get(){return this._id}},{key:"src",get:function get(){return this._src}},{key:"onError",set:function set(e){this._onError=e}},{key:"onLoad",set:function set(e){this._onLoad=e}}]),ImageWorkerImage}(),he=function createWorker(){function ImageWorkerServer(){this.items=new Map;var e=this;onmessage=function onmessage(t){e._receiveMessage(t)}}function ImageWorkerServerItem(e,t){this._onError=void 0,this._onFinish=void 0,this._id=e,this._src=t,this._xhr=void 0,this._mimeType=void 0,this._canceled=!1}ImageWorkerServer.isPathAbsolute=function(e){return/^(?:\/|[a-z]+:\/\/)/.test(e)||"data:"==e.substr(0,5)},ImageWorkerServer.prototype._receiveMessage=function(e){if("config"===e.data.type){this.config=e.data.config;var t=this.config.path.split("/");t.pop(),this._relativeBase=t.join("/")+"/"}else"add"===e.data.type?this.add(e.data.id,e.data.src):"cancel"===e.data.type&&this.cancel(e.data.id)},ImageWorkerServer.prototype.add=function(e,t){ImageWorkerServer.isPathAbsolute(t)||(t=this._relativeBase+t),"//"===t.substr(0,2)&&(t=this.config.protocol+t);var i=new ImageWorkerServerItem(e,t),r=this;i.onFinish=function(e){r.finish(i,e)},i.onError=function(e){r.error(i,e)},this.items.set(e,i),i.start()},ImageWorkerServer.prototype.cancel=function(e){var t=this.items.get(e);t&&(t.cancel(),this.items.delete(e))},ImageWorkerServer.prototype.finish=function(e,t){var i=t.imageBitmap,r=t.hasAlphaChannel;postMessage({type:"data",id:e.id,info:{imageBitmap:i,hasAlphaChannel:r}},[i]),this.items.delete(e.id)},ImageWorkerServer.prototype.error=function(e,t){var i=t.type,r=t.message;postMessage({type:"error",id:e.id,info:{type:i,message:r}}),this.items.delete(e.id)},ImageWorkerServer.isWPEBrowser=function(){return-1!==navigator.userAgent.indexOf("WPE")},Object.defineProperty(ImageWorkerServerItem.prototype,"id",{get:function get(){return this._id}}),Object.defineProperty(ImageWorkerServerItem.prototype,"onFinish",{get:function get(){return this._onFinish},set:function set(e){this._onFinish=e}}),Object.defineProperty(ImageWorkerServerItem.prototype,"onError",{get:function get(){return this._onError},set:function set(e){this._onError=e}}),ImageWorkerServerItem.prototype.start=function(){this._xhr=new XMLHttpRequest,this._xhr.open("GET",this._src,!0),this._xhr.responseType="blob";var e=this;this._xhr.onerror=function(t){e.error({type:"connection",message:"Connection error"})},this._xhr.onload=function(t){var i=e._xhr.response;e._mimeType=i.type,e._createImageBitmap(i)},this._xhr.send()},ImageWorkerServerItem.prototype._createImageBitmap=function(e){var t=this;createImageBitmap(e,{premultiplyAlpha:"premultiply",colorSpaceConversion:"none",imageOrientation:"none"}).then((function(e){t.finish({imageBitmap:e,hasAlphaChannel:t._hasAlphaChannel()})})).catch((function(e){t.error({type:"parse",message:"Error parsing image data"})}))},ImageWorkerServerItem.prototype._hasAlphaChannel=function(){return!!ImageWorkerServer.isWPEBrowser()||-1!==this._mimeType.indexOf("image/png")},ImageWorkerServerItem.prototype.cancel=function(){this._canceled||(this._xhr&&this._xhr.abort(),this._canceled=!0)},ImageWorkerServerItem.prototype.error=function(e,t){!this._canceled&&this._onError&&this._onError({type:e,message:t})},ImageWorkerServerItem.prototype.finish=function(e){!this._canceled&&this._onFinish&&this._onFinish(e)};new ImageWorkerServer},ue=function(){function WebPlatform(){_classCallCheck(this,WebPlatform)}return _createClass(WebPlatform,[{key:"init",value:function init(e){this.stage=e,this._looping=!1,this._awaitingLoop=!1,this.stage.getOption("useImageWorker")&&(window.createImageBitmap&&window.Worker?(console.log("Using image worker!"),this._imageWorker=new ae):console.warn("Can't use image worker because browser does not have createImageBitmap and Web Worker support"))}},{key:"destroy",value:function destroy(){this._imageWorker&&this._imageWorker.destroy(),this._removeKeyHandler()}},{key:"startLoop",value:function startLoop(){this._looping=!0,this._awaitingLoop||this.loop()}},{key:"stopLoop",value:function stopLoop(){this._looping=!1}},{key:"loop",value:function loop(){var e=this;requestAnimationFrame((function lp(){e._awaitingLoop=!1,e._looping&&(e.stage.drawFrame(),requestAnimationFrame(lp),e._awaitingLoop=!0)}))}},{key:"uploadGlTexture",value:function uploadGlTexture(e,t,i,r){i instanceof ImageData||i instanceof HTMLImageElement||i instanceof HTMLCanvasElement||i instanceof HTMLVideoElement||window.ImageBitmap&&i instanceof ImageBitmap?e.texImage2D(e.TEXTURE_2D,0,r.internalFormat,r.format,r.type,i):e.texImage2D(e.TEXTURE_2D,0,r.internalFormat,t.w,t.h,0,r.format,r.type,i)}},{key:"loadSrcTexture",value:function loadSrcTexture(e,t){var i=e.src,r=e.hasAlpha,n=void 0,s=i.indexOf(".png")>=0||"data:image/png;base64"==i.substr(0,21);if(this._imageWorker){var o=this._imageWorker.create(i);o.onError=function(e){return t("Image load error")},o.onLoad=function(e){var r=e.imageBitmap,n=e.hasAlphaChannel;t(null,{source:r,renderInfo:{src:i},hasAlpha:n,premultiplyAlpha:!0})},n=function cancelCb(){o.cancel()}}else{var h=new Image;"data:"!=i.substr(0,5)&&(h.crossOrigin="Anonymous"),h.onerror=function(e){if(h.src)return t("Image load error")},h.onload=function(){t(null,{source:h,renderInfo:{src:i},hasAlpha:s||r})},h.src=i,n=function cancelCb(){h.onerror=null,h.onload=null,h.removeAttribute("src")}}return n}},{key:"createWebGLContext",value:function createWebGLContext(e,t){var i=this.stage.getOption("canvas")||document.createElement("canvas");e&&t&&(i.width=e,i.height=t);var r={alpha:!0,antialias:!1,premultipliedAlpha:!0,stencil:!0,preserveDrawingBuffer:!1},n=i.getContext("webgl",r)||i.getContext("experimental-webgl",r);if(!n)throw new Error("This browser does not support webGL.");return n}},{key:"createCanvasContext",value:function createCanvasContext(e,t){var i=this.stage.getOption("canvas")||document.createElement("canvas");e&&t&&(i.width=e,i.height=t);var r=i.getContext("2d");if(!r)throw new Error("This browser does not support 2d canvas.");return r}},{key:"getHrTime",value:function getHrTime(){return window.performance?window.performance.now():(new Date).getTime()}},{key:"getDrawingCanvas",value:function getDrawingCanvas(){return document.createElement("canvas")}},{key:"getTextureOptionsForDrawingCanvas",value:function getTextureOptionsForDrawingCanvas(e){var t={};return t.source=e,t}},{key:"nextFrame",value:function nextFrame(e){}},{key:"registerKeydownHandler",value:function registerKeydownHandler(e){var t=this;this._keydownListener=function(i){_newArrowCheck(this,t),e(i)}.bind(this),window.addEventListener("keydown",this._keydownListener)}},{key:"registerKeyupHandler",value:function registerKeyupHandler(e){var t=this;this._keyupListener=function(i){_newArrowCheck(this,t),e(i)}.bind(this),window.addEventListener("keyup",this._keyupListener)}},{key:"_removeKeyHandler",value:function _removeKeyHandler(){this._keydownListener&&window.removeEventListener("keydown",this._keydownListener),this._keyupListener&&window.removeEventListener("keyup",this._keyupListener)}}]),WebPlatform}(),le=function(){function PlatformLoader(){_classCallCheck(this,PlatformLoader)}return _createClass(PlatformLoader,null,[{key:"load",value:function load(e){return e.platform?e.platform:ue}}]),PlatformLoader}(),ce=function(){function Utils(){_classCallCheck(this,Utils)}return _createClass(Utils,null,[{key:"isFunction",value:function isFunction(e){return"function"==typeof e}},{key:"isNumber",value:function isNumber(e){return"number"==typeof e}},{key:"isInteger",value:function isInteger(e){return"number"==typeof e&&e%1==0}},{key:"isBoolean",value:function isBoolean(e){return!0===e||!1===e}},{key:"isString",value:function isString(e){return"string"==typeof e}},{key:"isObject",value:function isObject(e){var t=typeof e;return!!e&&("object"==t||"function"==t)}},{key:"isPlainObject",value:function isPlainObject(e){return!!e&&"object"==typeof e}},{key:"isObjectLiteral",value:function isObjectLiteral(e){return"object"==typeof e&&e&&e.constructor===Object}},{key:"getArrayIndex",value:function getArrayIndex(e,t){return Utils.getModuloIndex(e,t.length)}},{key:"equalValues",value:function equalValues(e,t){return typeof e==typeof t&&(Utils.isObjectLiteral(e)?Utils.isObjectLiteral(t)&&Utils.equalObjectLiterals(e,t):Array.isArray(e)?Array.isArray(t)&&Utils.equalArrays(e,t):e===t)}},{key:"equalObjectLiterals",value:function equalObjectLiterals(e,t){var i=Object.keys(e),r=Object.keys(t);if(i.length!==r.length)return!1;for(var n=0,s=i.length;n<s;n++){var o=i[n],h=r[n];if(o!==h)return!1;var u=e[o],l=t[h];if(!Utils.equalValues(u,l))return!1}return!0}},{key:"equalArrays",value:function equalArrays(e,t){if(e.length!==t.length)return!1;for(var i=0,r=e.length;i<r;i++)if(!this.equalValues(e[i],t[i]))return!1;return!0}}]),Utils}(),_e=function(){function WebGLState(e,t){_classCallCheck(this,WebGLState),this._id=e,this._gl=t,this._program=void 0,this._buffers=new Map,this._framebuffers=new Map,this._renderbuffers=new Map,this._vertexAttribs=new Array(16),this._nonDefaultFlags=new Set,this._settings=new Map,this._textures=new Array(8),this._maxTexture=0,this._activeTexture=t.TEXTURE0,this._pixelStorei=new Array(5)}return _createClass(WebGLState,[{key:"_getDefaultFlag",value:function _getDefaultFlag(e){return e===this._gl.DITHER}},{key:"setFlag",value:function setFlag(e,t){return t===this._getDefaultFlag(e)?this._nonDefaultFlags.delete(e):!this._nonDefaultFlags.has(e)&&(this._nonDefaultFlags.add(e),!0)}},{key:"setBuffer",value:function setBuffer(e,t){var i=this._buffers.get(e)!==t;return this._buffers.set(e,t),i&&e===this._gl.ARRAY_BUFFER&&(this._vertexAttribs=[]),i}},{key:"setFramebuffer",value:function setFramebuffer(e,t){var i=this._framebuffers.get(e)!==t;return this._framebuffers.set(e,t),i}},{key:"setRenderbuffer",value:function setRenderbuffer(e,t){var i=this._renderbuffers.get(e)!==t;return this._renderbuffers.set(e,t),i}},{key:"setProgram",value:function setProgram(e){var t=this._program!==e;return this._program=e,t}},{key:"setSetting",value:function setSetting(e,t){var i=this._settings.get(e),r=!i||!ce.equalValues(i,t);return this._settings.set(e,t),r}},{key:"disableVertexAttribArray",value:function disableVertexAttribArray(e){var t=this._vertexAttribs[e];return!(!t||!t[5])&&(t[5]=!1,!0)}},{key:"enableVertexAttribArray",value:function enableVertexAttribArray(e){var t=this._vertexAttribs[e];return t?!t[0]&&(t[0]=!0,!0):(this._vertexAttribs[e]=[0,0,0,0,0,!0],!0)}},{key:"vertexAttribPointer",value:function vertexAttribPointer(e,t){var i=this._vertexAttribs[e],r=!1;return i&&(r=i[0]===t[0]&&i[1]===t[1]&&i[2]===t[2]&&i[3]===t[3]&&i[4]===t[4]),!r&&(t[5]=!!i&&i[5],!0)}},{key:"setActiveTexture",value:function setActiveTexture(e){var t=this._activeTexture!==e;return this._activeTexture=e,t}},{key:"bindTexture",value:function bindTexture(e,t){var i=WebGLState._getTextureIndex(this._activeTexture);this._maxTexture=Math.max(this._maxTexture,i+1);var r=this._textures[i],n=WebGLState._getTextureTargetIndex(e);return r?r[n]!==t&&(r[n]=t,!0):!!t&&(this._textures[i]=[],this._textures[i][n]=t,!0)}},{key:"setPixelStorei",value:function setPixelStorei(e,t){var i=WebGLState._getPixelStoreiIndex(e),r=!ce.equalValues(this._pixelStorei[i],t);return this._pixelStorei[i]=t,r}},{key:"migrate",value:function migrate(e){var t=this;this._migrateFlags(t,e),e._program!==t._program&&this._gl._useProgram(e._program),this._migrateFramebuffers(t,e),this._migrateRenderbuffers(t,e);var i=this._migrateBuffers(t,e);this._migrateAttributes(t,e,i),this._migrateFlags(t,e),this._migrateSettings(t,e),this._migratePixelStorei(t,e),this._migrateTextures(t,e)}},{key:"_migratePixelStorei",value:function _migratePixelStorei(e,t){for(var i=0,r=e._pixelStorei.length;i<r;i++)if(e._pixelStorei[i]!==t._pixelStorei[i]){var n=void 0!==t._pixelStorei[i]?t._pixelStorei[i]:WebGLState._getDefaultPixelStoreiByIndex(i);this._gl._pixelStorei(WebGLState._getPixelStoreiByIndex(i),n)}}},{key:"_migrateTextures",value:function _migrateTextures(e,t){for(var i=Math.max(e._maxTexture,t._maxTexture),r=e._activeTexture,n=0;n<i;n++)for(var s=t._textures[n],o=e._textures[n],h=WebGLState._getTextureByIndex(n),u=0,l=Math.max(o?o.length:0,s?s.length:0);u<l;u++){var _=WebGLState._getTextureTargetByIndex(u);r!==h&&(this._gl._activeTexture(h),r=h);var d=s&&s[u]||null;this._gl._bindTexture(_,d)}t._activeTexture!==r&&this._gl._activeTexture(t._activeTexture)}},{key:"_migrateBuffers",value:function _migrateBuffers(e,t){var i=this;return t._buffers.forEach(function(t,r){_newArrowCheck(this,i),e._buffers.get(r)!==t&&this._gl._bindBuffer(r,t)}.bind(this)),e._buffers.forEach(function(e,r){_newArrowCheck(this,i),void 0===t._buffers.get(r)&&this._gl._bindBuffer(r,null)}.bind(this)),t._buffers.get(this._gl.ARRAY_BUFFER)!==e._buffers.get(this._gl.ARRAY_BUFFER)}},{key:"_migrateFramebuffers",value:function _migrateFramebuffers(e,t){var i=this;t._framebuffers.forEach(function(t,r){_newArrowCheck(this,i),e._framebuffers.get(r)!==t&&this._gl._bindFramebuffer(r,t)}.bind(this)),e._framebuffers.forEach(function(e,r){_newArrowCheck(this,i),void 0===t._framebuffers.get(r)&&this._gl._bindFramebuffer(r,null)}.bind(this))}},{key:"_migrateRenderbuffers",value:function _migrateRenderbuffers(e,t){var i=this;t._renderbuffers.forEach(function(t,r){_newArrowCheck(this,i),e._renderbuffers.get(r)!==t&&this._gl._bindRenderbuffer(r,t)}.bind(this)),e._renderbuffers.forEach(function(e,r){_newArrowCheck(this,i),void 0===t._renderbuffers.get(r)&&this._gl._bindRenderbuffer(r,null)}.bind(this))}},{key:"_migrateAttributes",value:function _migrateAttributes(e,t,i){var r=this;i?t._vertexAttribs.forEach(function(e,t){_newArrowCheck(this,r),e[0]&&this._gl._vertexAttribPointer(t,e[0],e[1],e[2],e[3],e[4]),e[5]&&this._gl._enableVertexAttribArray(t)}.bind(this)):(e._vertexAttribs.forEach(function(e,i){_newArrowCheck(this,r),t._vertexAttribs[i]||this._gl._disableVertexAttribArray(i)}.bind(this)),t._vertexAttribs.forEach(function(e,t){_newArrowCheck(this,r),this._gl._vertexAttribPointer(t,e[0],e[1],e[2],e[4]),e[5]?this._gl._enableVertexAttribArray(t):this._gl._disableVertexAttribArray(t)}.bind(this)))}},{key:"_migrateSettings",value:function _migrateSettings(e,t){var i=this,r=this.constructor.getDefaultSettings();e._settings.forEach(function(e,n){_newArrowCheck(this,i);var s=n.name||n.xname;if(!t._settings.has(n)){var o=r.get(s);ce.isFunction(o)&&(o=o(this._gl)),t._settings.set(n,o),n.apply(this._gl,o)}}.bind(this)),t._settings.forEach(function(t,r){_newArrowCheck(this,i);var n=e._settings.get(r);n&&ce.equalValues(n,t)||r.apply(this._gl,t)}.bind(this))}},{key:"_migrateFlags",value:function _migrateFlags(e,t){var i=this;e._nonDefaultFlags.forEach(function(e){_newArrowCheck(this,i),t._nonDefaultFlags.has(e)||(this._getDefaultFlag(e)?this._gl._enable(e):this._gl._disable(e))}.bind(this)),t._nonDefaultFlags.forEach(function(t){_newArrowCheck(this,i),e._nonDefaultFlags.has(t)||(this._getDefaultFlag(t)?this._gl._disable(t):this._gl._enable(t))}.bind(this))}}],[{key:"getDefaultSettings",value:function getDefaultSettings(){if(!this._defaultSettings){this._defaultSettings=new Map;var e=this._defaultSettings,t=WebGLRenderingContext.prototype;e.set("viewport",(function(e){return[0,0,e.canvas.width,e.canvas.height]})),e.set("scissor",(function(e){return[0,0,e.canvas.width,e.canvas.height]})),e.set("blendColor",[0,0,0,0]),e.set("blendEquation",[t.FUNC_ADD]),e.set("blendEquationSeparate",[t.FUNC_ADD,t.FUNC_ADD]),e.set("blendFunc",[t.ONE,t.ZERO]),e.set("blendFuncSeparate",[t.ONE,t.ZERO,t.ONE,t.ZERO]),e.set("clearColor",[0,0,0,0]),e.set("clearDepth",[1]),e.set("clearStencil",[0]),e.set("colorMask",[!0,!0,!0,!0]),e.set("cullFace",[t.BACK]),e.set("depthFunc",[t.LESS]),e.set("depthMask",[!0]),e.set("depthRange",[0,1]),e.set("frontFace",[t.CCW]),e.set("lineWidth",[1]),e.set("polygonOffset",[0,0]),e.set("sampleCoverage",[1,!1]),e.set("stencilFunc",[t.ALWAYS,0,1]),e.set("_stencilFuncSeparateFront",[t.ALWAYS,0,1]),e.set("_stencilFuncSeparateBack",[t.ALWAYS,0,1]),e.set("_stencilFuncSeparateFrontAndBack",[t.ALWAYS,0,1]),e.set("stencilMask",[1]),e.set("_stencilMaskSeparateFront",[1]),e.set("_stencilMaskSeparateBack",[1]),e.set("_stencilMaskSeparateFrontAndBack",[1]),e.set("stencilOp",[t.KEEP,t.KEEP,t.KEEP]),e.set("_stencilOpSeparateFront",[t.KEEP,t.KEEP,t.KEEP]),e.set("_stencilOpSeparateBack",[t.KEEP,t.KEEP,t.KEEP]),e.set("_stencilOpSeparateFrontAndBack",[t.KEEP,t.KEEP,t.KEEP]),e.set("vertexAttrib1f",[]),e.set("vertexAttrib1fv",[]),e.set("vertexAttrib2f",[]),e.set("vertexAttrib2fv",[]),e.set("vertexAttrib3f",[]),e.set("vertexAttrib3fv",[]),e.set("vertexAttrib4f",[]),e.set("vertexAttrib4fv",[])}return this._defaultSettings}},{key:"_getTextureTargetIndex",value:function _getTextureTargetIndex(e){switch(e){case 3553:return 0;case 34067:return 1;default:throw new Error("Unknown texture target: "+e)}}},{key:"_getTextureTargetByIndex",value:function _getTextureTargetByIndex(e){return this._textureTargetIndices||(this._textureTargetIndices=[3553,34067]),this._textureTargetIndices[e]}},{key:"_getTextureIndex",value:function _getTextureIndex(e){return e-33984}},{key:"_getTextureByIndex",value:function _getTextureByIndex(e){return e+33984}},{key:"_getPixelStoreiIndex",value:function _getPixelStoreiIndex(e){switch(e){case 3333:return 0;case 3317:return 1;case 37440:return 2;case 37441:return 3;case 37443:return 4;case 37445:return 5;default:throw new Error("Unknown pixelstorei: "+e)}}},{key:"_getPixelStoreiByIndex",value:function _getPixelStoreiByIndex(e){return this._pixelStoreiIndices||(this._pixelStoreiIndices=[3333,3317,37440,37441,37443]),this._pixelStoreiIndices[e]}},{key:"_getDefaultPixelStoreiByIndex",value:function _getDefaultPixelStoreiByIndex(e){return this._pixelStoreiDefaults||(this._pixelStoreiDefaults=[4,4,!1,!1,WebGLRenderingContext.prototype.BROWSER_DEFAULT_WEBGL]),this._pixelStoreiDefaults[e]}}]),WebGLState}(),de=function(){function WebGLStateManager(){_classCallCheck(this,WebGLStateManager)}return _createClass(WebGLStateManager,[{key:"_initStateManager",value:function _initStateManager(){var e=arguments.length>0&&void 0!==arguments[0]?arguments[0]:"default";this._states={},this._state=this._getState(e)}},{key:"_getState",value:function _getState(e){return this._states[e]||(this._states[e]=new _e(e,this)),this._states[e]}},{key:"switchState",value:function switchState(){var e=arguments.length>0&&void 0!==arguments[0]?arguments[0]:"default";if(this._state._id!==e){var t=this._getState(e);this._state.migrate(t),this._state=t}}},{key:"$useProgram",value:function $useProgram(e){this._state.setProgram(e)&&this._useProgram(e)}},{key:"$bindBuffer",value:function $bindBuffer(e,t){this._state.setBuffer(e,t)&&this._bindBuffer(e,t)}},{key:"$bindFramebuffer",value:function $bindFramebuffer(e,t){this._state.setFramebuffer(e,t)&&this._bindFramebuffer(e,t)}},{key:"$bindRenderbuffer",value:function $bindRenderbuffer(e,t){this._state.setRenderbuffer(e,t)&&this._bindRenderbuffer(e,t)}},{key:"$enable",value:function $enable(e){this._state.setFlag(e,!0)&&this._enable(e)}},{key:"$disable",value:function $disable(e){this._state.setFlag(e,!1)&&this._disable(e)}},{key:"$viewport",value:function $viewport(e,t,i,r){this._state.setSetting(this._viewport,[e,t,i,r])&&this._viewport(e,t,i,r)}},{key:"$scissor",value:function $scissor(e,t,i,r){this._state.setSetting(this._scissor,[e,t,i,r])&&this._scissor(e,t,i,r)}},{key:"$disableVertexAttribArray",value:function $disableVertexAttribArray(e){this._state.disableVertexAttribArray(e)&&this._disableVertexAttribArray(e)}},{key:"$enableVertexAttribArray",value:function $enableVertexAttribArray(e){this._state.enableVertexAttribArray(e)&&this._enableVertexAttribArray(e)}},{key:"$vertexAttribPointer",value:function $vertexAttribPointer(e,t,i,r,n,s){this._state.vertexAttribPointer(e,[t,i,r,n,s])&&this._vertexAttribPointer(e,t,i,r,n,s)}},{key:"$activeTexture",value:function $activeTexture(e){this._state.setActiveTexture(e)&&this._activeTexture(e)}},{key:"$bindTexture",value:function $bindTexture(e,t){this._state.bindTexture(e,t)&&this._bindTexture(e,t)}},{key:"$pixelStorei",value:function $pixelStorei(e,t){this._state.setPixelStorei(e,t)&&this._pixelStorei(e,t)}},{key:"$stencilFuncSeparate",value:function $stencilFuncSeparate(e,t,i,r){var n;switch(e){case this.FRONT:n=this._stencilFuncSeparateFront;break;case this.BACK:n=this._stencilFuncSeparateBack;break;case this.FRONT_AND_BACK:n=this._stencilFuncSeparateFrontAndBack}this._state.setSetting(n,[t,i,r])&&n.apply(this,[t,i,r])}},{key:"_stencilFuncSeparateFront",value:function _stencilFuncSeparateFront(e,t,i){this._stencilFuncSeparate(this.FRONT,e,t,i)}},{key:"_stencilFuncSeparateBack",value:function _stencilFuncSeparateBack(e,t,i){this._stencilFuncSeparate(this.BACK,e,t,i)}},{key:"_stencilFuncSeparateFrontAndBack",value:function _stencilFuncSeparateFrontAndBack(e,t,i){this._stencilFuncSeparate(this.FRONT_AND_BACK,e,t,i)}},{key:"$stencilMaskSeparate",value:function $stencilMaskSeparate(e,t){var i;switch(e){case this.FRONT:i=this._stencilMaskSeparateFront;break;case this.BACK:i=this._stencilMaskSeparateBack;break;case this.FRONT_AND_BACK:i=this._stencilMaskSeparateFrontAndBack}this._state.setSetting(i,[t])&&i.apply(this,[t])}},{key:"_stencilMaskSeparateFront",value:function _stencilMaskSeparateFront(e){this._stencilMaskSeparate(this.FRONT,e)}},{key:"_stencilMaskSeparateBack",value:function _stencilMaskSeparateBack(e){this._stencilMaskSeparate(this.BACK,e)}},{key:"_stencilMaskSeparateFrontAndBack",value:function _stencilMaskSeparateFrontAndBack(e){this._stencilMaskSeparate(this.FRONT_AND_BACK,e)}},{key:"$stencilOpSeparate",value:function $stencilOpSeparate(e,t,i,r){var n;switch(e){case this.FRONT:n=this._stencilOpSeparateFront;break;case this.BACK:n=this._stencilOpSeparateBack;break;case this.FRONT_AND_BACK:n=this._stencilOpSeparateFrontAndBack}this._state.setSetting(n,[t,i,r])&&n.apply(this,[t,i,r])}},{key:"_stencilOpSeparateFront",value:function _stencilOpSeparateFront(e,t,i){this._stencilOpSeparate(this.FRONT,e,t,i)}},{key:"_stencilOpSeparateBack",value:function _stencilOpSeparateBack(e,t,i){this._stencilOpSeparate(this.BACK,e,t,i)}},{key:"_stencilOpSeparateFrontAndBack",value:function _stencilOpSeparateFrontAndBack(e,t,i){this._stencilOpSeparate(this.FRONT_AND_BACK,e,t,i)}},{key:"$blendColor",value:function $blendColor(e,t,i,r){this._state.setSetting(this._blendColor,[e,t,i,r])&&this._blendColor(e,t,i,r)}},{key:"$blendEquation",value:function $blendEquation(e){this._state.setSetting(this._blendEquation,[e])&&this._blendEquation(e)}},{key:"$blendEquationSeparate",value:function $blendEquationSeparate(e,t){this._state.setSetting(this._blendEquationSeparate,[e,t])&&this._blendEquationSeparate(e,t)}},{key:"$blendFunc",value:function $blendFunc(e,t){this._state.setSetting(this._blendFunc,[e,t])&&this._blendFunc(e,t)}},{key:"$blendFuncSeparate",value:function $blendFuncSeparate(e,t,i,r){this._state.setSetting(this._blendFuncSeparate,[e,t,i,r])&&this._blendFuncSeparate(e,t,i,r)}},{key:"$clearColor",value:function $clearColor(e,t,i,r){this._state.setSetting(this._clearColor,[e,t,i,r])&&this._clearColor(e,t,i,r)}},{key:"$clearDepth",value:function $clearDepth(e){this._state.setSetting(this._clearDepth,[e])&&this._clearDepth(e)}},{key:"$clearStencil",value:function $clearStencil(e){this._state.setSetting(this._clearStencil,[e])&&this._clearStencil(e)}},{key:"$colorMask",value:function $colorMask(e,t,i,r){this._state.setSetting(this._colorMask,[e,t,i,r])&&this._colorMask(e,t,i,r)}},{key:"$cullFace",value:function $cullFace(e){this._state.setSetting(this._cullFace,[e])&&this._cullFace(e)}},{key:"$depthFunc",value:function $depthFunc(e){this._state.setSetting(this._depthFunc,[e])&&this._depthFunc(e)}},{key:"$depthMask",value:function $depthMask(e){this._state.setSetting(this._depthMask,[e])&&this._depthMask(e)}},{key:"$depthRange",value:function $depthRange(e,t){this._state.setSetting(this._depthRange,[e,t])&&this._depthRange(e,t)}},{key:"$frontFace",value:function $frontFace(e){this._state.setSetting(this._frontFace,[e])&&this._frontFace(e)}},{key:"$lineWidth",value:function $lineWidth(e){this._state.setSetting(this._lineWidth,[e])&&this._lineWidth(e)}},{key:"$polygonOffset",value:function $polygonOffset(e,t){this._state.setSetting(this._polygonOffset,[e,t])&&this._polygonOffset(e,t)}},{key:"$sampleCoverage",value:function $sampleCoverage(e,t){this._state.setSetting(this._sampleCoverage,[e,t])&&this._sampleCoverage(e,t)}},{key:"$stencilFunc",value:function $stencilFunc(e,t,i){this._state.setSetting(this._stencilFunc,[e,t,i])&&this._stencilFunc(e,t,i)}},{key:"$stencilMask",value:function $stencilMask(e){this._state.setSetting(this._stencilMask,[e])&&this._stencilMask(e)}},{key:"$stencilOp",value:function $stencilOp(e,t,i){this._state.setSetting(this._stencilOp,[e,t,i])&&this._stencilOp(e,t,i)}},{key:"$vertexAttrib1f",value:function $vertexAttrib1f(e,t){this._state.setSetting(this._vertexAttrib1f,[e,t])&&this._vertexAttrib1f(e,t)}},{key:"$vertexAttrib1fv",value:function $vertexAttrib1fv(e,t){this._state.setSetting(this._vertexAttrib1fv,[e,t])&&this._vertexAttrib1fv(e,t)}},{key:"$vertexAttrib2f",value:function $vertexAttrib2f(e,t,i){this._state.setSetting(this._vertexAttrib2f,[e,t,i])&&this._vertexAttrib2f(e,t,i)}},{key:"$vertexAttrib2fv",value:function $vertexAttrib2fv(e,t){this._state.setSetting(this._vertexAttrib2fv,[e,t])&&this._vertexAttrib2fv(e,t)}},{key:"$vertexAttrib3f",value:function $vertexAttrib3f(e,t,i,r){this._state.setSetting(this._vertexAttrib3f,[e,t,i,r])&&this._vertexAttrib3f(e,t,i,r)}},{key:"$vertexAttrib3fv",value:function $vertexAttrib3fv(e,t){this._state.setSetting(this._vertexAttrib3fv,[e,t])&&this._vertexAttrib3fv(e,t)}},{key:"$vertexAttrib4f",value:function $vertexAttrib4f(e,t,i,r,n){this._state.setSetting(this._vertexAttrib4f,[e,t,i,r,n])&&this._vertexAttrib4f(e,t,i,r,n)}},{key:"$vertexAttrib4fv",value:function $vertexAttrib4fv(e,t){this._state.setSetting(this._vertexAttrib4fv,[e,t])&&this._vertexAttrib4fv(e,t)}}],[{key:"enable",value:function enable(e){var t=this,i=arguments.length>1&&void 0!==arguments[1]?arguments[1]:"default",r=Object.getOwnPropertyNames(WebGLStateManager.prototype);e.__proto__;return r.forEach(function(i){if(_newArrowCheck(this,t),"constructor"!==i){var r=WebGLStateManager.prototype[i];"$"===i.charAt(0)&&(i=i.substr(1)),e[i]!==r&&(e[i]&&(e[i].name||(e[i].xname=i),e["_"+i]=e[i]),e[i]=r)}}.bind(this)),WebGLStateManager.prototype._initStateManager.call(e,i),e}}]),WebGLStateManager}(),fe=function(){function TextureManager(e){_classCallCheck(this,TextureManager),this.stage=e,this._usedMemory=0,this._uploadedTextureSources=[],this.textureSourceHashmap=new Map}return _createClass(TextureManager,[{key:"destroy",value:function destroy(){for(var e=0,t=this._uploadedTextureSources.length;e<t;e++)this._nativeFreeTextureSource(this._uploadedTextureSources[e]);this.textureSourceHashmap.clear(),this._usedMemory=0}},{key:"getReusableTextureSource",value:function getReusableTextureSource(e){return this.textureSourceHashmap.get(e)}},{key:"getTextureSource",value:function getTextureSource(e,t){var i=t?this.textureSourceHashmap.get(t):null;return i||(i=new x(this,e),t&&(i.lookupId=t,this.textureSourceHashmap.set(t,i))),i}},{key:"uploadTextureSource",value:function uploadTextureSource(e,t){if(!e.isLoaded()){this._addMemoryUsage(e.w*e.h);var i=this._nativeUploadTextureSource(e,t);e._nativeTexture=i,i.w=e.w,i.h=e.h,i.update=this.stage.frameCounter,this._uploadedTextureSources.push(e),this.addToLookupMap(e)}}},{key:"_addMemoryUsage",value:function _addMemoryUsage(e){this._usedMemory+=e,this.stage.addMemoryUsage(e)}},{key:"addToLookupMap",value:function addToLookupMap(e){var t=e.lookupId;t&&(this.textureSourceHashmap.has(t)||this.textureSourceHashmap.set(t,e))}},{key:"gc",value:function gc(){this.freeUnusedTextureSources(),this._cleanupLookupMap()}},{key:"freeUnusedTextureSources",value:function freeUnusedTextureSources(){for(var e=[],t=0,i=this._uploadedTextureSources.length;t<i;t++){var r=this._uploadedTextureSources[t];r.allowCleanup()?this._freeManagedTextureSource(r):e.push(r)}this._uploadedTextureSources=e,this._cleanupLookupMap()}},{key:"_freeManagedTextureSource",value:function _freeManagedTextureSource(e){e.isLoaded()&&(this._nativeFreeTextureSource(e),this._addMemoryUsage(-e.w*e.h)),e.loadingSince=null}},{key:"_cleanupLookupMap",value:function _cleanupLookupMap(){var e=this;this.textureSourceHashmap.forEach(function(t,i){_newArrowCheck(this,e),t.isLoaded()||t.isLoading()||t.isUsed()||this.textureSourceHashmap.delete(i)}.bind(this))}},{key:"freeTextureSource",value:function freeTextureSource(e){var t=this._uploadedTextureSources.indexOf(e),i=-1!==t;e.isLoaded()&&(i&&(this._addMemoryUsage(-e.w*e.h),this._uploadedTextureSources.splice(t,1)),this._nativeFreeTextureSource(e)),e.loadingSince=null}},{key:"_nativeUploadTextureSource",value:function _nativeUploadTextureSource(e,t){return this.stage.renderer.uploadTextureSource(e,t)}},{key:"_nativeFreeTextureSource",value:function _nativeFreeTextureSource(e){this.stage.renderer.freeTextureSource(e),e.clearNativeTexture()}},{key:"usedMemory",get:function get(){return this._usedMemory}}]),TextureManager}(),ge=function(){function TextureThrottler(e){var t=this;_classCallCheck(this,TextureThrottler),this.stage=e,this.genericCancelCb=function(e){_newArrowCheck(this,t),this._remove(e)}.bind(this),this._sources=[],this._data=[]}return _createClass(TextureThrottler,[{key:"destroy",value:function destroy(){this._sources=[],this._data=[]}},{key:"processSome",value:function processSome(){if(this._sources.length){var e=Date.now();do{this._processItem()}while(this._sources.length&&Date.now()-e<TextureThrottler.MAX_UPLOAD_TIME_PER_FRAME)}}},{key:"_processItem",value:function _processItem(){var e=this._sources.pop(),t=this._data.pop();e.isLoading()&&e.processLoadedSource(t)}},{key:"add",value:function add(e,t){this._sources.push(e),this._data.push(t)}},{key:"_remove",value:function _remove(e){var t=this._sources.indexOf(e);t>=0&&(this._sources.splice(t,1),this._data.splice(t,1))}}]),TextureThrottler}();ge.MAX_UPLOAD_TIME_PER_FRAME=10;var pe=function(){function CoreContext(e){_classCallCheck(this,CoreContext),this.stage=e,this.root=null,this.updateTreeOrder=0,this.renderState=this.stage.renderer.createCoreRenderState(this),this.renderExec=this.stage.renderer.createCoreRenderExecutor(this),this.renderExec.init(),this._usedMemory=0,this._renderTexturePool=[],this._renderTextureId=1,this._zSorts=[]}return _createClass(CoreContext,[{key:"destroy",value:function destroy(){var e=this;this._renderTexturePool.forEach(function(t){return _newArrowCheck(this,e),this._freeRenderTexture(t)}.bind(this)),this._usedMemory=0}},{key:"hasRenderUpdates",value:function hasRenderUpdates(){return!!this.root._parent._hasRenderUpdates}},{key:"render",value:function render(){this.root._parent._hasRenderUpdates=0,this._render()}},{key:"update",value:function update(){this._update(),this.root._hasUpdates&&this._update(),this._performForcedZSorts()}},{key:"_performForcedZSorts",value:function _performForcedZSorts(){if(this._zSorts.length){for(var e=0,t=this._zSorts.length;e<t;e++)this._zSorts[e].zSort&&this._zSorts[e].sortZIndexedChildren();this._zSorts=[]}}},{key:"_update",value:function _update(){this.updateTreeOrder=0,this.root.update()}},{key:"_render",value:function _render(){if(this._fillRenderState(),this.stage.getOption("readPixelsBeforeDraw")){var e=new Uint8Array(4),t=this.stage.gl;t.readPixels(0,0,1,1,t.RGBA,t.UNSIGNED_BYTE,e)}this._performRender()}},{key:"_fillRenderState",value:function _fillRenderState(){this.renderState.reset(),this.root.render(),this.renderState.finish()}},{key:"_performRender",value:function _performRender(){this.renderExec.execute()}},{key:"_addMemoryUsage",value:function _addMemoryUsage(e){this._usedMemory+=e,this.stage.addMemoryUsage(e)}},{key:"allocateRenderTexture",value:function allocateRenderTexture(e,t){for(var i=this.stage.getRenderPrecision(),r=Math.max(1,Math.round(e*i)),n=Math.max(1,Math.round(t*i)),s=this._renderTexturePool.length-1;s>=0;s--){var o=this._renderTexturePool[s];if(o.w===r&&o.h===n&&o.update!==this.stage.frameCounter)return o.f=this.stage.frameCounter,this._renderTexturePool.splice(s,1),o}var h=this._createRenderTexture(e,t,r,n);return h.precision=i,h}},{key:"releaseRenderTexture",value:function releaseRenderTexture(e){this._renderTexturePool.push(e)}},{key:"freeUnusedRenderTextures",value:function freeUnusedRenderTextures(){var e=this,t=arguments.length>0&&void 0!==arguments[0]?arguments[0]:60,i=this.stage.frameCounter-t;this._renderTexturePool=this._renderTexturePool.filter(function(t){return _newArrowCheck(this,e),!(t.f<=i)||(this._freeRenderTexture(t),!1)}.bind(this))}},{key:"_createRenderTexture",value:function _createRenderTexture(e,t,i,r){this._addMemoryUsage(i*r);var n=this.stage.renderer.createRenderTexture(e,t,i,r);return n.id=this._renderTextureId++,n.f=this.stage.frameCounter,n.ow=e,n.oh=t,n.w=i,n.h=r,n}},{key:"_freeRenderTexture",value:function _freeRenderTexture(e){this.stage.renderer.freeRenderTexture(e),this._addMemoryUsage(-e.w*e.h)}},{key:"copyRenderTexture",value:function copyRenderTexture(e,t,i){this.stage.renderer.copyRenderTexture(e,t,i)}},{key:"forceZSort",value:function forceZSort(e){this._zSorts.push(e)}},{key:"usedMemory",get:function get(){return this._usedMemory}}]),CoreContext}(),ve=function(){function TransitionSettings(t){_classCallCheck(this,TransitionSettings),this.stage=t,this._timingFunction="ease",this._timingFunctionImpl=e.getTimingFunction(this._timingFunction),this.delay=0,this.duration=.2,this.merger=null}return _createClass(TransitionSettings,[{key:"patch",value:function patch(e){i.patchObject(this,e)}},{key:"timingFunction",get:function get(){return this._timingFunction},set:function set(t){this._timingFunction=t,this._timingFunctionImpl=e.getTimingFunction(t)}},{key:"timingFunctionImpl",get:function get(){return this._timingFunctionImpl}}]),TransitionSettings}();ve.prototype.isTransitionSettings=!0;var ye=function(){function TransitionManager(e){var t=this;_classCallCheck(this,TransitionManager),this.stage=e,this.stage.on("frameStart",function(){return _newArrowCheck(this,t),this.progress()}.bind(this)),this.active=new Set,this.defaultTransitionSettings=new ve(this.stage)}return _createClass(TransitionManager,[{key:"progress",value:function progress(){var e=this;if(this.active.size){var t=this.stage.dt,i=!1;this.active.forEach((function(e){e.progress(t),e.isRunning()||(i=!0)})),i&&(this.active=new Set(_toConsumableArray(this.active).filter(function(t){return _newArrowCheck(this,e),t.isRunning()}.bind(this))))}}},{key:"createSettings",value:function createSettings(e){var t=new ve;return i.patchObject(t,e),t}},{key:"addActive",value:function addActive(e){this.active.add(e)}},{key:"removeActive",value:function removeActive(e){this.active.delete(e)}}]),TransitionManager}(),xe=function(){function MultiSpline(){_classCallCheck(this,MultiSpline),this._clear()}return _createClass(MultiSpline,[{key:"_clear",value:function _clear(){this._p=[],this._pe=[],this._idp=[],this._f=[],this._v=[],this._lv=[],this._sm=[],this._s=[],this._ve=[],this._sme=[],this._se=[],this._length=0}},{key:"parse",value:function parse(e,i){var r,n;t.isObjectLiteral(i)||(i={0:i});var s=.5,o=[];for(var h in i)if(i.hasOwnProperty(h)){var u=i[h];t.isObjectLiteral(u)||(u={v:u});var l=parseFloat(h);"sm"===h?s=u.v:!isNaN(l)&&l>=0&&l<=2&&(u.p=l,u.f=t.isFunction(u.v),u.lv=u.f?u.v(0,0):u.v,o.push(u))}for(n=(o=o.sort((function(e,t){return e.p-t.p}))).length,r=0;r<n;r++){var _=r===n-1;if(o[r].hasOwnProperty("pe")){var d=r<n-1?o[r+1].p:1;o[r].pe>d&&(o[r].pe=d)}else o[r].pe=_?o[r].p<=1?1:2:o[r+1].p;o[r].pe===o[r].p?o[r].idp=0:o[r].idp=1/(o[r].pe-o[r].p)}for(r=0;r<n;r++)if(o[r].hasOwnProperty("sm")||(o[r].sm=s),!o[r].hasOwnProperty("s"))if(0===r||r===n-1||1===o[r].p)o[r].s=e?[0,0,0,0]:0;else{var f=o[r-1],g=o[r+1];if(f.p===g.p)o[r].s=e?[0,0,0,0]:0;else if(e){var p=MultiSpline.getRgbaComponents(g.lv),v=MultiSpline.getRgbaComponents(f.lv),y=1/(g.p-f.p);o[r].s=[y*(p[0]-v[0]),y*(p[1]-v[1]),y*(p[2]-v[2]),y*(p[3]-v[3])]}else o[r].s=(g.lv-f.lv)/(g.p-f.p)}for(r=0;r<n-1;r++)if(!o[r].f){var x=r===n-1;o[r].hasOwnProperty("ve")||(o[r].ve=x?o[r].lv:o[r+1].lv),t.isNumber(o[r].v)&&t.isNumber(o[r].lv)&&(o[r].hasOwnProperty("sme")||(o[r].sme=x?s:o[r+1].sm),o[r].hasOwnProperty("se")||(o[r].se=x?e?[0,0,0,0]:0:o[r+1].s),o[r].v=e?MultiSpline.getSplineRgbaValueFunction(o[r].v,o[r].ve,o[r].p,o[r].pe,o[r].sm,o[r].sme,o[r].s,o[r].se):MultiSpline.getSplineValueFunction(o[r].v,o[r].ve,o[r].p,o[r].pe,o[r].sm,o[r].sme,o[r].s,o[r].se),o[r].f=!0)}for(this.length&&this._clear(),r=0,n=o.length;r<n;r++)this._add(o[r])}},{key:"_add",value:function _add(e){this._p.push(e.p||0),this._pe.push(e.pe||0),this._idp.push(e.idp||0),this._f.push(e.f||!1),this._v.push(e.hasOwnProperty("v")?e.v:0),this._lv.push(e.lv||0),this._sm.push(e.sm||0),this._s.push(e.s||0),this._ve.push(e.ve||0),this._sme.push(e.sme||0),this._se.push(e.se||0),this._length++}},{key:"_getItem",value:function _getItem(e){var t=this._length;if(!t)return-1;if(e<this._p[0])return 0;for(var i=0;i<t;i++)if(this._p[i]<=e&&e<this._pe[i])return i;return t-1}},{key:"getValue",value:function getValue(e){var t=this._getItem(e);if(-1!==t){if(this._f[t]){var i=Math.min(1,Math.max(0,(e-this._p[t])*this._idp[t]));return this._v[t](i)}return this._v[t]}}},{key:"length",get:function get(){return this._length}}],[{key:"getRgbaComponents",value:function getRgbaComponents(e){return[(e/65536|0)%256,(e/256|0)%256,e%256,e/16777216|0]}},{key:"getSplineValueFunction",value:function getSplineValueFunction(e,t,i,r,n,s,o,h){var u=r-i;o*=u,h*=u;var l=MultiSpline.getSplineHelpers(e,t,n,s,o,h);return l?function(i){return 0===i?e:1===i?t:MultiSpline.calculateSpline(l,i)}:function(i){return 0===i?e:1===i?t:t*i+e*(1-i)}}},{key:"getSplineRgbaValueFunction",value:function getSplineRgbaValueFunction(e,t,i,r,n,s,o,h){var u=r-i;o[0]*=u,o[1]*=u,o[2]*=u,o[3]*=u,h[0]*=u,h[1]*=u,h[2]*=u,h[3]*=u;var l=MultiSpline.getRgbaComponents(e),_=MultiSpline.getRgbaComponents(t),d=[MultiSpline.getSplineHelpers(l[0],_[0],n,s,o[0],h[0]),MultiSpline.getSplineHelpers(l[1],_[1],n,s,o[1],h[1]),MultiSpline.getSplineHelpers(l[2],_[2],n,s,o[2],h[2]),MultiSpline.getSplineHelpers(l[3],_[3],n,s,o[3],h[3])];return d[0]?function(i){return 0===i?e:1===i?t:MultiSpline.getArgbNumber([Math.min(255,MultiSpline.calculateSpline(d[0],i)),Math.min(255,MultiSpline.calculateSpline(d[1],i)),Math.min(255,MultiSpline.calculateSpline(d[2],i)),Math.min(255,MultiSpline.calculateSpline(d[3],i))])}:function(i){return 0===i?e:1===i?t:MultiSpline.mergeColors(t,e,i)}}},{key:"getSplineHelpers",value:function getSplineHelpers(e,t,i,r,n,s){if(!i&&!r)return null;var o=e+n*i,h=1-r,u=t-s*r;return[3*i-3*h+1,-6*i+3*h,3*i,3*o-3*u+t-e,3*(u+e)-6*o,3*(o-e),e]}},{key:"calculateSpline",value:function calculateSpline(e,t){var i=e[0],r=e[1],n=e[2],s=e[3],o=e[4],h=e[5],u=e[6];if(-2===i&&-2===s&&0===n&&0===h)return t;for(var l,_=.5,d=0;d<20;d++){if((l=t-_*(_*(_*i+r)+n))>-1e-8&&l<1e-8)return _*(_*(_*s+o)+h)+u;var f=_*(_*(3*i)+2*r)+n;if(f>1e-10&&f<1e-10)break;_+=l/f}for(var g=0,p=1,v=0;v<20;v++){if((l=t-(_=.5*(g+p))*(_*(_*i+r)+n))>-1e-8&&l<1e-8)return _*(_*(_*s+o)+h)+u;l<0?p=_:g=_}return _}},{key:"mergeColors",value:function mergeColors(e,t,i){var r=(e/65536|0)%256*i+(t/65536|0)%256*(1-i),n=(e/256|0)%256*i+(t/256|0)%256*(1-i),s=e%256*i+t%256*(1-i),o=(e/16777216|0)*i+(t/16777216|0)*(1-i);return 16777216*Math.round(o)+65536*Math.round(r)+256*Math.round(n)+Math.round(s)}},{key:"getArgbNumber",value:function getArgbNumber(e){e[0]=Math.max(0,Math.min(255,e[0])),e[1]=Math.max(0,Math.min(255,e[1])),e[2]=Math.max(0,Math.min(255,e[2])),e[3]=Math.max(0,Math.min(255,e[3]));var t=((0|e[3])<<24)+((0|e[0])<<16)+((0|e[1])<<8)+(0|e[2]);return t<0&&(t=4294967295+t+1),t}}]),MultiSpline}(),me=function(){function AnimationActionSettings(e){_classCallCheck(this,AnimationActionSettings),this.animationSettings=e,this._selector="",this._items=new xe,this._props=[],this._propSetters=[],this._resetValue=void 0,this._hasResetValue=!1,this._hasColorProperty=void 0}return _createClass(AnimationActionSettings,[{key:"getResetValue",value:function getResetValue(){return this._hasResetValue?this._resetValue:this._items.getValue(0)}},{key:"apply",value:function apply(i,r,n){var s=this.getAnimatedElements(i),o=this._items.getValue(r);if(void 0!==o&&s.length){if(1!==n){var h=this.getResetValue();t.isNumber(o)&&t.isNumber(h)&&(o=this.hasColorProperty()?e.mergeColors(o,h,n):e.mergeNumbers(o,h,n))}for(var u=this._propSetters.length,l=s.length,_=0;_<l;_++)for(var d=0;d<u;d++)this._propSetters[d](s[_],o)}}},{key:"getAnimatedElements",value:function getAnimatedElements(e){return e.select(this._selector)}},{key:"reset",value:function reset(e){var t=this.getAnimatedElements(e),i=this.getResetValue();if(void 0!==i&&t.length)for(var r=this._propSetters.length,n=t.length,s=0;s<n;s++)for(var o=0;o<r;o++)this._propSetters[o](t[s],i)}},{key:"patch",value:function patch(e){i.patchObject(this,e)}},{key:"hasColorProperty",value:function hasColorProperty(){return void 0===this._hasColorProperty&&(this._hasColorProperty=!!this._props.length&&M.isColorProperty(this._props[0])),this._hasColorProperty}},{key:"selector",set:function set(e){this._selector=e}},{key:"t",set:function set(e){this.selector=e}},{key:"resetValue",get:function get(){return this._resetValue},set:function set(e){this._resetValue=e,this._hasResetValue=void 0!==e}},{key:"rv",set:function set(e){this.resetValue=e}},{key:"value",set:function set(e){this._items.parse(this.hasColorProperty(),e)}},{key:"v",set:function set(e){this.value=e}},{key:"properties",set:function set(e){var t=this;Array.isArray(e)||(e=[e]),this._props=[],e.forEach(function(e){_newArrowCheck(this,t),this._props.push(e),this._propSetters.push(M.getSetter(e))}.bind(this))}},{key:"property",set:function set(e){this._hasColorProperty=void 0,this.properties=e}},{key:"p",set:function set(e){this.properties=e}}]),AnimationActionSettings}();me.prototype.isAnimationActionSettings=!0;var ke=function(){function AnimationSettings(){_classCallCheck(this,AnimationSettings),this._actions=[],this.delay=0,this.duration=1,this.repeat=0,this.repeatOffset=0,this.repeatDelay=0,this.autostop=!1,this.stopMethod=AnimationSettings.STOP_METHODS.FADE,this._stopTimingFunction="ease",this._stopTimingFunctionImpl=e.getTimingFunction(this._stopTimingFunction),this.stopDuration=0,this.stopDelay=0}return _createClass(AnimationSettings,[{key:"apply",value:function apply(e,t){var i=arguments.length>2&&void 0!==arguments[2]?arguments[2]:1;this._actions.forEach((function(r){r.apply(e,t,i)}))}},{key:"reset",value:function reset(e){this._actions.forEach((function(t){t.reset(e)}))}},{key:"patch",value:function patch(e){i.patchObject(this,e)}},{key:"actions",get:function get(){return this._actions},set:function set(e){this._actions=[];for(var t=0,i=e.length;t<i;t++){var r=e[t];if(r.isAnimationActionSettings)this._actions.push(r);else{var n=new me(this);n.patch(r),this._actions.push(n)}}}},{key:"stopTimingFunction",get:function get(){return this._stopTimingFunction},set:function set(t){this._stopTimingFunction=t,this._stopTimingFunctionImpl=e.getTimingFunction(t)}},{key:"stopTimingFunctionImpl",get:function get(){return this._stopTimingFunctionImpl}}]),AnimationSettings}();ke.STOP_METHODS={FADE:"fade",REVERSE:"reverse",FORWARD:"forward",IMMEDIATE:"immediate",ONETOTWO:"onetotwo"};var Se=function(e){function Animation(e,t,i){var r;return _classCallCheck(this,Animation),(r=_possibleConstructorReturn(this,_getPrototypeOf(Animation).call(this))).manager=e,r._settings=t,r._element=i,r._state=Animation.STATES.IDLE,r._p=0,r._delayLeft=0,r._repeatsLeft=0,r._stopDelayLeft=0,r._stopP=0,r}return _inherits(Animation,e),_createClass(Animation,[{key:"start",value:function start(){this._element&&this._element.attached?(this._p=0,this._delayLeft=this.settings.delay,this._repeatsLeft=this.settings.repeat,this._state=Animation.STATES.PLAYING,this.emit("start"),this.checkActive()):console.warn("Element must be attached before starting animation")}},{key:"play",value:function play(){this._state===Animation.STATES.PAUSED?(this._state=Animation.STATES.PLAYING,this.checkActive(),this.emit("resume")):this._state==Animation.STATES.STOPPING&&this.settings.stopMethod==ke.STOP_METHODS.REVERSE?(this._state=Animation.STATES.PLAYING,this.emit("stopContinue")):this._state!=Animation.STATES.PLAYING&&this._state!=Animation.STATES.FINISHED&&this.start()}},{key:"pause",value:function pause(){this._state===Animation.STATES.PLAYING&&(this._state=Animation.STATES.PAUSED,this.emit("pause"))}},{key:"replay",value:function replay(){this._state==Animation.STATES.FINISHED?this.start():this.play()}},{key:"skipDelay",value:function skipDelay(){this._delayLeft=0,this._stopDelayLeft=0}},{key:"finish",value:function finish(){this._state===Animation.STATES.PLAYING?(this._delayLeft=0,this._p=1):this._state===Animation.STATES.STOPPING&&(this._stopDelayLeft=0,this._p=0)}},{key:"stop",value:function stop(){this._state!==Animation.STATES.STOPPED&&this._state!==Animation.STATES.IDLE&&(this._stopDelayLeft=this.settings.stopDelay||0,this.settings.stopMethod===ke.STOP_METHODS.IMMEDIATE&&!this._stopDelayLeft||this._delayLeft>0?(this._state=Animation.STATES.STOPPING,this.emit("stop")):(this.settings.stopMethod===ke.STOP_METHODS.FADE&&(this._stopP=0),this._state=Animation.STATES.STOPPING,this.emit("stop")),this.checkActive())}},{key:"stopNow",value:function stopNow(){this._state===Animation.STATES.STOPPED&&this._state===Animation.STATES.IDLE||(this._state=Animation.STATES.STOPPING,this._p=0,this.emit("stop"),this.reset(),this._state=Animation.STATES.STOPPED,this.emit("stopFinish"))}},{key:"isPaused",value:function isPaused(){return this._state===Animation.STATES.PAUSED}},{key:"isPlaying",value:function isPlaying(){return this._state===Animation.STATES.PLAYING}},{key:"isStopping",value:function isStopping(){return this._state===Animation.STATES.STOPPING}},{key:"isFinished",value:function isFinished(){return this._state===Animation.STATES.FINISHED}},{key:"checkActive",value:function checkActive(){this.isActive()&&this.manager.addActive(this)}},{key:"isActive",value:function isActive(){return(this._state==Animation.STATES.PLAYING||this._state==Animation.STATES.STOPPING)&&this._element&&this._element.attached}},{key:"progress",value:function progress(e){this._element&&(this._progress(e),this.apply())}},{key:"_progress",value:function _progress(e){if(this._state!=Animation.STATES.STOPPING){if(this._state==Animation.STATES.PLAYING){if(this._delayLeft>0){if(this._delayLeft-=e,!(this._delayLeft<0))return;e=-this._delayLeft,this._delayLeft=0,this.emit("delayEnd")}0===this.settings.duration?this._p=1:this.settings.duration>0&&(this._p+=e/this.settings.duration),this._p>=1?-1==this.settings.repeat||this._repeatsLeft>0?(this._repeatsLeft>0&&this._repeatsLeft--,this._p=this.settings.repeatOffset,this.emit("progress",this._p),this.settings.repeatDelay&&(this._delayLeft=this.settings.repeatDelay),this.emit("repeat",this._repeatsLeft)):(this._p=1,this.emit("progress",this._p),this._state=Animation.STATES.FINISHED,this.emit("finish"),this.settings.autostop&&this.stop()):this.emit("progress",this._p)}}else this._stopProgress(e)}},{key:"_stopProgress",value:function _stopProgress(e){var t=this._getStopDuration();if(this._stopDelayLeft>0){if(this._stopDelayLeft-=e,!(this._stopDelayLeft<0))return;e=-this._stopDelayLeft,this._stopDelayLeft=0,this.emit("stopDelayEnd")}this.settings.stopMethod==ke.STOP_METHODS.IMMEDIATE?(this._state=Animation.STATES.STOPPED,this.emit("stopFinish")):this.settings.stopMethod==ke.STOP_METHODS.REVERSE?(0===t?this._p=0:t>0&&(this._p-=e/t),this._p<=0&&(this._p=0,this._state=Animation.STATES.STOPPED,this.emit("stopFinish"))):this.settings.stopMethod==ke.STOP_METHODS.FADE?(this._progressStopTransition(e),this._stopP>=1&&(this._p=0,this._state=Animation.STATES.STOPPED,this.emit("stopFinish"))):this.settings.stopMethod==ke.STOP_METHODS.ONETOTWO?this._p<2&&(0===t?this._p=2:t>0&&(this._p<1?this._p+=e/this.settings.duration:this._p+=e/t),this._p>=2?(this._p=2,this._state=Animation.STATES.STOPPED,this.emit("stopFinish")):this.emit("progress",this._p)):this.settings.stopMethod==ke.STOP_METHODS.FORWARD&&this._p<1&&(0==this.settings.duration?this._p=1:this._p+=e/this.settings.duration,this._p>=1?this.settings.stopMethod==ke.STOP_METHODS.FORWARD?(this._p=1,this._state=Animation.STATES.STOPPED,this.emit("stopFinish")):this._repeatsLeft>0?(this._repeatsLeft--,this._p=0,this.emit("repeat",this._repeatsLeft)):(this._p=1,this._state=Animation.STATES.STOPPED,this.emit("stopFinish")):this.emit("progress",this._p))}},{key:"_progressStopTransition",value:function _progressStopTransition(e){if(this._stopP<1){if(this._stopDelayLeft>0){if(this._stopDelayLeft-=e,!(this._stopDelayLeft<0))return;e=-this._stopDelayLeft,this._stopDelayLeft=0,this.emit("delayEnd")}var t=this._getStopDuration();0==t?this._stopP=1:this._stopP+=e/t,this._stopP>=1&&(this._stopP=1)}}},{key:"_getStopDuration",value:function _getStopDuration(){return this.settings.stopDuration||this.settings.duration}},{key:"apply",value:function apply(){if(this._state===Animation.STATES.STOPPED)this.reset();else{var e=1;this._state===Animation.STATES.STOPPING&&this.settings.stopMethod===ke.STOP_METHODS.FADE&&(e=1-this.settings.stopTimingFunctionImpl(this._stopP)),this._settings.apply(this._element,this._p,e)}}},{key:"reset",value:function reset(){this._settings.reset(this._element)}},{key:"state",get:function get(){return this._state}},{key:"p",get:function get(){return this._p}},{key:"delayLeft",get:function get(){return this._delayLeft}},{key:"element",get:function get(){return this._element}},{key:"frame",get:function get(){return Math.round(this._p*this._settings.duration*60)}},{key:"settings",get:function get(){return this._settings}}]),Animation}(C);Se.STATES={IDLE:0,PLAYING:1,STOPPING:2,STOPPED:3,FINISHED:4,PAUSED:5};var Ce=function(){function AnimationManager(e){var t=this;_classCallCheck(this,AnimationManager),this.stage=e,this.stage.on("frameStart",function(){return _newArrowCheck(this,t),this.progress()}.bind(this)),this.active=new Set}return _createClass(AnimationManager,[{key:"progress",value:function progress(){var e=this;if(this.active.size){var t=this.stage.dt,i=!1;this.active.forEach((function(e){e.isActive()?e.progress(t):i=!0})),i&&(this.active=new Set(_toConsumableArray(this.active).filter(function(t){return _newArrowCheck(this,e),t.isActive()}.bind(this))))}}},{key:"createAnimation",value:function createAnimation(e,i){return t.isObjectLiteral(i)&&(i=this.createSettings(i)),new Se(this,i,e)}},{key:"createSettings",value:function createSettings(e){var t=new ke;return i.patchObject(t,e),t}},{key:"addActive",value:function addActive(e){this.active.add(e)}}]),AnimationManager}(),Te=function(e){function RectangleTexture(){return _classCallCheck(this,RectangleTexture),_possibleConstructorReturn(this,_getPrototypeOf(RectangleTexture).apply(this,arguments))}return _inherits(RectangleTexture,e),_createClass(RectangleTexture,[{key:"_getLookupId",value:function _getLookupId(){return"__whitepix"}},{key:"_getSourceLoader",value:function _getSourceLoader(){return function(e){e(null,{source:new Uint8Array([255,255,255,255]),w:1,h:1,permanent:!0})}}},{key:"isAutosizeTexture",value:function isAutosizeTexture(){return!1}}]),RectangleTexture}(b),be=function(i){function Stage(){var e,i=arguments.length>0&&void 0!==arguments[0]?arguments[0]:{};_classCallCheck(this,Stage),(e=_possibleConstructorReturn(this,_getPrototypeOf(Stage).call(this)))._setOptions(i),e._usedMemory=0,e._lastGcFrame=0;var r=Stage.platform?Stage.platform:le.load(i);e.platform=new r,e.platform.init&&e.platform.init(_assertThisInitialized(e)),e.gl=null,e.c2d=null;var n=e.getOption("context");return n?n.useProgram?e.gl=n:e.c2d=n:!t.isWeb||Stage.isWebglSupported()&&!e.getOption("canvas2d")?e.gl=e.platform.createWebGLContext(e.getOption("w"),e.getOption("h")):(console.log("Using canvas2d renderer"),e.c2d=e.platform.createCanvasContext(e.getOption("w"),e.getOption("h"))),e.gl&&de.enable(e.gl,"lightning"),e._mode=e.gl?0:1,e.getCanvas()&&(e._options.w=e.getCanvas().width,e._options.h=e.getCanvas().height),0===e._mode?t.isSpark?e._renderer=new se(_assertThisInitialized(e)):e._renderer=new Z(_assertThisInitialized(e)):e._renderer=new re(_assertThisInitialized(e)),e.setClearColor(e.getOption("clearColor")),e.frameCounter=0,e.transitions=new ye(_assertThisInitialized(e)),e.animations=new Ce(_assertThisInitialized(e)),e.textureManager=new fe(_assertThisInitialized(e)),e.textureThrottler=new ge(_assertThisInitialized(e)),e.startTime=0,e.currentTime=0,e.dt=0,e.rectangleTexture=new Te(_assertThisInitialized(e)),e.rectangleTexture.load(),e.rectangleTexture.source.permanent=!0,e.ctx=new pe(_assertThisInitialized(e)),e._updateSourceTextures=new Set,e}return _inherits(Stage,i),_createClass(Stage,[{key:"isWebgl",value:function isWebgl(){return 0===this.mode}},{key:"isC2d",value:function isC2d(){return 1===this.mode}},{key:"getOption",value:function getOption(e){return this._options[e]}},{key:"_setOptions",value:function _setOptions(e){var t=this;this._options={};var i=function opt(i,r){_newArrowCheck(this,t);var n=e[i];this._options[i]=void 0===n?r:n}.bind(this);i("canvas",null),i("context",null),i("w",1920),i("h",1080),i("srcBasePath",null),i("memoryPressure",24e6),i("bufferMemory",2e6),i("textRenderIssueMargin",0),i("clearColor",[0,0,0,0]),i("defaultFontFace","sans-serif"),i("fixedDt",0),i("useImageWorker",!0),i("autostart",!0),i("precision",1),i("canvas2d",!1),i("platform",null),i("readPixelsBeforeDraw",!1)}},{key:"setApplication",value:function setApplication(e){this.application=e}},{key:"init",value:function init(){this.application.setAsRoot(),this.getOption("autostart")&&this.platform.startLoop()}},{key:"destroy",value:function destroy(){this.platform.stopLoop(),this.platform.destroy(),this.ctx.destroy(),this.textureManager.destroy(),this._renderer.destroy()}},{key:"stop",value:function stop(){this.platform.stopLoop()}},{key:"resume",value:function resume(){this.platform.startLoop()}},{key:"getCanvas",value:function getCanvas(){return this._mode?this.c2d.canvas:this.gl.canvas}},{key:"getRenderPrecision",value:function getRenderPrecision(){return this._options.precision}},{key:"addUpdateSourceTexture",value:function addUpdateSourceTexture(e){this._updatingFrame?e._performUpdateSource():this._updateSourceTextures.add(e)}},{key:"removeUpdateSourceTexture",value:function removeUpdateSourceTexture(e){this._updateSourceTextures&&this._updateSourceTextures.delete(e)}},{key:"hasUpdateSourceTexture",value:function hasUpdateSourceTexture(e){return this._updateSourceTextures&&this._updateSourceTextures.has(e)}},{key:"drawFrame",value:function drawFrame(){var e=this;this.startTime=this.currentTime,this.currentTime=this.platform.getHrTime(),this._options.fixedDt?this.dt=this._options.fixedDt:this.dt=this.startTime?.001*(this.currentTime-this.startTime):.02,this.emit("frameStart"),this._updateSourceTextures.size&&(this._updateSourceTextures.forEach(function(t){_newArrowCheck(this,e),t._performUpdateSource()}.bind(this)),this._updateSourceTextures=new Set),this.emit("update");var t=this.ctx.hasRenderUpdates();this.textureThrottler.processSome(),t&&(this._updatingFrame=!0,this.ctx.update(),this.ctx.render(),this._updatingFrame=!1),this.platform.nextFrame(t),this.emit("frameEnd"),this.frameCounter++}},{key:"isUpdatingFrame",value:function isUpdatingFrame(){return this._updatingFrame}},{key:"renderFrame",value:function renderFrame(){this.ctx.frame()}},{key:"forceRenderUpdate",value:function forceRenderUpdate(){this.root&&this.root.core._parent.setHasRenderUpdates(1)}},{key:"setClearColor",value:function setClearColor(t){this.forceRenderUpdate(),null===t?this._clearColor=null:Array.isArray(t)?this._clearColor=t:this._clearColor=e.getRgbaComponentsNormalized(t)}},{key:"getClearColor",value:function getClearColor(){return this._clearColor}},{key:"createElement",value:function createElement(e){return e?this.element(e):new M(this)}},{key:"createShader",value:function createShader(e){return T.create(this,e)}},{key:"element",value:function element(e){return e.isElement?e:(element=e.type?new e.type(this):new M(this),element.patch(e),element);var element}},{key:"c",value:function c(e){return this.element(e)}},{key:"addMemoryUsage",value:function addMemoryUsage(e){this._usedMemory+=e,this._lastGcFrame!==this.frameCounter&&this._usedMemory>this.getOption("memoryPressure")&&(this.gc(!1),this._usedMemory>this.getOption("memoryPressure")-2e6&&this.gc(!0))}},{key:"gc",value:function gc(e){if(this._lastGcFrame!==this.frameCounter){this._lastGcFrame=this.frameCounter;var t=this._usedMemory;this.gcTextureMemory(e),this.gcRenderTextureMemory(e),this.renderer.gc(e),console.log("GC".concat(e?"[aggressive]":"","! Frame ").concat(this._lastGcFrame," Freed ").concat(((t-this._usedMemory)/1e6).toFixed(2),"MP from GPU memory. Remaining: ").concat((this._usedMemory/1e6).toFixed(2),"MP"));var i=this._usedMemory-this.textureManager.usedMemory-this.ctx.usedMemory;console.log(" Textures: ".concat((this.textureManager.usedMemory/1e6).toFixed(2),"MP, Render Textures: ").concat((this.ctx.usedMemory/1e6).toFixed(2),"MP, Renderer caches: ").concat((i/1e6).toFixed(2),"MP"))}}},{key:"gcTextureMemory",value:function gcTextureMemory(){var e=arguments.length>0&&void 0!==arguments[0]&&arguments[0];e&&this.ctx.root.visible?(this.ctx.root.visible=!1,this.textureManager.gc(),this.ctx.root.visible=!0):this.textureManager.gc()}},{key:"gcRenderTextureMemory",value:function gcRenderTextureMemory(){var e=arguments.length>0&&void 0!==arguments[0]&&arguments[0];e&&this.root.visible?(this.root.visible=!1,this.ctx.freeUnusedRenderTextures(0),this.root.visible=!0):this.ctx.freeUnusedRenderTextures(0)}},{key:"getDrawingCanvas",value:function getDrawingCanvas(){return this.platform.getDrawingCanvas()}},{key:"update",value:function update(){this.ctx.update()}},{key:"addServiceProvider",value:function addServiceProvider(e){t.isSpark&&this.platform.addServiceProvider(e)}},{key:"renderer",get:function get(){return this._renderer}},{key:"mode",get:function get(){return this._mode}},{key:"root",get:function get(){return this.application}},{key:"w",get:function get(){return this._options.w}},{key:"h",get:function get(){return this._options.h}},{key:"coordsWidth",get:function get(){return this.w/this._options.precision}},{key:"coordsHeight",get:function get(){return this.h/this._options.precision}},{key:"usedMemory",get:function get(){return this._usedMemory}}],[{key:"isWebglSupported",value:function isWebglSupported(){if(t.isNode)return!0;try{return!!window.WebGLRenderingContext}catch(e){return!1}}}]),Stage}(C),Ae=function(e){function Application(){var e,t=this,i=arguments.length>0&&void 0!==arguments[0]?arguments[0]:{},r=arguments.length>1?arguments[1]:void 0;_classCallCheck(this,Application),Application._temp_options=i,Application.booting=!0;var n=new be(i.stage);return e=_possibleConstructorReturn(this,_getPrototypeOf(Application).call(this,n,r)),Application.booting=!1,e.__updateFocusCounter=0,e.__keypressTimers=new Map,e.stage.init(),e.updateFocusSettings(),e.__keymap=e.getOption("keys"),e.__keymap&&(e.stage.platform.registerKeydownHandler(function(i){_newArrowCheck(this,t),e._receiveKeydown(i)}.bind(this)),e.stage.platform.registerKeyupHandler(function(i){_newArrowCheck(this,t),e._receiveKeyup(i)}.bind(this))),e}return _inherits(Application,e),_createClass(Application,[{key:"getOption",value:function getOption(e){return this.__options[e]}},{key:"_setOptions",value:function _setOptions(e){var t=this;this.__options={};var i=function opt(i,r){_newArrowCheck(this,t);var n=e[i];this.__options[i]=void 0===n?r:n}.bind(this);i("debug",!1),i("keys",{38:"Up",40:"Down",37:"Left",39:"Right",13:"Enter",8:"Back",27:"Exit"})}},{key:"__construct",value:function __construct(){this.stage.setApplication(this),this._setOptions(Application._temp_options),delete Application._temp_options,_get(_getPrototypeOf(Application.prototype),"__construct",this).call(this)}},{key:"__init",value:function __init(){_get(_getPrototypeOf(Application.prototype),"__init",this).call(this),this.__updateFocus()}},{key:"updateFocusPath",value:function updateFocusPath(){this.__updateFocus()}},{key:"__updateFocus",value:function __updateFocus(){var e=this.__updateFocusRec();!Application.booting&&e&&this.updateFocusSettings()}},{key:"__updateFocusRec",value:function __updateFocusRec(){var e=++this.__updateFocusCounter;this.__updateFocusId=e;var t=this.__getFocusPath(),i=t[t.length-1],r=this._focusPath?this._focusPath[this._focusPath.length-1]:void 0;if(!r){this._focusPath=[];for(var n=0,s=t.length;n<s;n++){if(this._focusPath.push(t[n]),this._focusPath[n]._focus(i,void 0),this.__updateFocusId!==e)return!1}return!0}var o,h=Math.min(this._focusPath.length,t.length);for(o=0;o<h&&this._focusPath[o]===t[o];o++);if(this._focusPath.length!==t.length||o!==t.length){this.__options.debug&&console.log("FOCUS "+i.getLocationString());for(var u=this._focusPath.length-1;u>=o;u--){if(this._focusPath.pop()._unfocus(i,r),this.__updateFocusId!==e)return!1}for(var l=o,_=t.length;l<_;l++){if(this._focusPath.push(t[l]),this._focusPath[l]._focus(i,r),this.__updateFocusId!==e)return!1}for(var d=0;d<o;d++)this._focusPath[d]._focusChange(i,r)}return!0}},{key:"updateFocusSettings",value:function updateFocusSettings(){for(var e=this._focusPath[this._focusPath.length-1],t={},i=U.prototype._setFocusSettings,r=0,n=this._focusPath.length;r<n;r++)this._focusPath[r]._setFocusSettings!==i&&this._focusPath[r]._setFocusSettings(t);for(var s=U.prototype._handleFocusSettings,o=0,h=this._focusPath.length;o<h;o++)this._focusPath[o]._handleFocusSettings!==s&&this._focusPath[o]._handleFocusSettings(t,this.__prevFocusSettings,e);this.__prevFocusSettings=t}},{key:"_handleFocusSettings",value:function _handleFocusSettings(e,t,i,r){}},{key:"__getFocusPath",value:function __getFocusPath(){for(var e=[this],t=this;;){var i=t._getFocused();if(!i||i===t)break;var r=i.cparent;if(r===t)e.push(i);else{var n=[i];do{r||t._throwError("Return value for _getFocused must be an attached descendant component but its '"+i.getLocationString()+"'"),n.push(r),r=r.cparent}while(r!==t);for(var s=0,o=n.length;s<o;s++)e.push(n[o-s-1])}t=i}return e}},{key:"focusTopDownEvent",value:function focusTopDownEvent(e){for(var t=this.focusPath,i=t.length,r=arguments.length,n=new Array(r>1?r-1:0),s=1;s<r;s++)n[s-1]=arguments[s];for(var o=0;o<i;o++){var h=t[o]._getMostSpecificHandledMember(e);if(void 0!==h){var u,l=(u=t[o])[h].apply(u,n);if(!1!==l)return!0}}return!1}},{key:"focusBottomUpEvent",value:function focusBottomUpEvent(e){for(var t=this.focusPath,i=t.length,r=arguments.length,n=new Array(r>1?r-1:0),s=1;s<r;s++)n[s-1]=arguments[s];for(var o=i-1;o>=0;o--){var h=t[o]._getMostSpecificHandledMember(e);if(void 0!==h){var u,l=(u=t[o])[h].apply(u,n);if(!1!==l)return!0}}return!1}},{key:"_receiveKeydown",value:function _receiveKeydown(e){var t,i=e,r=this.__keymap[e.keyCode],n=this.focusPath;if(r&&(t=Array.isArray(r)?r:[r]),t)for(var s=0,o=t.length;s<o;s++){var h=this.__keypressTimers.has(t[s]);if(n[n.length-1].longpress&&h)return;this.stage.application.focusTopDownEvent(["_capture".concat(t[s]),"_captureKey"],i)||this.stage.application.focusBottomUpEvent(["_handle".concat(t[s]),"_handleKey"],i)}else this.stage.application.focusTopDownEvent(["_captureKey"],i)||this.stage.application.focusBottomUpEvent(["_handleKey"],i);this.updateFocusPath();var u=n[n.length-1];if(t&&u.longpress)for(var l=0,_=t.length;l<_;l++)this._startLongpressTimer(t[l],u)}},{key:"_receiveKeyup",value:function _receiveKeyup(e){var t,i=e,r=this.__keymap[e.keyCode];if(r&&(t=Array.isArray(r)?r:[r]),t)for(var n=0,s=t.length;n<s;n++)this.stage.application.focusTopDownEvent(["_capture".concat(t[n],"Release"),"_captureKeyRelease"],i)||this.stage.application.focusBottomUpEvent(["_handle".concat(t[n],"Release"),"_handleKeyRelease"],i);else this.stage.application.focusTopDownEvent(["_captureKeyRelease"],i)||this.stage.application.focusBottomUpEvent(["_handleKeyRelease"],i);if(this.updateFocusPath(),t)for(var o=0,h=t.length;o<h;o++)this.__keypressTimers.has(t[o])&&(clearTimeout(this.__keypressTimers.get(t[o])),this.__keypressTimers.delete(t[o]))}},{key:"_startLongpressTimer",value:function _startLongpressTimer(e,i){var r=this,n=i.longpress,s=e.toLowerCase();if(n[s]){var o=n[s];t.isNumber(o)?this.__keypressTimers.set(e,setTimeout(function(){_newArrowCheck(this,r),this.stage.application.focusTopDownEvent(["_capture".concat(e,"Long"),"_captureKey"],{})||this.stage.application.focusBottomUpEvent(["_handle".concat(e,"Long"),"_handleKey"],{}),this.__keypressTimers.delete(e)}.bind(this),o||500)):i._throwError("config value for longpress must be a number")}}},{key:"destroy",value:function destroy(){this._destroyed||(this._destroy(),this.stage.destroy(),this._destroyed=!0)}},{key:"_destroy",value:function _destroy(){if(this.stage.setApplication(void 0),this._updateAttachedFlag(),this._updateEnabledFlag(),this.__keypressTimers.size){var e=!0,t=!1,i=void 0;try{for(var r,n=this.__keypressTimers.values()[Symbol.iterator]();!(e=(r=n.next()).done);e=!0){var s=r.value;clearTimeout(s)}}catch(e){t=!0,i=e}finally{try{e||null==n.return||n.return()}finally{if(t)throw i}}this.__keypressTimers.clear()}}},{key:"getCanvas",value:function getCanvas(){return this.stage.getCanvas()}},{key:"focusPath",get:function get(){return this._focusPath}}]),Application}(U),we=function(e){function StaticCanvasTexture(e){var t;return _classCallCheck(this,StaticCanvasTexture),(t=_possibleConstructorReturn(this,_getPrototypeOf(StaticCanvasTexture).call(this,e)))._factory=void 0,t._lookupId=void 0,t}return _inherits(StaticCanvasTexture,e),_createClass(StaticCanvasTexture,[{key:"_getIsValid",value:function _getIsValid(){return!!this._factory}},{key:"_getLookupId",value:function _getLookupId(){return this._lookupId}},{key:"_getSourceLoader",value:function _getSourceLoader(){var e=this,t=this._factory;return function(i){var r=this;return _newArrowCheck(this,e),t(function(e,t){if(_newArrowCheck(this,r),e)return i(e);i(null,this.stage.platform.getTextureOptionsForDrawingCanvas(t))}.bind(this),this.stage)}.bind(this)}},{key:"content",set:function set(e){var t=e.factory,i=e.lookupId,r=void 0===i?void 0:i;this._factory=t,this._lookupId=r,this._changed()}}]),StaticCanvasTexture}(b),Re=function(){function Tools(){_classCallCheck(this,Tools)}return _createClass(Tools,null,[{key:"getCanvasTexture",value:function getCanvasTexture(e,t){return{type:we,content:{factory:e,lookupId:t}}}},{key:"getRoundRect",value:function getRoundRect(e,i,r,n,s,o,h){var u=this;Array.isArray(r)||(r=[r,r,r,r]);var l=function factory(l,_){_newArrowCheck(this,u),t.isSpark?_.platform.createRoundRect(l,_,e,i,r,n,s,o,h):l(null,this.createRoundRect(_,e,i,r,n,s,o,h))}.bind(this),_="rect"+[e,i,n,s,o?1:0,h].concat(r).join(",");return Tools.getCanvasTexture(l,_)}},{key:"createRoundRect",value:function createRoundRect(i,r,n,s,o,h,u,l){void 0===u&&(u=!0),void 0===o&&(o=0);var _=i.platform.getDrawingCanvas(),d=_.getContext("2d");d.imageSmoothingEnabled=!0,_.width=r+o+2,_.height=n+o+2,d.beginPath();var f=.5*o+1,g=.5*o+1;return d.moveTo(f+s[0],g),d.lineTo(f+r-s[1],g),d.arcTo(f+r,g,f+r,g+s[1],s[1]),d.lineTo(f+r,g+n-s[2]),d.arcTo(f+r,g+n,f+r-s[2],g+n,s[2]),d.lineTo(f+s[3],g+n),d.arcTo(f,g+n,f,g+n-s[3],s[3]),d.lineTo(f,g+s[0]),d.arcTo(f,g,f+s[0],g,s[0]),d.closePath(),u&&(t.isNumber(l)?d.fillStyle=e.getRgbaString(l):d.fillStyle="white",d.fill()),o&&(t.isNumber(h)?d.strokeStyle=e.getRgbaString(h):d.strokeStyle="white",d.lineWidth=o,d.stroke()),_}},{key:"getShadowRect",value:function getShadowRect(e,i){var r=this,n=arguments.length>2&&void 0!==arguments[2]?arguments[2]:0,s=arguments.length>3&&void 0!==arguments[3]?arguments[3]:5,o=arguments.length>4&&void 0!==arguments[4]?arguments[4]:2*s;Array.isArray(n)||(n=[n,n,n,n]);var h=function factory(h,u){_newArrowCheck(this,r),t.isSpark?u.platform.createShadowRect(h,u,e,i,n,s,o):h(null,this.createShadowRect(u,e,i,n,s,o))}.bind(this),u="shadow"+[e,i,s,o].concat(n).join(",");return Tools.getCanvasTexture(h,u)}},{key:"createShadowRect",value:function createShadowRect(t,i,r,n,s,o){var h=t.platform.getDrawingCanvas(),u=h.getContext("2d");u.imageSmoothingEnabled=!0,h.width=i+2*o,h.height=r+2*o,u.globalAlpha=.01,u.fillRect(0,0,.01,.01),u.globalAlpha=1,u.shadowColor=e.getRgbaString(4294967295),u.fillStyle=e.getRgbaString(4294967295),u.shadowBlur=s,u.shadowOffsetX=i+10+o,u.shadowOffsetY=o,u.beginPath();var l=-(i+10);return u.moveTo(l+n[0],0),u.lineTo(l+i-n[1],0),u.arcTo(l+i,0,l+i,0+n[1],n[1]),u.lineTo(l+i,0+r-n[2]),u.arcTo(l+i,0+r,l+i-n[2],0+r,n[2]),u.lineTo(l+n[3],0+r),u.arcTo(l,0+r,l,0+r-n[3],n[3]),u.lineTo(l,0+n[0]),u.arcTo(l,0,l+n[0],0,n[0]),u.closePath(),u.fill(),h}},{key:"getSvgTexture",value:function getSvgTexture(e,i,r){var n=this,s=function factory(s,o){_newArrowCheck(this,n),t.isSpark?o.platform.createSvg(s,o,e,i,r):this.createSvg(s,o,e,i,r)}.bind(this),o="svg"+[i,r,e].join(",");return Tools.getCanvasTexture(s,o)}},{key:"createSvg",value:function createSvg(e,t,i,r,n){var s=this,o=t.platform.getDrawingCanvas(),h=o.getContext("2d");h.imageSmoothingEnabled=!0;var u=new Image;u.onload=function(){_newArrowCheck(this,s),o.width=r,o.height=n,h.drawImage(u,0,0,o.width,o.height),e(null,o)}.bind(this),u.onError=function(t){_newArrowCheck(this,s),e(t)}.bind(this),u.crossOrigin="Anonymous",u.src=i}}]),Tools}(),Le=function(){function ObjMerger(){_classCallCheck(this,ObjMerger)}return _createClass(ObjMerger,null,[{key:"isMf",value:function isMf(e){return t.isFunction(e)&&e.__mf}},{key:"mf",value:function mf(e){return e.__mf=!0,e}},{key:"merge",value:function merge(e,i){var r=Object.keys(e),n=Object.keys(i);if(!n.length)return e;for(var s={},o={},h=0,u=n.length;h<u;h++){var l=n[h];s[l]=-1,o[l]=h}for(var _=0,d=r.length;_<d;_++){var f=r[_];s[f]=_,void 0===o[f]&&(o[f]=-1)}for(var g=r.length,p={},v=0,y=n.length;v<y;v++){for(var x=n[v],m=s[x],k=m;--k>=0;){if(-1!==o[r[k]])break}for(;++k<m;){var S=r[k];p[S]=e[S]}var C=i[x],T=e[x],b=void 0;void 0!==(b=this.isMf(C)?C(T):t.isObjectLiteral(T)&&t.isObjectLiteral(C)?ObjMerger.merge(T,C):C)&&(p[x]=b)}for(var A=g;--A>=0;){if(-1!==o[r[A]])break}for(;++A<g;){var w=r[A];p[w]=e[w]}return p}}]),ObjMerger}(),Pe=function(e){function ObjectListProxy(e){var t;return _classCallCheck(this,ObjectListProxy),(t=_possibleConstructorReturn(this,_getPrototypeOf(ObjectListProxy).call(this)))._target=e,t}return _inherits(ObjectListProxy,e),_createClass(ObjectListProxy,[{key:"onAdd",value:function onAdd(e,t){this._target.addAt(e,t)}},{key:"onRemove",value:function onRemove(e,t){this._target.removeAt(t)}},{key:"onSync",value:function onSync(e,t,i){this._target._setByArray(i)}},{key:"onSet",value:function onSet(e,t){this._target.setAt(e,t)}},{key:"onMove",value:function onMove(e,t,i){this._target.setAt(e,i)}},{key:"createItem",value:function createItem(e){return this._target.createItem(e)}},{key:"isItem",value:function isItem(e){return this._target.isItem(e)}}]),ObjectListProxy}(O),Ee=function(e){function ObjectListWrapper(e,t){var i;return _classCallCheck(this,ObjectListWrapper),(i=_possibleConstructorReturn(this,_getPrototypeOf(ObjectListWrapper).call(this,e)))._wrap=t,i}return _inherits(ObjectListWrapper,e),_createClass(ObjectListWrapper,[{key:"wrap",value:function wrap(e){var t=this._wrap(e);return e._wrapper=t,t}},{key:"onAdd",value:function onAdd(e,t){e=this.wrap(e),_get(_getPrototypeOf(ObjectListWrapper.prototype),"onAdd",this).call(this,e,t)}},{key:"onRemove",value:function onRemove(e,t){_get(_getPrototypeOf(ObjectListWrapper.prototype),"onRemove",this).call(this,e,t)}},{key:"onSync",value:function onSync(e,t,i){var r=this;t.forEach(function(e){return _newArrowCheck(this,r),this.wrap(e)}.bind(this)),i=i.map(function(e){return _newArrowCheck(this,r),e._wrapper}.bind(this)),_get(_getPrototypeOf(ObjectListWrapper.prototype),"onSync",this).call(this,e,t,i)}},{key:"onSet",value:function onSet(e,t){e=this.wrap(e),_get(_getPrototypeOf(ObjectListWrapper.prototype),"onSet",this).call(this,e,t)}},{key:"onMove",value:function onMove(e,t,i){_get(_getPrototypeOf(ObjectListWrapper.prototype),"onMove",this).call(this,e,t,i)}}]),ObjectListWrapper}(Pe),Oe=function(e){function NoiseTexture(){return _classCallCheck(this,NoiseTexture),_possibleConstructorReturn(this,_getPrototypeOf(NoiseTexture).apply(this,arguments))}return _inherits(NoiseTexture,e),_createClass(NoiseTexture,[{key:"_getLookupId",value:function _getLookupId(){return"__noise"}},{key:"_getSourceLoader",value:function _getSourceLoader(){var e=this.stage.gl;return function(t){for(var i=new Uint8Array(65536),r=0;r<65536;r+=4){var n=Math.floor(256*Math.random());i[r]=n,i[r+1]=n,i[r+2]=n,i[r+3]=255}var s={};e&&(s[e.TEXTURE_WRAP_S]=e.REPEAT,s[e.TEXTURE_WRAP_T]=e.REPEAT,s[e.TEXTURE_MIN_FILTER]=e.NEAREST,s[e.TEXTURE_MAG_FILTER]=e.NEAREST),t(null,{source:i,w:128,h:128,texParams:s})}}}]),NoiseTexture}(b),ze=function(e){function HtmlTexture(e){var t;return _classCallCheck(this,HtmlTexture),(t=_possibleConstructorReturn(this,_getPrototypeOf(HtmlTexture).call(this,e)))._htmlElement=void 0,t._scale=1,t}return _inherits(HtmlTexture,e),_createClass(HtmlTexture,[{key:"_getIsValid",value:function _getIsValid(){return this.htmlElement}},{key:"_getLookupId",value:function _getLookupId(){return this._scale+":"+this._htmlElement.innerHTML}},{key:"_getSourceLoader",value:function _getSourceLoader(){var e=this._htmlElement,t=this._scale;return function(i){var r=this;if(!window.html2canvas)return i(new Error("Please include html2canvas (https://html2canvas.hertzen.com/)"));var n=HtmlTexture.getPreloadArea();n.appendChild(e),html2canvas(e,{backgroundColor:null,scale:t}).then((function(t){if(n.removeChild(e),0===t.height)return i(new Error("Canvas height is 0"));i(null,{source:t,width:t.width,height:t.height})})).catch(function(e){_newArrowCheck(this,r),console.error(e)}.bind(this))}}},{key:"htmlElement",set:function set(e){this._htmlElement=e,this._changed()},get:function get(){return this._htmlElement}},{key:"scale",set:function set(e){this._scale=e,this._changed()},get:function get(){return this._scale}},{key:"html",set:function set(e){if(e){var t=document.createElement("div");t.innerHTML="<div>"+e+"</div>",this.htmlElement=t.firstElementChild}else this.htmlElement=void 0},get:function get(){return this._htmlElement.innerHTML}}],[{key:"getPreloadArea",value:function getPreloadArea(){return this._preloadArea||(this._preloadArea=document.createElement("div"),this._preloadArea.attachShadow&&this._preloadArea.attachShadow({mode:"closed"}),this._preloadArea.style.opacity=0,this._preloadArea.style.pointerEvents="none",this._preloadArea.style.position="fixed",this._preloadArea.style.display="block",this._preloadArea.style.top="100vh",this._preloadArea.style.overflow="hidden",document.body.appendChild(this._preloadArea)),this._preloadArea}}]),HtmlTexture}(b),Me=function(e){function StaticTexture(e,t){var i;return _classCallCheck(this,StaticTexture),(i=_possibleConstructorReturn(this,_getPrototypeOf(StaticTexture).call(this,e)))._options=t,i}return _inherits(StaticTexture,e),_createClass(StaticTexture,[{key:"_getIsValid",value:function _getIsValid(){return!!this._options}},{key:"_getSourceLoader",value:function _getSourceLoader(){var e=this;return function(t){_newArrowCheck(this,e),t(null,this._options)}.bind(this)}},{key:"options",set:function set(e){this._options!==e&&(this._options=e,this._changed())},get:function get(){return this._options}}]),StaticTexture}(b),Fe=function(e){function ListComponent(e){var t;return _classCallCheck(this,ListComponent),(t=_possibleConstructorReturn(this,_getPrototypeOf(ListComponent).call(this,e)))._wrapper=_get(_getPrototypeOf(ListComponent.prototype),"_children",_assertThisInitialized(t)).a({}),t._reloadVisibleElements=!1,t._visibleItems=new Set,t._index=0,t._started=!1,t._scrollTransitionSettings=t.stage.transitions.createSettings({}),t._itemSize=100,t._viewportScrollOffset=0,t._itemScrollOffset=0,t._roll=!1,t._rollMin=0,t._rollMax=0,t._progressAnimation=null,t._invertDirection=!1,t._horizontal=!0,t.itemList=new Ie(_assertThisInitialized(t)),t}return _inherits(ListComponent,e),_createClass(ListComponent,[{key:"_allowChildrenAccess",value:function _allowChildrenAccess(){return!1}},{key:"start",value:function start(){var e=this;this._wrapper.transition(this.property,this._scrollTransitionSettings),this._scrollTransition=this._wrapper.transition(this.property),this._scrollTransition.on("progress",function(t){return _newArrowCheck(this,e),this.update()}.bind(this)),this.setIndex(0,!0,!0),this._started=!0,this.update()}},{key:"setIndex",value:function setIndex(e){var i=arguments.length>1&&void 0!==arguments[1]&&arguments[1],r=arguments.length>2&&void 0!==arguments[2]&&arguments[2],n=this.length;if(n){if(this.emit("unfocus",this.getElement(this.realIndex),this._index,this.realIndex),r){var s=t.getModuloIndex(e,n),o=t.getModuloIndex(this.index,n),h=s-o;h>.5*n?h-=n:h<-.5*n&&(h+=n),this._index+=h}else this._index=e;(this._roll||this.viewportSize>this._itemSize*n)&&(this._index=t.getModuloIndex(this._index,n));var u,l,_,d=this._horizontal^this._invertDirection?-1:1,f=d*this._index*this._itemSize;if(this._roll)if(1==d)l=(n-1)*this._itemSize,l-=_=this._viewportScrollOffset*this.viewportSize-this._itemScrollOffset*this._itemSize,u=this.viewportSize-(this._itemSize+_),this._rollMin&&(u-=this._rollMin),this._rollMax&&(l+=this._rollMax),f=Math.max(Math.min(f,l),u);else{l=n*this._itemSize-this.viewportSize,l+=_=this._viewportScrollOffset*this.viewportSize-this._itemScrollOffset*this._itemSize;var g=_;this._rollMin&&(g-=this._rollMin),this._rollMax&&(l+=this._rollMax),f=Math.min(Math.max(-l,f),-g)}this._scrollTransition.start(f),i&&this._scrollTransition.finish(),this.emit("focus",this.getElement(this.realIndex),this._index,this.realIndex)}}},{key:"getAxisPosition",value:function getAxisPosition(){var e=-this._scrollTransition._targetValue,t=-(this._horizontal^this._invertDirection?-1:1)*this._index*this._itemSize;return this._viewportScrollOffset*this.viewportSize+(t-e)}},{key:"update",value:function update(){if(this._started){var e=this.length;if(e){var i,r,n,s,o=this._horizontal^this._invertDirection?-1:1,h=this._horizontal?this._wrapper.x:this._wrapper.y,u=this.viewportSize,l=this._viewportScrollOffset*u-this._itemScrollOffset*this._itemSize;h+=l,-1==o?(i=Math.floor(-h/this._itemSize),n=1-(-h/this._itemSize-i),r=Math.floor((u-h)/this._itemSize),s=(u-h)/this._itemSize-r):(i=Math.ceil(h/this._itemSize),n=1+h/this._itemSize-i,s=(r=Math.ceil((h-u)/this._itemSize))-(h-u)/this._itemSize),(this._roll||u>this._itemSize*e)&&(r>=e&&(r=e-1,s=1),i>=e&&(i=e-1,n=1),r<=-1&&(r=0,s=1),i<=-1&&(i=0,n=1));for(var _,d=-o*i*this._itemSize,f=i;-1==o?f<=r:f>=r;-1==o?f++:f--){var g=t.getModuloIndex(f,e),p=this.getElement(g);_=p.parent,this._visibleItems.delete(_),this._horizontal?_.x=d+l:_.y=d+l;var v=_.visible;if(_.visible=!0,v&&!this._reloadVisibleElements||this.emit("visible",f,g),this._progressAnimation){var y=1;f==i?y=n:f==r&&(y=s),this._progressAnimation.apply(p,y)}d+=this._itemSize}var x=this;this._visibleItems.forEach((function(e){e.visible=!1,x._visibleItems.delete(e)}));for(var m=i;-1==o?m<=r:m>=r;-1==o?m++:m--){var k=t.getModuloIndex(m,e);this._visibleItems.add(this.getWrapper(k))}this._reloadVisibleElements=!1}}}},{key:"setPrevious",value:function setPrevious(){this.setIndex(this._index-1)}},{key:"setNext",value:function setNext(){this.setIndex(this._index+1)}},{key:"getWrapper",value:function getWrapper(e){return this._wrapper.children[e]}},{key:"getElement",value:function getElement(e){var t=this._wrapper.children[e];return t?t.children[0]:null}},{key:"reload",value:function reload(){this._reloadVisibleElements=!0,this.update()}},{key:"items",get:function get(){return this.itemList.get()},set:function set(e){this.itemList.patch(e)}},{key:"element",get:function get(){var e=this._wrapper.children[this.realIndex];return e?e.children[0]:null}},{key:"length",get:function get(){return this._wrapper.children.length}},{key:"property",get:function get(){return this._horizontal?"x":"y"}},{key:"viewportSize",get:function get(){return this._horizontal?this.w:this.h}},{key:"index",get:function get(){return this._index}},{key:"realIndex",get:function get(){return t.getModuloIndex(this._index,this.length)}},{key:"itemSize",get:function get(){return this._itemSize},set:function set(e){this._itemSize=e,this.update()}},{key:"viewportScrollOffset",get:function get(){return this._viewportScrollOffset},set:function set(e){this._viewportScrollOffset=e,this.update()}},{key:"itemScrollOffset",get:function get(){return this._itemScrollOffset},set:function set(e){this._itemScrollOffset=e,this.update()}},{key:"scrollTransitionSettings",get:function get(){return this._scrollTransitionSettings},set:function set(e){this._scrollTransitionSettings.patch(e)}},{key:"scrollTransition",set:function set(e){this._scrollTransitionSettings.patch(e)},get:function get(){return this._scrollTransition}},{key:"progressAnimation",get:function get(){return this._progressAnimation},set:function set(e){t.isObjectLiteral(e)?this._progressAnimation=this.stage.animations.createSettings(e):this._progressAnimation=e,this.update()}},{key:"roll",get:function get(){return this._roll},set:function set(e){this._roll=e,this.update()}},{key:"rollMin",get:function get(){return this._rollMin},set:function set(e){this._rollMin=e,this.update()}},{key:"rollMax",get:function get(){return this._rollMax},set:function set(e){this._rollMax=e,this.update()}},{key:"invertDirection",get:function get(){return this._invertDirection},set:function set(e){this._started||(this._invertDirection=e)}},{key:"horizontal",get:function get(){return this._horizontal},set:function set(e){e!==this._horizontal&&(this._started||(this._horizontal=e))}}]),ListComponent}(U),Ie=function(e){function ListItems(e){var t,i=this;_classCallCheck(this,ListItems);var r=function wrap(e){_newArrowCheck(this,i);var t=e.stage.createElement();return t.add(e),t.visible=!1,t}.bind(this);return(t=_possibleConstructorReturn(this,_getPrototypeOf(ListItems).call(this,e._wrapper._children,r))).list=e,t}return _inherits(ListItems,e),_createClass(ListItems,[{key:"onAdd",value:function onAdd(e,t){_get(_getPrototypeOf(ListItems.prototype),"onAdd",this).call(this,e,t),this.checkStarted(t)}},{key:"checkStarted",value:function checkStarted(e){this.list._reloadVisibleElements=!0,this.list._started?(1===this.list.length?this.list.setIndex(0,!0,!0):this.list._index>=this.list.length&&this.list.setIndex(0),this.list.update()):this.list.start()}},{key:"onRemove",value:function onRemove(e,t){_get(_getPrototypeOf(ListItems.prototype),"onRemove",this).call(this,e,t);var i=this.list.realIndex;i===t?(i===this.list.length&&i--,i>=0&&this.list.setIndex(i)):i>t&&this.list.setIndex(i-1),this.list._reloadVisibleElements=!0}},{key:"onSet",value:function onSet(e,t){_get(_getPrototypeOf(ListItems.prototype),"onSet",this).call(this,e,t),this.checkStarted(t)}},{key:"onSync",value:function onSync(e,t,i){_get(_getPrototypeOf(ListItems.prototype),"onSync",this).call(this,e,t,i),this.checkStarted(0)}},{key:"_signalProxy",get:function get(){return!0}}]),ListItems}(Ee),Ue=function(e){function LinearBlurShader(e){var t;return _classCallCheck(this,LinearBlurShader),(t=_possibleConstructorReturn(this,_getPrototypeOf(LinearBlurShader).call(this,e)))._direction=new Float32Array([1,0]),t._kernelRadius=1,t}return _inherits(LinearBlurShader,e),_createClass(LinearBlurShader,[{key:"useDefault",value:function useDefault(){return 0===this._kernelRadius}},{key:"setupUniforms",value:function setupUniforms(e){_get(_getPrototypeOf(LinearBlurShader.prototype),"setupUniforms",this).call(this,e),this._setUniform("direction",this._direction,this.gl.uniform2fv),this._setUniform("kernelRadius",this._kernelRadius,this.gl.uniform1i);var t=e.getRenderWidth(),i=e.getRenderHeight();this._setUniform("resolution",new Float32Array([t,i]),this.gl.uniform2fv)}},{key:"x",get:function get(){return this._direction[0]},set:function set(e){this._direction[0]=e,this.redraw()}},{key:"y",get:function get(){return this._direction[1]},set:function set(e){this._direction[1]=e,this.redraw()}},{key:"kernelRadius",get:function get(){return this._kernelRadius},set:function set(e){this._kernelRadius=e,this.redraw()}}]),LinearBlurShader}(Y);Ue.fragmentShaderSource="\n    #ifdef GL_ES\n    precision lowp float;\n    #endif\n    uniform vec2 resolution;\n    varying vec2 vTextureCoord;\n    varying vec4 vColor;\n    uniform sampler2D uSampler;\n    uniform vec2 direction;\n    uniform int kernelRadius;\n    \n    vec4 blur1(sampler2D image, vec2 uv, vec2 resolution, vec2 direction) {\n        vec4 color = vec4(0.0);\n        vec2 off1 = vec2(1.3333333333333333) * direction;\n        color += texture2D(image, uv) * 0.29411764705882354;\n        color += texture2D(image, uv + (off1 / resolution)) * 0.35294117647058826;\n        color += texture2D(image, uv - (off1 / resolution)) * 0.35294117647058826;\n        return color; \n    }\n    \n    vec4 blur2(sampler2D image, vec2 uv, vec2 resolution, vec2 direction) {\n        vec4 color = vec4(0.0);\n        vec2 off1 = vec2(1.3846153846) * direction;\n        vec2 off2 = vec2(3.2307692308) * direction;\n        color += texture2D(image, uv) * 0.2270270270;\n        color += texture2D(image, uv + (off1 / resolution)) * 0.3162162162;\n        color += texture2D(image, uv - (off1 / resolution)) * 0.3162162162;\n        color += texture2D(image, uv + (off2 / resolution)) * 0.0702702703;\n        color += texture2D(image, uv - (off2 / resolution)) * 0.0702702703;\n        return color;\n    }\n    \n    vec4 blur3(sampler2D image, vec2 uv, vec2 resolution, vec2 direction) {\n        vec4 color = vec4(0.0);\n        vec2 off1 = vec2(1.411764705882353) * direction;\n        vec2 off2 = vec2(3.2941176470588234) * direction;\n        vec2 off3 = vec2(5.176470588235294) * direction;\n        color += texture2D(image, uv) * 0.1964825501511404;\n        color += texture2D(image, uv + (off1 / resolution)) * 0.2969069646728344;\n        color += texture2D(image, uv - (off1 / resolution)) * 0.2969069646728344;\n        color += texture2D(image, uv + (off2 / resolution)) * 0.09447039785044732;\n        color += texture2D(image, uv - (off2 / resolution)) * 0.09447039785044732;\n        color += texture2D(image, uv + (off3 / resolution)) * 0.010381362401148057;\n        color += texture2D(image, uv - (off3 / resolution)) * 0.010381362401148057;\n        return color;\n    }    \n\n    void main(void){\n        if (kernelRadius == 1) {\n            gl_FragColor = blur1(uSampler, vTextureCoord, resolution, direction) * vColor;\n        } else if (kernelRadius == 2) {\n            gl_FragColor = blur2(uSampler, vTextureCoord, resolution, direction) * vColor;\n        } else {\n            gl_FragColor = blur3(uSampler, vTextureCoord, resolution, direction) * vColor;\n        }\n    }\n";var Be=function(e){function BoxBlurShader(){return _classCallCheck(this,BoxBlurShader),_possibleConstructorReturn(this,_getPrototypeOf(BoxBlurShader).apply(this,arguments))}return _inherits(BoxBlurShader,e),_createClass(BoxBlurShader,[{key:"setupUniforms",value:function setupUniforms(e){_get(_getPrototypeOf(BoxBlurShader.prototype),"setupUniforms",this).call(this,e);var t=1/e.getTextureWidth(0),i=1/e.getTextureHeight(0);this._setUniform("stepTextureCoord",new Float32Array([t,i]),this.gl.uniform2fv)}}]),BoxBlurShader}(Y);Be.vertexShaderSource="\n    #ifdef GL_ES\n    precision lowp float;\n    #endif\n    uniform vec2 stepTextureCoord;\n    attribute vec2 aVertexPosition;\n    attribute vec2 aTextureCoord;\n    attribute vec4 aColor;\n    uniform vec2 projection;\n    varying vec4 vColor;\n    varying vec2 vTextureCoordUl;\n    varying vec2 vTextureCoordUr;\n    varying vec2 vTextureCoordBl;\n    varying vec2 vTextureCoordBr;\n    void main(void){\n        gl_Position = vec4(aVertexPosition.x * projection.x - 1.0, aVertexPosition.y * -abs(projection.y) + 1.0, 0.0, 1.0);\n        vTextureCoordUl = aTextureCoord - stepTextureCoord;\n        vTextureCoordBr = aTextureCoord + stepTextureCoord;\n        vTextureCoordUr = vec2(vTextureCoordBr.x, vTextureCoordUl.y);\n        vTextureCoordBl = vec2(vTextureCoordUl.x, vTextureCoordBr.y);\n        vColor = aColor;\n        gl_Position.y = -sign(projection.y) * gl_Position.y;\n    }\n",Be.fragmentShaderSource="\n    #ifdef GL_ES\n    precision lowp float;\n    #endif\n    varying vec2 vTextureCoordUl;\n    varying vec2 vTextureCoordUr;\n    varying vec2 vTextureCoordBl;\n    varying vec2 vTextureCoordBr;\n    varying vec4 vColor;\n    uniform sampler2D uSampler;\n    void main(void){\n        vec4 color = 0.25 * (texture2D(uSampler, vTextureCoordUl) + texture2D(uSampler, vTextureCoordUr) + texture2D(uSampler, vTextureCoordBl) + texture2D(uSampler, vTextureCoordBr));\n        gl_FragColor = color * vColor;\n    }\n";var De=function(e){function BlurShader(e){var t;return _classCallCheck(this,BlurShader),(t=_possibleConstructorReturn(this,_getPrototypeOf(BlurShader).call(this,e)))._kernelRadius=1,t}return _inherits(BlurShader,e),_createClass(BlurShader,[{key:"useDefault",value:function useDefault(){return 0===this._amount}},{key:"_beforeDrawEl",value:function _beforeDrawEl(e){e.target.ctx.filter="blur("+this._kernelRadius+"px)"}},{key:"_afterDrawEl",value:function _afterDrawEl(e){e.target.ctx.filter="none"}},{key:"kernelRadius",get:function get(){return this._kernelRadius},set:function set(e){this._kernelRadius=e,this.redraw()}}]),BlurShader}(ee),We=function(e){function FastBlurComponent(){return _classCallCheck(this,FastBlurComponent),_possibleConstructorReturn(this,_getPrototypeOf(FastBlurComponent).apply(this,arguments))}return _inherits(FastBlurComponent,e),_createClass(FastBlurComponent,[{key:"_onResize",value:function _onResize(){this.wrap.w=this.renderWidth,this.wrap.h=this.renderHeight}},{key:"_build",value:function _build(){this.patch({Wrap:{type:this.stage.gl?Ne:je}})}},{key:"wrap",get:function get(){return this.tag("Wrap")}},{key:"content",set:function set(e){return this.wrap.content=e},get:function get(){return this.wrap.content}},{key:"padding",set:function set(e){this.wrap._paddingX=e,this.wrap._paddingY=e,this.wrap._updateBlurSize()}},{key:"paddingX",set:function set(e){this.wrap._paddingX=e,this.wrap._updateBlurSize()}},{key:"paddingY",set:function set(e){this.wrap._paddingY=e,this.wrap._updateBlurSize()}},{key:"amount",set:function set(e){return this.wrap.amount=e},get:function get(){return this.wrap.amount}},{key:"_signalProxy",get:function get(){return!0}}],[{key:"_template",value:function _template(){return{}}}]),FastBlurComponent}(U),je=function(e){function C2dFastBlurComponent(e){var t;return _classCallCheck(this,C2dFastBlurComponent),(t=_possibleConstructorReturn(this,_getPrototypeOf(C2dFastBlurComponent).call(this,e)))._textwrap=t.sel("Textwrap"),t._wrapper=t.sel("Textwrap>Content"),t._amount=0,t._paddingX=0,t._paddingY=0,t}return _inherits(C2dFastBlurComponent,e),_createClass(C2dFastBlurComponent,null,[{key:"_template",value:function _template(){return{forceZIndexContext:!0,rtt:!0,Textwrap:{shader:{type:De},Content:{}}}}}]),_createClass(C2dFastBlurComponent,[{key:"_updateBlurSize",value:function _updateBlurSize(){var e=this.renderWidth,t=this.renderHeight,i=this._paddingX,r=this._paddingY;this._wrapper.x=i,this._textwrap.x=-i,this._wrapper.y=r,this._textwrap.y=-r,this._textwrap.w=e+2*i,this._textwrap.h=t+2*r}},{key:"content",get:function get(){return this.sel("Textwrap>Content")},set:function set(e){this.sel("Textwrap>Content").patch(e,!0)}},{key:"padding",set:function set(e){this._paddingX=e,this._paddingY=e,this._updateBlurSize()}},{key:"paddingX",set:function set(e){this._paddingX=e,this._updateBlurSize()}},{key:"paddingY",set:function set(e){this._paddingY=e,this._updateBlurSize()}},{key:"amount",get:function get(){return this._amount},set:function set(e){this._amount=e,this._textwrap.shader.kernelRadius=C2dFastBlurComponent._amountToKernelRadius(e)}},{key:"_signalProxy",get:function get(){return!0}}],[{key:"getSpline",value:function getSpline(){return this._multiSpline||(this._multiSpline=new xe,this._multiSpline.parse(!1,{0:0,.25:1.5,.5:5.5,.75:18,1:39})),this._multiSpline}},{key:"_amountToKernelRadius",value:function _amountToKernelRadius(e){return C2dFastBlurComponent.getSpline().getValue(Math.min(1,.25*e))}}]),C2dFastBlurComponent}(U),Ne=function(e){function WebGLFastBlurComponent(e){var t;return _classCallCheck(this,WebGLFastBlurComponent),(t=_possibleConstructorReturn(this,_getPrototypeOf(WebGLFastBlurComponent).call(this,e)))._textwrap=t.sel("Textwrap"),t._wrapper=t.sel("Textwrap>Content"),t._layers=t.sel("Layers"),t._output=t.sel("Result"),t._amount=0,t._paddingX=0,t._paddingY=0,t}return _inherits(WebGLFastBlurComponent,e),_createClass(WebGLFastBlurComponent,[{key:"_signalProxy",get:function get(){return!0}}],[{key:"_template",value:function _template(){var e=function onUpdate(e,t){if(130&t._recalc){var i=t.w,r=t.h,n=t;do{(n=n._children[0])._element.w=i,n._element.h=r}while(n._children)}};return{Textwrap:{rtt:!0,forceZIndexContext:!0,renderOffscreen:!0,Content:{}},Layers:{L0:{rtt:!0,onUpdate:e,renderOffscreen:!0,visible:!1,Content:{shader:{type:Be}}},L1:{rtt:!0,onUpdate:e,renderOffscreen:!0,visible:!1,Content:{shader:{type:Be}}},L2:{rtt:!0,onUpdate:e,renderOffscreen:!0,visible:!1,Content:{shader:{type:Be}}},L3:{rtt:!0,onUpdate:e,renderOffscreen:!0,visible:!1,Content:{shader:{type:Be}}}},Result:{shader:{type:He},visible:!1}}}}]),_createClass(WebGLFastBlurComponent,[{key:"_buildLayers",value:function _buildLayers(){var e=this,t=[{x:1,y:0,kernelRadius:1},{x:0,y:1,kernelRadius:1},{x:1.5,y:0,kernelRadius:1},{x:0,y:1.5,kernelRadius:1}].map(function(t){return _newArrowCheck(this,e),T.create(this.stage,Object.assign({type:Ue},t))}.bind(this));this._setLayerTexture(this.getLayerContents(0),this._textwrap.getTexture(),[]),this._setLayerTexture(this.getLayerContents(1),this.getLayer(0).getTexture(),[t[0],t[1]]),this._setLayerTexture(this.getLayerContents(2),this.getLayer(1).getTexture(),[t[0],t[1],t[2],t[3]]),this._setLayerTexture(this.getLayerContents(3),this.getLayer(2).getTexture(),[t[0],t[1],t[2],t[3]])}},{key:"_setLayerTexture",value:function _setLayerTexture(e,t,i){if(i.length){var r=i.pop(),n=e.stage.c({rtt:!0,shader:r});this._setLayerTexture(n,t,i),e.childList.add(n)}else e.texture=t;return e}},{key:"getLayer",value:function getLayer(e){return this._layers.sel("L"+e)}},{key:"getLayerContents",value:function getLayerContents(e){return this.getLayer(e).sel("Content")}},{key:"_onResize",value:function _onResize(){this._updateBlurSize()}},{key:"_updateBlurSize",value:function _updateBlurSize(){var e=this.renderWidth,t=this.renderHeight,i=this._paddingX,r=this._paddingY,n=e+2*i,s=t+2*r;this._textwrap.w=n,this._wrapper.x=i,this.getLayer(0).w=this.getLayerContents(0).w=n/2,this.getLayer(1).w=this.getLayerContents(1).w=n/4,this.getLayer(2).w=this.getLayerContents(2).w=n/8,this.getLayer(3).w=this.getLayerContents(3).w=n/16,this._output.x=-i,this._textwrap.x=-i,this._output.w=n,this._textwrap.h=s,this._wrapper.y=r,this.getLayer(0).h=this.getLayerContents(0).h=s/2,this.getLayer(1).h=this.getLayerContents(1).h=s/4,this.getLayer(2).h=this.getLayerContents(2).h=s/8,this.getLayer(3).h=this.getLayerContents(3).h=s/16,this._output.y=-r,this._textwrap.y=-r,this._output.h=s,this.w=e,this.h=t}},{key:"_update",value:function _update(){var e=Math.min(4,Math.max(0,this._amount));0===e?(this._textwrap.renderToTexture=!1,this._output.shader.otherTextureSource=null,this._output.visible=!1):(this._textwrap.renderToTexture=!0,this._output.visible=!0,this.getLayer(0).visible=e>0,this.getLayer(1).visible=e>1,this.getLayer(2).visible=e>2,this.getLayer(3).visible=e>3,e<=1?(this._output.texture=this._textwrap.getTexture(),this._output.shader.otherTextureSource=this.getLayer(0).getTexture(),this._output.shader.a=e):e<=2?(this._output.texture=this.getLayer(0).getTexture(),this._output.shader.otherTextureSource=this.getLayer(1).getTexture(),this._output.shader.a=e-1):e<=3?(this._output.texture=this.getLayer(1).getTexture(),this._output.shader.otherTextureSource=this.getLayer(2).getTexture(),this._output.shader.a=e-2):e<=4&&(this._output.texture=this.getLayer(2).getTexture(),this._output.shader.otherTextureSource=this.getLayer(3).getTexture(),this._output.shader.a=e-3))}},{key:"_firstActive",value:function _firstActive(){this._buildLayers()}},{key:"content",get:function get(){return this.sel("Textwrap>Content")},set:function set(e){this.sel("Textwrap>Content").patch(e,!0)}},{key:"padding",set:function set(e){this._paddingX=e,this._paddingY=e,this._updateBlurSize()}},{key:"paddingX",set:function set(e){this._paddingX=e,this._updateBlurSize()}},{key:"paddingY",set:function set(e){this._paddingY=e,this._updateBlurSize()}},{key:"amount",set:function set(e){this._amount=e,this._update()},get:function get(){return this._amount}},{key:"shader",set:function set(e){_set(_getPrototypeOf(WebGLFastBlurComponent.prototype),"shader",e,this,!0),this.renderToTexture||console.warn("Please enable renderToTexture to use with a shader.")}}]),WebGLFastBlurComponent}(U),He=function(e){function FastBlurOutputShader(e){var t;return _classCallCheck(this,FastBlurOutputShader),(t=_possibleConstructorReturn(this,_getPrototypeOf(FastBlurOutputShader).call(this,e)))._a=0,t._otherTextureSource=null,t}return _inherits(FastBlurOutputShader,e),_createClass(FastBlurOutputShader,[{key:"setupUniforms",value:function setupUniforms(e){_get(_getPrototypeOf(FastBlurOutputShader.prototype),"setupUniforms",this).call(this,e),this._setUniform("a",this._a,this.gl.uniform1f),this._setUniform("uSampler2",1,this.gl.uniform1i)}},{key:"beforeDraw",value:function beforeDraw(e){var t=this._otherTextureSource?this._otherTextureSource.nativeTexture:null,i=this.gl;i.activeTexture(i.TEXTURE1),i.bindTexture(i.TEXTURE_2D,t),i.activeTexture(i.TEXTURE0)}},{key:"a",get:function get(){return this._a},set:function set(e){this._a=e,this.redraw()}},{key:"otherTextureSource",set:function set(e){this._otherTextureSource=e,this.redraw()}}]),FastBlurOutputShader}(Y);He.fragmentShaderSource="\n    #ifdef GL_ES\n    precision lowp float;\n    #endif\n    varying vec2 vTextureCoord;\n    varying vec4 vColor;\n    uniform sampler2D uSampler;\n    uniform sampler2D uSampler2;\n    uniform float a;\n    void main(void){\n        if (a == 1.0) {\n            gl_FragColor = texture2D(uSampler2, vTextureCoord) * vColor;\n        } else {\n            gl_FragColor = ((1.0 - a) * texture2D(uSampler, vTextureCoord) + (a * texture2D(uSampler2, vTextureCoord))) * vColor;\n        }\n    }\n";var Ge=function(e){function BloomComponent(e){var t;return _classCallCheck(this,BloomComponent),(t=_possibleConstructorReturn(this,_getPrototypeOf(BloomComponent).call(this,e)))._textwrap=t.sel("Textwrap"),t._wrapper=t.sel("Textwrap.Content"),t._layers=t.sel("Layers"),t._amount=0,t._paddingX=0,t._paddingY=0,t}return _inherits(BloomComponent,e),_createClass(BloomComponent,[{key:"_signalProxy",get:function get(){return!0}}],[{key:"_template",value:function _template(){var e=function onUpdate(e,t){if(130&t._recalc){var i=t.w,r=t.h,n=t;do{(n=n._children[0])._element.w=i,n._element.h=r}while(n._children)}};return{Textwrap:{rtt:!0,forceZIndexContext:!0,renderOffscreen:!0,BloomBase:{shader:{type:Ve},Content:{}}},Layers:{L0:{rtt:!0,onUpdate:e,scale:2,pivot:0,visible:!1,Content:{shader:{type:Be}}},L1:{rtt:!0,onUpdate:e,scale:4,pivot:0,visible:!1,Content:{shader:{type:Be}}},L2:{rtt:!0,onUpdate:e,scale:8,pivot:0,visible:!1,Content:{shader:{type:Be}}},L3:{rtt:!0,onUpdate:e,scale:16,pivot:0,visible:!1,Content:{shader:{type:Be}}}}}}}]),_createClass(BloomComponent,[{key:"_build",value:function _build(){var e=this,t=[{x:1,y:0,kernelRadius:3},{x:0,y:1,kernelRadius:3},{x:1.5,y:0,kernelRadius:3},{x:0,y:1.5,kernelRadius:3}].map(function(t){return _newArrowCheck(this,e),this.stage.createShader(Object.assign({type:Ue},t))}.bind(this));this._setLayerTexture(this.getLayerContents(0),this._textwrap.getTexture(),[]),this._setLayerTexture(this.getLayerContents(1),this.getLayer(0).getTexture(),[t[0],t[1]]),this._setLayerTexture(this.getLayerContents(2),this.getLayer(1).getTexture(),[t[0],t[1],t[2],t[3]]),this._setLayerTexture(this.getLayerContents(3),this.getLayer(2).getTexture(),[t[0],t[1],t[2],t[3]])}},{key:"_setLayerTexture",value:function _setLayerTexture(e,t,i){if(i.length){var r=i.pop(),n=e.stage.c({rtt:!0,shader:r});this._setLayerTexture(n,t,i),e.childList.add(n)}else e.texture=t;return e}},{key:"getLayer",value:function getLayer(e){return this._layers.sel("L"+e)}},{key:"getLayerContents",value:function getLayerContents(e){return this.getLayer(e).sel("Content")}},{key:"_onResize",value:function _onResize(){this._updateBlurSize()}},{key:"_updateBlurSize",value:function _updateBlurSize(){var e=this.renderWidth,t=this.renderHeight,i=this._paddingX,r=this._paddingY,n=e+2*i,s=t+2*r;this._textwrap.w=n,this._wrapper.x=i,this.getLayer(0).w=this.getLayerContents(0).w=n/2,this.getLayer(1).w=this.getLayerContents(1).w=n/4,this.getLayer(2).w=this.getLayerContents(2).w=n/8,this.getLayer(3).w=this.getLayerContents(3).w=n/16,this._textwrap.x=-i,this._textwrap.h=s,this._wrapper.y=r,this.getLayer(0).h=this.getLayerContents(0).h=s/2,this.getLayer(1).h=this.getLayerContents(1).h=s/4,this.getLayer(2).h=this.getLayerContents(2).h=s/8,this.getLayer(3).h=this.getLayerContents(3).h=s/16,this._textwrap.y=-r,this.w=e,this.h=t}},{key:"_update",value:function _update(){var e=Math.min(4,Math.max(0,this._amount));e>0&&(this.getLayer(0).visible=e>0,this.getLayer(1).visible=e>1,this.getLayer(2).visible=e>2,this.getLayer(3).visible=e>3)}},{key:"_firstActive",value:function _firstActive(){this._build()}},{key:"content",get:function get(){return this.sel("Textwrap.Content")},set:function set(e){this.sel("Textwrap.Content").patch(e)}},{key:"padding",set:function set(e){this._paddingX=e,this._paddingY=e,this._updateBlurSize()}},{key:"paddingX",set:function set(e){this._paddingX=e,this._updateBlurSize()}},{key:"paddingY",set:function set(e){this._paddingY=e,this._updateBlurSize()}},{key:"amount",set:function set(e){this._amount=e,this._update()},get:function get(){return this._amount}},{key:"shader",set:function set(e){_set(_getPrototypeOf(BloomComponent.prototype),"shader",e,this,!0),this.renderToTexture||console.warn("Please enable renderToTexture to use with a shader.")}}]),BloomComponent}(U),Ve=function(e){function BloomBaseShader(){return _classCallCheck(this,BloomBaseShader),_possibleConstructorReturn(this,_getPrototypeOf(BloomBaseShader).apply(this,arguments))}return _inherits(BloomBaseShader,e),BloomBaseShader}(Y);Ve.fragmentShaderSource="\n    #ifdef GL_ES\n    precision lowp float;\n    #endif\n    varying vec2 vTextureCoord;\n    varying vec4 vColor;\n    uniform sampler2D uSampler;\n    void main(void){\n        vec4 color = texture2D(uSampler, vTextureCoord) * vColor;\n        float m = max(max(color.r, color.g), color.b);\n        float c = max(0.0, (m - 0.80)) * 5.0;\n        color = color * c;\n        gl_FragColor = color;\n    }\n";var Xe=function(e){function SmoothScaleComponent(e){var t;return _classCallCheck(this,SmoothScaleComponent),(t=_possibleConstructorReturn(this,_getPrototypeOf(SmoothScaleComponent).call(this,e)))._smoothScale=1,t._iterations=0,t}return _inherits(SmoothScaleComponent,e),_createClass(SmoothScaleComponent,null,[{key:"_template",value:function _template(){return{ContentWrap:{renderOffscreen:!0,forceZIndexContext:!0,onAfterUpdate:SmoothScaleComponent._updateDimensions,Content:{}},Scale:{visible:!1}}}}]),_createClass(SmoothScaleComponent,[{key:"_setIterations",value:function _setIterations(e){if(this._iterations!==e){for(var t=this.sel("Scale").childList,i=this.sel("ContentWrap");t.length<e;){var r=0===t.length?i.getTexture():t.last.getTexture();t.a({rtt:!0,renderOffscreen:!0,texture:r})}SmoothScaleComponent._updateDimensions(this.tag("ContentWrap"),!0);var n=e>0;this.patch({ContentWrap:{renderToTexture:n},Scale:{visible:n}});for(var s=0,o=t.length;s<o;s++)t.getAt(s).patch({visible:s<e,renderOffscreen:s!==e-1});this._iterations=e}}},{key:"content",get:function get(){return this.tag("Content")},set:function set(e){this.tag("Content").patch(e,!0)}},{key:"smoothScale",get:function get(){return this._smoothScale},set:function set(e){if(this._smoothScale!==e){for(var t=0;e<.5&&t<12;)t++,e*=2;this.scale=e,this._setIterations(t),this._smoothScale=e}}},{key:"_signalProxy",get:function get(){return!0}}],[{key:"_updateDimensions",value:function _updateDimensions(e,t){var i=e.children[0],r=i.renderWidth,n=i.renderHeight;if(r!==e.w||n!==e.h||t){e.w=r,e.h=n;for(var s=e.parent.tag("Scale").children,o=0,h=s.length;o<h;o++)r*=.5,n*=.5,s[o].w=r,s[o].h=n}}}]),SmoothScaleComponent}(U),Ye=function(e){function BorderComponent(e){var t;return _classCallCheck(this,BorderComponent),(t=_possibleConstructorReturn(this,_getPrototypeOf(BorderComponent).call(this,e)))._borderTop=t.tag("Top"),t._borderRight=t.tag("Right"),t._borderBottom=t.tag("Bottom"),t._borderLeft=t.tag("Left"),t.onAfterUpdate=function(e){var t=e.childList.first,i=e.core.w||t.renderWidth,r=e.core.h||t.renderHeight;e._borderTop.w=i,e._borderBottom.y=r,e._borderBottom.w=i,e._borderLeft.h=r+e._borderTop.h+e._borderBottom.h,e._borderLeft.y=-e._borderTop.h,e._borderRight.x=i,e._borderRight.h=r+e._borderTop.h+e._borderBottom.h,e._borderRight.y=-e._borderTop.h},t.borderWidth=1,t}return _inherits(BorderComponent,e),_createClass(BorderComponent,[{key:"_signalProxy",get:function get(){return!0}}],[{key:"_template",value:function _template(){return{Content:{},Borders:{Top:{rect:!0,visible:!1,mountY:1},Right:{rect:!0,visible:!1},Bottom:{rect:!0,visible:!1},Left:{rect:!0,visible:!1,mountX:1}}}}}]),_createClass(BorderComponent,[{key:"content",get:function get(){return this.sel("Content")},set:function set(e){this.sel("Content").patch(e,!0)}},{key:"borderWidth",get:function get(){return this.borderWidthTop},set:function set(e){this.borderWidthTop=e,this.borderWidthRight=e,this.borderWidthBottom=e,this.borderWidthLeft=e}},{key:"borderWidthTop",get:function get(){return this._borderTop.h},set:function set(e){this._borderTop.h=e,this._borderTop.visible=e>0}},{key:"borderWidthRight",get:function get(){return this._borderRight.w},set:function set(e){this._borderRight.w=e,this._borderRight.visible=e>0}},{key:"borderWidthBottom",get:function get(){return this._borderBottom.h},set:function set(e){this._borderBottom.h=e,this._borderBottom.visible=e>0}},{key:"borderWidthLeft",get:function get(){return this._borderLeft.w},set:function set(e){this._borderLeft.w=e,this._borderLeft.visible=e>0}},{key:"colorBorder",get:function get(){return this.colorBorderTop},set:function set(e){this.colorBorderTop=e,this.colorBorderRight=e,this.colorBorderBottom=e,this.colorBorderLeft=e}},{key:"colorBorderTop",get:function get(){return this._borderTop.color},set:function set(e){this._borderTop.color=e}},{key:"colorBorderRight",get:function get(){return this._borderRight.color},set:function set(e){this._borderRight.color=e}},{key:"colorBorderBottom",get:function get(){return this._borderBottom.color},set:function set(e){this._borderBottom.color=e}},{key:"colorBorderLeft",get:function get(){return this._borderLeft.color},set:function set(e){this._borderLeft.color=e}},{key:"borderTop",get:function get(){return this._borderTop},set:function set(e){this.borderTop.patch(e)}},{key:"borderRight",get:function get(){return this._borderRight},set:function set(e){this.borderRight.patch(e)}},{key:"borderBottom",get:function get(){return this._borderBottom},set:function set(e){this.borderBottom.patch(e)}},{key:"borderLeft",get:function get(){return this._borderLeft},set:function set(e){this.borderLeft.patch(e)}},{key:"borders",set:function set(e){this.borderTop=e,this.borderLeft=e,this.borderBottom=e,this.borderRight=e}}]),BorderComponent}(U),qe=function(e){function WebGLGrayscaleShader(e){var t;return _classCallCheck(this,WebGLGrayscaleShader),(t=_possibleConstructorReturn(this,_getPrototypeOf(WebGLGrayscaleShader).call(this,e)))._amount=1,t}return _inherits(WebGLGrayscaleShader,e),_createClass(WebGLGrayscaleShader,[{key:"useDefault",value:function useDefault(){return 0===this._amount}},{key:"setupUniforms",value:function setupUniforms(e){_get(_getPrototypeOf(WebGLGrayscaleShader.prototype),"setupUniforms",this).call(this,e),this._setUniform("amount",this._amount,this.gl.uniform1f)}},{key:"amount",set:function set(e){this._amount=e,this.redraw()},get:function get(){return this._amount}}],[{key:"getC2d",value:function getC2d(){return Ze}}]),WebGLGrayscaleShader}(Y);qe.fragmentShaderSource="\n    #ifdef GL_ES\n    precision lowp float;\n    #endif\n    varying vec2 vTextureCoord;\n    varying vec4 vColor;\n    uniform sampler2D uSampler;\n    uniform float amount;\n    void main(void){\n        vec4 color = texture2D(uSampler, vTextureCoord) * vColor;\n        float grayness = 0.2 * color.r + 0.6 * color.g + 0.2 * color.b;\n        gl_FragColor = vec4(amount * vec3(grayness, grayness, grayness) + (1.0 - amount) * color.rgb, color.a);\n    }\n";var Ze=function(e){function C2dGrayscaleShader(e){var t;return _classCallCheck(this,C2dGrayscaleShader),(t=_possibleConstructorReturn(this,_getPrototypeOf(C2dGrayscaleShader).call(this,e)))._amount=1,t}return _inherits(C2dGrayscaleShader,e),_createClass(C2dGrayscaleShader,[{key:"useDefault",value:function useDefault(){return 0===this._amount}},{key:"_beforeDrawEl",value:function _beforeDrawEl(e){e.target.ctx.filter="grayscale("+this._amount+")"}},{key:"_afterDrawEl",value:function _afterDrawEl(e){e.target.ctx.filter="none"}},{key:"amount",set:function set(e){this._amount=e,this.redraw()},get:function get(){return this._amount}}],[{key:"getWebGL",value:function getWebGL(){return qe}}]),C2dGrayscaleShader}(ee),$e=function(e){function DitheringShader(e){var t;return _classCallCheck(this,DitheringShader),(t=_possibleConstructorReturn(this,_getPrototypeOf(DitheringShader).call(this,e)))._noiseTexture=new Oe(e.stage),t._graining=1/256,t._random=!1,t}return _inherits(DitheringShader,e),_createClass(DitheringShader,[{key:"setExtraAttribsInBuffer",value:function setExtraAttribsInBuffer(e){this._noiseTexture.load();for(var t=e.extraAttribsDataByteOffset/4,i=e.quads.floats,r=e.length,n=0;n<r;n++){var s=e.getElementWidth(n)/this._noiseTexture.getRenderWidth(),o=e.getElementHeight(n)/this._noiseTexture.getRenderHeight(),h=0,u=0;if(this._random){if(s+=h=Math.random(),o+=u=Math.random(),Math.random()<.5){var l=h;h=s,s=l}if(Math.random()<.5){var _=u;u=o,o=_}}i[t]=h,i[t+1]=u,i[t+2]=s,i[t+3]=u,i[t+4]=s,i[t+5]=o,i[t+6]=h,i[t+7]=o,t+=8}}},{key:"beforeDraw",value:function beforeDraw(e){var t=this.gl;t.vertexAttribPointer(this._attrib("aNoiseTextureCoord"),2,t.FLOAT,!1,8,this.getVertexAttribPointerOffset(e));var i=this._noiseTexture.source.nativeTexture;t.activeTexture(t.TEXTURE1),t.bindTexture(t.TEXTURE_2D,i),t.activeTexture(t.TEXTURE0)}},{key:"getExtraAttribBytesPerVertex",value:function getExtraAttribBytesPerVertex(){return 8}},{key:"setupUniforms",value:function setupUniforms(e){_get(_getPrototypeOf(DitheringShader.prototype),"setupUniforms",this).call(this,e),this._setUniform("uNoiseSampler",1,this.gl.uniform1i),this._setUniform("graining",2*this._graining,this.gl.uniform1f)}},{key:"enableAttribs",value:function enableAttribs(){_get(_getPrototypeOf(DitheringShader.prototype),"enableAttribs",this).call(this),this.gl.enableVertexAttribArray(this._attrib("aNoiseTextureCoord"))}},{key:"disableAttribs",value:function disableAttribs(){_get(_getPrototypeOf(DitheringShader.prototype),"disableAttribs",this).call(this),this.gl.disableVertexAttribArray(this._attrib("aNoiseTextureCoord"))}},{key:"useDefault",value:function useDefault(){return 0===this._graining}},{key:"afterDraw",value:function afterDraw(e){this._random&&this.redraw()}},{key:"graining",set:function set(e){this._graining=e,this.redraw()}},{key:"random",set:function set(e){this._random=e,this.redraw()}}]),DitheringShader}(Y);$e.vertexShaderSource="\n    #ifdef GL_ES\n    precision lowp float;\n    #endif\n    attribute vec2 aVertexPosition;\n    attribute vec2 aTextureCoord;\n    attribute vec2 aNoiseTextureCoord;\n    attribute vec4 aColor;\n    uniform vec2 projection;\n    varying vec2 vTextureCoord;\n    varying vec2 vNoiseTextureCoord;\n    varying vec4 vColor;\n    void main(void){\n        gl_Position = vec4(aVertexPosition.x * projection.x - 1.0, aVertexPosition.y * -abs(projection.y) + 1.0, 0.0, 1.0);\n        vTextureCoord = aTextureCoord;\n        vNoiseTextureCoord = aNoiseTextureCoord;\n        vColor = aColor;\n        gl_Position.y = -sign(projection.y) * gl_Position.y;\n    }\n",$e.fragmentShaderSource="\n    #ifdef GL_ES\n    precision lowp float;\n    #endif\n    varying vec2 vTextureCoord;\n    varying vec2 vNoiseTextureCoord;\n    varying vec4 vColor;\n    uniform sampler2D uSampler;\n    uniform sampler2D uNoiseSampler;\n    uniform float graining;\n    void main(void){\n        vec4 noise = texture2D(uNoiseSampler, vNoiseTextureCoord);\n        vec4 color = texture2D(uSampler, vTextureCoord);\n        gl_FragColor = (color * vColor) + graining * (noise.r - 0.5);\n    }\n";var Qe=function(e){function CircularPushShader(e){var t;return _classCallCheck(this,CircularPushShader),(t=_possibleConstructorReturn(this,_getPrototypeOf(CircularPushShader).call(this,e)))._inputValue=0,t._maxDerivative=.01,t._normalizedValue=0,t._offset=0,t._amount=.1,t._aspectRatio=1,t._offsetX=0,t._offsetY=0,t.buckets=100,t}return _inherits(CircularPushShader,e),_createClass(CircularPushShader,[{key:"_getValues",value:function _getValues(e){for(var t=[],i=0;i<e;i++)t.push(this._inputValue);return t}},{key:"progress",value:function progress(e){this._offset+=e*this._buckets;var t=Math.floor(this._offset);this._offset-=t,this._shiftBuckets(t),this.redraw()}},{key:"_shiftBuckets",value:function _shiftBuckets(e){for(var t=this._buckets-1;t>=0;t--){var i=t-e;i<0?(this._normalizedValue=Math.min(this._normalizedValue+this._maxDerivative,Math.max(this._normalizedValue-this._maxDerivative,this._inputValue)),this._values[t]=255*this._normalizedValue):this._values[t]=this._values[i]}}},{key:"setupUniforms",value:function setupUniforms(e){_get(_getPrototypeOf(CircularPushShader.prototype),"setupUniforms",this).call(this,e),this._setUniform("aspectRatio",this._aspectRatio,this.gl.uniform1f),this._setUniform("offsetX",this._offsetX,this.gl.uniform1f),this._setUniform("offsetY",this._offsetY,this.gl.uniform1f),this._setUniform("amount",this._amount,this.gl.uniform1f),this._setUniform("offset",this._offset,this.gl.uniform1f),this._setUniform("buckets",this._buckets,this.gl.uniform1f),this._setUniform("uValueSampler",1,this.gl.uniform1i)}},{key:"useDefault",value:function useDefault(){return 0===this._amount}},{key:"beforeDraw",value:function beforeDraw(e){var i=this.gl;i.activeTexture(i.TEXTURE1),this._valuesTexture?i.bindTexture(i.TEXTURE_2D,this._valuesTexture):(this._valuesTexture=i.createTexture(),i.bindTexture(i.TEXTURE_2D,this._valuesTexture),i.texParameteri(i.TEXTURE_2D,i.TEXTURE_MAG_FILTER,i.LINEAR),i.texParameteri(i.TEXTURE_2D,i.TEXTURE_MIN_FILTER,i.LINEAR),i.texParameteri(i.TEXTURE_2D,i.TEXTURE_WRAP_S,i.CLAMP_TO_EDGE),i.texParameteri(i.TEXTURE_2D,i.TEXTURE_WRAP_T,i.CLAMP_TO_EDGE),t.isNode&&i.pixelStorei(i.UNPACK_FLIP_BLUE_RED,!1),i.pixelStorei(i.UNPACK_PREMULTIPLY_ALPHA_WEBGL,!1)),i.texImage2D(i.TEXTURE_2D,0,i.ALPHA,this._buckets,1,0,i.ALPHA,i.UNSIGNED_BYTE,this._values),i.activeTexture(i.TEXTURE0)}},{key:"cleanup",value:function cleanup(){this._valuesTexture&&this.gl.deleteTexture(this._valuesTexture)}},{key:"aspectRatio",get:function get(){return this._aspectRatio},set:function set(e){this._aspectRatio=e,this.redraw()}},{key:"offsetX",get:function get(){return this._offsetX},set:function set(e){this._offsetX=e,this.redraw()}},{key:"offsetY",get:function get(){return this._offsetY},set:function set(e){this._offsetY=e,this.redraw()}},{key:"amount",set:function set(e){this._amount=e,this.redraw()},get:function get(){return this._amount}},{key:"inputValue",set:function set(e){this._inputValue=e},get:function get(){return this._inputValue}},{key:"maxDerivative",set:function set(e){this._maxDerivative=e},get:function get(){return this._maxDerivative}},{key:"buckets",set:function set(e){e>100&&(console.warn("CircularPushShader: supports max 100 buckets"),e=100),this._buckets=e,this._values=new Uint8Array(this._getValues(e)),this.redraw()},get:function get(){return this._buckets}},{key:"offset",set:function set(e){this._offset=e,this.redraw()}}]),CircularPushShader}(Y);Qe.vertexShaderSource="\n    #ifdef GL_ES\n    precision lowp float;\n    #endif\n    attribute vec2 aVertexPosition;\n    attribute vec2 aTextureCoord;\n    attribute vec4 aColor;\n    uniform vec2 projection;\n    uniform float offsetX;\n    uniform float offsetY;\n    uniform float aspectRatio;\n    varying vec2 vTextureCoord;\n    varying vec2 vPos;\n    varying vec4 vColor;\n    void main(void){\n        gl_Position = vec4(aVertexPosition.x * projection.x - 1.0, aVertexPosition.y * -abs(projection.y) + 1.0, 0.0, 1.0);\n        vTextureCoord = aTextureCoord;\n        vPos = vTextureCoord * 2.0 - 1.0;\n        vPos.y = vPos.y * aspectRatio;\n        vPos.y = vPos.y + offsetY;\n        vPos.x = vPos.x + offsetX;\n        vColor = aColor;\n        gl_Position.y = -sign(projection.y) * gl_Position.y;\n    }\n",Qe.fragmentShaderSource="\n    #ifdef GL_ES\n    precision lowp float;\n    #endif\n    varying vec2 vTextureCoord;\n    varying vec4 vColor;\n    varying vec2 vPos;\n    uniform float amount;\n    uniform float offset;\n    uniform float values[100];\n    uniform float buckets;\n    uniform sampler2D uSampler;\n    uniform sampler2D uValueSampler;\n    void main(void){\n        float l = length(vPos);\n        float m = (l * buckets * 0.678 - offset) / buckets;\n        float f = texture2D(uValueSampler, vec2(m, 0.0)).a * amount;\n        vec2 unit = vPos / l;\n        gl_FragColor = texture2D(uSampler, vTextureCoord - f * unit) * vColor;\n    }\n";var Ke=function(e){function InversionShader(e){var t;return _classCallCheck(this,InversionShader),(t=_possibleConstructorReturn(this,_getPrototypeOf(InversionShader).call(this,e)))._amount=1,t}return _inherits(InversionShader,e),_createClass(InversionShader,[{key:"useDefault",value:function useDefault(){return 0===this._amount}},{key:"setupUniforms",value:function setupUniforms(e){_get(_getPrototypeOf(InversionShader.prototype),"setupUniforms",this).call(this,e),this._setUniform("amount",this._amount,this.gl.uniform1f)}},{key:"amount",set:function set(e){this._amount=e,this.redraw()},get:function get(){return this._amount}}]),InversionShader}(Y);Ke.fragmentShaderSource="\n    #ifdef GL_ES\n    precision lowp float;\n    #endif\n    varying vec2 vTextureCoord;\n    varying vec4 vColor;\n    uniform sampler2D uSampler;\n    uniform float amount;\n    void main(void){\n        vec4 color = texture2D(uSampler, vTextureCoord);\n        color.rgb = color.rgb * (1.0 - amount) + amount * (1.0 * color.a - color.rgb); \n        gl_FragColor = color * vColor;\n    }\n";var Je=function(t){function OutlineShader(e){var t;return _classCallCheck(this,OutlineShader),(t=_possibleConstructorReturn(this,_getPrototypeOf(OutlineShader).call(this,e)))._width=5,t._col=4294967295,t._color=[1,1,1,1],t}return _inherits(OutlineShader,t),_createClass(OutlineShader,[{key:"useDefault",value:function useDefault(){return 0===this._width||0===this._col[3]}},{key:"setupUniforms",value:function setupUniforms(e){_get(_getPrototypeOf(OutlineShader.prototype),"setupUniforms",this).call(this,e);var t=this.gl;this._setUniform("color",new Float32Array(this._color),t.uniform4fv)}},{key:"enableAttribs",value:function enableAttribs(){_get(_getPrototypeOf(OutlineShader.prototype),"enableAttribs",this).call(this),this.gl.enableVertexAttribArray(this._attrib("aCorner"))}},{key:"disableAttribs",value:function disableAttribs(){_get(_getPrototypeOf(OutlineShader.prototype),"disableAttribs",this).call(this),this.gl.disableVertexAttribArray(this._attrib("aCorner"))}},{key:"setExtraAttribsInBuffer",value:function setExtraAttribsInBuffer(e){for(var t=e.extraAttribsDataByteOffset/4,i=e.quads.floats,r=e.length,n=0;n<r;n++){var s=e.getElementCore(n),o=this._width/s.w,h=o/(1-2*o),u=this._width/s.h,l=u/(1-2*u);i[t]=-h,i[t+1]=-l,i[t+2]=1+h,i[t+3]=-l,i[t+4]=1+h,i[t+5]=1+l,i[t+6]=-h,i[t+7]=1+l,t+=8}}},{key:"beforeDraw",value:function beforeDraw(e){var t=this.gl;t.vertexAttribPointer(this._attrib("aCorner"),2,t.FLOAT,!1,8,this.getVertexAttribPointerOffset(e))}},{key:"getExtraAttribBytesPerVertex",value:function getExtraAttribBytesPerVertex(){return 8}},{key:"width",set:function set(e){this._width=e,this.redraw()}},{key:"color",get:function get(){return this._col},set:function set(t){if(this._col!==t){var i=e.getRgbaComponentsNormalized(t);i[0]=i[0]*i[3],i[1]=i[1]*i[3],i[2]=i[2]*i[3],this._color=i,this.redraw(),this._col=t}}}]),OutlineShader}(Y);Je.vertexShaderSource="\n    #ifdef GL_ES\n    precision lowp float;\n    #endif\n    attribute vec2 aVertexPosition;\n    attribute vec2 aTextureCoord;\n    attribute vec4 aColor;\n    attribute vec2 aCorner;\n    uniform vec2 projection;\n    varying vec2 vTextureCoord;\n    varying vec2 vCorner;\n    varying vec4 vColor;\n    void main(void){\n        gl_Position = vec4(aVertexPosition.x * projection.x - 1.0, aVertexPosition.y * -abs(projection.y) + 1.0, 0.0, 1.0);\n        vTextureCoord = aTextureCoord;\n        vCorner = aCorner;\n        vColor = aColor;\n        gl_Position.y = -sign(projection.y) * gl_Position.y;\n    }\n",Je.fragmentShaderSource="\n    #ifdef GL_ES\n    precision lowp float;\n    #endif\n    varying vec2 vTextureCoord;\n    varying vec4 vColor;\n    varying vec2 vCorner;\n    uniform vec4 color;\n    uniform sampler2D uSampler;\n    void main(void){\n        vec2 m = min(vCorner, 1.0 - vCorner);\n        float value = step(0.0, min(m.x, m.y));\n        gl_FragColor = mix(color, texture2D(uSampler, vTextureCoord) * vColor, value);\n    }\n";var et=function(e){function PixelateShader(e){var t;return _classCallCheck(this,PixelateShader),(t=_possibleConstructorReturn(this,_getPrototypeOf(PixelateShader).call(this,e)))._size=new Float32Array([4,4]),t}return _inherits(PixelateShader,e),_createClass(PixelateShader,[{key:"useDefault",value:function useDefault(){return 0===this._size[0]&&0===this._size[1]}},{key:"setupUniforms",value:function setupUniforms(e){_get(_getPrototypeOf(PixelateShader.prototype),"setupUniforms",this).call(this,e);var t=this.gl;this._setUniform("size",new Float32Array(this._size),t.uniform2fv)}},{key:"getExtraAttribBytesPerVertex",value:function getExtraAttribBytesPerVertex(){return 8}},{key:"enableAttribs",value:function enableAttribs(){_get(_getPrototypeOf(PixelateShader.prototype),"enableAttribs",this).call(this),this.gl.enableVertexAttribArray(this._attrib("aTextureRes"))}},{key:"disableAttribs",value:function disableAttribs(){_get(_getPrototypeOf(PixelateShader.prototype),"disableAttribs",this).call(this),this.gl.disableVertexAttribArray(this._attrib("aTextureRes"))}},{key:"setExtraAttribsInBuffer",value:function setExtraAttribsInBuffer(e){for(var t=e.extraAttribsDataByteOffset/4,i=e.quads.floats,r=e.length,n=0;n<r;n++){var s=e.quads.getTextureWidth(e.index+n),o=e.quads.getTextureHeight(e.index+n);i[t]=s,i[t+1]=o,i[t+2]=s,i[t+3]=o,i[t+4]=s,i[t+5]=o,i[t+6]=s,i[t+7]=o,t+=8}}},{key:"beforeDraw",value:function beforeDraw(e){var t=this.gl;t.vertexAttribPointer(this._attrib("aTextureRes"),2,t.FLOAT,!1,this.getExtraAttribBytesPerVertex(),this.getVertexAttribPointerOffset(e))}},{key:"x",get:function get(){return this._size[0]},set:function set(e){this._size[0]=e,this.redraw()}},{key:"y",get:function get(){return this._size[1]},set:function set(e){this._size[1]=e,this.redraw()}},{key:"size",get:function get(){return this._size[0]},set:function set(e){this._size[0]=e,this._size[1]=e,this.redraw()}}],[{key:"getWebGLImpl",value:function getWebGLImpl(){return WebGLPixelateShaderImpl}}]),PixelateShader}(Y);et.vertexShaderSource="\n    #ifdef GL_ES\n    precision lowp float;\n    #endif\n    attribute vec2 aVertexPosition;\n    attribute vec2 aTextureCoord;\n    attribute vec4 aColor;\n    attribute vec2 aTextureRes;\n    uniform vec2 projection;\n    varying vec2 vTextureCoord;\n    varying vec4 vColor;\n    varying vec2 vTextureRes;\n    void main(void){\n        gl_Position = vec4(aVertexPosition.x * projection.x - 1.0, aVertexPosition.y * -abs(projection.y) + 1.0, 0.0, 1.0);\n        vTextureCoord = aTextureCoord;\n        vColor = aColor;\n        vTextureRes = aTextureRes;\n        gl_Position.y = -sign(projection.y) * gl_Position.y;\n    }\n",et.fragmentShaderSource="\n    #ifdef GL_ES\n    precision lowp float;\n    #endif\n    varying vec2 vTextureCoord;\n    varying vec4 vColor;\n    varying vec2 vTextureRes;\n\n    uniform vec2 size;\n    uniform sampler2D uSampler;\n    \n    vec2 mapCoord( vec2 coord )\n    {\n        coord *= vTextureRes.xy;\n        return coord;\n    }\n    \n    vec2 unmapCoord( vec2 coord )\n    {\n        coord /= vTextureRes.xy;\n        return coord;\n    }\n    \n    vec2 pixelate(vec2 coord, vec2 size)\n    {\n        return floor( coord / size ) * size;\n    }\n    \n    void main(void)\n    {\n        vec2 coord = mapCoord(vTextureCoord);\n        coord = pixelate(coord, size);\n        coord = unmapCoord(coord);\n        gl_FragColor = texture2D(uSampler, coord) * vColor;\n    }\n";var tt=function(e){function RadialFilterShader(e){var t;return _classCallCheck(this,RadialFilterShader),(t=_possibleConstructorReturn(this,_getPrototypeOf(RadialFilterShader).call(this,e)))._radius=0,t._cutoff=1,t}return _inherits(RadialFilterShader,e),_createClass(RadialFilterShader,[{key:"useDefault",value:function useDefault(){return 0===this._radius}},{key:"setupUniforms",value:function setupUniforms(e){_get(_getPrototypeOf(RadialFilterShader.prototype),"setupUniforms",this).call(this,e),this._setUniform("radius",2*(this._radius-.5)/e.getRenderWidth(),this.gl.uniform1f),this._setUniform("cutoff",.5*e.getRenderWidth()/this._cutoff,this.gl.uniform1f)}},{key:"radius",set:function set(e){this._radius=e,this.redraw()},get:function get(){return this._radius}},{key:"cutoff",set:function set(e){this._cutoff=e,this.redraw()},get:function get(){return this._cutoff}}]),RadialFilterShader}(Y);tt.vertexShaderSource="\n    #ifdef GL_ES\n    precision lowp float;\n    #endif\n    attribute vec2 aVertexPosition;\n    attribute vec2 aTextureCoord;\n    attribute vec4 aColor;\n    uniform vec2 projection;\n    varying vec2 pos;\n    varying vec2 vTextureCoord;\n    varying vec4 vColor;\n    void main(void){\n        gl_Position = vec4(aVertexPosition.x * projection.x - 1.0, aVertexPosition.y * -abs(projection.y) + 1.0, 0.0, 1.0);\n        vTextureCoord = aTextureCoord;\n        vColor = aColor;\n        gl_Position.y = -sign(projection.y) * gl_Position.y;\n        pos = gl_Position.xy;\n    }\n",tt.fragmentShaderSource="\n    #ifdef GL_ES\n    precision lowp float;\n    #endif\n    varying vec2 vTextureCoord;\n    varying vec2 pos;\n    varying vec4 vColor;\n    uniform sampler2D uSampler;\n    uniform float radius;\n    uniform float cutoff;\n    void main(void){\n        vec4 color = texture2D(uSampler, vTextureCoord);\n        float f = max(0.0, min(1.0, 1.0 - (length(pos) - radius) * cutoff));\n        gl_FragColor = texture2D(uSampler, vTextureCoord) * vColor * f;\n    }\n";var it=function(t){function RoundedRectangleShader(e){var t;return _classCallCheck(this,RoundedRectangleShader),(t=_possibleConstructorReturn(this,_getPrototypeOf(RoundedRectangleShader).call(this,e)))._radius=[1,1,1,1],t._stroke=0,t._fillColor=t._getNormalizedColor(4294967295),t._strokeColor=t._getNormalizedColor(16777215),t}return _inherits(RoundedRectangleShader,t),_createClass(RoundedRectangleShader,[{key:"_getNormalizedColor",value:function _getNormalizedColor(t){var i=e.getRgbaComponentsNormalized(t);return i[0]*=i[3],i[1]*=i[3],i[2]*=i[3],i}},{key:"setupUniforms",value:function setupUniforms(e){var t=this;_get(_getPrototypeOf(RoundedRectangleShader.prototype),"setupUniforms",this).call(this,e);var i=e.shaderOwner,r=this.ctx.stage.getRenderPrecision(),n=this._radius.map(function(e){return _newArrowCheck(this,t),(e+.5)*r}.bind(this));this._setUniform("radius",new Float32Array(n),this.gl.uniform4fv),this._setUniform("strokeColor",this._strokeColor,this.gl.uniform4fv),this._setUniform("fillColor",this._fillColor,this.gl.uniform4fv),this._setUniform("stroke",this._stroke*r,this.gl.uniform1f),this._setUniform("resolution",new Float32Array([i._w*r,i._h*r]),this.gl.uniform2fv)}},{key:"radius",set:function set(e){Array.isArray(e)?this._radius=e:this._radius=[e,e,e,e],this.redraw()},get:function get(){return this._radius}},{key:"strokeColor",set:function set(e){this._strokeColor=this._getNormalizedColor(e),this.redraw()}},{key:"fillColor",set:function set(e){this._fillColor=this._getNormalizedColor(e),this.redraw()}},{key:"stroke",set:function set(e){this._stroke=e,this.redraw()}}]),RoundedRectangleShader}(Y);it.vertexShaderSource="\n    #ifdef GL_ES\n    precision lowp float;\n    #endif\n    attribute vec2 aVertexPosition;\n    attribute vec2 aTextureCoord;\n\n    attribute vec4 aColor;\n    uniform vec2 projection;\n    varying vec2 vTextureCoord;\n    varying vec4 vColor;\n\n    void main(void){\n        gl_Position = vec4(aVertexPosition.x * projection.x - 1.0, aVertexPosition.y * -abs(projection.y) + 1.0, 0.0, 1.0);\n        vTextureCoord = aTextureCoord;\n        vColor = aColor;\n        gl_Position.y = -sign(projection.y) * gl_Position.y;\n    }\n",it.fragmentShaderSource="\n    #ifdef GL_ES\n    precision lowp float;\n    #endif\n\n    #define PI 3.14159265359\n\n    varying vec2 vTextureCoord;\n    varying vec4 vColor;\n\n    uniform sampler2D uSampler;\n    uniform vec2 resolution;\n    uniform vec4 radius;\n    uniform float stroke;\n    uniform vec4 strokeColor;\n    uniform vec4 fillColor;\n    \n    float boxDist(vec2 p, vec2 size, float radius){\n        size -= vec2(radius);\n        vec2 d = abs(p) - size;\n        return min(max(d.x, d.y), 0.0) + length(max(d, 0.0)) - radius;\n    }\n    \n    float fillMask(float dist){\n        return clamp(-dist, 0.0, 1.0);\n    }\n    \n    float innerBorderMask(float dist, float width){\n        float alpha1 = clamp(dist + width, 0.0, 1.0);\n        float alpha2 = clamp(dist, 0.0, 1.0);\n        return alpha1 - alpha2;\n    }\n\n    void main() {\n        vec4 color = texture2D(uSampler, vTextureCoord) * vColor;\n        vec2 halfRes = 0.5 * resolution.xy;\n\n        float r = 0.0;\n        if (vTextureCoord.x < 0.5 && vTextureCoord.y < 0.5) {\n            r = radius[0];\n        } else if (vTextureCoord.x >= 0.5 && vTextureCoord.y < 0.5) {\n            r = radius[1];\n        } else if (vTextureCoord.x >= 0.5 && vTextureCoord.y >= 0.5) {\n            r = radius[2];\n        } else {\n            r = radius[3];\n        }\n\n        float b = boxDist(vTextureCoord.xy * resolution - halfRes, halfRes - 0.005, r);\n        vec4 tex = mix(vec4(0.0), color * fillColor, fillMask(b));\n        gl_FragColor = mix(tex, vColor * strokeColor, innerBorderMask(b, stroke));\n    }\n";var rt=function(e){function VignetteShader(e){var t;return _classCallCheck(this,VignetteShader),(t=_possibleConstructorReturn(this,_getPrototypeOf(VignetteShader).call(this,e)))._magnitude=1.3,t._intensity=.7,t._pivotX=.5,t._pivotY=.5,t}return _inherits(VignetteShader,e),_createClass(VignetteShader,[{key:"setupUniforms",value:function setupUniforms(e){_get(_getPrototypeOf(VignetteShader.prototype),"setupUniforms",this).call(this,e),this._setUniform("magnitude",this._magnitude,this.gl.uniform1f),this._setUniform("intensity",this._intensity,this.gl.uniform1f),this._setUniform("pivotX",this._pivotX,this.gl.uniform1f),this._setUniform("pivotY",this._pivotY,this.gl.uniform1f),this.redraw()}},{key:"pivotX",get:function get(){return this._pivotX},set:function set(e){this._pivotX=e,this.redraw()}},{key:"pivotY",get:function get(){return this._pivotY},set:function set(e){this._pivotY=e,this.redraw()}},{key:"intensity",get:function get(){return this._intensity},set:function set(e){this._intensity=e,this.redraw()}},{key:"magnitude",get:function get(){return this._magnitude},set:function set(e){this._magnitude=e,this.redraw()}}]),VignetteShader}(Y);rt.vertexShaderSource=Y.vertexShaderSource,rt.fragmentShaderSource="\n\n    #ifdef GL_ES\n    precision lowp float;\n    #endif\n    varying vec2 vTextureCoord;\n    varying vec4 vColor;\n    uniform sampler2D uSampler;\n\n    uniform float magnitude;\n    uniform float intensity;\n    uniform float pivotX;\n    uniform float pivotY;\n\n    void main() {\n        vec2 pivot = vec2(pivotX, pivotY);\n        vec2 uv = vTextureCoord.xy - pivot + vec2(0.5);\n        uv.x = clamp(uv.x, 0.0, 1.0);\n        uv.y = clamp(uv.y, 0.0, 1.0);\n   \n        uv *=  1.00 - uv.yx;\n        float vig = uv.x * uv.y * 25.0 * intensity;\n        vig = pow(vig, 0.45 * magnitude);\n        vec4 fragColor = vec4(vig) * vColor;\n        gl_FragColor = texture2D(uSampler, vTextureCoord) * fragColor;\n\n    }\n";var nt=function(t){function SpinnerShader(e){var t;return _classCallCheck(this,SpinnerShader),(t=_possibleConstructorReturn(this,_getPrototypeOf(SpinnerShader).call(this,e)))._radius=100,t._width=50,t._period=1,t._angle=.5,t._smooth=.005,t._color=4294967295,t._backgroundColor=4278190080,t._time=Date.now(),t}return _inherits(SpinnerShader,t),_createClass(SpinnerShader,[{key:"setupUniforms",value:function setupUniforms(t){_get(_getPrototypeOf(SpinnerShader.prototype),"setupUniforms",this).call(this,t);var i=t.shaderOwner;this._setUniform("iTime",Date.now()-this._time,this.gl.uniform1f);var r=this.ctx.stage.getRenderPrecision();this._setUniform("radius",this._radius*r,this.gl.uniform1f),this._setUniform("width",this._width*r,this.gl.uniform1f),this._setUniform("period",this._period,this.gl.uniform1f),this._setUniform("angle",this._angle,this.gl.uniform1f),this._setUniform("smooth",this._smooth,this.gl.uniform1f),this._setUniform("color",new Float32Array(e.getRgbaComponentsNormalized(this._color)),this.gl.uniform4fv),this._setUniform("backgroundColor",new Float32Array(e.getRgbaComponentsNormalized(this._backgroundColor)),this.gl.uniform4fv),this._setUniform("resolution",new Float32Array([i._w*r,i._h*r]),this.gl.uniform2fv),this.redraw()}},{key:"radius",set:function set(e){this._radius=e,this.redraw()}},{key:"width",set:function set(e){this._width=e,this.redraw()}},{key:"period",set:function set(e){this._period=e,this.redraw()}},{key:"angle",set:function set(e){this._angle=e,this.redraw()}},{key:"smooth",set:function set(e){this._smooth=e,this.redraw()}},{key:"color",set:function set(e){this._color=e,this.redraw()}},{key:"backgroundColor",set:function set(e){this._backgroundColor=e,this.redraw()}}]),SpinnerShader}(Y);nt.vertexShaderSource=Y.vertexShaderSource,nt.fragmentShaderSource="\n\n    #ifdef GL_ES\n    precision lowp float;\n    #endif\n    varying vec2 vTextureCoord;\n    varying vec4 vColor;\n    uniform sampler2D uSampler;\n\n    uniform float iTime;\n    uniform float radius;\n    uniform float width;\n    uniform float period;\n    uniform float angle;\n    uniform float smooth;\n    uniform vec2 resolution;\n\n    uniform vec4 color;\n    uniform vec4 backgroundColor;\n\n    float ratio = resolution.y / resolution.x;\n\n    vec2 transpose_pos(vec2 pos) {\n        if (ratio < 1.) {\n            float diff = 0.5 - pos.x;\n            pos.x = 0.5 - diff / ratio;\n        } else {\n            float diff = 0.5 - pos.y;\n            pos.y = 0.5 - diff * ratio;\n        }\n        return pos;\n    }\n\n    float get_angle(vec2 pos) {\n        pos = transpose_pos(pos);\n        float a = atan(pos.y - 0.5, pos.x - 0.5);\n        a = (1.0+a/3.14159)/2.0;\n        \n        return a;\n    }\n\n    float dist(vec2 pos1, vec2 pos2) {\n        pos1 = transpose_pos(pos1);\n        return distance(pos1, pos2);\n    }\n\n    void main()\n    {\n        vec2 fragCoord = vTextureCoord;\n        vec4 fragColor = vColor;\n        \n        vec2 st = vTextureCoord;\n        float pct = dist(st, vec2(0.5));\n\n        float a = get_angle(st);\n        float t = iTime / 1000.0 / period;\n\n        float inner = max((radius - width) / resolution.x, (radius - width) / resolution.y);\n        float outer = max(radius / resolution.x, radius / resolution.y);\n\n        float x1 = mod(t, 1.0);\n        float x2 = mod(t + angle, 1.0);\n\n        if (x1 < x2) {\n            if (a > x1 && a < x2) {\n                float val = (1.0 - (x2 - a) / angle) * smoothstep(0.0, 3. * smooth, (x2 - a));\n                fragColor = mix(backgroundColor, color, val);\n            } else {\n                fragColor = backgroundColor;\n            }\n        } else {\n            if (a < x2) {\n                float val = (1.0 - (x2 - a) / angle) * smoothstep(0.0, 3. * smooth, (x2 - a));\n                fragColor = mix(backgroundColor, color, val);\n            } else if (a > x1) {\n                float val = (1.0 - (1.0 + x2 - a) / angle) * smoothstep(0.0, 3. * smooth, (1.0 + x2 - a));\n                fragColor = mix(backgroundColor, color, val);\n            } else {\n                fragColor = backgroundColor;\n            }\n        }\n\n        float s = smoothstep(inner, inner + smooth + 0.00001, pct) * (1.0 - smoothstep(outer, outer + smooth + 0.00001, pct));\n        gl_FragColor = texture2D(uSampler, fragCoord) * vColor * (1. - s * fragColor.a) + fragColor * s;\n    }\n";var st=function(e){function HoleShader(e){var t;return _classCallCheck(this,HoleShader),(t=_possibleConstructorReturn(this,_getPrototypeOf(HoleShader).call(this,e)))._x=0,t._y=0,t._w=0,t._h=0,t._radius=0,t}return _inherits(HoleShader,e),_createClass(HoleShader,[{key:"setupUniforms",value:function setupUniforms(e){_get(_getPrototypeOf(HoleShader.prototype),"setupUniforms",this).call(this,e),this._setUniform("x",this._x,this.gl.uniform1f),this._setUniform("y",this._y,this.gl.uniform1f),this._setUniform("w",this._w,this.gl.uniform1f),this._setUniform("h",this._h,this.gl.uniform1f);var t=e.shaderOwner,i=this.ctx.stage.getRenderPrecision();this._setUniform("radius",(this._radius+.5)*i,this.gl.uniform1f),this._setUniform("resolution",new Float32Array([t._w*i,t._h*i]),this.gl.uniform2fv)}},{key:"useDefault",value:function useDefault(){return 0===this._x&&0===this._y&&0===this._w&&0===this._h}},{key:"x",get:function get(){return this._x},set:function set(e){this._x=e,this.redraw()}},{key:"y",get:function get(){return this._y},set:function set(e){this._y=e,this.redraw()}},{key:"w",get:function get(){return this._w},set:function set(e){this._w=e,this.redraw()}},{key:"h",get:function get(){return this._h},set:function set(e){this._h=e,this.redraw()}},{key:"radius",get:function get(){return this._radius},set:function set(e){this._radius=e,this.redraw()}}]),HoleShader}(Y);st.vertexShaderSource=Y.vertexShaderSource,st.fragmentShaderSource="\n    #ifdef GL_ES\n    precision lowp float;\n    #endif\n    varying vec2 vTextureCoord;\n    varying vec4 vColor;\n    uniform sampler2D uSampler;\n    uniform float x;\n    uniform float y;\n    uniform float w;\n    uniform float h;\n    uniform vec2 resolution;\n    uniform float radius;\n\n    float roundBox(vec2 p, vec2 b, float r) {\n        float d = length(max(abs(p)-b+r, 0.1))-r;\n        return smoothstep(1.0, 0.0, d);\n    }\n\n    void main(void){\n        vec4 color = texture2D(uSampler, vTextureCoord);\n        vec2 pos = vTextureCoord.xy * resolution - vec2(x, y) - vec2(w, h) / 2.0;\n        vec2 size = vec2(w, h) / 2.0;\n        float b = roundBox(pos, size, radius);\n        gl_FragColor = mix(color, vec4(0.0), b);\n    }\n";var at=function(t){function RadialGradientShader(e){var t;return _classCallCheck(this,RadialGradientShader),(t=_possibleConstructorReturn(this,_getPrototypeOf(RadialGradientShader).call(this,e)))._x=0,t._y=0,t.color=4294901760,t._radiusX=100,t._radiusY=100,t}return _inherits(RadialGradientShader,t),_createClass(RadialGradientShader,[{key:"setupUniforms",value:function setupUniforms(e){_get(_getPrototypeOf(RadialGradientShader.prototype),"setupUniforms",this).call(this,e);var t=e.getNormalRenderTextureCoords(this._x,this._y);this._setUniform("center",new Float32Array(t),this.gl.uniform2fv),this._setUniform("radius",2*this._radiusX/e.getRenderWidth(),this.gl.uniform1f),this._setUniform("alpha",e.getElementCore(0).renderContext.alpha,this.gl.uniform1f),this._setUniform("color",this._rawColor,this.gl.uniform4fv),this._setUniform("aspectRatio",this._radiusX/this._radiusY*e.getRenderHeight()/e.getRenderWidth(),this.gl.uniform1f)}},{key:"x",set:function set(e){this._x=e,this.redraw()}},{key:"y",set:function set(e){this._y=e,this.redraw()}},{key:"radiusX",set:function set(e){this._radiusX=e,this.redraw()},get:function get(){return this._radiusX}},{key:"radiusY",set:function set(e){this._radiusY=e,this.redraw()},get:function get(){return this._radiusY}},{key:"radius",set:function set(e){this.radiusX=e,this.radiusY=e}},{key:"color",get:function get(){return this._color},set:function set(t){if(this._color!==t){var i=e.getRgbaComponentsNormalized(t);i[0]=i[0]*i[3],i[1]=i[1]*i[3],i[2]=i[2]*i[3],this._rawColor=new Float32Array(i),this.redraw(),this._color=t}}}]),RadialGradientShader}(Y);at.vertexShaderSource="\n    #ifdef GL_ES\n    precision lowp float;\n    #endif\n    attribute vec2 aVertexPosition;\n    attribute vec2 aTextureCoord;\n    attribute vec4 aColor;\n    uniform vec2 projection;\n    uniform vec2 center;\n    uniform float aspectRatio;\n    varying vec2 pos;\n    varying vec2 vTextureCoord;\n    varying vec4 vColor;\n    void main(void){\n        gl_Position = vec4(aVertexPosition.x * projection.x - 1.0, aVertexPosition.y * -abs(projection.y) + 1.0, 0.0, 1.0);\n        vTextureCoord = aTextureCoord;\n        vColor = aColor;\n        gl_Position.y = -sign(projection.y) * gl_Position.y;\n        pos = gl_Position.xy - center;\n        pos.y = pos.y * aspectRatio;\n    }\n",at.fragmentShaderSource="\n    #ifdef GL_ES\n    precision lowp float;\n    #endif\n    varying vec2 vTextureCoord;\n    varying vec4 vColor;\n    varying vec2 pos;\n    uniform sampler2D uSampler;\n    uniform float radius;\n    uniform vec4 color;\n    uniform float alpha;\n    void main(void){\n        float dist = length(pos);\n        gl_FragColor = mix(color * alpha, texture2D(uSampler, vTextureCoord) * vColor, min(1.0, dist / radius));\n    }\n";var ot=function(e){function Light3dShader(e){var t;return _classCallCheck(this,Light3dShader),(t=_possibleConstructorReturn(this,_getPrototypeOf(Light3dShader).call(this,e)))._strength=.5,t._ambient=.5,t._fudge=.4,t._rx=0,t._ry=0,t._z=0,t._pivotX=NaN,t._pivotY=NaN,t._pivotZ=0,t._lightY=0,t._lightZ=0,t}return _inherits(Light3dShader,e),_createClass(Light3dShader,[{key:"setupUniforms",value:function setupUniforms(e){_get(_getPrototypeOf(Light3dShader.prototype),"setupUniforms",this).call(this,e);var t=e.shaderOwner,i=t.element,r=isNaN(this._pivotX)?i.pivotX*t.w:this._pivotX,n=isNaN(this._pivotY)?i.pivotY*t.h:this._pivotY,s=t.getRenderTextureCoords(r,n),o=-Math.atan2(t._renderContext.tc,t._renderContext.ta),h=this.gl;this._setUniform("pivot",new Float32Array([s[0],s[1],this._pivotZ]),h.uniform3fv),this._setUniform("rot",new Float32Array([this._rx,this._ry,o]),h.uniform3fv),this._setUniform("z",this._z,h.uniform1f),this._setUniform("lightY",this.lightY,h.uniform1f),this._setUniform("lightZ",this.lightZ,h.uniform1f),this._setUniform("strength",this._strength,h.uniform1f),this._setUniform("ambient",this._ambient,h.uniform1f),this._setUniform("fudge",this._fudge,h.uniform1f)}},{key:"useDefault",value:function useDefault(){return 0===this._rx&&0===this._ry&&0===this._z&&0===this._strength&&1===this._ambient}},{key:"strength",set:function set(e){this._strength=e,this.redraw()},get:function get(){return this._strength}},{key:"ambient",set:function set(e){this._ambient=e,this.redraw()},get:function get(){return this._ambient}},{key:"fudge",set:function set(e){this._fudge=e,this.redraw()},get:function get(){return this._fudge}},{key:"rx",get:function get(){return this._rx},set:function set(e){this._rx=e,this.redraw()}},{key:"ry",get:function get(){return this._ry},set:function set(e){this._ry=e,this.redraw()}},{key:"z",get:function get(){return this._z},set:function set(e){this._z=e,this.redraw()}},{key:"pivotX",get:function get(){return this._pivotX},set:function set(e){this._pivotX=e+1,this.redraw()}},{key:"pivotY",get:function get(){return this._pivotY},set:function set(e){this._pivotY=e+1,this.redraw()}},{key:"lightY",get:function get(){return this._lightY},set:function set(e){this._lightY=e,this.redraw()}},{key:"pivotZ",get:function get(){return this._pivotZ},set:function set(e){this._pivotZ=e,this.redraw()}},{key:"lightZ",get:function get(){return this._lightZ},set:function set(e){this._lightZ=e,this.redraw()}}]),Light3dShader}(Y);ot.vertexShaderSource="\n    #ifdef GL_ES\n    precision lowp float;\n    #endif\n    attribute vec2 aVertexPosition;\n    attribute vec2 aTextureCoord;\n    attribute vec4 aColor;\n    uniform vec2 projection;\n    varying vec2 vTextureCoord;\n    varying vec4 vColor;\n\n    uniform float fudge;\n    uniform float strength;\n    uniform float ambient;\n    uniform float z;\n    uniform float lightY;\n    uniform float lightZ;\n    uniform vec3 pivot;\n    uniform vec3 rot;\n    varying vec3 pos;\n\n    void main(void) {\n        pos = vec3(aVertexPosition.xy, z);\n        \n        pos -= pivot;\n        \n        // Undo XY rotation\n        mat2 iRotXy = mat2( cos(rot.z), sin(rot.z), \n                           -sin(rot.z), cos(rot.z));\n        pos.xy = iRotXy * pos.xy;\n        \n        // Perform 3d rotations\n        gl_Position.x = cos(rot.x) * pos.x - sin(rot.x) * pos.z;\n        gl_Position.y = pos.y;\n        gl_Position.z = sin(rot.x) * pos.x + cos(rot.x) * pos.z;\n        \n        pos.x = gl_Position.x;\n        pos.y = cos(rot.y) * gl_Position.y - sin(rot.y) * gl_Position.z;\n        pos.z = sin(rot.y) * gl_Position.y + cos(rot.y) * gl_Position.z;\n        \n        // Redo XY rotation\n        iRotXy[0][1] = -iRotXy[0][1];\n        iRotXy[1][0] = -iRotXy[1][0];\n        pos.xy = iRotXy * pos.xy; \n\n        // Undo translate to pivot position\n        pos.xyz += pivot;\n\n        pos = vec3(pos.x * projection.x - 1.0, pos.y * -abs(projection.y) + 1.0, pos.z * projection.x);\n        \n        // Set depth perspective\n        float perspective = 1.0 + fudge * pos.z;\n\n        pos.z += lightZ * projection.x;\n\n        // Map coords to gl coordinate space.\n        // Set z to 0 because we don't want to perform z-clipping\n        gl_Position = vec4(pos.xy, 0.0, perspective);\n\n        // Correct light source position.\n        pos.y += lightY * abs(projection.y);\n\n        vTextureCoord = aTextureCoord;\n        vColor = aColor;\n        \n        gl_Position.y = -sign(projection.y) * gl_Position.y;\n    }\n",ot.fragmentShaderSource="\n    #ifdef GL_ES\n    precision lowp float;\n    #endif\n    varying vec2 vTextureCoord;\n    varying vec4 vColor;\n    varying vec3 pos;\n    uniform sampler2D uSampler;\n    uniform float ambient;\n    uniform float strength;\n    void main(void){\n        vec4 rgba = texture2D(uSampler, vTextureCoord);\n        float d = length(pos);\n        float n = 1.0 / max(0.1, d);\n        rgba.rgb = rgba.rgb * (strength * n + ambient);\n        gl_FragColor = rgba * vColor;\n    }\n";var ht=function(e){function PerspectiveShader(e){var t;return _classCallCheck(this,PerspectiveShader),(t=_possibleConstructorReturn(this,_getPrototypeOf(PerspectiveShader).call(this,e)))._fudge=.2,t._rx=0,t._ry=0,t._z=1,t}return _inherits(PerspectiveShader,e),_createClass(PerspectiveShader,[{key:"setupUniforms",value:function setupUniforms(e){_get(_getPrototypeOf(PerspectiveShader.prototype),"setupUniforms",this).call(this,e);var t=e.shaderOwner,i=t.element,r=i.pivotX*t.w,n=i.pivotY*t.h,s=t.getRenderTextureCoords(r,n),o=-Math.atan2(t._renderContext.tc,t._renderContext.ta),h=this.gl;this._setUniform("pivot",new Float32Array([s[0],s[1],0]),h.uniform3fv),this._setUniform("rot",new Float32Array([this._rx,this._ry,o]),h.uniform3fv),this._setUniform("z",this._z,h.uniform1f),this._setUniform("fudge",this._fudge,h.uniform1f)}},{key:"useDefault",value:function useDefault(){return 0===this._rx&&0===this._ry&&0===this._z}},{key:"fudge",set:function set(e){this._fudge=e,this.redraw()},get:function get(){return this._fudge}},{key:"rx",get:function get(){return this._rx},set:function set(e){this._rx=e,this.redraw()}},{key:"ry",get:function get(){return this._ry},set:function set(e){this._ry=e,this.redraw()}},{key:"z",get:function get(){return this._z},set:function set(e){this._z=e,this.redraw()}}]),PerspectiveShader}(Y);ht.vertexShaderSource="\n    #ifdef GL_ES\n    precision lowp float;\n    #endif\n    attribute vec2 aVertexPosition;\n    attribute vec2 aTextureCoord;\n    attribute vec4 aColor;\n    uniform vec2 projection;\n    varying vec2 vTextureCoord;\n    varying vec4 vColor;\n\n    uniform float z;\n    uniform vec3 pivot;\n    uniform vec3 rot;\n    varying vec3 pos;\n\n    void main(void) {\n        pos = vec3(aVertexPosition.xy, z);\n        \n        pos -= pivot;\n        \n        // Undo XY rotation\n        mat2 iRotXy = mat2( cos(rot.z), sin(rot.z), \n                           -sin(rot.z), cos(rot.z));\n        pos.xy = iRotXy * pos.xy;\n        \n        // Perform 3d rotations\n        gl_Position.x = cos(rot.x) * pos.x - sin(rot.x) * pos.z;\n        gl_Position.y = pos.y;\n        gl_Position.z = sin(rot.x) * pos.x + cos(rot.x) * pos.z;\n        \n        pos.x = gl_Position.x;\n        pos.y = cos(rot.y) * gl_Position.y - sin(rot.y) * gl_Position.z;\n        pos.z = sin(rot.y) * gl_Position.y + cos(rot.y) * gl_Position.z;\n        \n        // Redo XY rotation\n        iRotXy[0][1] = -iRotXy[0][1];\n        iRotXy[1][0] = -iRotXy[1][0];\n        pos.xy = iRotXy * pos.xy; \n\n        // Undo translate to pivot position\n        pos.xyz += pivot;\n\n        pos = vec3(pos.x * projection.x - 1.0, pos.y * -abs(projection.y) + 1.0, pos.z * projection.x);\n        \n        // Map coords to gl coordinate space.\n        // Set z to 0 because we don't want to perform z-clipping\n        gl_Position = vec4(pos.xy, 0.0, z);\n\n        vTextureCoord = aTextureCoord;\n        vColor = aColor;\n        \n        gl_Position.y = -sign(projection.y) * gl_Position.y;\n    }\n",ht.fragmentShaderSource="\n    #ifdef GL_ES\n    precision lowp float;\n    #endif\n    varying vec2 vTextureCoord;\n    varying vec4 vColor;\n    uniform sampler2D uSampler;\n\n    uniform vec3 rot;\n    uniform float fudge;\n\n    void main(void) {\n        vec2 coords = vTextureCoord;\n\n        coords.xy -= vec2(0.5);\n        coords.y = coords.y + (sign(rot[0]) * 0.5 - coords.x) * sin(rot[0]) * fudge * coords.y;\n        coords.x = coords.x + (sign(rot[1]) * 0.5 - coords.y) * sin(rot[1]) * fudge * coords.x;\n        coords.xy += vec2(0.5);\n\n        if (coords.x < 0.0 || coords.x > 1.0 || coords.y < 0.0 || coords.y > 1.0) {\n            gl_FragColor = vec4(0.0);\n        } else {\n            gl_FragColor = texture2D(uSampler, coords) * vColor;\n        }\n    }\n";var ut={Application:Ae,Component:U,Base:i,Utils:t,StageUtils:e,Element:M,Tools:Re,Stage:be,ElementCore:k,ElementTexturizer:m,Texture:b,EventEmitter:C,shaders:{Grayscale:qe,BoxBlur:Be,Dithering:$e,CircularPush:Qe,Inversion:Ke,LinearBlur:Ue,Outline:Je,Pixelate:et,RadialFilter:tt,RoundedRectangle:it,Hole:st,Vignette:rt,Spinner:nt,RadialGradient:at,Light3d:ot,Perspective:ht,WebGLShader:X,WebGLDefaultShader:Y,C2dShader:J,C2dDefaultShader:ee,c2d:{Grayscale:Ze,Blur:De}},textures:{RectangleTexture:Te,NoiseTexture:Oe,TextTexture:R,ImageTexture:A,HtmlTexture:ze,StaticTexture:Me,StaticCanvasTexture:we,SourceTexture:P},components:{FastBlurComponent:We,BloomComponent:Ge,SmoothScaleComponent:Xe,BorderComponent:Ye,ListComponent:Fe},tools:{ObjMerger:Le,ObjectListProxy:Pe,ObjectListWrapper:Ee}};return t.isWeb&&(window.lng=ut),ut}));
//# sourceMappingURL=lightning.es5.min.js.map
